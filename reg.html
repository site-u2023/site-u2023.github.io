<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>SSHPS プロトコル登録＆起動</title>
</head>
<body>
  <input id="host" type="text" placeholder="ホスト名（例: myrouter.local）">
  <button id="reg-btn">ワンクリックでSSH起動セットアップ</button>

  <script>
  document.getElementById('reg-btn').addEventListener('click', () => {
    const host = document.getElementById('host').value.trim();
    if (!host) return alert('ホスト名を入力してください');

    // 1) .reg の内容を組み立て
    const reg = `
Windows Registry Editor Version 5.00

[HKEY_CLASSES_ROOT\\sshps]
@="URL:SSHPS Protocol"
"URL Protocol"=""

[HKEY_CLASSES_ROOT\\sshps\\shell]
@="open"

[HKEY_CLASSES_ROOT\\sshps\\shell\\open\\command]
@="\\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\" -NoProfile -Command ^
  "$dns = (Get-DnsClientServerAddress -AddressFamily IPv4)[0].ServerAddresses[0]; ^
   $ip  = (Resolve-DnsName -Name '${host}' -Server $dns -ErrorAction Stop).IPAddress; ^
   ssh root@$ip;\""
`.trim();

    // 2) Blob 化してダウンロード
    const blob = new Blob([reg], { type: 'application/octet-stream' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `sshps-register-${host}.reg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // 3) 少し待ってプロトコルハンドラを呼び出し
    setTimeout(() => {
      // ここでブラウザに「外部アプリを開きますか？」と聞かせる
      window.location.href = `sshps://${host}`;
      URL.revokeObjectURL(url);
    }, 500);
  });
  </script>
</body>
</html>
