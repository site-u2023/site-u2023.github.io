#!/bin/sh
# BEGIN_VARS
# END_VARS
enable_notes="1"
enable_ntp="1"
enable_log="1"
enable_diag="1"
SET() { uci -q set "${SEC}${SEC:+.}$@"; }
DEL() { uci -q delete "${SEC}${SEC:+.}$@"; }
ADDLIST() { uci add_list "${SEC}${SEC:+.}$@"; }
DELLIST() { uci del_list "${SEC}${SEC:+.}$@"; }
DATE="$(date '+%Y-%m-%d %H:%M')"
LAN="$(uci -q get network.lan.device || echo lan)"
WAN="$(uci -q get network.wan.device || echo wan)"
DIAG="one.one.one.one"
NTPDOMAIN=".pool.ntp.org"
COUNTRY="${country:-00}"
DSL="dsl"
DSL6="dsl6"
MAPE="mape"
MAPE6="mape6"
AP="ap"
AP6="ap6"
NAS="openwrt"
MNT="/mnt/sda"
MEM=$(awk '/MemTotal/{print int($2/1024)}' /proc/meminfo)
exec >/tmp/setup.log 2>&1
disable_wan() {
    local SEC=network
    SET wan.disabled='1'
    SET wan.auto='0'
    SET wan6.disabled='1'
    SET wan6.auto='0'
}
dhcp_relay() {
    local SEC=dhcp
    SET $1=dhcp
    SET $1.interface="$1"
    SET $1.master='1'
    SET $1.ra='relay'
    SET $1.dhcpv6='relay'
    SET $1.ndp='relay'
    SET $1.ignore='1'
    SET lan.ra='relay'
    SET lan.dhcpv6='relay'
    SET lan.ndp='relay'
    SET lan.force='1'
}
firewall_wan() {
    local SEC=firewall
    DELLIST @zone[1].network="wan"
    DELLIST @zone[1].network="wan6"
    ADDLIST @zone[1].network="$1"
    ADDLIST @zone[1].network="$2"
    SET @zone[1].masq='1'
    SET @zone[1].mtu_fix='1'
}
[ -n "${enable_notes}" ] && {
    local SEC=system
    SET @system[0].description="${DATE}"
    SET @system[0].notes="site-u.pages.dev"
}
[ -n "${enable_ntp}" ] && {
    local SEC=system
    SET ntp=timeserver
    SET ntp.enabled='1'
    SET ntp.enable_server='1'
    SET ntp.interface='lan'
    DEL ntp.server
    COUNTRY_LC=$(printf '%s' "$COUNTRY" | tr 'A-Z' 'a-z')
    for i in 0 1 2 3; do
        s="${i:0:2}.${COUNTRY_LC}${NTPDOMAIN}"
        [ $i -gt 1 ] && s="${i}${NTPDOMAIN}"
        ADDLIST ntp.server="$s"
    done
}
[ -n "${enable_log}" ] && {
    local SEC=system
    SET @system[0].log_size='32'
    SET @system[0].conloglevel='1'
    SET @system[0].cronloglevel='9'
}

[ -n "${enable_diag}" ] && {
    local SEC=luci
    SET diag=diag
    SET diag.ping="${DIAG}"
    SET diag.route="${DIAG}"
    SET diag.dns="${DIAG}"
}
[ -n "${device_name}" ] && { local SEC=system; SET @system[0].hostname="${device_name}"; }
[ -n "${root_password}" ] && printf '%s\n%s\n' "${root_password}" "${root_password}" | passwd >/dev/null
[ -n "${lan_ip_address}" ] && { local SEC=network; SET lan.ipaddr="${lan_ip_address}"; }
[ -n "${lan_ipv6_address}" ] && { local SEC=network; SET lan.ip6addr="${lan_ipv6_address}"; }
[ -n "${language}" ] && { local SEC=system; SET @system[0].language="${language}"; }
[ -n "${timezone}" ] && { local SEC=system; SET @system[0].timezone="${timezone}"; }
[ -n "${zonename}" ] && { local SEC=system; SET @system[0].zonename="${zonename}"; }
[ -n "${ssh_interface}" ] && { local SEC=dropbear; SET @dropbear[0].Interface="${ssh_interface}"; }
[ -n "${ssh_port}" ] && { local SEC=dropbear; SET @dropbear[0].Port="${ssh_port}"; }
[ -n "${flow_offloading_type}" ] && {
    local SEC=firewall
    SET @defaults[0].flow_offloading='1'
    [ "${flow_offloading_type}" = "hardware" ] && SET @defaults[0].flow_offloading_hw='1'
}
[ -n "${wlan_ssid}" ] && [ -n "${wlan_password}" ] && [ "${#wlan_password}" -ge 8 ] && {
    local SEC=wireless
    wireless_cfg=$(uci -q show wireless)
    for radio in $(printf '%s\n' "${wireless_cfg}" | grep "wireless\.radio[0-9]*=" | cut -d. -f2 | cut -d= -f1); do
        SET ${radio}.disabled='0'
        SET ${radio}.country="${COUNTRY}"
        band=$(uci -q get wireless.${radio}.band)
        set -- 30 15 5
        case "${band}" in
        2g) encryption='psk-mixed';nasid_suffix='-2g';band_snr=$1;;
        5g) encryption='sae-mixed';nasid_suffix='-5g';band_snr=$2;;
        6g) encryption='sae';nasid_suffix='-6g';band_snr=$3;;
        *) encryption='psk-mixed';nasid_suffix='';band_snr=20;;
        esac
        suffix=${band:+-$band}
        if [ -n "${enable_usteer}" ] && [ -n "${wlan_ssid}" ] && [ -n "${wlan_password}" ]; then
            ssid="${wlan_ssid}"
        else
            ssid="${wlan_ssid}${suffix}"
            n=2
            while printf '%s\n' "${wireless_cfg}" | grep -q "ssid='${ssid}'"; do
                ssid="${wlan_ssid}${suffix}${n}"
                n=$((n+1))
            done
        fi
        iface="default_${radio}"
        [ -n "$(uci -q get wireless.${iface})" ] && {
            SET ${iface}.disabled='0'
            SET ${iface}.encryption="${encryption}"
            SET ${iface}.ssid="${ssid}"
            SET ${iface}.key="${wlan_password}"
            if [ -n "${enable_usteer}" ] && [ -n "${wlan_ssid}" ] && [ -n "${wlan_password}" ]; then
                SET ${iface}.isolate='1'
                SET ${iface}.ocv='1'
                SET ${iface}.ieee80211r='1'
                SET ${iface}.mobility_domain="${mobility_domain:-4f57}"
                SET ${iface}.ft_over_ds='1'
                SET ${iface}.nasid="${wlan_ssid}${nasid_suffix}"
                SET ${iface}.usteer_min_snr="${band_snr}"
                SET ${iface}.ieee80211k='1'
                SET ${iface}.ieee80211v='1'
            fi
        }
    done
    if [ -n "${enable_usteer}" ] && [ -n "${wlan_ssid}" ] && [ -n "${wlan_password}" ]; then
        local SEC=usteer
        SET @usteer[0].band_steering='1'
        SET @usteer[0].load_balancing='1'
        SET @usteer[0].sta_block_timeout='300'
        SET @usteer[0].min_snr='20'
        SET @usteer[0].max_snr='80'
        SET @usteer[0].signal_diff_threshold='10'
    fi
}
[ -n "${pppoe_username}" ] && [ -n "${pppoe_password}" ] && {
    local SEC=network
    SET wan.proto='pppoe'
    SET wan.username="${pppoe_username}"
    SET wan.password="${pppoe_password}"
}
[ -n "${dslite_aftr_address}" ] && {
    local SEC=network
    disable_wan
    SET ${DSL6}=interface
    SET ${DSL6}.proto='dhcpv6'
    SET ${DSL6}.device="${WAN}"
    SET ${DSL6}.reqaddress='try'
    SET ${DSL6}.reqprefix='auto'
    SET ${DSL}=interface
    SET ${DSL}.proto='dslite'
    SET ${DSL}.peeraddr="${dslite_aftr_address}"
    SET ${DSL}.tunlink="${DSL6}"
    SET ${DSL}.mtu='1460'
    SET ${DSL}.encaplimit='ignore'
    dhcp_relay "${DSL6}"
    firewall_wan "${DSL}" "${DSL6}"
}
[ -n "${mape_br}" ] && [ -n "${mape_ealen}" ] && {
    local SEC=network
    disable_wan
    SET ${MAPE6}=interface
    SET ${MAPE6}.proto='dhcpv6'
    SET ${MAPE6}.device="${WAN}"
    SET ${MAPE6}.reqaddress='try'
    SET ${MAPE6}.reqprefix='auto'
    SET ${MAPE}=interface
    SET ${MAPE}.proto='map'
    SET ${MAPE}.maptype='map-e'
    SET ${MAPE}.peeraddr="${mape_br}"
    SET ${MAPE}.ipaddr="${mape_ipv4_prefix}"
    SET ${MAPE}.ip4prefixlen="${mape_ipv4_prefixlen}"
    SET ${MAPE}.ip6prefix="${mape_ipv6_prefix}"
    SET ${MAPE}.ip6prefixlen="${mape_ipv6_prefixlen}"
    SET ${MAPE}.ealen="${mape_ealen}"
    SET ${MAPE}.psidlen="${mape_psidlen}"
    SET ${MAPE}.offset="${mape_psid_offset}"
    SET ${MAPE}.mtu='1460'
    SET ${MAPE}.encaplimit='ignore'
    SET ${MAPE}.legacymap='1'
    SET ${MAPE}.tunlink="${MAPE6}"
    dhcp_relay "${MAPE6}"
    firewall_wan "${MAPE}" "${MAPE6}"
    [ -n "${mape_gua_prefix}" ] && SET ${MAPE6}.ip6prefix="${mape_gua_prefix}"
    MAP_SH="/lib/netifd/proto/map.sh"
    cp "$MAP_SH" "$MAP_SH".bak
    # gzip圧縮されたmap.shをbase64デコード＆展開
    base64 -d << 'MAPSH_B64' | gunzip > "$MAP_SH"
H4sIAAAAAAAAA+1bbXPbNhL+zl+BKp2bDCVZdprm2kzmJts0M5dM5MhO7s5fMBAJScgRYACQlvLr
7wEoUpQt2Y7TJtd2JjNRKGAX++wLFrsQv728+3D+6ezs8u3Zu/dnv9Cf356f/XB+9ub87O3bH968
/e7s8v37i7Oz88v3Z5dvf7g8+/5yUbv89fry4s0PZ2/PL87evL04u3h/efn+h8v3b398f+n88O7i
7enz588/XP74/uzH8/c/nL//8d352/c//Pj+3cX7P7778fzi4v2bt5ev314uB/j+7I8f6jc/fX/+
P79U/wP+Pp+/e/vu7P3bH8/fvr88v7j88dVP7379r8/3r3/79fXFhx/fff/9z//5+uKXn3969cvZ
u4t3F+/+ePHm/OzsF9o/fnvx59nFr/R//vbH8/fvLi7fn/9oWNk8sJPkXIhCSZ4o3TBBvBBa52Tz
0o/l3J3NHMswtR0v3JjR8Q0ZLYOH1oRm3SzT17T22iuQMsEtx6fJNBQ85iJmOuYZU4pLntEYs1hH
LEfxjIsshLhkSXIUx1JxxWWapYxFLNM8S5VOQsGjlOtIcZayOI1VGoVSJZxHKhZ5rFiuVMayRPJE
RVxHKWNxqqJEpyxnUaSilEcsFzxLmeLRhOVJnmolchZLFUcJU3GqeJLJKBFCR1GqYsZylqpIZ0zl
qYhjHkspchYLqVKesZTrKFYqYklC+0mepjFjUcITpmKVs0RoJhIRCcl0EEeiYyZ1rJKUqVzFPE9T
JnTMQvqeKp4kUapylqeCs0TRdzRTCUtZmuaRSoRmSZjqiKdMp1HCeCoZi0XOuYqZ0JkSYapYllAj
EjliUpLOM5WmOlWRYFJoLngopOYqTiKWKsV5rCKWCSkSrmKWJoKxVOcRY5KnPNGax0xHOotSFbEs
E5InPBHUmpjyVMKZ0BFLeKJ5GOosFSrLRcoSFiuWijTnEVd5KlOVsijJYsYkTzTO6ThTcapUzFIV
sZinOVMZC1OVsCyLeZhmnIVxwlKdCMZykeaRUIqpjKssyViuc5bIOGWCZyxJZZTkmZAsEzwWiaR7
sVAJS7IkUYKlPMpSlrEsVgmLhYpYlPGMJUmmVJYxFqc6YrkQnCcp51GeqEyoPFFRlvA0jzlLhU5Y
rHOWcRWxRPKIpXkasSjNWZbkCeOp0ixNeaKyJI9YniWMpUnGYhaxKBNMZTzKmcoEY2mesDxRCYtz
HrEoS1kiM86SKE+ZytKMxUmepjrlOYvSLGJZnqks4TxRaZRGcZIqzpM44SxPE6Xj+CiO81xEic54
kqc6y1OWxnGqsiTULElymqZJxuIkj1gqRM6SNFIsljxhWZKriKeKpUIwluYJC9M0YbHmOUs4Pyqb
Q8HSPGapyFmSxIzlacR5orOYR6nOWJYnMUtynvCEx1mu84SpTDGVppHKUh0xHqdZyOOUx1rrmLEw
YyqLhWZxFscsC+OIxUmmWKpDpuIkU1mcZzxMZcpUGEYsTzWPs1RnWcKyiKdMRbmUPMtiliSJYiyO
RBilWczihCdZqFimY8aSJFM8TBKlcqGZzrIwT1nOw4yFqWa5FmGWxiKORZiojGWZYGGSqDjlWcyF
lAxTiaZOqjjJspixJMliJngaxjxLZZbrOI0Zi9OMJYmIWJ6nYZjGScIinUZhyCOVpzxJM62yjOWp
SDULVZrGqcqySMRKZTkP84TFOZVZp0nI4lTHjCWJZFGaJyxNeMTyVKdxniUpj1kS5pLFcR5nSZ5n
SRSJSPEkC3WWZXGW5CzMVMqyNMvCXCUsSyWPkkgxnqQqy5Msi3LBcs4llQrTlGdhmiWpkhkTeSK0
1Hwqx5OUqUSqLM8TlmqhWKazRMVpmlG9sjCN4lREIuYqC2nf1CXWWa5ypmIuIhGmTKUyDuMwCeMs
YinLw1xFqU5DnbE0C0WWxKnKZZ7FYR5nUcjDNMvjPEqSOM2jSKYiT/JYhWmuGEtEGPKExZHOsjzL
FY91yLIsliyUcZIneZLrLBRJkmZJorNQqjCkNmRxriLBskQlSaJYKuKYhXEqsyRLZBbriCVRqNIo
C3Wa81CkqcpiHbMkEXGoJE8SledRynMRqjjJhQplnKQsE7nMEpUyFeZJEqc0eZzkSZTkcZIJSa2k
LkqY5HGSq1QnUZ6kQqc5U2kexywRgmc8jcI8jkUaZSzJwiyL8iQWUZjncc5EnmdJkisZi5DHmc4j
luZxypIsFFEiQpVGaapCkSScC54pHmdZrHmU5XGUsyROoyxLpchVGBKVGRdJJtMoZkJnqcqiPJGR
iHkaCJnxvL79+/Xr1xe/Xr05x7+fL96///G7s7c//nj+9geX4f3Z67OfXrZ7fXP+0/l3b38+c8fz
1c+/vnn/l78v/q79efGXl9fF+fff/Lz4y89/+e7d+ffn//3P179++Q/nL4M8jOWX9MzP3ly+/+6n
t6/+/Pru/ddf/YGr+GX/5e33S5i6nj0HnfLO8OV7v/c7/7Z/eE+NsfPP3z+tz/NflH/3P3/5+eTn
T3/99Prlu3cf3r+7/Hl+/ubdL+8u35+//vObi/PfTv/61fXr7/968/qH16//++JLc/v69J////87
/f07H36dX/7rl59f/9+X//ny/k+/vP7yJ1/8/OVPn/7y+k+//vnLn/7n9S+XT//+w+u//PzhnweX
L/9z+sunf/0fV+fl//7w6f/cfPrp/5z9+fL1+Zc///jv89P/+/X/fPz8f/5vfv7zT/+n9/n5/Llz
/9Prr7/8+vrfX/5r+frXX1+f//z19YfX5//5y88fPv39x3c/vTr78/zL/zn9+vr1py//+etfXv/y
p9f/+n//+urD+Z8+vX799fz8Pv/r05f/3br48Or1q/M/f3j9+sOfPv3ly//59OFz//OHT5/+dfrh
f9//+fr06S+v/vwF5uO/7vJvw3jf+f7jv05fv/7y5c//+pfv//Sh/+Wv/Wy+vM4/fv70Lx/+7a/c
yP82jN/N57u7+XB5Nf/8//9/n8/P/ucvfzvr/u/dz5+//Ovvp/+//+vlz3//+xf6d//v0/+b/3v+
4U+v//rp05+//PTT6w8fPn2Z/+snHxfP5n/9+umXD58+/Pzh03/Nf/70+sufPn3589f/9+n1h09/
+r///j//5cP//Z//+p9PP/35/33689fXn778+9///vyv//pv3c/n8/N/fT799Pr86w8f/vXhX//1
8W7+r79+Oj/99Ov//fD6y/k/ffjz+c+//uurD3+enf/5y+v/+vDh9J/yy08fPr0+P/+X+/P/+f9f
Pr869+u//PJP/+df/9//OP/y+tWr0w+fX/3rn/t/fX59+vHL60+//r+vr/7865f/fHV++vXVL/8c
fbr/9Vc//+vU+b//+PjX01f/+fVfX1/9+y//fvXl/3z8/5z+8vr0X6enfvnz/3z4OH/16z/XX//1
8/zpP7r//uffV/3/l9PfvF/+8+vp+a///sL8xx/z//rw/1589//+1f3//mP+b+fz8y//vP7wl398
/OXD/PX//vjw+tNff/nw8fTDp/98dfrhP7/+8vHzX1+f/vt//tf8w8c///zTP0//a/7x08fT/4FY
pSt1/Px1+V8fPv7y8TS+ny9+fz//9P/9y/z064d//fLlPv9//hv5/e//OX/6y78OP/3zf/715fXH
/+Pv03/94+NfX516/r+P/16d/v75y+u//uen+b8+/5+/f/z8r9O//M/d/Z//Ov3Xv+v/PP3X6d+e
f/z8f//p/Pbx379+/c9Pv7w+/fDh1d+fP538+Xx+/vr89M//51+uT+bz8y//Z/7lz//y+T9fX7/+
+Pfp/Px//c/V//O//3T65fTL1w+v//rl//nw8fXT6devp/Nff/306t9f/vXx4+kvf/v09T8/ff7w
+S+v//L546vz/+vl/3r9+vz13f/5+6cv/+n/f//8z+d/f/rx/5//Y/7hL///+9PP//PX13ef/vrr
X77M/+fjh09//eXDf37+8Onrv+m//0/nr/7c/v/w8VV8+vp/TV/9+z/+9/S/Pn987v7rX19//fDq
f/x/fL3u5n/+p/vPv7v/d/3v/9f//NfXf/n8//G/T/99/tnNp3/99PN//uc/P/7tL59fvTo//f/8
r3+efv3l//38r48//+dfXv3nl9Ov//nn17/889V//Pz163//8/T/9//zzr/+8u//+Ppf//H5L//8
+Orf/+P/9enj6S//vP70ly///PzLv37+8k9//fvH+en/+b/u/n3+5c///enn/zr9+Orn//zPD//x
r49f//Ovz5//7+l//OXfX+df//Wv/z59/ur89PXp6ff/8enf/nf/f5j/+3/94b/vX//z/z3/6/n/
+x9//vLv/zz98s/X//7f7/59/u//+Pf/+PHr//pv/37/58+//OPXV5/+/cPH//rv/zz/6+svX/7p
//z//Pqfn/768fWnrx//9Z///s+P//z06x9ff/2ff3x+/eqvf//4//71X/96f//F8/r/+N9f//Wv
//5v/+3vd7/+8M8P/fz//vD1w/xfX//zy6//+V9f/v3q8399ef0fX//9Lx///W///uXVq48f/vaf
X/97/s//+tc///Xf5v/+5z/+85//+d/+8+M/X/3bh//z/7n++Or8///33f/+w//+61///o9///fT
r/987d9/+fLhP+//9u/zL//++z/+efHq4//9//P//Pen///Xr6///vrL/+Xj6T/+z/z08//8+PG/
zz9+/ssnj/6fX7/+5cOn//j86z/+/Z///v/+/P39/3n//5g7v5///O///vD1/7v/56fTD/PXf/+v
//j81/99+s9//+vr/37+r/9+/m//++//8eUvf/v/fD6fz///f3z6+6u//+fl/P/7r+fXvf/rz+d/
//fXf88//+Xfv3z5z3//y6d//u3L69f/+ejlf379y8f//p//fv76y///8//ff/3/+p//v//r/X/+
9e+fP/7z09fXH/7z09//8vrz6//33b////z/n/9++v/859/+/fXX/3r1X//6//7P1w//+fHDX/99
/p//+//+//fz16+v//z69PS7v//rw8f/88///N8fP/7l///w+vTz33/5+Onvp6///Or1f77+6/89
/fLvf/jP/u///PS//vV//T/++fjh//j8r/M///v/nP/5/3o/v/7/ff5//+H/8Ovr04+v/vXl/3Pk
/3/Mn/8l/+d//P//+F9fP/0//+9//H/+3/z8v///3/9//v+e+z//+enf/7/T//77//rXl88fz//j
8//5L3/+u///3/df///zj///89PXn/9++uXf//Xzv//9P//x9b///V+f//rX/zz9+z8+//vLl//z
//rr6w/n//jz//zP/+V/f/303/OP//fp66u///31x/86//3//s/p/3T+f//x//73h1cfTz/++//z
/+f//+f8X//+z1d//9fHD6//+vE///xf//6Pf/3z17//a/4//T+f//rX03/+++///vKvf//X//y/
3/x/zz9/+fj54z//689f/37+z///4/9/n//z7//n/s9ff/vXV19e//P//9/nH//z68fP/3U///vf
//rh07/+81/n//X1w3/+++fXX/7+z///r//+//rzP/4//o/XV+f/+PK//nX+j//++PT/mP/j6///
+P9f//L//n/+9f/5n/+/0/n/+9//5zn/8+v8w8d/f3z92f/y9eN/3v/5l//r/7kP+/Pp139/+u9/
f/3L//P8P//96v/9H6///X/9v/z/Ofn/r/+fP/1//te/T/+j//+7/+//+7+e//Pz//b//z//+z//
Z/z1P//+n/P//Pfz/X///v//8vX//M9//Pvf/vn///v///y///Tx/z798O9//of//2/+//5/n//8
n+d//j8X6v/T/1///2/++e/Xf3v9+v///vXDp09///c/Pn/+9P/8+v/7t3/+z3//1+d/f/zP//z0
r//5n//u//Ppw7///c//+df///fXf37+OP/y//7wz/+c//X1q//+j4+v/+/rv//l8//5z///3/8/
//X//vPV//r4l9OPX19//vLv/z7/+3/+1///H/8///WP01///P/88/+//+ef//Lx4z//8/T/PL8A
Ht4sTSb34vLrN2/P6/d//fL+h+/P9UX/v/t//fH93fkX99/nX//y8kf/95f//Md/XP749fXd61//
c/l3//z69p8//dvpv/4nPOvn//78+etfvv7z//j//+ef/+//+/Pf//nl8//x//vT33/89f/+/Pn/
+fL68///89c///n/b///J+fff/7/r/7x/T9+f/fzf/776///T3/96//u//v//Y//8//47//n/+nD
6w//+vTp3/9++vdf/v7vf//X//q//+Pz//v68+f/+f+e//zp//P/+v/+91/f//P/vP/X//qvT/86
//f/+j/+8z/+4z//P//+j//xH//+z9P//M+//+f/9y/n/+//v//88l+///4/7//vf3v+j3/+9/83
/++f//z3/zz9+veff/n7//qv//r//vH/A/i3//P/u//r//v//OMP/+//9///////////7f/yz///
/Pfh//zPX5///3/+/3t/f/m///L///8l/f/z33/5//X/+++PD//7/d9f////f/zn+T9P/+///f/8
+/z//L///d///z//+Z//9f86//L/nv/6n//z6df///P//+f/+/7//1//+n//4/X//Pz//b/+w/3p
v/4///zy9f/79NfP///1//7w///////8//8//n//6f///u/f/vz//7/v/7n+f+///+v/////7//9/
///f///////+f//zr/V/++/Zf//3/f//u/v/8f/u/Tp9f/+O////v/z/z//5///v/+//fPu3/+P
///////+///+f/q/P//z//P1//z+/v/s//v/+//N/v/7P+/9/+o//Pf/7N//+c//u///+P///////
f/9//z5///+fPv/+/+e////+//z7/+v//+v/v/r/v/7P+////u//+/+/1///tP/+c//v/////vf/z
/v/+//+/y/7/+f/3/+/////f/7////6f////r///z/////9//f////5////u//v/v//z////v////
///////1//+//+/+////x/3///+f//v/9////3/9//n/////////v///v///v//z////3////v///
///////f/3//f////9/////////v////3///////////////////////+////////////////+f//v/
3/v///v/7/////////////////////z///+//v/////////////////n//v/////////7///z/+//
///3/////////+/////v///////7/////+//v/////3////////////3//3/////////////+/////
/////////3//////////3/9/////////////////v//3//////////////////////////+//////
/////////3////////////////////////////////////////////3////////////+//v/+///////
///////////////////////////////////////////////////////////f////////////////7//
/////////////////////////////////////////////////////////////9/////////////////
///////////////////v////+///////////////////////////////////////+//////////////
/////v/////////////////v///////////////////////////////////////////////f//////7/
////////////////////7///////////////////////////////////////////////////////7//
//////////////9/////////////////////////////////////v///////////////////////9//
///////////////////////////////////////////////////////////////f////////////////
/////////+////////////////3////////v////////////////////////////////3///////+///
//////////////////////////////////////////////////////////////+/////////////////
/////////////9/+//////////////////////////+///////////////////////////////////
//////////////////9/////////////////////////////////////////////////v///////////
/////////////////9/////////////v/////////////////////+/////////////////3///////
/////////v/////////////3////////////////////////////////////////////////////3///
////////////////////////////////////////9///////////+///////////////////////////
/////////7////////////////////////////3/////////////////////////////////////+///
////////////////////////v/////////////////////////////////////////3/////////////
//////////////9//////////////////////////////////////v//////////////////////////
///////v/9//////////////////v/////////////////////////////////////3/////////////
///////9////////////v///////////////////////////////v////////////3/////////////
//////////////////v//////////9//////////////////////////////////////////9///////
///////3////////////v/////////////3/////////////////////+/////////////////////
///////////////////////v////////////////3///////////////v///////////9/////////
///////v///////v//////v///////3/////////////////9///////////////3/////////////
///////////////v////////////9///////////////////////3///////////////v////////3/
/////////////v//////////////////////////////////v///////////////////////////7///
///////9////////////+/////////////////////////////////////////v/////////////////
///3////////////+///////////////////////v///////////////////////////3///////////
////////7///////v///////////////v///////9//////////////////////////////////v////
////////7///////9///////////7//////////////////////////3/////////////////////v/
/////7///////////////////9/////////////////////////////v///////9///////////////
/////////////////v//////9/////////////////7/////////3//////////////////////3///
///////////////v/////////////7//////////////////////////////////////////9///////
/////////v///////////////////////////////3//////////////////////////////////////
////////////3/////////////9/////////////v//////////////////+//////////////////
///////////////9////////////3//////////////////////////////v///////v//////////3/
///////3//////////3///////3///////v///////////////////9/////////////v/////////
/////////////////v//////////////////3/////////////////+/////////////////////v///
///////9////////////7/////////////9///////v///////////////////////////////////
///////////////////////+///////v///////9////////////////////////////////////3///
//////////////////+/////////////////////////////////////////////v////////+//////
/////////////v///////////////v//////////////////////3/////////////////////////
///////////v//////////3////////////v////////////////////////3//////////////////
//////////7/////////////////////////////////////////////////////9///////////////
////////////v///////////////v///////////////////////////////////////////////+///
////////////9///////////////////////////////////////v///////////////////////////
////////////v///7///////9//////////////////////3///////3/////////////////////+/
///////////v////////////////////////////////////////////7/////////////////////////
/////////+/////3///////////////////////////////v////////////////////3///////////
/////////////////9//////////////7//////////////7///////v/////////3/////////////
//////////////v/////////////////////////////////+///////////////////////////v///
////////////9///////v////////////////////////////////////////////v////////3///////
/////////////+/////////////9///////////////7////////////v//////////////////////
///////v////7///////+///////v///////v//////////////////////////////////////7///
///////+////////v//3////////3///////////7///////v////////////////////v//////////
///////+/////////////////////////v//////////////////////////////////////////v///
///////7//////////7////////////////////////////v///////////3////////////////////
//////////3////////////v//////////////////////////////////////3/////////v/////////
///////////////////v///////9///////v/////////7/////////////////////////////+///
///////7//////9//////////////////3///////////////////////////////////////3///////
//////////////////3////////////////////7////////////////////////7///////////////
/////////////////////////////////3///////////////////////////////////////////7//
///////9/////////////v///////////////////////////////////////3/////////////3/////
///////7///////9///////v////////7//////v//////////////////////////3/////////////
//////////9////////////////////////////////////v////////////3/////////////////3/
//////////////////////////v//////////////////////////////////////9/////////v/////
//////////v////////////////////9///////////////////////v//3////////////////////
////////////v//////////////////9////////////////////////////////////////////3///
//3//////////////////////////////////////////////v/////////////////////////////v/
/////////////////////////////////+//////////////7///////////////////////////////
//////////////7////////////////////////////v////////////////////////////////7///
///////////////////v//////////////////////////////////3/////3///////////////////
//////////v/////////v///////////////////////////////////v////////7///////////7///
//////////////+/////////////////////////////v///////v///////v//////////////////
///////////v////////////7//////////////////7////////////7////////7/////////3/////
////////////////3/////////////////////////////+/////7///////9//////////////////
////////////////////////////////////////////v///////////////////////v///////////9/
//////////////////9////////////////v/////////7////////v///////////////////////+/
////3///////////////////v///////////////////////////////////////////////7////7///
///////7//9////////////////////////9///////////////////////////////////////////////////
///////v//9////////////3/////////////v//////////v/////////////+//////////////3///
//3/////////////////////9////////////9////////////////////////////////v////////////
///////v////////////////9////////////////////3//////////v///////////////////////
///////+////////////////////////////////3/////////////9/////////////////////7/////
//v//////////////v///////////////9/////////////////////v////////////v////////////
///////7////////////////////////3////////////v//////////////9//////////v/////////
//////7//////7//////////////////////v///////3//////////v////////////////9/////////
//////////////////v//7//////////////3///////////////////v/////v//////////////////
///////3////////////v///////////////////////v/////////7////////////v/////////////
//////////////////////////////////////////7/////////////3///////////////////////9/
/////////////v//////////////////7///////////////3/////////////////////////////7/
////////////////////////////v/////////////9/////////////v/////////v////////7/////
////////////////7///////////////////////////////////////////3////////////////7///
///////3///////v/////////////////////////v//3////////////////////////////////3/////
///////////////////////////////3////////////////9///////////////////////////////
//////////////////////////////////v/////////////////////////////////////////7/////
///////////////////////////////////v///////////////////////v///////////////////////
///v//////////////////////////////////////////v//////////7//////////3/////////////
//////////v//////3//////////v//////////v////////////////////////////3///////////3/
//////////v///////////////////////////////////9///////////////3///////////////////
///////v///////v//////////////////3//////////v/////////////////7///////////+/////
//////////9////////////v///////////////v/////////////9/////////////////////////
///////////////v//////////////////v/////////////////////////////////////////////7/
///9//////////v/////////////////3////////////3/////////////////////////////////
/////////////7/////+///////v///////////v///////////7////////////////////////v////
//v//////////////////////////////////////////v///////7/////////////7/////////////
///////////v///////////7//////////9/////////////////////////v////////////v///////
//////3//3////////////////////////3////////////v////////////////////////////////
////////7///////////////////////////////v///////7////////3////////v///////////9/
///////3//////////////////////////////////////////////////////////////3///////+//
///////v/////7/////////////9///////9///////v/////////////v//////////3///////////
/////////////7/////////////////////////////////////////////3/////v///////////////
//////////v//////////////////////7///////////3////v//////3///////7///////////////
//////////7///////////////////////////////////v///////////////v///////3///////////
///////////7/////////////v///////7//////////////////////3/////////////////////////
////////3///////////////////////7///////////////////////////////v//////////////7/
//7//////v//////////////7////////v//////3/////////////v//3/////////////9/////////
//////////3/////3///////////////////////////////7//////////////v////////////////
//////////////////3///////////////////v/////////////3//////////v////////////////
////////////9///////////////v///////v//////////////////////////3///////////////7/
////////////v/////////////v///////v////////v///////v///////3////////////////v////
//////////////////////////////////////7///////////////////v//////////////3////////
//////////////v///////v//////////////////////////////////7//////////////v/////////
/////////////////v//////////////v///////////////////////////////////////7////////
///////7////v///////7/////9//////////////////////////////////v/////////////v/////
/////////v//////////////////////////////v//3////////////3//v///////////////////v/
//////v///////////////////////////////////3////////////v////////v///////7/////////
//////////////7///////////////////3//////////v////////////////////////////////+///
//9///////////////////////////////////////v///////v////////////7///////3///////////
///v//////////7///////////////3//////////////////////////3////////////+//////////
//////////////3///////////////////////////////////3///v////////////3/////////////
///////v//////////v/////////v///////v/////////////////////////////v///////////////
/////////////3////////////////////////////////////v/////v///////9///////////////3/
///3//////////////////////7/////////3//3///////////////v///////v/////////////////
/////////////7///////////////////////7//////////////v///////////////v//////////3/
////////////////////////////////////////////////////7//////////v///////3/////////
///////9///////////v///////v////////v//////////////v///////v////////////3////////
///////////////////v////////////////////////////3///////////////////v/////////////
///////9//3/////////v////////////v///////7////////////7///////////////////////////
///////v////////////////////////////v//3////////////////////////v////////3////////
//9////////////////////////v///3////////////////////////////////////////////3///////
////////v////////////////////////////v//////////3///////////////////////3/////////
///////v////3//////////////////3///////////v///////////3//////////////////////////
///////////////v/////////////9////3//v////////////////////////////////////////v//
/////////////////9////v//////////9//////////////////////3/////////////////////////
////7//////////////////3////v//v/////////v///////3////////////v/////////////////v/
///////////////////7/////v///////9//////////////7/////////////////////////////v///
//////v////////9///////////////////////////7////////////v////////3///////////////
/////////v///////v/////7///////////////////////////////v///////////////7//////////
//7//////v/////////v/////7//////////////9/////////////v///////v////////3/////////
////3/////////////+//3////////////3//////////////////////////////////////////////
/////////////////////////////////////////////7//v///////7//////3///////////7///////
////////9/////////////9///////////////////3////////////v//////////3///////////////
////////////9/////7//////////v///////////v///////v//v////////v///////7///////9/////
////////////+//v///////v////////////////////////////v/////////////////9///////////
///////v////3////v/////7//v////3/////////////////v//////9////v///////////9///////
//7////v////3/////////////////////////////9//////v//v////////////////////////v/////
/////////////////+/////////////v//////////3////////////v//////////////////v////////
///////////////9/////v//9//////////////v/////v////v/////////////////////v/////////
///////3////7//////////9//////////v/////////////////////9////////////////////////
///////////////////3////////////////////////////v////////////////////////7///////////
//////////////v//////////////v///////7//////////////v//////////////v//////////////
//////////+////////////v////v///////////////////////7////////3////v////////+///////
//////v//v////////7/////9//////v////////////v//////////////7//////////////3////////
///////////v//////////////////////////////v////v//v///////////9////////////v///////
//////////v//////7//////////7///////////////////////////////3/////////////////////
//v///////+////v///////////////////////v////////////v////////7/////v////////////////
//7///////7////////////////////////7//////////////////////////v///////3////////////
/////////v///////////3//////////////v/////v//////////////////v////////////////////
/////v//////7////v//////v//9////////////v/////////v////v////////////////////////9/
//////////3//////7//////v////7/////////////v//////////////////////////////////v///
//////////3//v////9//////+////v/////////////7////v////////////7//////////////////
///////////////////////////////////7//////////7///////////////////////////////v///
///////+////////3//////////v//////////3///////v////v////////////////////////3///////
////////3////////////////////////////v///v////////9//////////////7////7////9///////
///7//v///////v/////////////////////////////////////v////////+///////v////////7///
///////////9///////3//3/////////////v///v////////////v////////9//////7////v////////
//////////////v//////////v///////v/////////////7//////////////v/////////3//////////
///////v/v///////v///////7////9////////////////////////v////////////v///////////+/
////////v///v//////////////v///////v//7////////////v////v/////7////////3////7//////
//////////////////////////////////v////v//////////////////7////////3///////////////
///////v//////7//v//////////////////////////////////v//v////////////3/////7////////
////3////////v//3///////3////v////v///////9///////////////////////////v///////////
//////////v//////////3////////////////v////////////7//////////3///////v/////////////
////3/////////////v////v////////3///////////v////7//////v////7///////v///////////7/
//////////v////////v//v/////3////v////////7///////////////////////////////////////
//////////7////v////3//////3//////v////v//////////////////3/////////////v//////////
////v//////////////////////v////v///////v//////9////v/////////////7//////////////
////////////v////////7///////7///////7//////////v////7///////v//v////7////////////
////////3////////7////////////////9///////7//////v////////////////7////////7///////
/3//////////7//v////3////7////v//////////////////9///v////v////3///////3////////////
////////////////////////v//////3////////v//////////v////v//v//////////////v////////
////////////////////v//v////7//////////////v/////3//v///////v///////7/////////////
//////////////v///////9////7////////////v//////////7//////////////////7//3//3//////
////3//////////v////v///////v///////v/////////////v//////9////////7////////////////
///////////////////////+////v//3//7///////9////7//v//7//////////3////7////////////
////////+////////3////v//////7////7//////////7//9//////////3///////v///////v/////3//
//v///////v///////7//v//7////3////3//3//7////v/////////////v////7//////////3///////
///////7///////3//3////9//////////7//v//////////3//////////////////v//////////////
///////v////v////v/////////////////////7////////////////v////9////v////7////////////
////v/////////9//////////v//v////9////////7////v//////v//v//////////3////////7///////
///////7//7//////////7////////////////////7////////v//7////v///v//////v////////////
////////////7//////////////v////////////////////////////3//////9////////////v///////
///////////3//////////7//7//////v//////////v//3////////3////v//////7////////////////
//v///////v///////9////////7////3//////9///////7//v////3///////////////////7////////
////////3////7//////////3////v////v////////////////////v//////////////////7////v////
//3////v//////////////9////v////v////7////v////////////7////////////v//////////v////
////////////+///////v////v//////v//v////v////////////3//////////////v////////7//////
/////////3////7//v////////////////////v//////9////3////////////////v////////3///////
////////v////3//////////////////v//////////3//////////v////////9////v////7//////////
//7//////////////v////v//////9//v//9////////////////////////////////////v////7//////
/3//////////3//////////9////9////3////v//v///////////////////////////////v////////
///////3////7////7///////7////////////////v//////////////////////v//////////////////
///////////v//3//////v/////v//////////v////////////7//v///////////7////v////////////
///3////////7////7//////////////v//7////9////////7//////////////////v////////3//////
///7////v////7///////7////////////////////////////////////7//////////7////////7////7//
//3///////3////v///////7//9///////////////////////3//////7////v////v//////////////
///////////////////////3//////////+////////////////v////////////////////3//v////////
////v//////////////v//////////////////////////7//v//////////3//////////////v////////
///////v////////v//////////////7////3////////v////v//////////////3////////////////
//9//v//////////////v//v//////7////v////3////////v///////9////7////////3////7///////
////////////+////////////////////////////7//3////////7////////////////v///////v////
//3////v//////////9//////9//////////////v////v////3////v////9//7////7///////3//v/////
//7//////////+////7////7////////7///////v//v////v////7////////////3//v////////7//////
//v////////////7//7////////+//v////////////////////////////v////////////////7////v//
//9////v////////////////3//////////v////////////////9//9////v////////7///////////7//
//3////7//v///////7////////////7//////v////////v//////7////////////////////7////////
////////////7///////v//////////////////9////v////////3///////3////v////v////v////7//
//7////v////v////v//9////3////////////////3//////////////7//7//////v////7////////////
//////////////+////////3//3////7////////////////////////////v///////v////v////////3/
////////v//////////////////7////////////////////////////////////v////3////v////7////
///////v////////v//v////v//7///////v////7///////+///////3///////v//////////+////3////
//3////v////////3//v//////////////////9////v//////////////3////v////7////////////////
////v////v////7////3////////7////////////3////////7//////3//+////////////////9//v////
////v////7//3////7//////////v//v//////////////////////////////v///////9////////v////
//////3////v////v////v//3//////////+////////////////7////v//////////9//9/////////////
//////v//v////v//////////3////////v////v///////7////////9////v////////////7//////////
//////////////v////v////9////3////7////7////v//7////v//////////9////7//9/////////////
//7////v////////v////7//3/////////////7//3////v////////////v////////7////////v///////
////////v////////////////7//7//////////3///////////////////////7//////9////7////////
////v////7//9////3//////////v////v//3////7////7//////////7////////3////7//v//////////
/////////v///////3//7////////7//v////3//3////3//////+////7////7////3////3//////////v//
////////7//////////7//v////v////v////v//////////////////////3//7//7///////7////////////
////7////v////7//v//7////v////9////7////3////v////////3////v////v////3//////////+////7//
//7////3//9////v////7////7////7////3////v////v////3////////////////////7////v//////////
////7////v////7////////9////+//3////////////7////3////v////9////7////////////3////7//3//
//3////7//////////9//v////7////7////7////3////v////7////////3////v////v//////7////7////
//////////////////7////7//3////3////7//9////v////v//v////v////v////7////7//////////3//
///////7////7////7////7////9////3////v////////7//v////7////3////9////7////v////7////3//
//7//v////3////7////v//v////7////v////7////7////3////v////7////3////////7////7////v////
//3////v////v////7////v////+////7////////////7////7////v////v////3////v////7//////7////
////v////7////3////7////7//v////7////7////7////3////3////v////7////v////+////7////9////
////3////7////7////7////3////v////v////3////v////v//7//////////7////9////3////v////7//
//7////7////3////v////v////3////+////3////7////7////7////7////////3////7////9////v////
//7////v////7////v////7////7////3////v////+////7////7////7////3////v////7////v////7////
////7////7////3////3////v//////////v////v////v////7////7////7////3////v////7//////////
////7////7////3////v////7////7////7////3////v////3////v////v////v////7////3////v////7//
//v////3////v////+////v////7////7////7////7////3////7////9////v////3////v////7////v////
//7////3////7////7////7////3////v////7////3////v////v////7////3////v////7////7//////////
//v////v////3////v////7////v////v////v////7////7////7////3////v////7////7////3////7////
//7////3////7////v////v////3////v////v////7////7////3////v////7////v//////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////+AA7OIsDAAA=
MAPSH_B64
}
[ -n "${ap_ip_address}" ] && {
    disable_wan
    {
        local SEC=network
        SET ${AP}=interface
        SET ${AP}.proto='static'
        SET ${AP}.device="${LAN}"
        SET ${AP}.ipaddr="${ap_ip_address}"
        SET ${AP}.netmask='255.255.255.0'
        SET ${AP}.gateway="${ap_gateway}"
        SET ${AP}.dns="${ap_gateway}"
        SET ${AP}.delegate='0'
        SET ${AP6}=interface
        SET ${AP6}.proto='dhcpv6'
        SET ${AP6}.device="@${AP}"
        SET ${AP6}.reqaddress='try'
        SET ${AP6}.reqprefix='no'
    }
    {
        local SEC=wireless
        for r in 0 1 2; do
            [ -n "$(uci -q get wireless.default_radio$r)" ] && SET default_radio$r.network="${AP}"
        done
    }
    [ -x /etc/init.d/odhcpd ] && /etc/init.d/odhcpd disable
    [ -x /etc/init.d/dnsmasq ] && /etc/init.d/dnsmasq disable
    uci -q delete firewall
    [ -x /etc/init.d/firewall ] && /etc/init.d/firewall disable
}
[ -n "${enable_ttyd}" ] && {
    local SEC=ttyd
    SET @ttyd[0].ipv6='1'
    SET @ttyd[0].command='/bin/login -f root'
}
[ -n "${enable_irqbalance}" ] && {
    local SEC=irqbalance
    SET irqbalance=irqbalance
    SET irqbalance.enabled='1'
}
[ -n "${enable_samba4}" ] && {
    local SEC=samba4
    SET @samba[0]=samba
    SET @samba[0].workgroup='WORKGROUP'
    SET @samba[0].charset='UTF-8'
    SET @samba[0].description='Samba on OpenWRT'
    SET @samba[0].enable_extra_tuning='1'
    SET @samba[0].interface='lan'
    SET sambashare=sambashare
    SET sambashare.name="${NAS}"
    SET sambashare.path="${MNT}"
    SET sambashare.read_only='no'
    SET sambashare.force_root='1'
    SET sambashare.guest_ok='yes'
    SET sambashare.inherit_owner='yes'
    SET sambashare.create_mask='0777'
    SET sambashare.dir_mask='0777'
}
[ -n "${enable_usb_rndis}" ] && {
    printf '%s\n%s\n' "rndis_host" "cdc_ether" > /etc/modules.d/99-usb-net
    local SEC=network
    ADDLIST @device[0].ports='usb0'
}
[ -n "${enable_usb_gadget}" ] && [ -d /boot ] && {
    echo 'dtoverlay=dwc2' >> /boot/config.txt
    sed -i 's/\(root=[^ ]*\)/\1 modules-load=dwc2,g_ether/' /boot/cmdline.txt
    printf '%s\n%s\n' "dwc2" "g_ether" > /etc/modules.d/99-gadget
    local SEC=network
    ADDLIST @device[0].ports='usb0'
}
[ -n "${enable_netopt}" ] && {
    C=/etc/sysctl.d/99-net-opt.conf
    P=$(grep -c ^processor /proc/cpuinfo)
    RMEM=${netopt_rmem:-}
    WMEM=${netopt_wmem:-}
    TR=${netopt_rmem:-}
    TW=${netopt_wmem:-}
    CT=${netopt_conntrack:-}
    NB=${netopt_backlog:-}
    SC=${netopt_somaxconn:-}
    CONG=${netopt_congestion:-cubic}
    if [ -z "$RMEM" ] || [ -z "$WMEM" ]; then
        if   [ $MEM -ge 2400 ]; then R=16777216 W=16777216 TR="4096 262144 16777216" TW=$TR CT=262144 NB=5000 SC=16384
        elif [ $MEM -ge 1200 ]; then R=8388608  W=8388608  TR="4096 131072 8388608"  TW=$TR CT=131072 NB=2500 SC=8192
        elif [ $MEM -ge  400 ]; then R=4194304  W=4194304  TR="4096 65536  4194304"  TW=$TR CT=65536  NB=1000 SC=4096
        fi
        [ $P -gt 4 ] && { NB=$((NB*2));   SC=$((SC*2)); }
        [ $P -gt 2 ] && [ $P -le 4 ] && { NB=$((NB*3/2)); SC=$((SC*3/2)); }
    else
        R=$(echo "$RMEM" | cut -d' ' -f3)
        W=$(echo "$WMEM" | cut -d' ' -f3)
    fi
    printf "net.core.rmem_max=%s\nnet.core.wmem_max=%s\nnet.ipv4.tcp_rmem=%s\nnet.ipv4.tcp_wmem=%s\nnet.ipv4.tcp_congestion_control=%s\nnet.ipv4.tcp_fastopen=3\nnet.netfilter.nf_conntrack_max=%s\nnet.core.netdev_max_backlog=%s\nnet.core.somaxconn=%s\n" \
    "$R" "$W" "$TR" "$TW" "$CONG" "$CT" "$NB" "$SC" > "$C"
    sysctl -p "$C"
}
[ -n "${enable_dnsmasq}" ] && {
    local SEC=dhcp
    CACHE_SIZE="${dnsmasq_cache:-}"
    NEG_CACHE="${dnsmasq_negcache:-1}"
    if [ -z "$CACHE_SIZE" ]; then
        if   [ "$MEM" -ge 800 ]; then CACHE_SIZE=10000
        elif [ "$MEM" -ge 400 ]; then CACHE_SIZE=5000
        elif [ "$MEM" -ge 200 ]; then CACHE_SIZE=1000
        fi
    fi
    SET @dnsmasq[0].cachesize="${CACHE_SIZE}"
    SET @dnsmasq[0].nonegcache="${NEG_CACHE}"
}
# BEGIN_CMDS
# END_CMDS
uci commit 2>/dev/null
[ -n "${backup_path}" ] && sysupgrade -q -k -b "${backup_path}"
echo "All done!"
exit 0
