<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt setup.sh デバッグツール</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .content {
            padding: 30px;
        }
        .section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .result-item {
            background: white;
            border-left: 4px solid #ddd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        .result-item strong {
            display: block;
            margin-bottom: 5px;
        }
        .result-item .line {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat.errors .stat-number { color: #f44336; }
        .stat.warnings .stat-number { color: #ff9800; }
        .stat.success .stat-number { color: #4caf50; }
        .stat.info .stat-number { color: #2196f3; }
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 OpenWrt setup.sh デバッグツール</h1>
            <p>自動分析中...</p>
        </div>

        <div class="content">
            <div class="stats">
                <div class="stat errors">
                    <div class="stat-label">エラー</div>
                    <div class="stat-number" id="statErrors">0</div>
                </div>
                <div class="stat warnings">
                    <div class="stat-label">警告</div>
                    <div class="stat-number" id="statWarnings">0</div>
                </div>
                <div class="stat info">
                    <div class="stat-label">情報</div>
                    <div class="stat-number" id="statInfo">0</div>
                </div>
                <div class="stat success">
                    <div class="stat-label">成功</div>
                    <div class="stat-number" id="statSuccess">0</div>
                </div>
            </div>

            <div class="section">
                <h2>🔍 分析結果</h2>
                <div id="resultContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        setup.sh を読み込んで分析中...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let errors = 0, warnings = 0, infos = 0, successes = 0;
        const results = [];

        function addResult(type, message, lineNum = null, content = null) {
            if (type === 'error') errors++;
            else if (type === 'warning') warnings++;
            else if (type === 'info') infos++;
            else if (type === 'success') successes++;
            
            results.push({ type, message, lineNum, content });
            updateStats();
        }

        function updateStats() {
            document.getElementById('statErrors').textContent = errors;
            document.getElementById('statWarnings').textContent = warnings;
            document.getElementById('statInfo').textContent = infos;
            document.getElementById('statSuccess').textContent = successes;
        }

        function analyzeScript(content) {
            results.length = 0;
            errors = warnings = infos = successes = 0;

            const lines = content.split('\n');
            
            // 括弧チェック
            let ifCount = 0, fiCount = 0, forCount = 0, doneCount = 0;
            let openBrace = 0, closeBrace = 0;
            let openParen = 0, closeParen = 0;

            lines.forEach((line, idx) => {
                const lineNum = idx + 1;
                
                ifCount += (line.match(/\bif\s/g) || []).length;
                fiCount += (line.match(/\bfi\b/g) || []).length;
                forCount += (line.match(/\bfor\s/g) || []).length;
                doneCount += (line.match(/\bdone\b/g) || []).length;
                openBrace += (line.match(/{/g) || []).length;
                closeBrace += (line.match(/}/g) || []).length;
                openParen += (line.match(/\(/g) || []).length;
                closeParen += (line.match(/\)/g) || []).length;

                // SET関数チェック
                if (line.includes('SET ') && !line.trim().startsWith('#')) {
                    const opens = (line.match(/{/g) || []).length;
                    const closes = (line.match(/}/g) || []).length;
                    if (opens !== closes) {
                        addResult('warning', 'SET関数の括弧が対応していません', lineNum, line.trim());
                    }
                }

                // 長い行チェック
                if (line.length > 200) {
                    addResult('info', `長い行です (${line.length}文字)`, lineNum, line.substring(0, 80) + '...');
                }

                // SEDコマンドの引用符チェック
                if (line.includes('sed -i')) {
                    const hasQuotes = /sed -i ['"][^'"]*['"]/.test(line);
                    if (!hasQuotes) {
                        addResult('warning', 'sedコマンドの引用符が疑わしいです', lineNum, line.trim());
                    }
                }

                // ローカル変数チェック
                if (line.includes('local SEC=')) {
                    let found = false;
                    for (let i = idx + 1; i < Math.min(idx + 50, lines.length); i++) {
                        if (lines[i].includes('SET') || lines[i].includes('DEL') || lines[i].includes('ADDLIST')) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        addResult('warning', 'SEC設定後に使用がありません', lineNum, line.trim());
                    }
                }
            });

            // チェック結果まとめ
            if (ifCount === fiCount) {
                addResult('success', `条件分岐 if/fi: ${ifCount}個のペア`);
            } else {
                addResult('error', `条件分岐が対応していません: if=${ifCount}, fi=${fiCount}`);
            }

            if (forCount === doneCount) {
                addResult('success', `ループ for/done: ${forCount}個のペア`);
            } else {
                addResult('error', `ループが対応していません: for=${forCount}, done=${doneCount}`);
            }

            if (openBrace === closeBrace) {
                addResult('success', `波括弧 {}: ${openBrace}個のペア`);
            } else {
                addResult('error', `波括弧が対応していません: {=${openBrace}, }=${closeBrace}`);
            }

            if (openParen === closeParen) {
                addResult('success', `括弧 (): ${openParen}個のペア`);
            } else {
                addResult('error', `括弧が対応していません: (=${openParen}, )=${closeParen}`);
            }

            addResult('info', `総行数: ${lines.length}`);

            displayResults();
        }

        function displayResults() {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="loading">結果がありません</div>';
                return;
            }

            results.forEach(r => {
                const div = document.createElement('div');
                div.className = `result-item ${r.type}`;
                
                let html = `<strong>${r.message}</strong>`;
                if (r.lineNum) html += `<div class="line">行 ${r.lineNum}</div>`;
                if (r.content) html += `<div class="line"><code>${escapeHtml(r.content)}</code></div>`;
                
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // setup.sh を読み込む
        fetch('setup.sh')
            .then(response => response.text())
            .then(content => {
                analyzeScript(content);
            })
            .catch(error => {
                document.getElementById('resultContainer').innerHTML = 
                    `<div class="result-item error"><strong>エラー: setup.sh が見つかりません</strong><div class="line">同じディレクトリに setup.sh を配置してください</div></div>`;
            });
    </script>
</body>
</html>
