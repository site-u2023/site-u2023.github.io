<!DOCTYPE html>
<html>
<head>
    <title>ASU uci-defaults Test</title>
</head>
<body>
    <h2>ASU uci-defaults Test</h2>
    
    <label>Profile:</label><br>
    <input type="text" id="profile" value="asus_rt-ax53u"><br><br>
    
    <label>Target:</label><br>
    <input type="text" id="target" value="ramips/mt7621"><br><br>
    
    <label>Version:</label><br>
    <input type="text" id="version" value="24.10.2"><br><br>
    
    <h3>テスト実行結果</h3>
    <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; margin-bottom: 20px;">
        <tr style="background-color: #f0f0f0;">
            <th>Version</th>
            <th>Request Hash</th>
            <th>Build Date</th>
            <th>Kernel</th>
            <th>Status</th>
            <th>実行内容</th>
        </tr>
        <tr>
            <td>24.10.1</td>
            <td>93bdd6d4...</td>
            <td>2025-04-13 16:38:32</td>
            <td>6.6.86</td>
            <td>✅ 成功</td>
            <td rowspan="3">heredoc動的スクリプト生成テスト<br>
                ・/tmp/test1.sh 生成・実行<br>
                ・/tmp/test2.sh 生成・実行<br>
                ・/tmp/asu-test.log に結果記録</td>
        </tr>
        <tr>
            <td>24.10.2</td>
            <td>fdba15e3...</td>
            <td>2025-06-23 20:40:36</td>
            <td>6.6.93</td>
            <td>✅ 成功</td>
        </tr>
        <tr>
            <td>24.10.2</td>
            <td>fdba15e3...</td>
            <td>2025-06-23 20:40:36</td>
            <td>6.6.93</td>
            <td>✅ 成功 (再実行)</td>
        </tr>
    </table>
    
    <p><strong>判明事実:</strong></p>
    <ul>
        <li>ASUサーバーは20KBまでのuci-defaultsを正常に受付</li>
        <li>heredoc記法による動的スクリプト生成が動作確認済み</li>
        <li><code>FILES=/srv/store/.../files</code>でファイル展開処理</li>
        <li>異なるバージョンでも同一ハッシュで結果をキャッシュ</li>
    </ul>
    
    <label>uci-defaults content:</label><br>
    <textarea id="defaults" rows="15" cols="80">#!/bin/sh

# Test script 1
echo "# Generated script 1" > /tmp/test1.sh
cat > /tmp/test1.sh << 'EOF'
#!/bin/sh
echo "Script 1 executed" >> /tmp/asu-test.log
EOF
chmod +x /tmp/test1.sh

# Test script 2  
echo "# Generated script 2" > /tmp/test2.sh
cat > /tmp/test2.sh << 'EOF'
#!/bin/sh
echo "Script 2 executed" >> /tmp/asu-test.log
EOF
chmod +x /tmp/test2.sh

# Execute both
/tmp/test1.sh
/tmp/test2.sh

echo "ASU test completed at $(date)" >> /tmp/asu-test.log
</textarea><br><br>
    
    <button onclick="testAsu()">Send to ASU</button>
    <button onclick="checkStatus()">Check Status</button><br><br>
    
    <label>Request Hash:</label><br>
    <input type="text" id="requestHash" value="fdba15e3ee7ba7b262b2026795bf1eb859dc9986aa40e076c523b045db6d2176" style="width: 500px;"><br><br>
    
    <div id="result"></div>

    <script>
    function checkStatus() {
        const hash = document.getElementById('requestHash').value;
        const resultDiv = document.getElementById('result');
        
        if (!hash) {
            alert('Request hash is required');
            return;
        }
        
        resultDiv.innerHTML = '<p>Checking status...</p>';
        
        fetch(`https://sysupgrade.openwrt.org/api/v1/build/${hash}`, {
            method: 'GET'
        })
        .then(response => {
            resultDiv.innerHTML += `<p>Status: ${response.status}</p>`;
            return response.json();
        })
        .then(data => {
            resultDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            if (data.status === 200 && data.bin_dir) {
                resultDiv.innerHTML += `<p><strong>Build completed!</strong></p>`;
                resultDiv.innerHTML += `<p>Binary directory: ${data.bin_dir}</p>`;
                resultDiv.innerHTML += `<p><a href="https://sysupgrade.openwrt.org/store/${data.bin_dir}" target="_blank">View build artifacts</a></p>`;
            } else if (data.imagebuilder_status) {
                resultDiv.innerHTML += `<p>Status: ${data.imagebuilder_status}</p>`;
                setTimeout(checkStatus, 10000); // Auto-retry in 10 seconds
            }
        })
        .catch(error => {
            resultDiv.innerHTML += `<p>Error: ${error.message}</p>`;
        });
    }
    
    function testAsu() {
        const profile = document.getElementById('profile').value;
        const target = document.getElementById('target').value;
        const version = document.getElementById('version').value;
        const defaults = document.getElementById('defaults').value;
        const resultDiv = document.getElementById('result');
        
        if (!profile || !target) {
            alert('Profile and Target are required');
            return;
        }
        
        const body = JSON.stringify({
            profile: profile,
            target: target,
            version: version,
            packages: ['luci'],
            defaults: defaults,
            client: "test/1.0"
        });
        
        resultDiv.innerHTML = '<p>Sending request...</p>';
        
        fetch('https://sysupgrade.openwrt.org/api/v1/build', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: body
        })
        .then(response => {
            resultDiv.innerHTML += `<p>Status: ${response.status}</p>`;
            return response.json();
        })
        .then(data => {
            resultDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            if (data.request_hash) {
                resultDiv.innerHTML += `<p>Request hash: ${data.request_hash}</p>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML += `<p>Error: ${error.message}</p>`;
        });
    }
    </script>
</body>
</html>
