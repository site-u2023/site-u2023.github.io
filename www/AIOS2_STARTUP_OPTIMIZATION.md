# aios2 起動速度最適化レポート

## 概要

OpenWrt用デバイスセットアップツール「aios2」の起動処理を並列化により最適化し、UI選択画面の即時表示を実現することで、ユーザー体感速度を大幅に改善しました。

---

## 最適化手法

### 修正前の設計
必須ファイル（API応答、setup.json、postinst.json）のダウンロード完了を待機してからUI選択画面を表示していました。ユーザーは2秒から5秒程度の待機時間を経験する必要がありました。

### 修正後の設計
config.jsのダウンロードとパース完了直後に全てのファイルのバックグラウンドダウンロードを開始し、その直後にUI選択画面を表示します。ユーザーがUIモードを選択している間も、バックグラウンドで並列ダウンロードが継続されます。

---

## パフォーマンス比較

### テスト環境1: Banana Pi BPI-R4（高性能デバイス、MAP-E接続）

| 計測項目 | 修正前 | 修正後 | 改善効果 |
|:---------|-------:|-------:|:---------|
| UI表示までの時間 | 4.990秒 | 1.050秒 | **3.940秒短縮（78.9%改善）** |
| 全自動処理時間（総計） | 4.990秒 | 1.530秒 | **3.460秒短縮（69.3%改善）** |

※全自動処理時間は、UI表示後のバックグラウンド処理完了までを含む総時間です。

### テスト環境2: Sony NCP-HG100（旧世代デバイス、PPPoE接続）

| 計測項目 | 修正前 | 修正後 | 改善効果 |
|:---------|-------:|-------:|:---------|
| UI表示までの時間 | 2.350秒 | 0.690秒 | **1.660秒短縮（70.6%改善）** |
| 全自動処理時間（総計） | 2.370秒 | 1.460秒 | **0.910秒短縮（38.4%改善）** |

※全自動処理時間は、UI表示後のバックグラウンド処理完了までを含む総時間です。

---

## 処理フロー比較

### 修正前
```
起動 → config.jsダウンロード → 並列ダウンロード開始
  ↓
必須ファイル完了待機 ← [2～5秒の待機時間]
  ↓
UI選択画面表示 ← ユーザーはここで初めて操作可能
  ↓
ユーザーがモード選択 → 残りのファイル完了待機 → 処理完了
```

### 修正後
```
起動 → config.jsダウンロード → 並列ダウンロード開始（BG実行）
  ↓
UI選択画面表示 ← [約1秒で到達、待機時間ほぼゼロ]
  ↓
ユーザーがモード選択 ← この間もBGでダウンロード継続
  ↓
必須ファイル完了確認 ← 通常は既に完了済み
  ↓
残りのファイル完了待機 → 処理完了
```

---

## 技術的詳細

この最適化では、約15個のファイルを並列ダウンロードしつつ、ユーザーインタラクションのタイミングを最適化しています。各HTTPSリクエストは独立したバックグラウンドプロセスとして実行され、プロセスIDを保持することで必要なタイミングでの完了確認を可能としています。低速なネットワーク環境において、ユーザーの選択がバックグラウンドダウンロードより早く完了した場合でも、待機処理により処理の整合性が確保されます。

---

## 結論

並列ダウンロードとUI表示タイミングの最適化により、ユーザー体感速度が劇的に改善されました。高性能デバイスでは約4秒、旧世代デバイスでは約1.7秒のUI表示時間短縮を達成しています。ユーザーはほぼ待機時間なく即座にセットアップ作業を開始できるようになりました。
