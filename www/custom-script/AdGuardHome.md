# AdGuard Home インストールスクリプト - 技術仕様書

## 書式
```
adguardhome.sh [-c] [-n] [-r <mode>] [-i <source>]
```

## オプション

**-c**

システムリソースチェックを無効化し、最小要件（RAM 20MB、Flash 25MB）を満たさない環境でも強制的にインストールを実行する。

**-n**

YAML設定ファイルの自動生成を無効化する。このオプションを指定した場合、初回起動後にWebインターフェース経由で手動設定を行う必要がある。環境変数`NO_YAML=1`と同等の機能を提供する。

**-r** *mode*

削除モードを指定する。*mode*には以下の値を指定可能。

- **auto** - 確認プロンプトなしで自動削除を実行
- **manual** - 対話的な確認を経て削除を実行

**-i** *source*

インストールソースを指定する。*source*には以下の値を指定可能。

- **openwrt** - OpenWrtリポジトリパッケージからインストール
- **official** - GitHub公式リリースバイナリからインストール

オプションの指定順序は任意である。

## 環境変数

**INSTALL_MODE**

インストールソースを指定する。設定可能な値は`openwrt`または`official`である。この変数が設定されている場合、対話的なインストールソース選択プロンプトは表示されない。コマンドラインオプション`-i`と同じ機能を持つが、コマンドラインオプションが優先される。

**NO_YAML**

YAML設定ファイルの自動生成を制御する。値として`1`を設定した場合、YAML生成が無効化される。未設定または`1`以外の値の場合は自動的にYAMLファイルが生成される。コマンドラインオプション`-n`と同等の機能を提供する。

**REMOVE_MODE**

削除モードを指定する。設定可能な値は`auto`または`manual`である。コマンドラインオプション`-r`が優先される。

**AGH_USER**

AdGuard Home管理画面の管理者ユーザー名を指定する。デフォルト値は`admin`である。この変数は`NO_YAML`が設定されていない場合のみ有効である。

**AGH_PASS**

AdGuard Home管理画面の管理者パスワードを指定する。デフォルト値は`password`であるが、最小8文字の制約がある。この変数は`NO_YAML`が設定されていない場合のみ有効である。パスワードはhtpasswdコマンドによりbcryptハッシュ化されてYAMLファイルに保存される。

**WEB_PORT**

Webインターフェースのポート番号を指定する。デフォルト値は`8000`である。この変数は`NO_YAML`が設定されていない場合のみ有効である。

**DNS_PORT**

DNSサービスのポート番号を指定する。デフォルト値は`53`である。この変数は`NO_YAML`が設定されていない場合のみ有効である。

**DNS_BACKUP_PORT**

バックアップdnsmasqサービスのポート番号を指定する。デフォルト値は`54`である。AdGuard Homeが主DNSサーバーとして動作し、ローカルドメイン解決のためdnsmasqがこのポートで待機する。この変数は`NO_YAML`が設定されていない場合のみ有効である。

**LAN_ADDR**

LANインターフェースのIPv4アドレスを指定する。未設定の場合はubusコマンドにより自動検出される。この変数は`NO_YAML`が設定されていない場合のみ有効である。

**SCRIPT_BASE_URL**

YAML設定テンプレートファイルのダウンロード元URLを指定する。デフォルト値は`https://site-u.pages.dev/www/custom-script`である。カスタムテンプレートを使用する場合にこの変数を変更する。

**SKIP_RESOURCE_CHECK**

リソースチェックの無効化を制御する内部変数である。この変数はコマンドラインオプション`-c`により自動的に設定されるため、通常は手動で設定する必要はない。

## 非対話モード実行

本スクリプトは環境変数による完全な非対話モード実行に対応している。必要な環境変数を全て指定することで、対話的なプロンプトを一切表示せずに自動インストールを実行できる。非対話モードは自動化スクリプトやCI/CD環境での使用に適している。

YAML自動生成を伴う完全非対話モード実行では、`AGH_USER`、`AGH_PASS`、`WEB_PORT`、`DNS_PORT`の4つの環境変数を指定する必要がある。これらの変数が設定されている場合、対話的な認証情報入力は実行されず、指定された値またはデフォルト値が使用される。

本番環境では`AGH_PASS`環境変数により強力なパスワードを指定することを推奨する。デフォルト値`password`の使用はセキュリティリスクとなる。

## システム要件

本スクリプトは以下の動作検証基準を設定している。
```
MINIMUM_MEM="20"
MINIMUM_FLASH="25"
RECOMMENDED_MEM="50"
RECOMMENDED_FLASH="100"
```

スクリプト実行時にこれらの値を下回った場合、エラーメッセージを表示して終了する。コマンドラインオプション`-c`または環境変数`SKIP_RESOURCE_CHECK=1`により、このチェックを無効化して強制的にインストールを実行できる。

なお、これらの数値はAdGuard Home公式の要件ではなく、OpenWrt環境における安定動作を想定した本スクリプト独自の基準である。

## パッケージマネージャー検出

スクリプトは実行時に自動的にパッケージマネージャーを検出する。opkgコマンドが利用可能な場合はopkgを使用し、apkコマンドが利用可能な場合はapkを使用する。いずれも利用できない場合はエラーとなり実行を中断する。

## 使用例

標準的な対話型インストールを実行する場合は以下のように実行する。
```
sh adguardhome.sh
```

インストールソースの選択プロンプトが表示され、管理者認証情報の入力が求められる。YAML設定ファイルは自動生成される。

公式バイナリからの非対話型インストールを実行する場合は以下のように実行する。
```
INSTALL_MODE=official AGH_USER=admin AGH_PASS=securepass123 sh adguardhome.sh
```

対話的なプロンプトなしで公式バイナリからインストールされ、指定された認証情報でYAML設定ファイルが自動生成される。

Web手動設定モードでインストールを実行する場合は以下のように実行する。
```
sh adguardhome.sh -i official -n
```

YAML設定ファイルは生成されず、初回起動後にWebインターフェース経由で設定を行う必要がある。

カスタム設定で非対話型インストールを実行する場合は以下のように実行する。
```
AGH_USER=myadmin AGH_PASS=securepass123 WEB_PORT=3000 DNS_PORT=53 sh adguardhome.sh -i openwrt
```

指定された管理者情報とポート番号でYAML設定ファイルが生成され、OpenWrtリポジトリパッケージからインストールされる。

リソースチェックを無効化して強制インストールを実行する場合は以下のように実行する。
```
sh adguardhome.sh -i official -c
```

システムリソースが最小要件を満たさない場合でも強制的にインストールが実行される。

非対話的に自動削除を実行する場合は以下のように実行する。
```
sh adguardhome.sh -r auto
```

確認プロンプトなしでAdGuard Homeが削除され、設定ファイルのバックアップから復元される。

環境変数とコマンドラインオプションを組み合わせて実行する場合は以下のように実行する。
```
AGH_USER=admin AGH_PASS=mypassword sh adguardhome.sh -i official -c -n
```

環境変数で認証情報を指定しつつ、コマンドラインオプションでインストールソース、リソースチェック無効化、YAML生成無効化を制御する。オプションの指定順序は任意である。
