# AdGuard Home インストールスクリプト - 技術仕様書

## 構文
```
adguardhome.sh [-c] [-r <mode>] [-i <source>]
```

## コマンドラインオプション

### -c

システムリソースチェックを無効化します。通常モードでは最小50MBのRAMおよび100MBのフラッシュストレージが要求されますが、このオプションを指定することで要件を満たさない環境でも強制的にインストールを実行します。

### -r <mode>

削除モードを指定します。引数として`auto`または`manual`を受け付けます。`auto`を指定した場合は確認プロンプトなしで自動的に削除を実行します。`manual`を指定した場合は対話的な確認を経て削除を実行します。引数を省略した場合はエラーとなります。

### -i <source>

インストールソースを指定します。引数として`openwrt`または`official`を受け付けます。`openwrt`を指定した場合はOpenWrtリポジトリパッケージからインストールします。`official`を指定した場合はAdGuard HomeのGitHub公式リリースからバイナリをダウンロードしてインストールします。引数を省略した場合はエラーとなります。

## 環境変数

### INSTALL_MODE

インストールソースを指定します。設定可能な値は`openwrt`または`official`です。この変数が設定されている場合、対話的なインストールソース選択プロンプトは表示されません。コマンドラインオプション`-i`と同じ機能を持ちますが、環境変数の方が優先度は低くなります。

### NO_YAML

YAML設定ファイルの自動生成を制御します。値として`1`を設定した場合、YAML設定ファイルは生成されずWebインターフェース経由での手動セットアップが必要となります。未設定または`1`以外の値の場合は自動的にYAML設定ファイルが生成されます。

### REMOVE_MODE

削除モードを指定します。設定可能な値は`auto`または`manual`です。この変数が設定されている場合、コマンドラインオプション`-r`を指定したのと同じ動作となります。コマンドラインオプションの方が優先度は高くなります。

### AGH_USER

AdGuard Home管理画面の管理者ユーザー名を指定します。デフォルト値は`admin`です。この変数は`NO_YAML`が設定されていない場合のみ有効です。

### AGH_PASS

AdGuard Home管理画面の管理者パスワードを指定します。デフォルト値は`password`ですが、最小8文字の制約があります。この変数は`NO_YAML`が設定されていない場合のみ有効です。パスワードはhtpasswdコマンドによりbcryptハッシュ化されてYAMLファイルに保存されます。

### WEB_PORT

AdGuard Home Webインターフェースのポート番号を指定します。デフォルト値は`8000`です。この変数は`NO_YAML`が設定されていない場合のみ有効です。

### DNS_PORT

AdGuard Home DNSサービスのポート番号を指定します。デフォルト値は`53`です。この変数は`NO_YAML`が設定されていない場合のみ有効です。

### DNS_BACKUP_PORT

バックアップdnsmasqサービスのポート番号を指定します。デフォルト値は`54`です。AdGuard Homeが主DNSサーバーとして動作し、ローカルドメイン解決のためdnsmasqがこのポートで待機します。この変数は`NO_YAML`が設定されていない場合のみ有効です。

### LAN_ADDR

LANインターフェースのIPv4アドレスを指定します。未設定の場合はubusコマンドにより自動検出されます。この変数は`NO_YAML`が設定されていない場合のみ有効です。

### SCRIPT_BASE_URL

YAML設定テンプレートファイルのダウンロード元URLを指定します。デフォルト値は`https://site-u.pages.dev/www/custom-script`です。カスタムテンプレートを使用する場合にこの変数を変更します。

### SKIP_RESOURCE_CHECK

リソースチェックの無効化を制御します。この変数はコマンドラインオプション`-c`により自動的に設定される内部変数であり、通常は手動で設定する必要はありません。

## システム要件

インストールには最小20MBのRAMおよび25MBのフラッシュストレージが必要です。推奨値は50MBのRAMおよび100MBのフラッシュストレージです。これらの要件はコマンドラインオプション`-c`または環境変数`SKIP_RESOURCE_CHECK=1`により無効化できます。

## パッケージマネージャー検出

スクリプトは実行時に自動的にパッケージマネージャーを検出します。opkgコマンドが利用可能な場合はopkgを使用し、apkコマンドが利用可能な場合はapkを使用します。いずれも利用できない場合はエラーとなり実行を中断します。

## 実行例

### 標準的な対話型インストール
```
sh adguardhome.sh
```

インストールソースの選択プロンプトが表示され、YAML設定ファイルが自動生成されます。管理者ユーザー名とパスワードの入力が求められます。

### 公式バイナリからの自動インストール
```
INSTALL_MODE=official sh adguardhome.sh
```

対話的なプロンプトなしで公式バイナリからインストールされます。YAML設定ファイルは自動生成されます。

### Web手動設定モードでのインストール
```
NO_YAML=1 sh adguardhome.sh
```

YAML設定ファイルは生成されず、初回起動後にWebインターフェース経由で設定を行う必要があります。

### カスタム設定でのインストール
```
AGH_USER=myadmin AGH_PASS=securepass123 WEB_PORT=3000 sh adguardhome.sh
```

指定された管理者情報とポート番号でYAML設定ファイルが生成されます。

### リソースチェック無効化での強制インストール
```
sh adguardhome.sh -c
```

システムリソースが最小要件を満たさない場合でも強制的にインストールを実行します。

### 非対話的な自動削除
```
sh adguardhome.sh -r auto
```

確認プロンプトなしでAdGuard Homeを削除し、設定ファイルのバックアップから復元します。

### OpenWrtパッケージからの削除
```
INSTALL_MODE=openwrt sh adguardhome.sh -r manual
```

対話的な確認を経てOpenWrtリポジトリパッケージ版のAdGuard Homeを削除します。
