# AdGuard Home 自動インストールスクリプト for OpenWrt

※本ドキュメントはAIを活用して記述されています。記述に不明瞭な点や誤記がある可能性がありますので、ご了承ください。問題を発見された場合は、GitHubのIssuesでご報告いただけると幸いです。

OpenWrtルーターにAdGuard Homeを自動的にインストール・設定するための包括的なシェルスクリプトです。公式ドキュメントの基本的な手順を大幅に拡張し、実用的な運用環境を考慮した堅牢な実装を提供します。

## 主要な特徴

本スクリプトは、OpenWrt公式ドキュメントに記載されている基本的なAdGuard Homeのインストール手順を基に、プロダクション環境での実用性を大幅に向上させた実装となっています。システム要件の事前検証、自動的なパッケージマネージャー検出、包括的なエラーハンドリング、設定ファイルのバックアップと復元機能など、運用上の安全性と信頼性を重視した設計を採用しています。

特筆すべき点として、日本国内の主要ISPで採用されているMAP-EやDS-LiteなどのIPv4 over IPv6トンネリング技術に対応しています。これらの環境では、IPv6アドレスの適切な処理とDHCPv6によるDNSサーバー情報の配布が必須となりますが、本スクリプトはこれらの要件を自動的に満たす設定を行います。デュアルスタック環境、IPv4のみの環境、IPv6のみの環境のいずれにおいても、適切なアドレスファミリーを検出し、最適なファイアウォールルールとDHCP設定を自動生成します。

インストール方法として、OpenWrtパッケージリポジトリからのインストールと、GitHubから最新の公式バイナリを直接ダウンロードするインストールの両方に対応しています。設定方法についても、YAML設定ファイルを自動生成して管理者アカウントを事前設定する方法と、インストールのみを行いWebインターフェースから手動で初期設定を行う方法の両方を選択できます。これにより、ユーザーの技術レベルや運用ポリシーに応じた柔軟な導入が可能となっています。

## 対応環境

本スクリプトは、OpenWrt 19.07以降のすべてのバージョンに対応しています。パッケージマネージャーとして、従来のリリース版で使用されるopkgと、SNAPSHOT版で採用されているapk（24.x系以降）の両方を自動検出してサポートします。

対応アーキテクチャとして、ARM系（armv5、armv6、armv7、arm64）、x86系（32bit、64bit）、MIPS系（mipsle、mips64le）など、OpenWrtがサポートする主要なプロセッサアーキテクチャに対応しています。スクリプトは実行環境のアーキテクチャを自動判別し、適切なバイナリを選択してインストールを実行します。

ネットワーク環境については、IPv4のみ、IPv6のみ、デュアルスタック構成のいずれにも対応しています。特に日本国内で広く採用されているMAP-E、DS-Lite、transixなどのIPv4 over IPv6トンネリング技術を使用する環境において、適切なDNS設定とファイアウォールルールを自動構成します。

## インストールモード

本スクリプトは、4つの設定軸を組み合わせることで、合計16種類の異なるインストールモードをサポートしています。

第一の軸はパッケージマネージャーです。OpenWrtのバージョンに応じて、opkgまたはapkが自動的に検出されます。opkgは従来のリリース版で使用され、apkは最新のSNAPSHOT版（24.x系以降）で採用されています。スクリプトはシステムで利用可能なパッケージマネージャーを自動判別するため、ユーザーが意識する必要はありません。

第二の軸はパッケージソースです。OpenWrtパッケージを選択した場合、システムのパッケージリポジトリに登録されているAdGuard Homeがインストールされます。この方法は、システムのパッケージ管理と統合されるため、将来的なアップデート管理が容易です。一方、公式バイナリを選択した場合、GitHubのリリースページから最新版のバイナリを直接ダウンロードしてインストールします。この方法は、パッケージリポジトリに登録される前の最新機能をいち早く利用できる利点があります。

第三の軸は設定方法です。YAML自動セットアップを選択した場合、スクリプトは対話的に管理者のユーザー名とパスワードを入力させ、htpasswdツールを使用してbcrypt形式の安全なパスワードハッシュを生成します。その後、リモートサーバーから設定テンプレートをダウンロードし、入力された認証情報やポート番号などのパラメータを埋め込んだAdGuardHome.yamlファイルを作成します。この方法により、インストール完了後すぐにWebインターフェースにログインして使用を開始できます。一方、手動セットアップモード（環境変数NO_YAML=1で有効化）を選択した場合、これらの処理はすべてスキップされ、AdGuard Homeのインストールのみが実行されます。初期設定はWebインターフェースから手動で行う必要がありますが、htpasswdなどの依存パッケージのインストールが不要となり、より軽量な導入が可能です。

第四の軸は実行コンテキストです。スタンドアロンモードでは、スクリプトを単独で実行すると対話的なプロンプトが表示され、ユーザーの選択に基づいてインストールが進行します。完了後は自動的にシステムの再起動を促します。一方、統合モードでは、別のスクリプトやオーケストレーションツールから呼び出されることを想定し、環境変数を通じてすべての設定を事前に渡すことで、完全に無人でのインストールを実現します。

これら4つの軸の組み合わせにより、opkg環境でのOpenWrtパッケージ版のYAML自動セットアップをスタンドアロンで実行する場合から、apk環境での公式バイナリ版の手動セットアップを統合モードで実行する場合まで、16種類すべての組み合わせに対応しています。

## システム要件

本スクリプトを実行するには、最低50MBの空きメモリと100MBの空きストレージ容量が必要です。スクリプトは実行開始時にこれらの要件を自動的にチェックし、条件を満たさない場合は処理を中断します。これにより、リソース不足による不完全なインストールや、システムの不安定化を防止します。

ネットワーク接続については、パッケージリポジトリへのアクセス、GitHubからのバイナリダウンロード、YAML設定テンプレートの取得など、複数の外部リソースへの接続が必要となります。スクリプトはHTTPS接続を優先しますが、証明書検証に失敗した場合は自動的に証明書検証をスキップする設定でリトライを試みます。

YAML自動セットアップモードを使用する場合、bcryptパスワードハッシュを生成するためのhtpasswdツールが必要となります。OpenWrtにはhtpasswdの単体パッケージが存在しないため、本スクリプトではApache関連パッケージを一時的にインストールし、htpasswdバイナリのみを抽出した後、Apacheを即座にアンインストールします。この処理は完全に自動化されており、Apacheサービスが実際に起動することはありません。手動セットアップモードを使用する場合、これらの処理は不要です。

## 使用方法

最も基本的な使用方法は、スクリプトファイルをルーターにダウンロードし、シェルコマンドで実行することです。
```sh
wget https://raw.githubusercontent.com/site-u2023/site-u2023.github.io/refs/heads/main/www/custom-script/adguardhome.sh
sh adguardhome.sh
```

この方法では、対話的なプロンプトが表示され、OpenWrtパッケージ版と公式バイナリ版のどちらをインストールするかを選択できます。その後、管理者のユーザー名とパスワードの入力を求められ、YAML設定ファイルが自動生成されます。すべての処理が完了すると、Webインターフェースへのアクセス情報とQRコードが表示され、Enterキーを押すことでシステムが再起動されます。

手動セットアップモードを使用する場合は、環境変数NO_YAMLを設定します。
```sh
NO_YAML=1 sh adguardhome.sh
```

この方法では、htpasswdのインストール、認証情報の入力、YAML設定ファイルの生成がすべてスキップされ、AdGuard Homeのインストールのみが実行されます。初期設定は、インストール完了後にWebブラウザからアクセスして手動で行います。

完全に自動化された無人インストールを行う場合は、すべての設定を環境変数で指定します。
```sh
INSTALL_MODE=official NO_YAML=1 sh adguardhome.sh
```

この方法では、対話的なプロンプトは一切表示されず、指定された設定に基づいてインストールが自動的に実行されます。CIパイプラインや大規模な展開スクリプトに組み込む場合に適しています。

既にAdGuard Homeがインストールされている環境でスクリプトを実行した場合、自動的にアンインストーラーモードで起動します。スクリプトはインストールされているバージョンを検出し、削除するかどうかを確認します。削除を選択した場合、サービスの停止、パッケージのアンインストール、設定ファイルの削除、バックアップからの設定復元が順次実行されます。

## 環境変数による設定

本スクリプトは、複数の環境変数を通じて動作をカスタマイズできます。

INSTALL_MODEは、インストール方法を指定します。openwrtを指定するとOpenWrtパッケージ版が、officialを指定すると公式バイナリ版がインストールされます。未指定の場合は対話的なプロンプトが表示されます。

NO_YAMLは、YAML設定ファイルの自動生成をスキップするかどうかを制御します。1または任意の値を設定すると、htpasswdのインストール、認証情報の入力、パスワードハッシュの生成、YAML設定ファイルのダウンロードと生成がすべてスキップされます。

AGH_USERとAGH_PASSは、YAML自動セットアップモードで使用する管理者のユーザー名とパスワードを事前に指定します。これらを設定することで、対話的な入力プロンプトをスキップできます。デフォルト値はそれぞれadminとpasswordですが、セキュリティ上、本番環境では必ず変更してください。

WEB_PORTは、AdGuard HomeのWebインターフェースがリッスンするポート番号を指定します。デフォルトは8000です。DNS_PORTは、AdGuard HomeがDNSクエリを受け付けるポート番号を指定します。デフォルトは53です。DNS_BACKUP_PORTは、dnsmasqがバックアップDNSサーバーとして使用するポート番号を指定します。デフォルトは54です。

SCRIPT_BASE_URLは、YAML設定テンプレートをダウンロードする際のベースURLを指定します。独自の設定テンプレートを使用する場合に変更できます。

REMOVE_MODEは、削除処理を実行するかどうかを制御します。autoを指定すると、確認プロンプトなしで自動的に削除処理が実行されます。

## 技術的な実装詳細

### htpasswdの取得方法

OpenWrtにはhtpasswdの単体パッケージが存在しないため、本スクリプトでは以下の独自の方法でhtpasswdバイナリを取得します：

1. Apache（apache2/apache）パッケージを依存関係とともに一時的にインストール
2. /usr/bin/htpasswdバイナリを/tmp/にコピー
3. Apacheパッケージを即座にアンインストール（--force-depends / --force）
4. 抽出したhtpasswdバイナリを/usr/bin/に配置

この処理中、Apacheパッケージはインストールされると同時に自動的にenabled状態になりますが、startコマンドは実行されないため、Apacheサービスが実際に起動することはありません。htpasswdのコピー完了後、即座にApacheがアンインストールされるため、システムに影響を与えることなくhtpasswdのみがシステムに残ります。

この実装方法には以下の利点があります：

- **アーキテクチャ完全非依存**: OpenWrtのパッケージマネージャーが自動的に適切なアーキテクチャのバイナリを選択するため、mips、arm、x86など、あらゆるアーキテクチャで動作します
- **クロスコンパイル不要**: 独自のバイナリを配布・メンテナンスする必要がありません
- **確実な動作保証**: パッケージリポジトリから提供される公式ビルドを使用するため、依存関係やライブラリの互換性が保証されます
- **メンテナンスフリー**: OpenWrtのバージョンアップに追従して自動的に最適なバイナリが選択されます

この方法は一見冗長に見えますが、OpenWrtの制約環境下でアーキテクチャ非依存のhtpasswd取得を実現する最も現実的かつ堅牢な実装です。

### dnsmasqとAdGuard Homeの連携

本スクリプトは、dnsmasqとAdGuard Homeを以下のように連携させます：

- **AdGuard Home（port 53）**: 外部DNSクエリ処理、広告ブロック、フィルタリング、キャッシュ
- **dnsmasq（port 54）**: ローカルホスト名解決専用（.lanドメイン）

dnsmasqはデフォルトで53番ポートを使用しますが、AdGuard Homeが53番ポートを必要とするため、DNS_BACKUP_PORT（デフォルト54番）に移動します。dnsmasqはnoresolvオプションにより上流DNSサーバーへの直接問い合わせが無効化され、cachesizeが0に設定されることでDNSキャッシュ機能も無効化されます。その役割は、ローカルネットワーク内のホスト名（*.lanドメイン）の解決に特化します。

AdGuard Homeは、受信したすべてのDNSクエリを処理し、ローカルドメイン（*.lan）のクエリのみをdnsmasq（127.0.0.1:54および::1:54）に転送します。それ以外のクエリは、AdGuard Homeの設定で指定された上流DNSサーバーに転送されます。この構成により、ローカルホスト名解決とグローバルDNS解決を適切に分離し、AdGuard Homeの広告ブロック機能を最大限に活用できます。

"BACKUP"という名称は、dnsmasqがフェイルオーバー用のバックアップDNSサーバーとして機能することを意味するのではなく、AdGuard Homeが使用する53番ポートを空けるために「別のポート番号に退避させた」という意味で使用されています。

### IPv6アドレスの取り扱い

本スクリプトは、IPv6環境において以下の処理を行います：

- グローバルユニキャストアドレス（2xxx::/3、fd00::/8、fc00::/7）のみを検出
- プライバシー拡張機能による一時アドレス（temporary address）を自動的に除外
- 検出されたすべての安定したIPv6アドレスをDHCPv6のoption6で配布

一時アドレスは定期的に変更されるため、DNS設定には使用されません。これにより、クライアントが常に有効なDNSサーバーアドレスを受け取ることが保証されます。

### アーキテクチャ対応の詳細

対応アーキテクチャは、インストール方法によって異なります：

- **OpenWrtパッケージ版**: パッケージリポジトリで提供されているアーキテクチャに限定されます。一般的には、主要なアーキテクチャ（arm、mips、x86など）がサポートされていますが、古いアーキテクチャやマイナーなアーキテクチャでは利用できない場合があります。

- **公式バイナリ版**: AdGuard Homeプロジェクトがサポートするすべてのアーキテクチャ（armv5、armv6、armv7、arm64、386、amd64、mipsle、mips64le）に対応します。スクリプトは`uname -m`の出力を基に適切なバイナリを自動選択します。

OpenWrtパッケージ版でパッケージが見つからない場合、スクリプトは自動的に公式バイナリ版へフォールバックします。

## ネットワーク設定の詳細

本スクリプトは、AdGuard Homeをネットワークの中核的なDNSリゾルバとして機能させるため、OpenWrtの複数のネットワークコンポーネントの設定を自動的に調整します。

dnsmasqの設定では、noresolvオプションを有効にすることで、dnsmasqが直接上流DNSサーバーに問い合わせることを防ぎます。cachesizeを0に設定することで、dnsmasqのDNSキャッシュ機能を無効化し、AdGuard Homeが一元的にキャッシュを管理するようにします。rebind_protectionを無効にすることで、プライベートIPアドレスへのDNS応答が拒否されないようにします。これは、ローカルネットワーク内のホスト名解決に必要です。

dnsmasqのリスニングポートは、デフォルトの53番からDNS_BACKUP_PORTで指定されたポート（デフォルトは54番）に変更されます。これにより、AdGuard Homeが53番ポートを使用できるようになります。dnsmasqは、127.0.0.1と::1のDNS_PORTをserverとして指定することで、受信したDNSクエリをローカルホスト上のAdGuard Homeに転送します。ただし、dnsmasqの役割はローカルホスト名解決（*.lanドメイン）に特化しており、フェイルオーバー用のバックアップDNSサーバーとして機能するわけではありません。

DHCP設定では、LANクライアントに配布するDNSサーバーアドレスとして、ルーター自身のIPv4アドレスとIPv6アドレスを指定します。これにより、クライアントはルーターをDNSサーバーとして認識し、実際にはAdGuard Homeでフィルタリングされたクエリ結果を受け取ることになります。

IPv4の場合、DHCP option 6（DNS Server）を使用してルーターのIPv4アドレスを配布します。IPv6の場合、DHCPv6のoption6（DNS recursive name server）を使用してルーターのIPv6アドレスを配布します。IPv6アドレスは複数存在する可能性があるため、検出されたすべてのグローバルユニキャストアドレスが配布されます。ただし、プライバシー拡張機能による一時アドレス（temporary address）は、定期的に変更されるため自動的に除外されます。

これらの設定は、MAP-EやDS-Liteなどのトンネリング技術を使用する日本の主要ISP環境で適切にDNSが機能するために不可欠です。特にIPv6環境では、DHCPv6による適切なDNSサーバー情報の配布が行われないと、クライアントがISPのDNSサーバーを直接使用してしまい、AdGuard Homeのフィルタリング機能が機能しません。

ファイアウォール設定では、LANからポート53宛てのすべてのDNSトラフィック（TCPおよびUDP）を、AdGuard Homeが実際にリッスンしているポート（デフォルトは53番）にリダイレクトするDNATルールを作成します。このルールは、検出されたIPアドレスファミリー（ipv4、ipv6、またはany）に応じて適切なfamilyパラメータを設定します。これにより、クライアントが他のDNSサーバー（例：8.8.8.8、1.1.1.1）を直接指定しようとしても、すべてのDNSクエリが強制的にAdGuard Homeを経由するようになります。

このファイアウォールルールは、セキュリティとプライバシーの観点から非常に重要です。悪意のあるソフトウェアや設定ミスにより、クライアントが意図しないDNSサーバーを使用することを防ぎ、ネットワーク全体のDNSトラフィックを一元管理できます。

## バックアップと復元

本スクリプトは、設定変更を行う前に、network、dhcp、firewallの各設定ファイルのバックアップを自動的に作成します。これらのバックアップは、それぞれ元のファイル名に.adguard.bakという拡張子を付けた名前で/etc/configディレクトリに保存されます。

アンインストール時には、これらのバックアップファイルが存在するかを確認し、存在する場合は自動的に復元します。バックアップが存在しない場合（手動でAdGuard Homeをインストールした後に本スクリプトでアンインストールを実行した場合など）、スクリプトはdnsmasqの設定をOpenWrtのデフォルト状態に戻す処理を実行します。具体的には、AdGuard Homeのインストール時に追加または変更された設定項目（noresolv、cachesize、rebind_protection、port、serverリスト、dhcp_option、dhcp_option6など）を削除し、標準的なdnsmasq設定に戻します。

ファイアウォールについては、AdGuard Home専用に追加されたDNSリダイレクトルール（adguardhome_dns_53という名前のredirectルール）のみを削除し、ユーザーが独自に設定した他のファイアウォールルールには影響を与えません。このアプローチにより、AdGuard Homeの削除がネットワーク全体の設定に予期しない影響を与えることを防ぎます。

バックアップファイルは削除処理が正常に完了した後に自動的に削除されます。これにより、ディスク容量の無駄な消費を防ぎ、システムを整然とした状態に保ちます。

設定ファイルの削除については、アンインストール時に対話的に確認されます。ユーザーが削除を選択した場合、/etc/AdGuardHomeディレクトリ（公式バイナリ版の場合）または/etc/adguardhome.yaml（OpenWrtパッケージ版の場合）が完全に削除されます。削除しない選択をした場合、これらの設定ファイルは保持され、再インストール時に再利用できます。

## トラブルシューティング

インストールが失敗する最も一般的な原因は、システムリソースの不足です。スクリプトは実行開始時にメモリとストレージの要件をチェックしますが、インストール処理中に一時的にさらに多くのリソースが必要となる場合があります。特に、公式バイナリ版をインストールする場合、ダウンロードしたアーカイブを展開する際に追加のストレージ容量が必要です。この問題を解決するには、不要なパッケージを削除するか、外部ストレージを利用してください。

ネットワーク接続の問題も、インストール失敗の一般的な原因です。パッケージリポジトリやGitHubへのアクセスが制限されている環境では、ダウンロードが失敗する可能性があります。スクリプトは証明書検証をスキップする設定で自動的にリトライを試みますが、それでも失敗する場合は、プロキシ設定を確認するか、別のネットワーク環境から実行してください。

YAML自動セットアップモードで、htpasswdのインストールに失敗する場合があります。これは、Apacheパッケージがリポジトリに存在しないか、依存関係の問題で正しくインストールできない場合に発生します。この問題を回避するには、NO_YAML=1を設定して手動セットアップモードを使用し、Webインターフェースから初期設定を行ってください。

AdGuard Homeのサービスが起動しない場合、ポート番号の競合が原因である可能性があります。デフォルトでは、AdGuard Homeはポート53でDNSクエリを受け付け、ポート8000でWebインターフェースを提供しますが、これらのポートが既に他のサービスで使用されている場合、起動に失敗します。DNS_PORTやWEB_PORT環境変数を使用して、利用可能なポート番号に変更してください。

削除処理が正常に完了しない場合、手動でバックアップファイルから設定を復元する必要がある場合があります。バックアップファイルは/etc/config/ディレクトリに.adguard.bak拡張子で保存されています。これらのファイルを元のファイル名にリネームすることで、手動で復元できます。

## セキュリティに関する考慮事項

YAML自動セットアップモードを使用する場合、管理者のパスワードはbcrypt形式でハッシュ化されて保存されます。bcryptは、パスワードハッシュ生成のための業界標準アルゴリズムであり、ブルートフォース攻撃に対して高い耐性を持ちます。ただし、デフォルトのユーザー名とパスワード（admin/password）は、セキュリティ上のリスクがあるため、必ず変更する必要があります。

AdGuard HomeのWebインターフェースは、デフォルトではHTTPで提供されます。本番環境では、HTTPSを使用するように設定することを強く推奨します。AdGuard Homeは、Let's Encryptなどの証明書プロバイダーとの統合をサポートしており、Webインターフェースから簡単に設定できます。

ファイアウォールルールにより、LANからのすべてのDNSトラフィックがAdGuard Homeを経由するよう強制されます。これは、ネットワーク全体のセキュリティを向上させる一方で、AdGuard Homeが単一障害点となる可能性があります。冗長性を確保するため、DNS_BACKUP_PORTで指定されたポートでdnsmasqがバックアップDNSサーバーとして機能するよう設定されていますが、より高い可用性が必要な場合は、複数のAdGuard Homeインスタンスを構成することを検討してください。

YAML設定テンプレートは、SCRIPT_BASE_URLで指定されたリモートサーバーからダウンロードされます。このテンプレートには、AdGuard Homeの動作を制御する重要な設定が含まれているため、信頼できるソースからのみダウンロードするようにしてください。独自のテンプレートを使用する場合は、SCRIPT_BASE_URL環境変数を適切に設定する必要があります。

## パフォーマンスの最適化

AdGuard Homeは、デフォルト設定でも優れたパフォーマンスを提供しますが、環境に応じた最適化により、さらに応答速度を向上させることができます。キャッシュサイズを増やすことで、頻繁にアクセスされるドメインの解決速度が向上しますが、メモリ使用量も増加します。リソースが限られたデバイスでは、適切なバランスを見つける必要があります。

上流DNSサーバーの選択も、パフォーマンスに大きな影響を与えます。地理的に近いDNSサーバーを使用することで、クエリの応答時間を短縮できます。日本国内では、CloudflareやGoogle Public DNSに加えて、各ISPが提供するDNSサーバーの使用も検討してください。AdGuard Homeは、複数の上流DNSサーバーを設定し、最も応答が速いサーバーを自動的に選択する機能をサポートしています。

フィルタリングルールの数も、パフォーマンスに影響します。多数のフィルタリストを有効にすると、メモリ使用量が増加し、クエリ処理時間が長くなる可能性があります。実際に必要なフィルタリストのみを有効にし、定期的に使用状況を確認して不要なリストを無効化してください。

## ライセンスとサポート

本スクリプトは、オープンソースプロジェクトとして公開されています。詳細なライセンス情報については、リポジトリのLICENSEファイルを参照してください。

本スクリプトの使用に関して問題が発生した場合、GitHubリポジトリのIssuesセクションで報告してください。バグレポートを提出する際は、OpenWrtのバージョン、使用したインストールモード、エラーメッセージの全文など、問題を再現するために必要な情報を含めてください。

機能の追加や改善の提案も歓迎します。Pull Requestを提出する前に、既存のIssuesを確認し、重複する提案がないことを確認してください。コードの変更を含むPull Requestは、ShellCheckによる静的解析をパスし、既存の機能に影響を与えないことを確認してから提出してください。

本スクリプトは、コミュニティの貢献により継続的に改善されています。貢献者の皆様に感謝いたします。
