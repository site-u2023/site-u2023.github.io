# File Browser インストールスクリプト - 技術仕様書

## クイックスタート

スクリプトのダウンロードと実行は以下のワンライナーで可能である。
```bash
mkdir -p /tmp && wget --no-check-certificate -O /tmp/filebrowser.sh "https://site-u.pages.dev/www/custom-scripts/filebrowser.sh" && chmod +x /tmp/filebrowser.sh && sh /tmp/filebrowser.sh -i
```

このコマンドは以下の処理を順次実行する。

1. `/tmp`ディレクトリの作成（既存の場合はスキップ）
2. スクリプトのダウンロード（SSL証明書検証を無効化）
3. 実行権限の付与
4. スクリプトの実行（インストールモード）

対話的にインストールの確認が求められる。非対話実行を行う場合は、環境変数を設定して実行すること。

詳細な使用方法については「使用例」セクションを参照すること。

## ファイル配置

本スクリプトに関連するファイルは以下のリポジトリで管理されている。

### 実行ファイル

[filebrowser.sh](https://github.com/site-u2023/site-u2023.github.io/blob/main/www/custom-scripts/filebrowser.sh)

本体スクリプトである。全ての機能がこの単一ファイルに実装されている。

### 技術仕様書

[filebrowser.md](https://github.com/site-u2023/site-u2023.github.io/blob/main/www/custom-scripts/filebrowser.md)

本ドキュメントである。スクリプトの仕様、動作、使用方法が詳細に記載されている。

## 書式
```
filebrowser.sh [-i] [-r [auto]] [-t] [-h]
```

## オプション

**-i**

インストールモード。File Browserをダウンロードしてインストールする。

**-r** *[mode]*

削除モードを指定する。

- **auto** - 確認なしで自動削除
- **manual** - 対話的確認後に削除（デフォルト）

引数なしで`-r`を指定した場合は`manual`モードとなる。

**-t**

TUIモード(内部使用)。統合モード実行時に使用される。

**-h**

使用方法を表示して終了する。

オプションの指定順序は任意である。

## 環境変数

環境変数による動作制御は、主に他のスクリプトからの統合実行を想定した実装である。

**FB_USER**

管理者ユーザー名を指定する。デフォルト値は`admin`である。

**FB_PASS**

管理者パスワードを指定する。デフォルト値は`admin12345678`、最小12文字である。

注意: デフォルト値は脆弱であり、本番環境では必ず変更すること。初回ログイン後にWebインターフェースからパスワードを変更することを強く推奨する。

**FB_PORT**

Webインターフェースポート番号を指定する。デフォルト値は`8080`である。

**FB_LANG**

Webインターフェースの言語を指定する。デフォルト値は`en`である。日本語の場合は`ja`を指定する。

**FB_ROOT**

ファイルブラウザのルートパスを指定する。デフォルト値は`/`である。特定のディレクトリのみを公開したい場合に変更する。

**REMOVE_MODE**

削除モードを指定する。`auto`を設定した場合、確認なしで削除を実行する。

**TUI_MODE**

`1`を設定した場合、TUI(統合)モードで実行する。コマンドラインオプション`-t`と同等である。

**SELECTED_OPTION**

TUIモードで使用される。`install`または`remove`を指定してアクションを決定する。

## インストール先

### バイナリ

File Browserバイナリは以下のパスにインストールされる。

- `/usr/bin/filebrowser`

### 設定ディレクトリ

設定ファイルとデータベースは以下のディレクトリに配置される。

- `/etc/filebrowser/`
- `/etc/filebrowser/filebrowser.db` - SQLiteデータベース

### initスクリプト

サービス管理用のinitスクリプトは以下のパスに作成される。

- `/etc/init.d/filebrowser`

## アーキテクチャ検出

スクリプトは`uname -m`の出力に基づいて適切なバイナリをダウンロードする。

サポートされるアーキテクチャは以下の通りである。

- `aarch64`, `arm64` → `arm64`
- `armv7l` → `armv7`
- `armv6l` → `armv6`
- `x86_64`, `amd64` → `amd64`
- `i386`, `i686` → `386`
- `riscv64` → `riscv64`

上記以外のアーキテクチャが検出された場合、エラーメッセージを表示して終了する。

## インストール動作の詳細

### バイナリのダウンロード

GitHub APIから最新リリース情報を取得し、アーキテクチャに応じた適切なバイナリをダウンロードする。APIからバージョン取得に失敗した場合は、フォールバックとしてバージョン`2.31.2`を使用する。

ダウンロードURLの形式は以下の通りである。
```
https://github.com/filebrowser/filebrowser/releases/download/v${ver}/linux-${arch}-filebrowser.tar.gz
```

ダウンロードしたtarballは`/tmp`に展開され、バイナリは`/usr/bin/filebrowser`に移動される。

### データベース初期化

インストール時にSQLiteデータベースが存在しない場合、以下の処理が実行される。

1. `filebrowser config init`によるデータベース初期化
2. 設定値の適用（ルートパス、アドレス、ポート、言語）
3. 管理者ユーザーの作成（admin権限付与）

データベースが既に存在する場合は、設定値の更新のみが実行される。

### initスクリプトの作成

procdベースのinitスクリプトが`/etc/init.d/filebrowser`に作成される。このスクリプトは以下の特徴を持つ。

- START優先度: 99（システム起動の最後に実行）
- STOP優先度: 10
- procd respawn機能による自動再起動

### サービスの有効化と起動

インストール完了後、サービスは自動的に有効化され、起動される。

## 設定の詳細

### バインドアドレス

File Browserは`0.0.0.0`にバインドされ、全てのネットワークインターフェースからのアクセスを受け付ける。これによりIPv4およびIPv6の両方からアクセス可能となる。

### 言語設定

言語設定はデータベース初期化時に適用される。既存のデータベースに対しては`filebrowser config set --locale`コマンドで更新される。

サポートされる言語コードの例:
- `en` - 英語
- `ja` - 日本語
- `zh-cn` - 中国語（簡体字）
- `ko` - 韓国語
- `de` - ドイツ語
- `fr` - フランス語

## 削除モードの詳細動作

### autoモード

全ての確認プロンプトをスキップし、即座に削除を実行する。

### manualモード

削除実行前にユーザーへ確認を求める。確認に対して`y`または`Y`以外が入力された場合、処理をキャンセルして正常終了する。

### 削除処理の実行内容

削除処理では以下の操作が順次実行される。

1. サービスの停止
2. サービスの無効化
3. バイナリの削除（`/usr/bin/filebrowser`）
4. initスクリプトの削除（`/etc/init.d/filebrowser`）
5. 設定ディレクトリの削除（`/etc/filebrowser/`）

## Webインターフェース情報の表示

インストール完了時、アクセス情報が以下の形式で表示される。

### アクセスURL

LANインターフェース（`br-lan`）のIPv4アドレスを自動検出し、`http://${lan_ip}:${FB_PORT}/`の形式で表示される。検出に失敗した場合は`192.168.1.1`がデフォルトとして使用される。

### 認証情報

管理者ユーザー名(`FB_USER`)とパスワード(`FB_PASS`)が表示される。初回ログイン後のパスワード変更が推奨される旨の警告も表示される。

## 使用例

### 対話型インストール

オプション指定なしで実行すると、インストールの確認が対話的に求められる。
```bash
sh filebrowser.sh
```

### 直接インストール
```bash
sh filebrowser.sh -i
```

既にインストール済みの場合は、アクセス情報のみが表示される。

### カスタム設定でのインストール
```bash
FB_USER=myadmin FB_PASS=mysecurepassword FB_PORT=9000 FB_LANG=ja sh filebrowser.sh -i
```

環境変数を指定してカスタム設定でインストールする。

### 自動削除
```bash
sh filebrowser.sh -r auto
```

確認プロンプトなしで削除を実行する。

### 対話的削除
```bash
sh filebrowser.sh -r
```

削除実行前に確認プロンプトが表示される。

### TUI統合モード
```bash
TUI_MODE=1 SELECTED_OPTION=install sh filebrowser.sh -t
```

他のスクリプトからの統合実行用モードである。

### 使用方法の表示
```bash
sh filebrowser.sh -h
```

オプション一覧と使用方法が表示される。

## スタンドアロンモードと統合モード

スクリプトは実行形態により動作が変化する。

### スタンドアロンモード

`$(basename "$0")` が `filebrowser.sh` と一致する場合、スタンドアロンモードとして実行される。

### 統合モード

他のスクリプトから`source`または`.`により読み込まれた場合、統合モードとして動作する。このモードでは、環境変数`TUI_MODE`および`SELECTED_OPTION`により動作を制御可能である。

## セキュリティに関する注意事項

### デフォルトパスワード

デフォルトパスワード`admin12345678`は脆弱である。インストール後、速やかにWebインターフェースからパスワードを変更すること。

### ルートパス設定

デフォルトではルートパスが`/`に設定されており、ルーターのファイルシステム全体が公開される。セキュリティを考慮し、必要に応じて`FB_ROOT`環境変数で公開範囲を制限することを推奨する。

### ファイアウォール設定

本スクリプトはファイアウォール設定を自動的には変更しない。WANからのアクセスを許可する場合は、別途ファイアウォールルールの追加が必要である。デフォルトではLANゾーンからのみアクセス可能である。

## 既知の制限事項

### IPv6アクセスURL

現在のバージョンでは、インストール完了時のアクセス情報表示においてIPv6アドレスは表示されない。ただし、File Browser自体は`0.0.0.0`にバインドされているため、IPv6アドレスを直接指定することでアクセス可能である。

### データベースの永続性

設定とユーザー情報はSQLiteデータベース（`/etc/filebrowser/filebrowser.db`）に保存される。ファームウェアアップグレード時にこのファイルが保持されるよう、sysupgradeの設定を確認すること。
