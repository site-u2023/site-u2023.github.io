# jerrykuku カスタムフィードインストールスクリプト - 技術仕様書

## 概要

jerrykukuリポジトリから提供されるArgonテーマパッケージをインストールするためのスクリプトである。LuCI用の高品質なテーマを提供し、OpenWrtの管理インターフェースの外観をモダンなデザインに変更する。

## ファイル配置

本スクリプトに関連するファイルは以下のリポジトリで管理されている。

### 実行ファイル

[jerrykuku.sh](https://github.com/site-u2023/site-u2023.github.io/blob/main/www/custom-feeds/jerrykuku.sh)

本体スクリプトである。パッケージのダウンロードとインストール処理が実装されている。

### 設定ファイル

[customfeeds.json](https://github.com/site-u2023/site-u2023.github.io/blob/main/www/custom-feeds/customfeeds.json)

パッケージ定義とリポジトリ情報が記載されたJSON設定ファイルである。

### 技術仕様書

[jerrykuku.md](https://github.com/site-u2023/site-u2023.github.io/blob/main/www/custom-feeds/jerrykuku.md)

本ドキュメントである。スクリプトの仕様、動作、提供パッケージが詳細に記載されている。

## システム要件

### 対応OpenWrtバージョン

- 最小バージョン: OpenWrt 23.05以降
- パッケージマネージャー: opkg または apk

### パッケージマネージャー別対応

| パッケージマネージャー | 拡張子 |
|------------------------|--------|
| opkg | `.ipk` |
| apk | `.apk` |

## リポジトリ情報

### API エンドポイント

リリース情報の取得に使用されるGitHub Releases APIのURLは以下の通りである。
```
https://api.github.com/repos/jerrykuku/luci-theme-argon/releases/latest
```

注: スクリプトは最新リリースだけでなく、全リリースを検索してパッケージを探す。

### ダウンロードベースURL

パッケージファイルのダウンロードに使用されるURLは以下の形式である。
```
https://github.com/jerrykuku/luci-theme-argon/releases/download/${TAG_NAME}/${PACKAGE_NAME}
```

## 提供パッケージ一覧

### luci-theme-argon

LuCI用Argonテーマである。モダンでクリーンなデザインのLuCIテーマを提供する。

| 項目 | 値 |
|------|-----|
| パターン | `luci-theme-argon` |
| 最小OpenWrtバージョン | 21.02 |
| 依存パッケージ | なし |

#### テーマの特徴

- レスポンシブデザイン
- ダークモード対応
- カスタム背景画像のサポート
- アニメーション効果
- 多言語対応

## スクリプト動作の詳細

### 環境変数

スクリプトは以下の環境変数を使用する。これらは呼び出し元から設定される。

**PKG_MGR**

使用するパッケージマネージャーを指定する。`opkg`または`apk`である。

**PKG_EXT**

パッケージファイルの拡張子を指定する。`ipk`または`apk`である。

**PACKAGES**

インストール対象のパッケージ定義をスペース区切りで指定する。各パッケージは以下の形式である。
```
pattern:exclude:filename:enable_service:restart_service
```

**DOWNLOAD_BASE_URL**

パッケージダウンロード用のベースURLを指定する。

**PKG_INSTALL_CMD_TEMPLATE**

パッケージインストールコマンドのテンプレートを指定する。`{package}`プレースホルダーが実際のパッケージパスに置換される。

### パッケージソート処理

スクリプトはパッケージを依存関係を考慮してソートする。

1. テーマパッケージ（`*config*`を含まないもの）を先にインストール
2. 設定パッケージ（`*config*`を含むもの）を後にインストール

これにより、テーマ本体がインストールされた後に設定パッケージがインストールされる。

### リリース検索ロジック

1. GitHub Releases APIから全リリース情報を取得
2. 各リリースのアセットを順次検索
3. パターンと拡張子に一致するパッケージを探索
4. 最初に見つかったパッケージを選択

この方式により、最新リリースにパッケージが含まれていない場合でも、過去のリリースから適切なパッケージを取得可能である。

### インストール処理

1. リリース検索でパッケージとタグ名を特定
2. ダウンロードURLを構築
3. パッケージファイルをダウンロード
4. パッケージマネージャーでインストール
5. ダウンロードしたパッケージファイルを削除

## ログ出力

スクリプトの実行ログは以下のファイルに出力される。
```
/tmp/aios2/debug.log
```

ログには以下の情報が記録される。

- 使用パッケージマネージャーと拡張子
- 処理対象パッケージパターン
- 検索したリリースとタグ名
- 検出されたパッケージ名
- ダウンロードURL
- インストール結果

## エラーハンドリング

### リリース情報取得失敗

GitHub APIからのレスポンス取得に失敗した場合、エラーメッセージを出力して終了する。

### パッケージ未検出

指定されたパターンに一致するパッケージが全リリースで見つからない場合、エラーメッセージを出力して次のパッケージ処理に進む。

### ダウンロード失敗

パッケージのダウンロードに失敗した場合、エラーメッセージを出力して次のパッケージ処理に進む。

## テーマ適用後の設定

### LuCIでのテーマ選択

インストール後、LuCIの以下のパスからテーマを選択可能である。
```
System → System → Language and Style → Design
```

### 背景画像のカスタマイズ

Argonテーマは背景画像のカスタマイズをサポートしている。以下のディレクトリに画像ファイルを配置することで、カスタム背景を設定可能である。
```
/www/luci-static/argon/background/
```

サポートされる画像形式:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- 動画 (.mp4)

## 外部リンク

- [jerrykuku/luci-theme-argon](https://github.com/jerrykuku/luci-theme-argon) - Argonテーマリポジトリ
- [jerrykuku/luci-app-argon-config](https://github.com/jerrykuku/luci-app-argon-config) - Argon設定アプリ（オプション）

## 注意事項

### バージョン互換性

Argonテーマはバージョンによって対応するOpenWrtのバージョンが異なる。スクリプトはパッケージマネージャーの拡張子に基づいて適切なパッケージを自動選択するが、互換性の問題が発生した場合は手動でのバージョン選択が必要となる場合がある。

### 他テーマとの共存

複数のLuCIテーマをインストール可能であるが、同時にアクティブにできるテーマは1つのみである。テーマの切り替えはLuCIの設定画面から行う。
