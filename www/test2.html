<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ASU uci-defaults 20KB超過テスト（分割数表示付き）</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#log { white-space: pre; background: #f5f5f5; padding: 1em; }
label { display: block; margin-top: 0.5em; }
</style>
</head>
<body>
<h1>ASU uci-defaults 20KB超過テスト（分割数表示付き）</h1>

<label>プロファイル: <input id="profile" value="asus_rt-ax53u"></label>
<label>ターゲット: <input id="target" value="ramips/mt7621"></label>
<label>バージョン: <input id="version" value="23.05.5"></label>
<label>パッケージ(カンマ区切り): <input id="packages" value="luci"></label>

<label>uci-defaults の内容:</label>
<textarea id="defaults" rows="15" style="width:100%"></textarea>

<button id="sendBtn">ASUへ送信</button>
<div id="log"></div>

<script>
const ASU_URL = 'https://sysupgrade.openwrt.org/api/v1/build';
const CHUNK_LIMIT = 20 * 1024; // 20KB

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

// 最初から20KB超過のdefaultsを生成
function makeLargeDefaults() {
  let base = "#!/bin/sh\n";
  base += "echo start > /tmp/test.log\n";
  base += "generate_dummy_block() {\ncat << 'EOF'\n";
  for (let i = 0; i < 2500; i++) {
    base += `# dummy line ${i+1}\n`;
  }
  base += "EOF\n}\n";
  base += "for i in $(seq 1 5); do f=/tmp/file_$i; : > $f; generate_dummy_block >> $f; done\n";
  return base;
}

document.getElementById('defaults').value = makeLargeDefaults();

document.getElementById('sendBtn').addEventListener('click', async () => {
  document.getElementById('log').textContent = '';
  const profile = document.getElementById('profile').value.trim();
  const target = document.getElementById('target').value.trim();
  const version = document.getElementById('version').value.trim();
  const pkgs = document.getElementById('packages').value.trim();
  const defaults = document.getElementById('defaults').value;

  // サイズ計算
  const sizeBytes = new Blob([defaults]).size;
  const chunks = Math.ceil(sizeBytes / CHUNK_LIMIT);
  const chunkSizeKB = (sizeBytes / chunks / 1024).toFixed(2);
  const totalKB = (sizeBytes / 1024).toFixed(2);

  log(`defaultsサイズ: ${sizeBytes} bytes (${totalKB} KB)`);
  log(`分割数: ${chunks} 個`);
  log(`1チャンク: ${chunkSizeKB} KB`);
  log(`合計サイズ: ${totalKB} KB`);
  log('--- 実送信開始 ---');

  const body = {
    profile: profile,
    target: target,
    version: version,
    packages: pkgs ? pkgs.split(',').map(s => s.trim()).filter(Boolean) : [],
    defaults: defaults,
    client: 'asu-defaults-test/20kb-over'
  };

  try {
    const res = await fetch(ASU_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    log(`HTTP ${res.status}`);
    const data = await res.json().catch(() => ({}));
    log(JSON.stringify(data, null, 2));
  } catch (e) {
    log(`送信エラー: ${e.message}`);
  }
});
</script>
</body>
</html>
