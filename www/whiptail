#!/bin/sh
# whiptail fallback - text UI emulation
# Self-contained - no external dependencies

VERSION="R7.1122.2140"
DEBUG="${DEBUG:-0}"
DEBUG_LOG="${DEBUG_LOG:-/tmp/aios2/whiptail_debug.log}"

# 初期化時にログファイルをクリア
: > "$DEBUG_LOG"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] whiptail fallback initialized" >> "$DEBUG_LOG"

_debug() {
    # ログには常に書き出す
    echo "[$(date '+%H:%M:%S')] $*" >> "$DEBUG_LOG"
    # 画面表示はDEBUG=1の時のみ
    if [ "$DEBUG" = "1" ]; then
        echo "[DEBUG] $*" >&2
    fi
}

_whiptail_header() {
    local title="$1"
    _debug "_whiptail_header: title='$title'"
    echo "========================================" >&2
    echo "  $title" >&2
    echo "========================================" >&2
    echo "" >&2
}

_whiptail_inputbox() {
    local title="$1"
    local prompt="$2"
    local default="$3"
    
    _debug "_whiptail_inputbox: title='$title' prompt='$prompt' default='$default'"
    _whiptail_header "$title"
    if [ -n "$prompt" ]; then
        printf "%s [%s]: " "$prompt" "$default" >&2
    else
        printf "[%s]: " "$default" >&2
    fi
    read -r value
    _debug "_whiptail_inputbox: value='${value:-$default}'"
    echo "${value:-$default}"
    return 0
}

_whiptail_menu() {
    local title="$1"
    local prompt="$2"
    shift 2
    
    _debug "_whiptail_menu: title='$title' prompt='$prompt' args=$#"
    _whiptail_header "$title"
    [ -n "$prompt" ] && echo "$prompt" >&2 && echo "" >&2
    
    while [ $# -ge 2 ]; do
        _debug "_whiptail_menu: item key='$1' label='$2'"
        echo "$1) $2" >&2
        shift 2
    done
    
    echo "" >&2
    printf "Choice: " >&2
    read -r choice
    _debug "_whiptail_menu: choice='$choice'"
    echo "$choice"
    return 0
}

_whiptail_yesno() {
    local title="$1"
    local prompt="$2"
    local yes_btn="${3:-y}"
    local no_btn="${4:-n}"
    
    _debug "_whiptail_yesno: title='$title' prompt='$prompt' yes='$yes_btn' no='$no_btn'"
    _whiptail_header "$title"
    echo "$prompt" >&2
    echo "" >&2
    printf "(%s/%s): " "$yes_btn" "$no_btn" >&2
    read -r choice
    _debug "_whiptail_yesno: choice='$choice'"
    
    case "$(echo "$choice" | tr '[:upper:]' '[:lower:]')" in
        y|yes|"$yes_btn") return 0 ;;
        *) return 1 ;;
    esac
}

_whiptail_msgbox() {
    local title="$1"
    local prompt="$2"
    local ok_btn="${3:-OK}"
    
    _debug "_whiptail_msgbox: title='$title' prompt='$prompt' ok='$ok_btn'"
    _whiptail_header "$title"
    echo "$prompt" >&2
    echo "" >&2
    printf "[%s] " "$ok_btn" >&2
    read -r _
    _debug "_whiptail_msgbox: done"
    return 0
}

_whiptail_checklist() {
    local title="$1"
    local prompt="$2"
    shift 2
    
    _debug "_whiptail_checklist: title='$title' prompt='$prompt' args=$#"
    _whiptail_header "$title"
    [ -n "$prompt" ] && echo "$prompt" >&2 && echo "" >&2
    
    while [ $# -ge 3 ]; do
        local key="$1"
        local label="$2"
        local status="$3"
        _debug "_whiptail_checklist: key='$key' label='$label' status='$status'"
        if [ "$status" = "ON" ]; then
            echo "[X] $key) $label" >&2
        else
            echo "[ ] $key) $label" >&2
        fi
        shift 3
    done
    
    echo "" >&2
    printf "Toggle (space-separated numbers): " >&2
    read -r choices
    _debug "_whiptail_checklist: choices='$choices'"
    echo "$choices"
    return 0
}

_whiptail_textbox() {
    local title="$1"
    local file="$2"
    local ok_btn="${3:-OK}"
    
    _debug "_whiptail_textbox: title='$title' file='$file' ok='$ok_btn'"
    _whiptail_header "$title"
    [ -f "$file" ] && cat "$file" >&2
    echo "" >&2
    printf "[%s] " "$ok_btn" >&2
    read -r _
    _debug "_whiptail_textbox: done"
    return 0
}

whiptail() {
    # stdin を /dev/tty に強制的に繋ぎ直す
    exec 9<&0
    exec 0</dev/tty
    
    _debug "whiptail() called with $# args: $*"
    
    local title="" type="" prompt=""
    local yes_btn="" no_btn="" ok_btn="" cancel_btn=""
    local height="" width="" menu_height="" default="" file=""
    local ret=0
    
    while [ $# -gt 0 ]; do
        _debug "parsing arg: '$1'"
        case "$1" in
            --title) 
                title="$2"
                _debug "  title='$2'"
                shift 2
                ;;
            --yes-button)
                yes_btn="$2"
                _debug "  yes_btn='$2'"
                shift 2
                ;;
            --no-button)
                no_btn="$2"
                _debug "  no_btn='$2'"
                shift 2
                ;;
            --ok-button)
                ok_btn="$2"
                _debug "  ok_btn='$2'"
                shift 2
                ;;
            --cancel-button)
                cancel_btn="$2"
                _debug "  cancel_btn='$2'"
                shift 2
                ;;
            --scrolltext)
                _debug "  scrolltext flag"
                shift
                ;;
            --inputbox)
                type="inputbox"
                prompt="$2"
                height="$3"
                width="$4"
                default="$5"
                _debug "  inputbox: prompt='$2' default='$5'"
                shift 5
                ;;
            --menu)
                type="menu"
                prompt="$2"
                height="$3"
                width="$4"
                menu_height="$5"
                shift 5
                
                _debug "  menu: prompt='$prompt' height=$height width=$width menu_height=$menu_height"
                _debug "  menu: remaining args=$# items=$*"
                
                # メニュー表示を直接処理
                _whiptail_header "$title"
                [ -n "$prompt" ] && echo "$prompt" >&2 && echo "" >&2
                
                # メニュー項目を2つずつ処理（key label のペア）
                while [ $# -ge 2 ]; do
                    local key="$1"
                    local label="$2"
                    _debug "  menu item: key='$key' label='$label'"
                    echo "$key) $label" >&2
                    shift 2
                done
                
                echo "" >&2
                
                # 空入力対策：有効な入力があるまでループ
                local choice=""
                while [ -z "$choice" ]; do
                    printf "Choice: " >&2
                    read -r choice
                    _debug "  menu: choice='$choice'"
                    
                    if [ -z "$choice" ]; then
                        _debug "  menu: empty input, retry"
                        echo "Please enter a valid choice." >&2
                    fi
                done
                
                # stdinを元に戻す
                exec 0<&9
                exec 9<&-
                
                echo "$choice"
                return 0
                ;;
            --yesno)
                type="yesno"
                prompt="$2"
                height="$3"
                width="$4"
                _debug "  yesno: prompt='$2'"
                shift 4
                ;;
            --msgbox)
                type="msgbox"
                prompt="$2"
                height="$3"
                width="$4"
                _debug "  msgbox: prompt length=${#prompt}"
                shift 4
                ;;
            --checklist)
                type="checklist"
                prompt="$2"
                height="$3"
                width="$4"
                menu_height="$5"
                _debug "  checklist: prompt='$prompt'"
                shift 5
                _debug "  checklist: remaining args=$#"
                _whiptail_checklist "$title" "$prompt" "$@"
                ret=$?
                exec 0<&9
                exec 9<&-
                return $ret
                ;;
            --textbox)
                type="textbox"
                file="$2"
                height="$3"
                width="$4"
                _debug "  textbox: file='$2'"
                shift 4
                ;;
            *)
                _debug "  skip unknown: '$1'"
                shift
                ;;
        esac
    done
    
    _debug "executing type='$type'"
    case "$type" in
        inputbox) _whiptail_inputbox "$title" "$prompt" "$default"; ret=$? ;;
        yesno) _whiptail_yesno "$title" "$prompt" "$yes_btn" "$no_btn"; ret=$? ;;
        msgbox) _whiptail_msgbox "$title" "$prompt" "$ok_btn"; ret=$? ;;
        textbox) _whiptail_textbox "$title" "$file" "$ok_btn"; ret=$? ;;
    esac
    
    # stdin を元に戻す
    exec 0<&9
    exec 9<&-
    
    return $ret
}
