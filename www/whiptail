#!/bin/sh
# whiptail fallback - text UI emulation

VERSION="R7.1122.2117"
DEBUG="${DEBUG:-0}"

_debug() {
    [ "$DEBUG" = "1" ] && echo "[DEBUG] $*" >&2
}

_whiptail_header() {
    local title="$1"
    _debug "_whiptail_header: title='$title'"
    echo "========================================" >&2
    echo "  $title" >&2
    echo "========================================" >&2
    echo "" >&2
}

_whiptail_inputbox() {
    local title="$1"
    local prompt="$2"
    local default="$3"
    
    _debug "_whiptail_inputbox: title='$title' prompt='$prompt' default='$default'"
    _whiptail_header "$title"
    if [ -n "$prompt" ]; then
        printf "%s [%s]: " "$prompt" "$default" >&2
    else
        printf "[%s]: " "$default" >&2
    fi
    read -r value < /dev/tty
    _debug "_whiptail_inputbox: value='${value:-$default}'"
    echo "${value:-$default}"
    return 0
}

_whiptail_menu() {
    local title="$1"
    local prompt="$2"
    shift 2
    
    _debug "_whiptail_menu: title='$title' prompt='$prompt' args=$#"
    _whiptail_header "$title"
    [ -n "$prompt" ] && echo "$prompt" >&2 && echo "" >&2
    
    while [ $# -ge 2 ]; do
        _debug "_whiptail_menu: item key='$1' label='$2'"
        echo "$1) $2" >&2
        shift 2
    done
    
    echo "" >&2
    printf "Choice: " >&2
    read -r choice < /dev/tty
    _debug "_whiptail_menu: choice='$choice'"
    echo "$choice"
    return 0
}

_whiptail_yesno() {
    local title="$1"
    local prompt="$2"
    local yes_btn="${3:-y}"
    local no_btn="${4:-n}"
    
    _debug "_whiptail_yesno: title='$title' prompt='$prompt' yes='$yes_btn' no='$no_btn'"
    _whiptail_header "$title"
    echo "$prompt" >&2
    echo "" >&2
    printf "(%s/%s): " "$yes_btn" "$no_btn" >&2
    read -r choice < /dev/tty
    _debug "_whiptail_yesno: choice='$choice'"
    
    case "$(echo "$choice" | tr '[:upper:]' '[:lower:]')" in
        y|yes|"$yes_btn") return 0 ;;
        *) return 1 ;;
    esac
}

_whiptail_msgbox() {
    local title="$1"
    local prompt="$2"
    local ok_btn="${3:-OK}"
    
    _debug "_whiptail_msgbox: title='$title' prompt='$prompt' ok='$ok_btn'"
    _whiptail_header "$title"
    echo "$prompt" >&2
    echo "" >&2
    printf "[%s] " "$ok_btn" >&2
    read -r _ < /dev/tty
    _debug "_whiptail_msgbox: done"
    return 0
}

_whiptail_checklist() {
    local title="$1"
    local prompt="$2"
    shift 2
    
    _debug "_whiptail_checklist: title='$title' prompt='$prompt' args=$#"
    _whiptail_header "$title"
    [ -n "$prompt" ] && echo "$prompt" >&2 && echo "" >&2
    
    while [ $# -ge 3 ]; do
        local key="$1"
        local label="$2"
        local status="$3"
        _debug "_whiptail_checklist: key='$key' label='$label' status='$status'"
        if [ "$status" = "ON" ]; then
            echo "[X] $key) $label" >&2
        else
            echo "[ ] $key) $label" >&2
        fi
        shift 3
    done
    
    echo "" >&2
    printf "Toggle (space-separated numbers): " >&2
    read -r choices < /dev/tty
    _debug "_whiptail_checklist: choices='$choices'"
    echo "$choices"
    return 0
}

_whiptail_textbox() {
    local title="$1"
    local file="$2"
    local ok_btn="${3:-OK}"
    
    _debug "_whiptail_textbox: title='$title' file='$file' ok='$ok_btn'"
    _whiptail_header "$title"
    [ -f "$file" ] && cat "$file" >&2
    echo "" >&2
    printf "[%s] " "$ok_btn" >&2
    read -r _ < /dev/tty
    _debug "_whiptail_textbox: done"
    return 0
}

whiptail() {
    _debug "whiptail() called with: $*"
    
    local title="" type="" prompt=""
    local yes_btn="" no_btn="" ok_btn="" cancel_btn=""
    local height="" width="" default="" file=""
    
    while [ $# -gt 0 ]; do
        _debug "whiptail parsing: '$1'"
        case "$1" in
            --title) title="$2"; _debug "title='$2'"; shift 2 ;;
            --yes-button) yes_btn="$2"; _debug "yes_btn='$2'"; shift 2 ;;
            --no-button) no_btn="$2"; _debug "no_btn='$2'"; shift 2 ;;
            --ok-button) ok_btn="$2"; _debug "ok_btn='$2'"; shift 2 ;;
            --cancel-button) cancel_btn="$2"; _debug "cancel_btn='$2'"; shift 2 ;;
            --scrolltext) _debug "scrolltext flag"; shift ;;
            --inputbox)
                type="inputbox"
                prompt="$2"
                height="$3"
                width="$4"
                default="$5"
                _debug "inputbox: prompt='$2' h='$3' w='$4' default='$5'"
                shift 5
                ;;
            --menu)
                type="menu"
                prompt="$2"
                height="$3"
                width="$4"
                shift 5
                _debug "menu: prompt='$prompt' remaining=$#"
                _whiptail_menu "$title" "$prompt" "$@"
                return $?
                ;;
            --yesno)
                type="yesno"
                prompt="$2"
                height="$3"
                width="$4"
                _debug "yesno: prompt='$2' h='$3' w='$4'"
                shift 4
                ;;
            --msgbox)
                type="msgbox"
                prompt="$2"
                height="$3"
                width="$4"
                _debug "msgbox: prompt='$2' h='$3' w='$4'"
                shift 4
                ;;
            --checklist)
                type="checklist"
                prompt="$2"
                height="$3"
                width="$4"
                shift 5
                _debug "checklist: prompt='$prompt' remaining=$#"
                _whiptail_checklist "$title" "$prompt" "$@"
                return $?
                ;;
            --textbox)
                type="textbox"
                file="$2"
                height="$3"
                width="$4"
                _debug "textbox: file='$2' h='$3' w='$4'"
                shift 4
                ;;
            *)
                _debug "unknown/skip: '$1'"
                shift
                ;;
        esac
    done
    
    _debug "executing type='$type'"
    case "$type" in
        inputbox) _whiptail_inputbox "$title" "$prompt" "$default" ;;
        yesno) _whiptail_yesno "$title" "$prompt" "$yes_btn" "$no_btn" ;;
        msgbox) _whiptail_msgbox "$title" "$prompt" "$ok_btn" ;;
        textbox) _whiptail_textbox "$title" "$file" "$ok_btn" ;;
    esac
}

[ "$DEBUG" = "1" ] && echo "[FALLBACK] whiptail loaded (DEBUG=ON)" >&2
