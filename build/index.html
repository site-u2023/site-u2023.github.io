#!/bin/ash
#
# OpenWrt 初期設定スクリプト (aios-light.sh代替版)
# OpenWrt ash シェル対応
#

# 設定変数 (必要に応じて変更してください)
DEVICE_NAME="${DEVICE_NAME:-OpenWrt-Router}"
ROOT_PASSWORD="${ROOT_PASSWORD:-}"
WLAN_NAME="${WLAN_NAME:-MyOpenWrt}"
WLAN_PASSWORD="${WLAN_PASSWORD:-}"
ISP_MODE="${ISP_MODE:-auto}"
PPPOE_USERNAME="${PPPOE_USERNAME:-}"
PPPOE_PASSWORD="${PPPOE_PASSWORD:-}"
LANGUAGE="${LANGUAGE:-en}"

# ログ出力関数
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $1" | tee -a /var/log/openwrt-setup.log
}

log_error() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $1" | tee -a /var/log/openwrt-setup.log >&2
}

# UCI設定のバックアップ
backup_config() {
    log "設定のバックアップを作成中..."
    cp -r /etc/config /etc/config.backup.$(date +%Y%m%d_%H%M%S)
}

# ホスト名設定
setup_hostname() {
    if [ -n "$DEVICE_NAME" ]; then
        log "ホスト名を設定中: $DEVICE_NAME"
        uci set system.@system[0].hostname="$DEVICE_NAME"
        uci commit system
    fi
}

# rootパスワード設定
setup_root_password() {
    if [ -n "$ROOT_PASSWORD" ]; then
        log "rootパスワードを設定中..."
        echo "root:$ROOT_PASSWORD" | chpasswd
    else
        log "パスワード認証を無効化中..."
        passwd -d root
    fi
}

# WiFi設定
setup_wifi() {
    if [ -n "$WLAN_NAME" ]; then
        log "WiFi設定を開始..."
        
        # WiFiデバイスを有効化
        uci set wireless.radio0.disabled=0
        uci set wireless.radio1.disabled=0 2>/dev/null || true
        
        # SSID設定
        uci set wireless.default_radio0.ssid="$WLAN_NAME"
        uci set wireless.default_radio1.ssid="${WLAN_NAME}_5G" 2>/dev/null || true
        
        # WiFiパスワード設定
        if [ -n "$WLAN_PASSWORD" ]; then
            log "WiFiパスワードを設定中..."
            uci set wireless.default_radio0.encryption='psk2'
            uci set wireless.default_radio0.key="$WLAN_PASSWORD"
            uci set wireless.default_radio1.encryption='psk2' 2>/dev/null || true
            uci set wireless.default_radio1.key="$WLAN_PASSWORD" 2>/dev/null || true
        else
            log "オープンWiFiを設定中..."
            uci set wireless.default_radio0.encryption='none'
            uci set wireless.default_radio1.encryption='none' 2>/dev/null || true
        fi
        
        uci commit wireless
        wifi reload
    fi
}

# インターネット接続設定
setup_internet() {
    log "インターネット接続設定: $ISP_MODE"
    
    case "$ISP_MODE" in
        "pppoe")
            setup_pppoe
            ;;
        "dhcp")
            setup_dhcp
            ;;
        "dslite")
            setup_dslite
            ;;
        "mape")
            setup_mape
            ;;
        "none")
            log "インターネット接続設定をスキップ"
            ;;
        *)
            log "自動検出モード - DHCP設定を適用"
            setup_dhcp
            ;;
    esac
}

# DHCP設定
setup_dhcp() {
    log "DHCP接続を設定中..."
    uci set network.wan.proto='dhcp'
    uci commit network
}

# PPPoE設定
setup_pppoe() {
    if [ -n "$PPPOE_USERNAME" ] && [ -n "$PPPOE_PASSWORD" ]; then
        log "PPPoE接続を設定中..."
        uci set network.wan.proto='pppoe'
        uci set network.wan.username="$PPPOE_USERNAME"
        uci set network.wan.password="$PPPOE_PASSWORD"
        uci commit network
    else
        log_error "PPPoEユーザー名またはパスワードが未設定"
    fi
}

# DS-Lite設定
setup_dslite() {
    log "DS-Lite接続を設定中..."
    
    # IPv6 WAN設定
    uci set network.wan6=interface
    uci set network.wan6.ifname='@wan'
    uci set network.wan6.proto='dhcpv6'
    uci set network.wan6.reqaddress='try'
    uci set network.wan6.reqprefix='auto'
    
    # DS-Liteトンネル設定
    uci set network.dslite=interface
    uci set network.dslite.proto='dslite'
    uci set network.dslite.peeraddr='aftr.ipv6.ocn.ne.jp'  # OCN例
    
    uci commit network
}

# MAP-E設定
setup_mape() {
    log "MAP-E接続を設定中..."
    
    # IPv6 WAN設定
    uci set network.wan6=interface
    uci set network.wan6.ifname='@wan'
    uci set network.wan6.proto='dhcpv6'
    uci set network.wan6.reqaddress='try'
    uci set network.wan6.reqprefix='auto'
    
    # MAP-Eトンネル設定
    uci set network.map=interface
    uci set network.map.proto='map'
    uci set network.map.maptype='map-e'
    uci set network.map.peeraddr='auto'
    uci set network.map.ipaddr='auto'
    uci set network.map.ip4prefixlen='auto'
    uci set network.map.ip6prefix='auto'
    uci set network.map.ip6prefixlen='auto'
    uci set network.map.ealen='auto'
    uci set network.map.psidlen='auto'
    uci set network.map.offset='auto'
    
    uci commit network
}

# 言語設定 (LuCIが利用可能な場合)
setup_language() {
    if [ "$LANGUAGE" = "ja" ]; then
        log "日本語設定を適用中..."
        uci set luci.main.lang='ja' 2>/dev/null || true
        uci commit luci 2>/dev/null || true
    fi
}

# ファイアウォール設定
setup_firewall() {
    log "ファイアウォール設定を適用中..."
    
    # SSH許可 (デフォルトで有効だが明示的に設定)
    uci set firewall.@rule[0].target='ACCEPT'
    uci set firewall.@rule[0].src='wan'
    uci set firewall.@rule[0].proto='tcp'
    uci set firewall.@rule[0].dest_port='22'
    uci set firewall.@rule[0].name='Allow-SSH'
    
    uci commit firewall
}

# パッケージ更新
update_packages() {
    log "パッケージリストを更新中..."
    opkg update
    
    # 基本的な追加パッケージをインストール
    log "基本パッケージをインストール中..."
    opkg install luci-ssl luci-i18n-base-ja luci-i18n-firewall-ja 2>/dev/null || true
}

# サービス再起動
restart_services() {
    log "サービスを再起動中..."
    /etc/init.d/network restart
    /etc/init.d/firewall restart
    /etc/init.d/dropbear restart
}

# メイン実行部分
main() {
    log "OpenWrt設定スクリプトを開始..."
    
    # 設定内容をログに記録
    log "設定内容:"
    log "  デバイス名: $DEVICE_NAME"
    log "  WiFi SSID: $WLAN_NAME"
    log "  接続方式: $ISP_MODE"
    log "  言語: $LANGUAGE"
    
    backup_config
    setup_hostname
    setup_root_password
    setup_wifi
    setup_internet
    setup_language
    setup_firewall
    
    # パッケージ更新は時間がかかるため最後に実行
    update_packages
    
    restart_services
    
    log "設定完了！"
    log "設定を有効にするために再起動を推奨します: reboot"
}

# スクリプト実行
main "$@"
