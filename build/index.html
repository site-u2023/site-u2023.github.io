<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt Enhanced Firmware Selector</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #0056b3;
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .language-select {
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wifi-interface {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }
        
        .wifi-interface h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .device-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .build-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }
        
        .build-btn:hover {
            background: #218838;
        }
        
        .build-btn-secondary {
            background: #007bff;
        }
        
        .build-btn-secondary:hover {
            background: #0056b3;
        }
        
        .build-section {
            text-align: center;
            padding: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .preview {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover,
        .autocomplete-active {
            background-color: #007bff;
            color: white;
        }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ OpenWrt Enhanced Firmware Selector</h1>
            <select class="language-select" id="language-select">
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="en">English</option>
            </select>
        </div>
        
        <div class="content">
            <!-- ÂÖ¨Âºè„Éì„É´„ÉÄ„ÉºÁµ±Âêà -->
            <div class="form-section">
                <h3>üì° „Éá„Éê„Ç§„ÇπÈÅ∏Êäû</h3>
                
                <!-- ÂÖ¨Âºè„Å®Âêå„Åò„Éá„Éê„Ç§„ÇπÊ§úÁ¥¢UI -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="models">„Éá„Éê„Ç§„ÇπÂêçÊ§úÁ¥¢</label>
                        <div id="models-autocomplete" class="autocomplete" style="position: relative;">
                            <input id="models" type="text" class="form-control" 
                                   placeholder="„Éá„Éê„Ç§„ÇπÂêç„ÉªÂûãÁï™„ÇíÂÖ•Âäõ (‰æã: BPI-R4, Archer C7)" 
                                   spellcheck="false" autocapitalize="off" autofocus>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="versions">OpenWrt„Éê„Éº„Ç∏„Éß„É≥</label>
                        <select id="versions" class="form-control"></select>
                    </div>
                </div>
                
                <!-- „Éá„Éê„Ç§„ÇπÊÉÖÂ†±Ë°®Á§∫ -->
                <div id="device-info" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <h4>ÈÅ∏Êäû„Åï„Çå„Åü„Éá„Éê„Ç§„Çπ</h4>
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>„É¢„Éá„É´:</strong></div>
                        <div id="device-model">-</div>
                        <div><strong>„Çø„Éº„Ç≤„ÉÉ„Éà:</strong></div>
                        <div id="device-target">-</div>
                        <div><strong>„Éê„Éº„Ç∏„Éß„É≥:</strong></div>
                        <div id="device-version">-</div>
                    </div>
                </div>
            </div>

            <!-- „Éá„Éê„Ç§„ÇπÊ©üËÉΩÈÅ∏Êäû -->
            <div class="form-section">
                <h3>üîß „Éá„Éê„Ç§„ÇπÊ©üËÉΩ</h3>
                <div class="device-features">
                    <div class="feature-item">
                        <input type="checkbox" id="has_usb" checked>
                        <label for="has_usb">USBÂØæÂøú</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_sata">
                        <label for="has_sata">SATAÂØæÂøú</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_pcie">
                        <label for="has_pcie">PCIeÂØæÂøú</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_5g" checked>
                        <label for="has_5g">5G Wi-FiÂØæÂøú</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_6g">
                        <label for="has_6g">6G Wi-FiÂØæÂøú</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_mesh">
                        <label for="has_mesh">MeshÂØæÂøú</label>
                    </div>
                </div>
            </div>

            <!-- „Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂öË®≠ÂÆö -->
            <div class="form-section">
                <h3>üåê „Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂öË®≠ÂÆö</h3>
                <div class="form-group">
                    <label>Êé•Á∂öÊñπÂºè</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="isp_mape" name="isp_type" value="mape" checked>
                            <label for="isp_mape">MAP-EËá™ÂãïË®≠ÂÆö</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="isp_pppoe" name="isp_type" value="pppoe">
                            <label for="isp_pppoe">PPPoEÊé•Á∂ö</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="isp_none" name="isp_type" value="none">
                            <label for="isp_none">Ë®≠ÂÆö„Åó„Å™„ÅÑ</label>
                        </div>
                    </div>
                </div>
                
                <div id="pppoe_settings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pppoe_username">PPPoE „É¶„Éº„Ç∂„ÉºÂêç</label>
                            <input type="text" id="pppoe_username" class="form-control" placeholder="ISP„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç">
                        </div>
                        <div class="form-group">
                            <label for="pppoe_password">PPPoE „Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="pppoe_password" class="form-control" placeholder="ISP„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ">
                        </div>
                    </div>
                </div>
            </div>

            <!-- „Éá„Éê„Ç§„ÇπÂü∫Êú¨Ë®≠ÂÆö -->
            <div class="form-section">
                <h3>‚öôÔ∏è „Éá„Éê„Ç§„ÇπÂü∫Êú¨Ë®≠ÂÆö</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="root_password">ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="root_password" class="form-control" placeholder="„É´„Éº„Çø„ÉºÁÆ°ÁêÜÁî®„Éë„Çπ„ÉØ„Éº„Éâ">
                    </div>
                    <div class="form-group">
                        <label for="lan_ip">LAN IP„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="text" id="lan_ip" class="form-control" value="192.168.1.1">
                    </div>
                </div>
            </div>

            <!-- Wi-FiË®≠ÂÆö -->
            <div class="form-section">
                <h3>üì∂ Wi-FiË®≠ÂÆö</h3>
                <div class="form-group">
                    <label>Wi-FiÊßãÊàêÊñπÂºè</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="wifi_standard" name="wifi_mode" value="standard" checked>
                            <label for="wifi_standard">Ê®ôÊ∫ñË®≠ÂÆö</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="wifi_usteer" name="wifi_mode" value="usteer">
                            <label for="wifi_usteer">usteerÔºà„Éê„É≥„Éâ„Çπ„ÉÜ„Ç¢„É™„É≥„Ç∞Ôºâ</label>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 1 -->
                <div class="wifi-interface">
                    <h4>üì° Wi-Fi Interface 1</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi1_ssid">SSID</label>
                            <input type="text" id="wifi1_ssid" class="form-control" placeholder="MyWiFi">
                        </div>
                        <div class="form-group">
                            <label for="wifi1_password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="wifi1_password" class="form-control" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä">
                        </div>
                        <div class="form-group">
                            <label for="wifi1_band">Â∏ØÂüü</label>
                            <select id="wifi1_band" class="form-control">
                                <option value="">‰ΩøÁî®„Åó„Å™„ÅÑ</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G">5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 2 -->
                <div class="wifi-interface">
                    <h4>üì° Wi-Fi Interface 2</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi2_ssid">SSID</label>
                            <input type="text" id="wifi2_ssid" class="form-control" placeholder="MyWiFi_5G">
                        </div>
                        <div class="form-group">
                            <label for="wifi2_password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="wifi2_password" class="form-control" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä">
                        </div>
                        <div class="form-group">
                            <label for="wifi2_band">Â∏ØÂüü</label>
                            <select id="wifi2_band" class="form-control">
                                <option value="">‰ΩøÁî®„Åó„Å™„ÅÑ</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G" selected>5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 3 -->
                <div class="wifi-interface">
                    <h4>üì° Wi-Fi Interface 3</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi3_ssid">SSID</label>
                            <input type="text" id="wifi3_ssid" class="form-control" placeholder="MyWiFi_6G">
                        </div>
                        <div class="form-group">
                            <label for="wifi3_password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="wifi3_password" class="form-control" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä">
                        </div>
                        <div class="form-group">
                            <label for="wifi3_band">Â∏ØÂüü</label>
                            <select id="wifi3_band" class="form-control">
                                <option value="">‰ΩøÁî®„Åó„Å™„ÅÑ</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G">5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „Éë„ÉÉ„Ç±„Éº„Ç∏Ë®≠ÂÆö -->
            <div class="form-section">
                <h3>üì¶ „Éë„ÉÉ„Ç±„Éº„Ç∏Ë®≠ÂÆö</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_basic" checked>
                        <label for="pkg_basic">Âü∫Êú¨„Çª„ÉÉ„Éà</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_mape">
                        <label for="pkg_mape">MAP-EÂØæÂøú</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_vpn">
                        <label for="pkg_vpn">VPN</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_usb">
                        <label for="pkg_usb">USBÂØæÂøú</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_monitoring">
                        <label for="pkg_monitoring">Áõ£Ë¶ñ„ÉªÁµ±Ë®à</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_docker">
                        <label for="pkg_docker">Docker</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="custom_packages">„Ç´„Çπ„Çø„É†„Éë„ÉÉ„Ç±„Éº„Ç∏</label>
                    <textarea id="custom_packages" class="form-control" placeholder="„Éë„ÉÉ„Ç±„Éº„Ç∏Âêç„ÇíÂÖ•ÂäõÔºà„Çπ„Éö„Éº„ÇπÂå∫Âàá„ÇäÔºâ"></textarea>
                </div>
            </div>

            <!-- „Çπ„ÇØ„É™„Éó„ÉàÁîüÊàê„Éª„Éó„É¨„Éì„É•„Éº -->
            <div class="form-section">
                <h3>üìù uci-defaults„Çπ„ÇØ„É™„Éó„Éà</h3>
                <div class="button-group">
                    <button class="build-btn build-btn-secondary" id="generate-btn">„Çπ„ÇØ„É™„Éó„ÉàÁîüÊàê</button>
                    <button class="build-btn build-btn-secondary" id="copy-btn">„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
                </div>
                
                <div class="preview" id="scriptPreview" style="display: none;">
                    <!-- ÁîüÊàê„Åï„Çå„Åü„Çπ„ÇØ„É™„Éó„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>

            <div class="build-section">
                <p>„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Çπ„ÇØ„É™„Éó„Éà„ÇíÁîüÊàêÂæå„ÄÅ„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÇíÁõ¥Êé•„Éì„É´„Éâ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                
                <div class="button-group">
                    <button class="build-btn" id="test-btn">
                        üß™ „ÉÜ„Çπ„ÉàÔºà„ÇØ„É™„ÉÉ„ÇØÁ¢∫Ë™çÔºâ
                    </button>
                    <button class="build-btn" id="proxy-test-btn" style="background: #ffc107; color: #212529;">
                        üîç „Éó„É≠„Ç≠„Ç∑„ÉÜ„Çπ„Éà
                    </button>
                    <button class="build-btn" id="debug-info-btn" style="background: #6c757d;">
                        üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
                    </button>
                    <button class="build-btn" id="direct-build-btn">
                        üöÄ „Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÇíÁõ¥Êé•„Éì„É´„Éâ
                    </button>
                </div>
                
                <div id="build-status" style="display: none; margin-top: 15px; padding: 15px; border-radius: 4px;">
                    <div id="build-message"></div>
                    <div id="build-progress" style="margin-top: 10px;">
                        <progress id="build-progress-bar" style="width: 100%;" max="100" value="0"></progress>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 4px; font-size: 14px;">
                    <strong>‚úÖ Ë®≠ÂÆöÂÆå‰∫Ü:</strong><br>
                    „Éó„É≠„Ç≠„Ç∑Worker„Åå <code>openwrt-builder-proxy.site-u.workers.dev</code> „Å´„Éá„Éó„É≠„Ç§Ê∏à„Åø„Åß„Åô„ÄÇ<br>
                    „Äåüîç „Éó„É≠„Ç≠„Ç∑„ÉÜ„Çπ„Éà„Äç„Åß„ÉÜ„Çπ„ÉàÂæå„ÄÅ„ÄåüöÄ „Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÇíÁõ¥Êé•„Éì„É´„Éâ„Äç„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Éó„É≠„Ç≠„Ç∑Worker„ÅÆURLÔºà„Éá„Éó„É≠„Ç§Ê∏à„ÅøÔºâ
        const PROXY_URL = 'https://openwrt-builder-proxy.site-u.workers.dev';
        
        // OpenWrtÂÖ¨Âºè„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Çª„É¨„ÇØ„Çø„Éº„ÅÆÊ©üËÉΩ„ÇíÁµ±Âêà
        const config = {
            image_url: "https://downloads.openwrt.org",
            versions: [], // ÂãïÁöÑ„Å´ÂèñÂæó
            default_version: "24.10.2"
        };
        
        let current_device = {};
        let current_overview = {};
        
        // ÂÖ¨Âºè„Å®Âêå„Åò„Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„ÉàÊ©üËÉΩ
        function setupAutocompleteList(input, items, onbegin, onend) {
            let currentFocus = -1;
            
            const collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: "base",
            });
            items.sort(collator.compare);
            
            input.oninput = function () {
                onbegin();
                
                let pattern = this.value;
                closeAllLists();
                
                if (pattern.length === 0) {
                    return false;
                }
                
                if (items.includes(pattern)) {
                    closeAllLists();
                    onend(input);
                    return false;
                }
                
                const list = document.createElement("DIV");
                list.setAttribute("id", this.id + "-autocomplete-list");
                list.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(list);
                
                const patterns = pattern.toUpperCase().split(/\s+/).filter(p => p.length > 0);
                let count = 0;
                
                for (const item of items) {
                    const matches = matchPatterns(item, patterns);
                    if (matches.length === 0) continue;
                    
                    count += 1;
                    if (count >= 15) {
                        let div = document.createElement("DIV");
                        div.innerText = "...";
                        list.appendChild(div);
                        break;
                    } else {
                        let div = document.createElement("DIV");
                        div.innerHTML = highlightMatches(item, matches) + `<input type="hidden" value="${item}">`;
                        
                        div.addEventListener("click", function () {
                            input.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                            onend(input);
                        });
                        
                        list.appendChild(div);
                    }
                }
            };
            
            input.onkeydown = function (e) {
                let x = document.getElementById(this.id + "-autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode === 40) {
                    currentFocus += 1;
                    setActive(x);
                } else if (e.keyCode === 38) {
                    currentFocus -= 1;
                    setActive(x);
                } else if (e.keyCode === 13) {
                    e.preventDefault();
                    if (currentFocus > -1 && x) x[currentFocus].click();
                }
            };
            
            input.onkeyup = function (e) {
                if (e && (e.key === "Enter" || e.keyCode === 13)) {
                    onend(input);
                }
            };
            
            function setActive(xs) {
                if (!xs) return false;
                for (const x of xs) {
                    x.classList.remove("autocomplete-active");
                }
                if (currentFocus >= xs.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = xs.length - 1;
                xs[currentFocus].classList.add("autocomplete-active");
            }
            
            function closeAllLists(elmnt) {
                const items = document.querySelectorAll(".autocomplete-items");
                for (const x of items) {
                    if (elmnt !== x && elmnt !== input) {
                        x.parentNode.removeChild(x);
                    }
                }
            }
            
            document.addEventListener("click", (e) => {
                closeAllLists(e.target);
            });
        }
        
        // „Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ„É≥„Ç∞Èñ¢Êï∞
        function matchPatterns(value, patterns) {
            const item = value.toUpperCase();
            let matches = [];
            for (const p of patterns) {
                const i = item.indexOf(p);
                if (i === -1) return [];
                matches.push({ begin: i, length: p.length });
            }
            return matches.sort((a, b) => a.begin - b.begin);
        }
        
        // „Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
        function highlightMatches(item, matches) {
            let prev = 0;
            let html = "";
            for (const m of matches) {
                html += item.substr(prev, m.begin - prev);
                html += `<strong>${item.substr(m.begin, m.length)}</strong>`;
                prev = m.begin + m.length;
            }
            html += item.substr(prev);
            return html;
        }
        
        // „Éê„Éº„Ç∏„Éß„É≥ÈÅ∏Êäû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        function setupSelectList(select, items, onselection) {
            items.sort((b, a) =>
                (a + (a.indexOf("-") < 0 ? "-Z" : "")).localeCompare(
                    b + (b.indexOf("-") < 0 ? "-Z" : ""),
                    undefined,
                    { numeric: true }
                )
            );
            
            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
            select.innerHTML = '';
            
            for (const item of items) {
                const option = document.createElement("OPTION");
                option.innerText = item;
                option.value = item;
                select.appendChild(option);
            }
            
            select.addEventListener("change", () => {
                onselection(items[select.selectedIndex]);
            });
            
            if (select.selectedIndex >= 0) {
                onselection(items[select.selectedIndex]);
            }
        }
        
        // „Éá„Éê„Ç§„Çπ„É¢„Éá„É´„ÅÆÂ§âÊõ¥Âá¶ÁêÜÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Å´‰øÆÊ≠£Ôºâ
        function changeModel(version, overview, title) {
            console.log('=== „Éá„Éê„Ç§„ÇπÂ§âÊõ¥Âá¶ÁêÜ ===', { version, title });
            
            const entry = overview.profiles[title];
            if (entry) {
                console.log('„Éá„Éê„Ç§„ÇπÊÉÖÂ†±:', entry);
                
                // „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Åß„Éó„É≠„Éï„Ç°„Ç§„É´Ë©≥Á¥∞„ÇíÂèñÂæó
                const base_url = `${PROXY_URL}/releases/${version}`;
                const profileUrl = `${base_url}/targets/${entry.target}/profiles.json`;
                
                console.log('„Éó„É≠„Éï„Ç°„Ç§„É´Ë©≥Á¥∞ÂèñÂæó‰∏≠:', profileUrl);
                
                fetch(profileUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`„Éó„É≠„Éï„Ç°„Ç§„É´ÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(mobj => {
                        console.log('„Éó„É≠„Éï„Ç°„Ç§„É´Ë©≥Á¥∞ÂèñÂæóÊàêÂäü');
                        
                        const device = {
                            id: entry.id,
                            target: entry.target,
                            version: version,
                            model: title,
                            images: mobj.profiles[entry.id]?.images || [],
                            default_packages: mobj.default_packages || [],
                            device_packages: mobj.profiles[entry.id]?.device_packages || []
                        };
                        
                        current_device = device;
                        updateDeviceInfo(device);
                        
                        console.log('‚úÖ „Éá„Éê„Ç§„ÇπË®≠ÂÆöÂÆå‰∫Ü:', device);
                    })
                    .catch(err => {
                        console.error('„Éó„É≠„Éï„Ç°„Ç§„É´ÂèñÂæó„Ç®„É©„Éº:', err);
                        
                        // Âü∫Êú¨ÊÉÖÂ†±„ÅÆ„Åø„Åß„Éá„Éê„Ç§„Çπ„ÇíË®≠ÂÆö
                        const device = {
                            id: entry.id,
                            target: entry.target,
                            version: version,
                            model: title,
                            images: [],
                            default_packages: [],
                            device_packages: []
                        };
                        
                        current_device = device;
                        updateDeviceInfo(device);
                        
                        console.log('‚ö†Ô∏è Âü∫Êú¨ÊÉÖÂ†±„ÅÆ„Åø„Åß„Éá„Éê„Ç§„ÇπË®≠ÂÆö:', device);
                    });
            } else {
                console.error('„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', title);
                console.log('Âà©Áî®ÂèØËÉΩ„Å™„Éá„Éê„Ç§„Çπ‰∏ÄË¶ß:');
                Object.keys(overview.profiles).forEach((key, index) => {
                    if (index < 10) { // ÊúÄÂàù„ÅÆ10‰ª∂„ÅÆ„ÅøË°®Á§∫
                        console.log(`  ${index + 1}. ${key}`);
                    }
                });
                if (Object.keys(overview.profiles).length > 10) {
                    console.log(`  ... ‰ªñ ${Object.keys(overview.profiles).length - 10} ‰ª∂`);
                }
                
                current_device = {};
                hideDeviceInfo();
            }
        }
        
        // „Éá„Éê„Ç§„ÇπÊÉÖÂ†±Ë°®Á§∫Êõ¥Êñ∞
        function updateDeviceInfo(device) {
            document.getElementById('device-model').textContent = device.model;
            document.getElementById('device-target').textContent = device.target;
            document.getElementById('device-version').textContent = device.version;
            document.getElementById('device-info').style.display = 'block';
        }
        
        // „Éá„Éê„Ç§„ÇπÊÉÖÂ†±ÈùûË°®Á§∫
        function hideDeviceInfo() {
            document.getElementById('device-info').style.display = 'none';
        }
        
        // OpenWrtÂÖ¨ÂºèAPI„Åã„ÇâÁâàÊú¨„Å®„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÇíÂèñÂæóÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Å´‰øÆÊ≠£Ôºâ
        async function initOpenWrtData() {
            try {
                console.log('=== OpenWrt „Éá„Éº„ÇøÂàùÊúüÂåñÈñãÂßã ===');
                console.log('„Éó„É≠„Ç≠„Ç∑URL:', PROXY_URL);
                
                // „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Åß„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
                const versionsUrl = `${PROXY_URL}/.versions.json`;
                console.log('„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±ÂèñÂæó‰∏≠:', versionsUrl);
                
                const versionsResponse = await fetch(versionsUrl);
                
                if (!versionsResponse.ok) {
                    throw new Error(`„Éê„Éº„Ç∏„Éß„É≥ÂèñÂæó„Ç®„É©„Éº: ${versionsResponse.status}`);
                }
                
                const versionsData = await versionsResponse.json();
                console.log('„Éê„Éº„Ç∏„Éß„É≥„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', versionsData);
                
                // „Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Çã„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Åø„Éï„Ç£„É´„ÇøÔºàÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÁ∂≠ÊåÅÔºâ
                const unsupported_versions_re = /^(19\.07\.\d|18\.06\.\d|17\.01\.\d)$/;
                const versions = versionsData.versions_list.filter(
                    version => !unsupported_versions_re.test(version)
                );
                versions.push("SNAPSHOT");
                
                config.versions = versions;
                config.default_version = versionsData.stable_version || "24.10.2";
                
                console.log('Âà©Áî®ÂèØËÉΩ„Éê„Éº„Ç∏„Éß„É≥:', versions);
                
                // „Éê„Éº„Ç∏„Éß„É≥ÈÅ∏Êäû„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºàÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÁ∂≠ÊåÅÔºâ
                setupSelectList(document.getElementById('versions'), versions, (version) => {
                    loadDevicesForVersion(version);
                });
                
                console.log('‚úÖ OpenWrt „Éá„Éº„ÇøÂàùÊúüÂåñÂÆå‰∫Ü');
                
            } catch (error) {
                console.error('OpenWrt „Éá„Éº„ÇøÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                
                // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ - ÊâãÂãï„Åß„Éê„Éº„Ç∏„Éß„É≥„ÇíË®≠ÂÆö
                console.log('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà');
                const fallbackVersions = ["24.10.2", "23.05.5", "SNAPSHOT"];
                config.versions = fallbackVersions;
                config.default_version = "24.10.2";
                
                setupSelectList(document.getElementById('versions'), fallbackVersions, (version) => {
                    loadDevicesForVersion(version);
                });
                
                // „É¶„Éº„Ç∂„Éº„Å´Áä∂Ê≥Å„ÇíÈÄöÁü•
                showNetworkError('„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ');
            }
        }
        
        // ÊåáÂÆö„Åï„Çå„Åü„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Éá„Éê„Ç§„Çπ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Å´‰øÆÊ≠£Ôºâ
        function loadDevicesForVersion(version) {
            console.log(`=== „Éá„Éê„Ç§„ÇπË™≠„ÅøËæº„ÅøÈñãÂßã: ${version} ===`);
            
            // „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„Åßoverview.json„ÇíÂèñÂæó
            const overview_url = version === "SNAPSHOT" 
                ? `${PROXY_URL}/snapshots/.overview.json`
                : `${PROXY_URL}/releases/${version}/.overview.json`;
                
            console.log('„Éá„Éê„Ç§„ÇπÊÉÖÂ†±ÂèñÂæó‰∏≠:', overview_url);
            
            fetch(overview_url)
                .then(response => {
                    console.log('„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„É¨„Çπ„Éù„É≥„Çπ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(obj => {
                    console.log('„Éá„Éê„Ç§„ÇπÊÉÖÂ†±ÂèñÂæóÊàêÂäü:', obj);
                    
                    // „Éá„Éê„Ç§„Çπ„Çø„Ç§„Éà„É´„ÇíÁîüÊàêÔºàÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÁ∂≠ÊåÅÔºâ
                    const profiles = {};
                    for (const profile of obj.profiles) {
                        const titles = getModelTitles(profile.titles);
                        for (const title of titles) {
                            if (title.length > 0) {
                                profiles[title] = {
                                    id: profile.id,
                                    target: profile.target,
                                    title: title
                                };
                            }
                        }
                    }
                    
                    current_overview = { profiles };
                    console.log('Âà©Áî®ÂèØËÉΩ„Éá„Éê„Ç§„ÇπÊï∞:', Object.keys(profiles).length);
                    
                    // „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºàÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÁ∂≠ÊåÅÔºâ
                    setupAutocompleteList(
                        document.getElementById('models'),
                        Object.keys(profiles),
                        () => hideDeviceInfo(),
                        (input) => changeModel(version, current_overview, input.value)
                    );
                    
                    console.log('‚úÖ „Éá„Éê„Ç§„ÇπË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                })
                .catch(err => {
                    console.error('„Éá„Éê„Ç§„ÇπË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
                    showNetworkError(`„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                });
        }
        
        // „É¢„Éá„É´„Çø„Ç§„Éà„É´ÁîüÊàêÔºàÂÖ¨Âºè„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØÔºâ
        function getModelTitles(titles) {
            return titles.map((e) => {
                if (e.title) {
                    return e.title;
                } else {
                    return (
                        (e.vendor || "") + " " + (e.model || "") + " " + (e.variant || "")
                    ).trim();
                }
            });
        }
        
        // „Ç®„É©„ÉºË°®Á§∫Èñ¢Êï∞
        function showNetworkError(message) {
            console.warn('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº:', message);
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 15px;
                border-radius: 4px;
                max-width: 400px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            
            errorDiv.innerHTML = `
                <strong>‚ö†Ô∏è „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº</strong><br>
                ${message}<br>
                <small>„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</small>
                <button onclick="this.parentNode.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer; margin-top: -5px;">√ó</button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 10ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 10000);
        }
        
        // „Éë„ÉÉ„Ç±„Éº„Ç∏ÂÆöÁæ©
        const packageSets = {
            basic: ['luci-i18n-base-ja', 'luci-i18n-firewall-ja', 'luci-i18n-opkg-ja'],
            mape: ['map-e', 'kmod-map-e', 'jsonfilter'],
            vpn: ['luci-app-openvpn', 'openvpn-openssl', 'luci-app-wireguard', 'wireguard-tools'],
            usb: ['kmod-usb-storage', 'kmod-fs-ext4', 'kmod-fs-vfat', 'usbutils'],
            monitoring: ['collectd', 'luci-app-statistics', 'iftop', 'htop'],
            docker: ['dockerd', 'docker-compose', 'luci-app-dockerman']
        };
        
        // ISPÈÅ∏Êäû„ÅÆÂ§âÊõ¥Âá¶ÁêÜ
        document.querySelectorAll('input[name="isp_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const pppoeSettings = document.getElementById('pppoe_settings');
                if (this.value === 'pppoe') {
                    pppoeSettings.style.display = 'block';
                } else {
                    pppoeSettings.style.display = 'none';
                }
            });
        });
        
        // „Éë„ÉÉ„Ç±„Éº„Ç∏ÈÅ∏Êäû„ÅÆÂ§âÊõ¥Âá¶ÁêÜ
        document.querySelectorAll('input[type="checkbox"][id^="pkg_"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCustomPackages();
            });
        });
        
        // „Ç´„Çπ„Çø„É†„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊõ¥Êñ∞
        function updateCustomPackages() {
            const customPackagesTextarea = document.getElementById('custom_packages');
            let packages = [];
            
            // „Éá„Éê„Ç§„ÇπÊ©üËÉΩ„ÉÅ„Çß„ÉÉ„ÇØ
            const hasUsb = document.getElementById('has_usb').checked;
            const hasSata = document.getElementById('has_sata').checked;
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éë„ÉÉ„Ç±„Éº„Ç∏„Çª„ÉÉ„Éà„ÇíËøΩÂä†
            Object.keys(packageSets).forEach(key => {
                if (document.getElementById(`pkg_${key}`).checked) {
                    // USBÊ©üËÉΩ„Åå„Å™„ÅÑ„Éá„Éê„Ç§„Çπ„ÅßUSB„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                    if (key === 'usb' && !hasUsb) {
                        console.log('USB packages skipped: device has no USB support');
                        return;
                    }
                    packages = packages.concat(packageSets[key]);
                }
            });
            
            customPackagesTextarea.value = packages.join(' ');
        }
        
        // „Çπ„ÇØ„É™„Éó„ÉàÁîüÊàê
        async function generateScript() {
            try {
                // build-tools.sh„ÇíË™≠„ÅøËæº„Åø
                const response = await fetch('./build-tools.sh');
                if (!response.ok) {
                    throw new Error('build-tools.sh not found');
                }
                const baseScript = await response.text();
                
                // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„Å®„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÇíÂèñÂæó
                const ispType = document.querySelector('input[name="isp_type"]:checked').value;
                const wifiMode = document.querySelector('input[name="wifi_mode"]:checked').value;
                const rootPassword = document.getElementById('root_password').value;
                const lanIp = document.getElementById('lan_ip').value;
                const pppoeUsername = document.getElementById('pppoe_username').value;
                const pppoePassword = document.getElementById('pppoe_password').value;
                
                // „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åï„Çå„ÅüÂ§âÊï∞„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÁîüÊàê
                let customVariables = `# Generated for device: ${current_device.model || 'Unknown'}\n`;
                customVariables += `# Target: ${current_device.target || 'Unknown'}\n`;
                customVariables += `# Version: ${current_device.version || 'Unknown'}\n\n`;
                
                // „Éá„Éê„Ç§„ÇπÂü∫Êú¨Ë®≠ÂÆö
                if (rootPassword) customVariables += `ROOT_PASSWORD="${rootPassword}"\n`;
                if (lanIp && lanIp !== '192.168.1.1') customVariables += `LAN_IP_ADDRESS="${lanIp}"\n`;
                
                // PPPoEË®≠ÂÆö
                if (ispType === 'pppoe' && pppoeUsername && pppoePassword) {
                    customVariables += `PPPOE_USERNAME="${pppoeUsername}"\n`;
                    customVariables += `PPPOE_PASSWORD="${pppoePassword}"\n`;
                }
                
                // Wi-FiË®≠ÂÆö
                for (let i = 1; i <= 3; i++) {
                    const ssid = document.getElementById(`wifi${i}_ssid`).value;
                    const password = document.getElementById(`wifi${i}_password`).value;
                    const band = document.getElementById(`wifi${i}_band`).value;
                    if (ssid && password && band) {
                        customVariables += `WLAN_NAME_${i}="${ssid}"\n`;
                        customVariables += `WLAN_PASSWORD_${i}="${password}"\n`;
                        customVariables += `WLAN_BAND_${i}="${band}"\n`;
                    }
                }
                
                // „É°„Ç§„É≥ÂÆüË°åÈÉ®ÂàÜ„ÇíÊ±∫ÂÆö
                let mainExecution = '';
                if (ispType === 'mape') {
                    mainExecution = 'openwrt_main';
                } else if (ispType === 'pppoe') {
                    mainExecution = 'openwrt_pppoe_main';
                } else {
                    mainExecution = `# No ISP configuration selected
set_device_basic_config
set_wifi_config

uci commit system >/dev/null 2>&1
uci commit wireless >/dev/null 2>&1
uci commit network
echo "Basic configuration done!"`;
                }
                
                // „Ç≥„É°„É≥„ÉàË°å„Åã„ÇâÂ§âÊï∞ÂÆöÁæ©Ë°å„ÇíÊé¢„Åó„Å¶ÁΩÆ„ÅçÊèõ„Åà
                let modifiedScript = baseScript;
                
                // „Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„Åï„Çå„ÅüÂ§âÊï∞ÂÆöÁæ©„ÇíÂÆüÈöõ„ÅÆÂÄ§„Å´ÁΩÆ„ÅçÊèõ„Åà
                const variableLines = customVariables.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                variableLines.forEach(line => {
                    if (line.includes('=')) {
                        const [varName] = line.split('=');
                        const commentedPattern = new RegExp(`# ${varName}=""`, 'g');
                        modifiedScript = modifiedScript.replace(commentedPattern, line);
                    }
                });
                
                // „Éá„Éï„Ç©„É´„Éà„ÅÆ„É°„Ç§„É≥ÂÆüË°å„ÇíÁΩÆ„ÅçÊèõ„Åà
                modifiedScript = modifiedScript.replace('openwrt_main', mainExecution);
                
                // Wi-FiË®≠ÂÆö„Å´Èñ¢„Åô„ÇãËøΩÂä†„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                if (wifiMode === 'usteer') {
                    modifiedScript += `

# usteer band steering configuration
setup_usteer() {
    logger -t mape-setup "Setting up usteer band steering"
    opkg update && opkg install usteer >/dev/null 2>&1
    
    uci set usteer.@usteer[0]=usteer
    uci set usteer.@usteer[0].enabled='1'
    uci set usteer.@usteer[0].debug_level='2'
    uci commit usteer
    
    /etc/init.d/usteer enable
    /etc/init.d/usteer start
}

# Call usteer setup
setup_usteer`;
                }
                
                // ÊúÄÁµÇÁöÑ„Å™„Çπ„ÇØ„É™„Éó„Éà„Å´„Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„ÇíËøΩÂä†
                const finalScript = customVariables + '\n' + modifiedScript;
                
                document.getElementById('scriptPreview').textContent = finalScript;
                document.getElementById('scriptPreview').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating script:', error);
                document.getElementById('scriptPreview').textContent = `# Error: Could not load build-tools.sh
# Make sure build-tools.sh is in the same directory as this HTML file
# Error details: ${error.message}

# Device Information:
# Model: ${current_device.model || 'Not selected'}
# Target: ${current_device.target || 'Not selected'}
# Version: ${current_device.version || 'Not selected'}

#!/bin/sh
# Fallback basic script
echo "Script generation failed. Please check build-tools.sh file."
exit 1`;
                document.getElementById('scriptPreview').style.display = 'block';
            }
        }
        
        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyToClipboard() {
            const script = document.getElementById('scriptPreview').textContent;
            if (!script || script.includes('ÁîüÊàê„Åï„Çå„Åü„Çπ„ÇØ„É™„Éó„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô')) {
                alert('ÂÖà„Å´„Çπ„ÇØ„É™„Éó„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            navigator.clipboard.writeText(script).then(() => {
                alert('„Çπ„ÇØ„É™„Éó„Éà„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            }).catch(() => {
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            });
        }
        
        // „Éì„É´„ÉâÂÆüË°å„ÅÆÈùûÂêåÊúüÈñ¢Êï∞
        async function performBuild(script, buildBtn, buildStatus, buildMessage, progressBar) {
            try {
                // ÈÅ∏Êäû„Åï„Çå„Åü„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÂèñÂæó
                const customPackages = document.getElementById('custom_packages').value;
                const packages = customPackages ? customPackages.split(/\s+/).filter(p => p.trim()) : [];
                
                // „Éá„Éê„Ç§„ÇπÊÉÖÂ†±„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç
                if (!current_device.target) {
                    throw new Error('„Éá„Éê„Ç§„Çπ„ÅÆ„Çø„Éº„Ç≤„ÉÉ„ÉàÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                }
                
                const buildRequest = {
                    profile: current_device.id,
                    target: current_device.target,
                    version: current_device.version || '24.10.2',
                    packages: packages,
                    defaults: script,
                    diff_packages: true,
                    client: "enhanced-firmware-selector"
                };
                
                console.log('Build request:', buildRequest);
                
                buildMessage.textContent = '„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„ÉºÁµåÁî±„Åß„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠...';
                progressBar.value = 20;
                
                // „Éó„É≠„Ç≠„Ç∑WorkerÁµåÁî±„ÅßASU API„ÇíÂëº„Å≥Âá∫„Åó
                const response = await fetch(`${PROXY_URL}/api/build`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(buildRequest)
                });
                
                console.log('Response status:', response.status);
                progressBar.value = 40;
                
                if (response.status === 200) {
                    // „Éì„É´„ÉâÂÆå‰∫Ü
                    const result = await response.json();
                    console.log('Build result:', result);
                    buildStatus.style.backgroundColor = '#d4edda';
                    buildMessage.innerHTML = `
                        ‚úÖ „Éì„É´„ÉâÂÆå‰∫ÜÔºÅ<br>
                        <a href="${PROXY_URL}/store/${result.bin_dir}" target="_blank" 
                           style="color: #155724; font-weight: bold;">üì• „Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
                    `;
                    progressBar.value = 100;
                    
                } else if (response.status === 202) {
                    // „Éì„É´„ÉâÈÄ≤Ë°å‰∏≠
                    const result = await response.json();
                    console.log('Build queued:', result);
                    buildMessage.textContent = '„Éì„É´„Éâ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...';
                    progressBar.value = 60;
                    
                    // „Éù„Éº„É™„É≥„Ç∞„Åß„Éì„É´„ÉâÁä∂Ê≥Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (result.request_hash) {
                        checkBuildStatus(result.request_hash);
                    } else {
                        throw new Error('„Éì„É´„Éâ„É™„ÇØ„Ç®„Çπ„Éà„Éè„ÉÉ„Ç∑„É•„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                    
                } else {
                    // „Ç®„É©„Éº
                    const errorText = await response.text();
                    console.error('Build error response:', errorText);
                    let errorMessage = '„Éì„É´„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${errorText}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('Build error:', error);
                buildStatus.style.backgroundColor = '#f8d7da';
                buildMessage.innerHTML = `‚ùå „Ç®„É©„Éº: ${error.message}<br><small>„Éó„É≠„Ç≠„Ç∑Worker„Åå„Éá„Éó„É≠„Ç§„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>`;
                progressBar.value = 0;
            } finally {
                buildBtn.disabled = false;
            }
        }
        
        // „Éì„É´„ÉâÁä∂Ê≥Å„Çí„Éù„Éº„É™„É≥„Ç∞„Åß„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±Ôºâ
        async function checkBuildStatus(requestHash) {
            const buildMessage = document.getElementById('build-message');
            const progressBar = document.getElementById('build-progress-bar');
            const buildStatus = document.getElementById('build-status');
            
            try {
                console.log('Checking build status for hash:', requestHash);
                const response = await fetch(`${PROXY_URL}/api/build/${requestHash}`);
                
                if (response.status === 200) {
                    // „Éì„É´„ÉâÂÆå‰∫Ü
                    const result = await response.json();
                    console.log('Build completed:', result);
                    buildStatus.style.backgroundColor = '#d4edda';
                    buildMessage.innerHTML = `
                        ‚úÖ „Éì„É´„ÉâÂÆå‰∫ÜÔºÅ<br>
                        <a href="${PROXY_URL}/store/${result.bin_dir}" target="_blank" 
                           style="color: #155724; font-weight: bold;">üì• „Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
                    `;
                    progressBar.value = 100;
                    
                } else if (response.status === 202) {
                    // „Åæ„Å†„Éì„É´„Éâ‰∏≠
                    const result = await response.json();
                    console.log('Build in progress:', result);
                    const status = result.imagebuilder_status || result.queue_position || 'Âá¶ÁêÜ‰∏≠';
                    buildMessage.textContent = `„Éì„É´„Éâ‰∏≠: ${status}...`;
                    progressBar.value = Math.min(90, progressBar.value + 5);
                    
                    // 5ÁßíÂæå„Å´ÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
                    setTimeout(() => checkBuildStatus(requestHash), 5000);
                    
                } else {
                    // „Ç®„É©„Éº
                    const errorText = await response.text();
                    console.error('Build status error:', errorText);
                    throw new Error(`„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Ç®„É©„Éº: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Build status check error:', error);
                buildStatus.style.backgroundColor = '#f8d7da';
                buildMessage.textContent = `‚ùå „Ç®„É©„Éº: ${error.message}`;
                progressBar.value = 0;
            }
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©Ôºà„Éõ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞ÂØæÂøúÔºâ
        function buildFirmwareDirectly() {
            console.log('=== buildFirmwareDirectly() called ===');
            console.log('Function start time:', new Date().toISOString());
            console.log('current_device object:', JSON.stringify(current_device, null, 2));
            
            // „Éá„Éê„Ç§„ÇπÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ
            if (!current_device || !current_device.id) {
                console.log('Device check failed - no device selected');
                alert('„Åæ„Åö„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n„Éá„Éê„Ç§„ÇπÁä∂ÊÖã: ' + JSON.stringify(current_device));
                return;
            }
            console.log('‚úÖ Device check passed');
            
            // „Çπ„ÇØ„É™„Éó„ÉàÁ¢∫Ë™ç
            const scriptElement = document.getElementById('scriptPreview');
            console.log('Script element:', scriptElement);
            
            const script = scriptElement ? scriptElement.textContent : '';
            console.log('Script content length:', script.length);
            console.log('Script preview:', script.substring(0, 200) + '...');
            
            if (!script || script.includes('Error:')) {
                console.log('Script check failed');
                alert('„Åæ„Åö„Çπ„ÇØ„É™„Éó„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n„Çπ„ÇØ„É™„Éó„ÉàÁä∂ÊÖã: ' + (script ? '„Ç®„É©„ÉºÂê´„ÇÄ' : 'Êú™ÁîüÊàê'));
                return;
            }
            console.log('‚úÖ Script check passed');
            
            // DOMË¶ÅÁ¥†ÂèñÂæó
            const buildBtn = document.getElementById('direct-build-btn');
            const buildStatus = document.getElementById('build-status');
            const buildMessage = document.getElementById('build-message');
            const progressBar = document.getElementById('build-progress-bar');
            
            console.log('DOM elements:', {
                buildBtn: !!buildBtn,
                buildStatus: !!buildStatus,
                buildMessage: !!buildMessage,
                progressBar: !!progressBar
            });
            
            if (!buildBtn || !buildStatus || !buildMessage || !progressBar) {
                console.error('Some DOM elements are missing');
                alert('ÁîªÈù¢Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('‚úÖ DOM elements check passed');
            
            // UIÊõ¥Êñ∞
            buildBtn.disabled = true;
            buildStatus.style.display = 'block';
            buildStatus.style.backgroundColor = '#d1ecf1';
            buildMessage.textContent = '„Éì„É´„Éâ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...';
            progressBar.value = 10;
            
            console.log('‚úÖ UI updated, starting build process...');
            
            // ÈùûÂêåÊúüÂá¶ÁêÜ„ÇíÈñãÂßã
            performBuild(script, buildBtn, buildStatus, buildMessage, progressBar);
        }
        
        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM loaded, initializing... ===');
            console.log('Page URL:', window.location.href);
            console.log('PROXY_URL:', PROXY_URL);
            
            // ÈáçË¶Å„Å™DOMË¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            const importantElements = [
                'direct-build-btn',
                'test-btn', 
                'proxy-test-btn',
                'scriptPreview',
                'build-status',
                'build-message',
                'build-progress-bar'
            ];
            
            importantElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`Element ${id}:`, !!element);
                if (!element) {
                    console.warn(`‚ö†Ô∏è Missing element: ${id}`);
                }
            });
            
            // „ÉÜ„Çπ„ÉàÈñ¢Êï∞„ÇíÂÖà„Å´Ë®≠ÂÆö
            setupEventListeners();
            
            try {
                updateCustomPackages();
                initOpenWrtData(); // OpenWrtÂÖ¨Âºè„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±Ôºâ
                console.log('‚úÖ Initialization completed successfully');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('ÂàùÊúüÂåñ„Ç®„É©„Éº: ' + error.message);
            }
        });
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // „ÉÜ„Çπ„Éà„Éú„Çø„É≥
            const testBtn = document.getElementById('test-btn');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    alert('JavaScript „ÅØÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
                    console.log('Test button clicked');
                });
                console.log('Test button listener added');
            }
            
            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Éú„Çø„É≥
            const debugBtn = document.getElementById('debug-info-btn');
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    const info = {
                        current_device: current_device,
                        script_length: document.getElementById('scriptPreview')?.textContent?.length || 0,
                        proxy_url: PROXY_URL,
                        functions_available: {
                            buildFirmwareDirectly: typeof buildFirmwareDirectly,
                            generateScript: typeof generateScript,
                            initOpenWrtData: typeof initOpenWrtData
                        }
                    };
                    console.log('=== DEBUG INFO ===', info);
                    alert('„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ„Åó„Åæ„Åó„Åü\n\nF12 ‚Üí Console „Çø„Éñ„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                });
                console.log('Debug button listener added');
            }
            
            // „Éó„É≠„Ç≠„Ç∑„ÉÜ„Çπ„Éà„Éú„Çø„É≥
            const proxyTestBtn = document.getElementById('proxy-test-btn');
            if (proxyTestBtn) {
                proxyTestBtn.addEventListener('click', async function() {
                    console.log('Testing proxy connection...');
                    try {
                        const response = await fetch(`${PROXY_URL}/api/build`, {
                            method: 'OPTIONS'
                        });
                        console.log('Proxy OPTIONS response:', response.status);
                        alert(`„Éó„É≠„Ç≠„Ç∑Êé•Á∂ö„ÉÜ„Çπ„ÉàÁµêÊûú: ${response.status} ${response.statusText || 'Success'}`);
                        
                        // Ë©≥Á¥∞ÊÉÖÂ†±„ÇÇ„É≠„Ç∞Âá∫Âäõ
                        console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                        console.log('Response ok:', response.ok);
                    } catch (error) {
                        console.error('Proxy test error:', error);
                        alert('„Éó„É≠„Ç≠„Ç∑Êé•Á∂ö„Ç®„É©„Éº: ' + error.message + '\n\n„Éó„É≠„Ç≠„Ç∑Worker„Åå„Éá„Éó„É≠„Ç§„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                });
                console.log('Proxy test button listener added');
            }
            
            // „Éì„É´„Éâ„Éú„Çø„É≥
            const buildBtn = document.getElementById('direct-build-btn');
            if (buildBtn) {
                buildBtn.addEventListener('click', buildFirmwareDirectly);
                console.log('Build button listener added successfully');
            } else {
                console.error('Build button not found!');
            }
            
            // „Çπ„ÇØ„É™„Éó„ÉàÁîüÊàê„Éú„Çø„É≥
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    console.log('Generate script button clicked');
                    generateScript();
                });
                console.log('Generate script button listener added');
            }
            
            // „Ç≥„Éî„Éº„Éú„Çø„É≥
            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    console.log('Copy button clicked');
                    copyToClipboard();
                });
                console.log('Copy button listener added');
            }
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });
    </script>
</body>
</html>
