<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>OpenWrt Custom Firmware Selector</title>
    
    <!-- „É™„ÇΩ„Éº„Çπ„Éí„É≥„Éà -->
    <link rel="preconnect" href="https://downloads.openwrt.org">
    <link rel="preconnect" href="https://sysupgrade.openwrt.org">
    <link rel="dns-prefetch" href="https://auto-config.site-u.workers.dev">
    <link rel="dns-prefetch" href="https://site-u.pages.dev">
    
<style>
    /* Âü∫Êú¨„Çπ„Çø„Ç§„É´ */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #000;
    }

    .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 0 15px;
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 300;
        text-align: center;
        margin-bottom: 1rem;
        color: #007bff;
    }

    .lead {
        font-size: 1.25rem;
        font-weight: 300;
        text-align: center;
        margin-bottom: 2rem;
        color: #6c757d;
    }

    /* ÂÖ¨Âºè‰∫íÊèõ„ÅÆ„Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà */
    #models-autocomplete {
        display: flex;
        padding-top: 20px;
    }
    
    .autocomplete {
        position: relative;
        flex-grow: 1;
    }
    
    #models {
        border: 0.06em solid transparent;
        background-color: #f1f1f1;
        padding: 0.8em;
        flex-grow: 1;
        margin-right: 5px;
        border-radius: 0.2em;
        font-size: inherit;
        color: #495057;
    }
    
    #versions {
        border: 0.06em solid transparent;
        background-color: #f1f1f1;
        padding: 0.8em;
        min-width: 8em;
        border-radius: 0.25em;
        font-size: inherit;
        color: #495057;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background-color: #fff;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
        background-color: #e9ecef;
    }

    .autocomplete-active {
        background-color: #00a3e1 !important;
        color: #ffffff;
    }

    /* „Éï„Ç©„Éº„É†Ë¶ÅÁ¥† */
    .form-group {
        margin-bottom: 1rem;
    }

    label {
        display: inline-block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        display: block;
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.25;
        color: #495057;
        background-color: #f1f1f1;
        background-clip: padding-box;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .form-control:not(textarea) {
        height: calc(2.5rem + 2px);
    }

    .form-control:focus {
        color: #495057;
        background-color: #fff;
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .form-control:disabled {
        background-color: #e9ecef;
        color: #495057;
        opacity: 1;
    }

    /* Info/Status „Éú„ÉÉ„ÇØ„Çπ */
    .info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
    }

    .info h5 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .asu-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0.25rem;
    }

    .asu-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0.25rem;
    }

    /* „Éë„ÉÉ„Ç±„Éº„Ç∏„Çª„ÇØ„Ç∑„Éß„É≥ */
    .packages {
        margin: 1.5rem 0;
    }

    .packages h4 {
        margin-bottom: 1rem;
        font-weight: 500;
    }

    /* „Éú„Çø„É≥/„É™„É≥„ÇØ */
    .btn {
        display: inline-block;
        font-weight: 400;
        color: #212529;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        background-color: transparent;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: all 0.15s ease-in-out;
        text-decoration: none;
        box-shadow: 0em 0.06em 0.3em 0em rgba(0, 0, 0, 0.2),
            0em 0.125em 0.125em 0em rgba(0, 0, 0, 0.14),
            0em 0.19em 0.06em -0.125em rgba(0, 0, 0, 0.12);
    }

    .btn-primary {
        color: #fff;
        background-color: #00a3e1;
        border-color: #00a3e1;
    }

    .btn-primary:hover {
        color: #fff;
        background-color: #038fc6;
        border-color: #038fc6;
    }

    .btn-primary:disabled {
        color: #fff;
        background-color: #00a3e1;
        border-color: #00a3e1;
        opacity: 0.65;
    }

    .custom-link,
    .download-link {
        text-decoration: none;
        border-radius: 0.2em;
        padding: 0.8em;
        margin: 0.2em;
        font-size: inherit;
        cursor: pointer;
        letter-spacing: 0.05em;
        display: inline-flex;
        align-items: center;
        line-height: 1;
        vertical-align: middle;
        box-shadow: 0em 0.06em 0.3em 0em rgba(0, 0, 0, 0.2),
            0em 0.125em 0.125em 0em rgba(0, 0, 0, 0.14),
            0em 0.19em 0.06em -0.125em rgba(0, 0, 0, 0.12);
        color: #fff;
        background-color: #00a3e1;
        width: max-content;
    }

    .custom-link:hover,
    .download-link:hover {
        background-color: #038fc6;
        color: #fff;
    }

    /* flexÊèÉ„Åà„Å†„Åë„ÅßÁµ±‰∏Ä„Åó„ÄÅÂÜÖÈÉ®„Ç¢„Ç§„Ç≥„É≥„ÅØÂÖ¨ÂºèÈÄö„Çä:first-child„Å´Áõ¥Êé•content */
    .custom-link > :first-child,
    .download-link > :first-child {
        height: 1em;
        width: auto;
        margin-top: 0;
        margin-right: 15px;
        content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM12 7a1 1 0 0 1 1 1v4h3l-4 4-4-4h3V8a1 1 0 0 1 1-1z' fill='%23fff'/%3E%3C/svg%3E");
    }

    /* „Ç´„Çπ„Çø„É†„Çª„ÇØ„Ç∑„Éß„É≥ */
    .aios-section {
        margin: 1.5rem 0;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    .aios-config {
        margin-top: 1rem;
    }

    #package-selector-config {
        margin-top: 1rem;
        /* displayË®≠ÂÆö„ÅØ‰∏çË¶Å */
    }
    
    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -5px;
        margin-left: -5px;
    }

    .form-row > .form-group {
        padding-right: 5px;
        padding-left: 5px;
        flex: 1;
    }

    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .form-check {
        position: relative;
        display: block;
        padding-left: 1.25rem;
    }

    .form-check-input {
        position: absolute;
        margin-top: 0.3rem;
        margin-left: -1.25rem;
    }

    .form-check-label {
        margin-bottom: 0;
    }

    .conditional-section {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 0.25rem;
        display: none;
    }

    .text-muted {
        color: #6c757d;
    }

    .small {
        font-size: 0.875em;
    }

    /* „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫ */
    .build-progress {
        margin: 1rem 0;
        padding: 1rem;
        background-color: inherit;
        border: 1px solid #2196f3;
        border-radius: 0.25rem;
        display: none;
    }

    .progress {
        width: 100%;
        height: 1rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
    }

    /* „Éë„ÉÉ„Ç±„Éº„Ç∏ÈÅ∏Êäû */
    .package-category {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
    }

    .package-category h6 {
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        font-weight: 500;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .package-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        align-items: flex-start;
    }

    .package-item {
        width: calc(50% - 0.5rem);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0.25rem 0;
        margin-bottom: 0.5rem;
    }

    .package-item .form-check {
        margin-bottom: 0;
        flex: 1;
    }

    .package-link {
        color: #007bff;
        text-decoration: none;
        font-size: 1rem;
    }

    .package-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .package-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin-left: 1.25rem;
        margin-top: 0.1rem;
    }

    .package-hidden {
        opacity: 0.7;
        font-style: italic;
    }

    .package-dependent {
        margin-left: 1.5rem;
        font-size: 0.9em;
        color: #6c757d;
        display: flex;
        align-items: center;
    }

    .package-dependent::before {
        content: "‚Ü≥";
        display: inline-block;
        margin-right: 0.25rem;
        color: #007bff;
    }

    /* ÂÖ¨Âºè„É¨„Ç§„Ç¢„Ç¶„Éà */
    .row {
        display: flex;
        line-height: 1.5;
        padding-left: 1.5em;
        overflow: hidden;
    }

    .col1 {
        display: inline-block;
        width: 6em;
        color: #6c757d;
    }

    .col1:after {
        content: ":";
    }

    .col2 {
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .col2 a {
        margin-right: 1em;
    }

    /* „Ç¢„Ç§„Ç≥„É≥ */
    #image-info {
        width: 1.25em;
        content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='48px' viewBox='0 -2 24 24' width='48px' fill='%23000000'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z'/%3E%3C/svg%3E");
    }

    #image-folder {
        width: 1.25em;
        content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='48px' viewBox='0 -2 24 24' width='48px' fill='%23000000'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z'/%3E%3C/svg%3E");
    }

    #image-link {
        width: 1.25em;
        content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 -2 24 24' width='24px' fill='%23000000'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='m 6.3 17.7 c -1.2 -1.2 -1.2 -3.2 0 -4.4 L 9.10 10.5 7.8 9 4.9 12 c -2 2 -2 5 0 7 2 2 5 2 7 0 l 2.8 -2.8 -1.3 -1.3 -2.8 2.8 c -1.2 1.2 -3.2 1.2 -4.4 0 z M 10 15.5 15.5 10 14 8.5 8.5 14 Z M 12 4.9 9.18 7.8 10.5 9.1 13.4 6.3 c 1.21 -1.2 3.2 -1.2 4.4 0 1.2 1.2 1.2 3.2 0 4.4 l -2.8 2.8 1.3 1.3 2.8 -2.8 c 2 -2 2 -5 0 -7 -2 -2 -5 -2 -7 0 z'/%3E%3C/svg%3E");
    }

    .images {
        margin: 1.5rem 0;
    }

    /* ÁâπÊÆä„Éï„Ç£„Éº„É´„Éâ */
    #mape-gua-section {
        margin-top: 1rem;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    @media (max-width: 576px) {
        #models-autocomplete {
            flex-direction: column;
        }
        
        #versions {
            margin-top: 0.5em;
        }
        
        #models {
            margin-right: 0;
        }
        
        .form-row {
            flex-direction: column;
        }
        
        .radio-group {
            flex-direction: column;
            gap: 0.5rem;
        }

        .package-item {
            width: 100%;
        }
    }

    /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
    @media (prefers-color-scheme: dark) {
        body {
            background-color: #18181b;
            color: #d0d0d0;
        }
        
        #models,
        #versions {
            background-color: #313135;
            color: #d0d0d0;
        }
        
        .form-control {
            background-color: #313135;
            color: #d0d0d0;
        }
        
        .form-control:focus {
            background-color: #313135;
            color: #d0d0d0;
            border-color: #0080b3;
            box-shadow: 0 0 0 0.2rem rgba(0, 128, 179, 0.25);
        }
        
        .form-control:disabled {
            background-color: #313135;
            color: #d0d0d0;
        }
        
        .autocomplete-items {
            background-color: #252528;
            border-color: #444;
        }
        
        .autocomplete-items div {
            background-color: #252528;
            border-color: #444;
        }
        
        .autocomplete-items div:hover,
        .autocomplete-active {
            background-color: #0080b3 !important;
            color: #fff;
        }
        
        .info {
            background-color: #1d4046;
            border-color: #2a5a61;
            color: #d0d0d0;
        }
        
        .asu-info {
            background-color: #1d4046;
            border-color: #2a5a61;
            color: #d0d0d0;
        }
        
        .asu-error {
            background-color: #601b21;
            border-color: #721c24;
            color: #d0d0d0;
        }
        
        .aios-section {
            background-color: #313135;
            border-color: #444;
        }
        
        .package-category {
            background-color: #252528;
            border-color: #444;
        }
        
        .package-category h6 {
            color: #d0d0d0;
            border-color: #444;
        }
        
        .conditional-section {
            background-color: #313135 !important;
            border-color: #444 !important;
        }
        
        #asu-stderr,
        #asu-stdout {
            background-color: #252528 !important;
            color: #d0d0d0;
        }
        
        #image-info,
        #image-folder,
        #image-link {
            filter: invert(100%) sepia(9%) saturate(261%) hue-rotate(281deg) brightness(117%) contrast(100%);
        }

    } /* close @media (prefers-color-scheme: dark) */
</style>

</head>

<body>
    <div class="container">
        <h1>OpenWrt Custom Firmware Selector</h1>
        <p class="lead">Type the name or model of your device, then select a stable build or the nightly "snapshot" build.</p>

        <div id="models-autocomplete" class="autocomplete">
            <input type="text" id="models" placeholder="Type device model" autocomplete="off" spellcheck="false" autocapitalize="off" autofocus>
            <select id="versions">
                <option value="" disabled selected>Loading versions...</option>
            </select>
        </div>

        <div id="info" class="info" style="display: none;">
            <!-- Content will be dynamically generated -->
        </div>

        <div id="images" class="images" style="display: none;">
            <!-- Device images will be shown here -->
        </div>

        <div id="packages" class="packages" style="display: none;">
            <details id="asu">
                <summary>Customize installed packages and/or first boot script</summary>
                
                <!-- „Éë„ÉÉ„Ç±„Éº„Ç∏„Çª„É¨„ÇØ„Çø„Éº„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="aios-section">
                    <details id="use-package-selector-details">
                        <summary>Installed Packages</summary>
                        
                        <div id="package-selector-config">
                            <small class="text-muted">Select additional packages to install. Selected packages will be automatically added to the package list below.</small>
                        <!-- „Éë„ÉÉ„Ç±„Éº„Ç∏Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ -->
                        <div class="package-category">
                          <h6>Package Search</h6>
                          <div id="package-search-autocomplete" class="autocomplete" style="margin-top:1rem;">
                            <input type="text"
                                id="package-search"
                                placeholder="Type package name"
                                autocomplete="off"
                                spellcheck="false"
                                autocapitalize="off"
                                class="form-control">
                          </div>
                        </div>
                        <ul id="installed-packages">
                          <!-- „Éë„ÉÉ„Ç±„Éº„Ç∏‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </ul>
                        
                        <div id="package-categories">
                            <!-- „Ç´„ÉÜ„Ç¥„É™„Éº„Å®„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </div>
                        
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="asu-packages">Packages</label>
                            <textarea id="asu-packages" class="form-control" rows="6" placeholder="luci&#10;luci-ssl&#10;-wpad-basic-wolfssl&#10;wpad-wolfssl"></textarea>
                        </div>
                    </div>
                </div>

                <!-- setup.shË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="aios-section">
                    <details id="use-aios-config-details">
                        <summary>Script to run on first boot (uci-defaults)</summary>
                        
                        <div id="aios-config">
                            <h5>Basic Configuration</h5>
                        
                        <!-- 1Ë°åÁõÆ: Language „Å® Country -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aios-language">Language</label>
                                <select id="aios-language" class="form-control">
                                    <option value="en">English</option>
                                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
                                    <option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏ (Bulgarian)</option>
                                    <option value="ca">Catal√† (Catalan)</option>
                                    <option value="cs">ƒåe≈°tina (Czech)</option>
                                    <option value="da">Dansk (Danish)</option>
                                    <option value="de">Deutsch (German)</option>
                                    <option value="el">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (Greek)</option>
                                    <option value="es">Espa√±ol (Spanish)</option>
                                    <option value="fi">Suomi (Finnish)</option>
                                    <option value="fr">Fran√ßais (French)</option>
                                    <option value="he">◊¢◊ë◊®◊ô◊™ (Hebrew)</option>
                                    <option value="hu">Magyar (Hungarian)</option>
                                    <option value="it">Italiano (Italian)</option>
                                    <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                                    <option value="ko">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                                    <option value="lt">Lietuvi≈≥ (Lithuanian)</option>
                                    <option value="ms">Bahasa Melayu (Malay)</option>
                                    <option value="nl">Nederlands (Dutch)</option>
                                    <option value="no">Norsk (Norwegian)</option>
                                    <option value="pl">Polski (Polish)</option>
                                    <option value="pt">Portugu√™s (Portuguese)</option>
                                    <option value="pt_br">Portugu√™s do Brasil (Portuguese Brazil)</option>
                                    <option value="ro">Rom√¢nƒÉ (Romanian)</option>
                                    <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                                    <option value="sk">Slovenƒçina (Slovak)</option>
                                    <option value="sv">Svenska (Swedish)</option>
                                    <option value="tr">T√ºrk√ße (Turkish)</option>
                                    <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (Ukrainian)</option>
                                    <option value="vi">Ti·∫øng Vi·ªát (Vietnamese)</option>
                                    <option value="zh_cn">ÁÆÄ‰Ωì‰∏≠Êñá (Chinese Simplified)</option>
                                    <option value="zh_tw">ÁπÅÈ´î‰∏≠Êñá (Chinese Traditional)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="aios-country">Country</label>
                                <input type="text" id="aios-country" class="form-control" placeholder="US" maxlength="2">
                                <small class="form-text text-muted">2-letter country code (e.g., US, JP)</small>
                            </div>
                        </div>

                        <!-- 2Ë°åÁõÆ: Timezone „Å® Zone name -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aios-timezone">Timezone</label>
                                <input type="text" id="aios-timezone" class="form-control" placeholder="UTC">
                            </div>
                            <div class="form-group">
                                <label for="aios-zonename">Zone name</label>
                                <input type="text" id="aios-zonename" class="form-control" placeholder="America/New_York">
                                <small class="form-text text-muted">Optional: e.g., America/New_York, Asia/Tokyo</small>
                            </div>
                        </div>

                        <!-- LAN IPv4/IPv6„Ç¢„Éâ„É¨„Çπ -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aios-lan-ipv4">LAN IPv4 Address</label>
                                <input type="text" id="aios-lan-ipv4" class="form-control" placeholder="192.168.1.1" value="192.168.1.1">
                            </div>
                            <div class="form-group">
                                <label for="aios-lan-ipv6">LAN IPv6 Address</label>
                                <input type="text" id="aios-lan-ipv6" class="form-control" placeholder="fd00::1/64">
                                <small class="form-text text-muted">Optional: e.g., fd00::1/64</small>
                            </div>
                        </div>

                        <!-- Device name„Å®Root password -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aios-device-name">Device name</label>
                                <input type="text" id="aios-device-name" class="form-control" placeholder="OpenWrt">
                            </div>
                            <div class="form-group">
                                <label for="aios-root-password">Root password</label>
                                <div style="position: relative;">
                                    <input type="password" id="aios-root-password" class="form-control" placeholder="8+ characters" style="padding-right: 40px;">
                                    <button type="button" id="toggle-password" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;">
                                        <span id="password-icon">üëÅÔ∏è</span>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Leave empty to disable password authentication</small>
                            </div>
                        </div>
                        
                        <h5>Wi-Fi Configuration</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aios-wifi-ssid">Wi-Fi SSID</label>
                                <input type="text" id="aios-wifi-ssid" class="form-control" placeholder="OpenWrt">
                            </div>
                            <div class="form-group">
                                <label for="aios-wifi-password">Wi-Fi password</label>
                                <input type="password" id="aios-wifi-password" class="form-control" placeholder="8+ characters">
                            </div>
                        </div>

                        <h5>Internet Connection</h5>
                        <div class="form-group">
                            <label>Connection mode</label>
                            <div class="radio-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionMode" id="mode-auto" value="auto" checked>
                                    <label class="form-check-label" for="mode-auto">Auto (Recommended)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionMode" id="mode-manual" value="manual">
                                    <label class="form-check-label" for="mode-manual">Manual</label>
                                </div>
                            </div>
                        </div>

                        <div id="manual-connection-section" class="conditional-section">
                            <div class="form-group">
                                <label>Connection type</label>
                                <div class="radio-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="connectionType" id="conn-dhcp" value="dhcp" checked>
                                        <label class="form-check-label" for="conn-dhcp">DHCP</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="connectionType" id="conn-pppoe" value="pppoe">
                                        <label class="form-check-label" for="conn-pppoe">PPPoE</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="connectionType" id="conn-dslite" value="dslite">
                                        <label class="form-check-label" for="conn-dslite">DS-Lite</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="connectionType" id="conn-mape" value="mape">
                                        <label class="form-check-label" for="conn-mape">MAP-E</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="connectionType" id="conn-ap" value="ap">
                                        <label class="form-check-label" for="conn-ap">AP</label>
                                    </div>
                                </div>
                            </div>

                            <!-- PPPoEË®≠ÂÆö -->
                            <div id="pppoe-section" class="conditional-section">
                                <h6>PPPoE Configuration</h6>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="pppoe-username">PPPoE username</label>
                                        <input type="text" id="pppoe-username" class="form-control" placeholder="Username">
                                    </div>
                                    <div class="form-group">
                                        <label for="pppoe-password">PPPoE password</label>
                                        <input type="password" id="pppoe-password" class="form-control" placeholder="Password">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- DS-LiteË®≠ÂÆö -->
                            <div id="dslite-section" class="conditional-section">
                                <h6>DS-Lite Configuration</h6>
                                
                                <div class="form-group">
                                    <label>DS-Lite Configuration Mode</label>
                                    <div class="radio-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="dsliteMode" id="dslite-auto" value="auto" checked>
                                            <label class="form-check-label" for="dslite-auto">Auto (Recommended)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="dsliteMode" id="dslite-manual" value="manual">
                                            <label class="form-check-label" for="dslite-manual">Manual</label>
                                        </div>
                                    </div>
                                    <small class="text-muted">Auto: Use ISP-detected AFTR address | Manual: Specify AFTR settings manually</small>
                                </div>

                                <div id="dslite-manual-config" class="conditional-section">
                                    <div class="form-group">
                                        <label for="dslite-aftr-type">AFTR Type</label>
                                        <select id="dslite-aftr-type" class="form-control" onchange="applyInitialsFromApi('dslite')">
                                            <option value="transix">transix</option>
                                            <option value="xpass">xpass</option>
                                            <option value="v6option">v6option</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="dslite-area">Region</label>
                                        <select id="dslite-area" class="form-control" onchange="applyInitialsFromApi('dslite')">
                                            <option value="east">East Japan</option>
                                            <option value="west">West Japan</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="dslite-aftr-address">AFTR IPv6 Address</label>
                                    <input type="text" id="dslite-aftr-address" class="form-control" placeholder="2404:8e00::feed:100" value="">
                                    <small class="form-text text-muted">Auto mode: Set from ISP detection | Manual mode: Set based on AFTR type and region</small>
                                </div>
                            </div>
                            
                            <!-- MAP-EË®≠ÂÆö -->
                            <div id="mape-manual-section" class="conditional-section">
                                <h6>MAP-E Configuration</h6>
                                <div class="form-group">
                                    <label>MAP-E Connection Mode</label>
                                    <div class="radio-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mapeType" id="mape-auto" value="auto" checked>
                                            <label class="form-check-label" for="mape-auto">Auto (Recommended)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mapeType" id="mape-gua" value="gua">
                                            <label class="form-check-label" for="mape-gua">GUA</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mapeType" id="mape-pd" value="pd">
                                            <label class="form-check-label" for="mape-pd">PD</label>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <strong>Auto-detect</strong>: Automatically retrieve MAP-E technical information and configure with GUA mode (1G/10G compatible)<br>
                                        <strong>Manual selection</strong>: For troubleshooting or specific requirements only
                                    </small>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="mape-br">BR (Border Relay)</label>
                                        <input type="text" id="mape-br" class="form-control" placeholder="2001:db8::1">
                                    </div>
                                    <div class="form-group">
                                        <label for="mape-ealen">EA-len</label>
                                        <input type="number" id="mape-ealen" class="form-control" placeholder="16" min="0" max="48">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="mape-ipv4-prefix">IPv4 Prefix</label>
                                        <input type="text" id="mape-ipv4-prefix" class="form-control" placeholder="192.0.2.0">
                                    </div>
                                    <div class="form-group">
                                        <label for="mape-ipv4-prefixlen">IPv4 Prefix Length</label>
                                        <input type="number" id="mape-ipv4-prefixlen" class="form-control" placeholder="24" min="1" max="32">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="mape-ipv6-prefix">IPv6 Prefix</label>
                                        <input type="text" id="mape-ipv6-prefix" class="form-control" placeholder="2001:db8:8000::">
                                    </div>
                                    <div class="form-group">
                                        <label for="mape-ipv6-prefixlen">IPv6 Prefix Length</label>
                                        <input type="number" id="mape-ipv6-prefixlen" class="form-control" placeholder="32" min="1" max="128">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="mape-psid-offset">PSID Offset</label>
                                    <input type="number" id="mape-psid-offset" class="form-control" placeholder="4" min="0" max="16">
                                </div>
                                <div class="form-group">
                                    <label for="mape-psidlen">PSID Length</label>
                                    <input type="number" id="mape-psidlen" class="form-control" placeholder="6" min="0" max="16">
                                </div>

                                <div id="mape-gua-section" class="form-group" style="display: none;">
                                    <label for="mape-gua-prefix">GUA Prefix</label>
                                    <input type="text" id="mape-gua-prefix" class="form-control" placeholder="2400:4151:80e2:7500::/64">
                                    <small class="form-text text-muted">IPv6 Global Unicast Address prefix for 1G/10G line compatibility</small>
                                </div>
                            </div>
                        </div>

                        <!-- APË®≠ÂÆö -->
                        <div id="ap-section" class="conditional-section">
                            <h6>AP Configuration</h6>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ap-ip-address">IP Address</label>
                                    <input type="text" id="ap-ip-address" class="form-control" value="192.168.1.2">
                                </div>
                                <div class="form-group">
                                    <label for="ap-gateway">Gateway</label>
                                    <input type="text" id="ap-gateway" class="form-control" value="192.168.1.1">
                                </div>
                            </div>
                        </div>
    
                        <div class="form-group">
                            <label>ISP Detection Status</label>
                            <div id="isp-info-display" class="info" style="margin-bottom: 0;">
                                <div id="isp-status-message">ISPÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</div>
                                <div id="isp-technical-info" style="font-family: monospace; font-size: 0.9em; margin-top: 0.5rem; display: none;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="uci-defaults-content">Scripts</label>
                            <textarea id="uci-defaults-content" class="form-control" rows="6" placeholder="#!/bin/sh&#10;&#10;# Your custom script here&#10;# This area is for manual editing - configuration wizard will not overwrite your changes"></textarea>
                        </div>
                    </div>
                </div>

                <a id="request-build" href="javascript:buildAsuRequest()" class="custom-link">
                    <span></span>
                    <span>REQUEST BUILD</span>
                </a>
            </details>
        </div>

        <!-- „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫ -->
        <div id="build-progress" class="build-progress">
            <div id="build-message">Building image...</div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div id="asu-buildstatus" class="asu-info" style="display: none;">
            <span></span>
        </div>

        <div id="asu-log" style="display: none;">
            <details>
                <summary>STDERR</summary>
                <pre id="asu-stderr" style="background: #f8f8f8; padding: 10px; overflow: auto; max-height: 300px;"></pre>
            </details>
            <details>
                <summary>STDOUT</summary>
                <pre id="asu-stdout" style="background: #f8f8f8; padding: 10px; overflow: auto; max-height: 300px;"></pre>
            </details>
        </div>

        <div id="download-links"></div>
    </div>

    <script>
        // setup.sh„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂÜÖËîµÔºàÂ§ñÈÉ®„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø‰∏çË¶ÅÔºâ
        const SETUP_SH_TEMPLATE = `#!/bin/sh
#
# language="en"
# country="US"
# timezone="UTC"
# zonename="America/New_York"
# lan_ip_address="192.168.1.1"
# lan_ipv6_address="fd00::1/64"
# device_name="OpenWrt"
# root_password="Password"
# wlan_name="OpenWrt"
# wlan_password="12345678"
#
# PPPoE settings
# pppoe_username=""
# pppoe_password=""
#
# DS-Lite settings (from API or manual)
# dslite_aftr_address=""
#
# MAP-E settings (from API or manual - all values pre-calculated)
# mape_br=""
# mape_ealen=""
# mape_ipv4_prefix=""
# mape_ipv4_prefixlen=""
# mape_ipv6_prefix=""
# mape_ipv6_prefixlen=""
# mape_psidlen=""
# mape_psid_offset=""
# mape_gua_mode=""
# mape_gua_prefix=""
#
# OpenWrt version flags (one will be set by web)
# openwrt_19=""
# openwrt_21=""
#
# ap_ip_address="192.168.1.2"
# ap_gateway="192.168.1.1"
#
# enable_ttyd=""
# enable_irqbalance=""
# enable_samba4=""

# Network interface names
LAN_DEF="\$(uci -q get network.lan.device || echo lan)"
WAN_DEF="\$(uci -q get network.wan.device || echo wan)"
MAP_NAME="map"
MAP6_NAME="map6"
DSLITE_NAME="dslite"
DSLITE6_NAME="dslite6"
AP_NAME="ap"
AP6_NAME="ap6"

# log potential errors
exec >/tmp/setup.log 2>&1

echo "Starting OpenWrt initial configuration..."

# Configure root password
if [ -n "\${root_password}" ]; then
    echo "Setting root password..."
    (echo "\${root_password}"; sleep 1; echo "\${root_password}") | passwd > /dev/null 2>&1
fi

# Configure device name
if [ -n "\${device_name}" ]; then
    echo "Setting device name: \${device_name}"
    uci set system.@system[0].hostname="\${device_name}"
fi

# Configure LAN IP
if [ -n "\${lan_ip_address}" ]; then
    echo "Setting LAN IP: \${lan_ip_address}"
    uci set network.lan.ipaddr="\${lan_ip_address}"
fi

# Configure LAN IPv6
if [ -n "\${lan_ipv6_address}" ]; then
    echo "Setting LAN IPv6: \${lan_ipv6_address}"
    uci set network.lan.ip6addr="\${lan_ipv6_address}"
fi

# Configure language
if [ -n "\${language}" ]; then
    echo "Setting language: \${language}"
    uci set system.@system[0].language="\${language}"
fi

# Configure country code for wireless
if [ -n "\${country}" ]; then
    echo "Setting country code: \${country}"
    uci set wireless.@wifi-device[0].country="\${country}" 2>/dev/null
fi

# Configure timezone
if [ -n "\${timezone}" ]; then
    echo "Setting timezone: \${timezone}"
    uci set system.@system[0].timezone="\${timezone}"
fi

# Configure zone name (optional)
if [ -n "\${zonename}" ]; then
    echo "Setting zone name: \${zonename}"
    uci set system.@system[0].zonename="\${zonename}"
fi

# Configure WLAN
if [ -n "\${wlan_name}" ] && [ -n "\${wlan_password}" ] && [ \${#wlan_password} -ge 8 ]; then
    echo "Configuring WLAN: \${wlan_name}"
    uci set wireless.@wifi-device[0].disabled='0'
    uci set wireless.@wifi-iface[0].disabled='0'
    uci set wireless.@wifi-iface[0].encryption='sae-mixed'
    uci set wireless.@wifi-iface[0].ssid="\${wlan_name}"
    uci set wireless.@wifi-iface[0].key="\${wlan_password}"
fi

# Configure PPPoE
if [ -n "\${pppoe_username}" ] && [ -n "\${pppoe_password}" ]; then
    echo "Configuring PPPoE..."
    uci set network.wan.proto='pppoe'
    uci set network.wan.username="\${pppoe_username}"
    uci set network.wan.password="\${pppoe_password}"
fi

# Configure DS-Lite
if [ -n "\${dslite_aftr_address}" ]; then
    echo "Configuring DS-Lite: AFTR=\${dslite_aftr_address}"

    # Backup
    cp -p /etc/config/network /etc/config/network.\${DSLITE_NAME}.bak 2>/dev/null
    cp -p /etc/config/dhcp /etc/config/dhcp.\${DSLITE_NAME}.bak 2>/dev/null
    cp -p /etc/config/firewall /etc/config/firewall.\${DSLITE_NAME}.bak 2>/dev/null
    
    # Disable WAN/WAN6
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'
    uci set network.wan6.disabled='1'
    uci set network.wan6.auto='0'
    
    # DS-Lite IPv6 interface
    uci set network.\${DSLITE6_NAME}=interface
    uci set network.\${DSLITE6_NAME}.proto='dhcpv6'
    uci set network.\${DSLITE6_NAME}.device="\${WAN_DEF}"
    uci set network.\${DSLITE6_NAME}.reqaddress='try'
    uci set network.\${DSLITE6_NAME}.reqprefix='auto'
    
    # DS-Lite interface
    uci set network.\${DSLITE_NAME}=interface
    uci set network.\${DSLITE_NAME}.proto='dslite'
    uci set network.\${DSLITE_NAME}.peeraddr="\${dslite_aftr_address}"
    uci set network.\${DSLITE_NAME}.tunlink="\${DSLITE6_NAME}"
    uci set network.\${DSLITE_NAME}.mtu='1460'
    uci set network.\${DSLITE_NAME}.encaplimit='ignore'
    
    # DHCP settings
    uci set dhcp.\${DSLITE6_NAME}=dhcp
    uci set dhcp.\${DSLITE6_NAME}.interface="\${DSLITE6_NAME}"
    uci set dhcp.\${DSLITE6_NAME}.master='1'
    uci set dhcp.\${DSLITE6_NAME}.ra='relay'
    uci set dhcp.\${DSLITE6_NAME}.dhcpv6='relay'
    uci set dhcp.\${DSLITE6_NAME}.ndp='relay'
    uci set dhcp.\${DSLITE6_NAME}.ignore='1'
    
    # LAN IPv6 relay
    uci set dhcp.lan.ra='relay'
    uci set dhcp.lan.dhcpv6='relay'
    uci set dhcp.lan.ndp='relay'
    uci set dhcp.lan.force='1'
    
    # Firewall
    uci add_list firewall.@zone[1].network="\${DSLITE_NAME}"
    uci add_list firewall.@zone[1].network="\${DSLITE6_NAME}"
    uci set firewall.@zone[1].masq='1'
    uci set firewall.@zone[1].mtu_fix='1'
fi

# Configure MAP-E
if [ -n "\${mape_br}" ] && [ -n "\${mape_ealen}" ]; then
    echo "Configuring MAP-E: BR=\${mape_br}, EA-len=\${mape_ealen}"

    # Backup
    cp -p /etc/config/network /etc/config/network.\${MAP_NAME}.bak 2>/dev/null
    cp -p /etc/config/dhcp /etc/config/dhcp.\${MAP_NAME}.bak 2>/dev/null
    cp -p /etc/config/firewall /etc/config/firewall.\${MAP_NAME}.bak 2>/dev/null
    cp -p /lib/netifd/proto/map.sh /etc/config/firewall.\${MAP_NAME}.bak 2>/dev/null
    
    # Install map.sh (WEB side embeds content here)
    cat > /lib/netifd/proto/map.sh << 'MAP_SH_EOF'
\${map_sh_content}
MAP_SH_EOF
    
    # Disable WAN/WAN6
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'
    uci set network.wan6.disabled='1'
    uci set network.wan6.auto='0'
    
    # MAP-E IPv6 interface
    uci set network.\${MAP6_NAME}=interface
    uci set network.\${MAP6_NAME}.proto='dhcpv6'
    uci set network.\${MAP6_NAME}.device="\${WAN_DEF}"
    uci set network.\${MAP6_NAME}.reqaddress='try'
    uci set network.\${MAP6_NAME}.reqprefix='auto'
    
    # MAP-E interface
    uci set network.\${MAP_NAME}=interface
    uci set network.\${MAP_NAME}.proto='map'
    uci set network.\${MAP_NAME}.maptype='map-e'
    uci set network.\${MAP_NAME}.peeraddr="\${mape_br}"
    uci set network.\${MAP_NAME}.ipaddr="\${mape_ipv4_prefix}"
    uci set network.\${MAP_NAME}.ip4prefixlen="\${mape_ipv4_prefixlen}"
    uci set network.\${MAP_NAME}.ip6prefix="\${mape_ipv6_prefix}"
    uci set network.\${MAP_NAME}.ip6prefixlen="\${mape_ipv6_prefixlen}"
    uci set network.\${MAP_NAME}.ealen="\${mape_ealen}"
    uci set network.\${MAP_NAME}.psidlen="\${mape_psidlen}"
    uci set network.\${MAP_NAME}.offset="\${mape_psid_offset}"
    uci set network.\${MAP_NAME}.mtu='1460'
    uci set network.\${MAP_NAME}.encaplimit='ignore'
    
    # DHCP settings
    uci set dhcp.\${MAP6_NAME}=dhcp
    uci set dhcp.\${MAP6_NAME}.interface="\${MAP6_NAME}"
    uci set dhcp.\${MAP6_NAME}.master='1'
    uci set dhcp.\${MAP6_NAME}.ra='relay'
    uci set dhcp.\${MAP6_NAME}.dhcpv6='relay'
    uci set dhcp.\${MAP6_NAME}.ndp='relay'
    
    # LAN IPv6 relay
    uci set dhcp.lan.ra='relay'
    uci set dhcp.lan.dhcpv6='relay'
    uci set dhcp.lan.ndp='relay'
    uci set dhcp.lan.force='1'
    
    # Firewall
    uci add_list firewall.@zone[1].network="\${MAP_NAME}"
    uci add_list firewall.@zone[1].network="\${MAP6_NAME}"
    uci set firewall.@zone[1].masq='1'
    uci set firewall.@zone[1].mtu_fix='1'
fi

# MAP-E GUA mode settings
if [ -n "\${mape_gua_mode}" ]; then
    echo "Setting MAP-E GUA prefix: \${mape_gua_prefix}"
    uci set network.\${MAP6_NAME}.ip6prefix="\${mape_gua_prefix}"
fi

# OpenWrt 19.x specific MAP-E settings
if [ -n "\${openwrt_19}" ]; then
    echo "Applying OpenWrt 19.x specific settings"
    uci add_list network.\${MAP_NAME}.tunlink="\${MAP6_NAME}"
fi

# OpenWrt 21.02+ specific MAP-E settings
if [ -n "\${openwrt_21}" ]; then
    echo "Applying OpenWrt 21.02+ specific settings"
    uci set network.\${MAP_NAME}.legacymap='1'
    uci set network.\${MAP_NAME}.tunlink="\${MAP6_NAME}"
    uci set dhcp.\${MAP6_NAME}.ignore='1'
fi

# Configure Access point
if [ -n "\${ap_ip_address}" ]; then
    echo "Configuring Dumb AP: IP=\${ap_ip_address} GW=\${ap_gateway}"
    
    # Backup
    cp -p /etc/config/network /etc/config/network.\${AP_NAME}.bak 2>/dev/null
    cp -p /etc/config/dhcp /etc/config/dhcp.\${AP_NAME}.bak 2>/dev/null
    cp -p /etc/config/firewall /etc/config/firewall.\${AP_NAME}.bak 2>/dev/null

    # Disable WAN/WAN6
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'
    uci set network.wan6.disabled='1'
    uci set network.wan6.auto='0'

    # IPv4 Access point
    uci set network.\${AP_NAME}=interface
    uci set network.\${AP_NAME}.proto='static'
    uci set network.\${AP_NAME}.device="\${LAN_DEF}"
    uci set network.\${AP_NAME}.ipaddr="\${ap_ip_address}"
    uci set network.\${AP_NAME}.netmask='255.255.255.0'
    uci set network.\${AP_NAME}.gateway="\${dumb_gateway}"
    uci set network.\${AP_NAME}.dns="\${dumb_gateway}"
    uci set network.\${AP_NAME}.delegate='0'

    # IPv6 Access point
    uci set network.\${AP6_NAME}=interface
    uci set network.\${AP6_NAME}.proto='dhcpv6'
    uci set network.\${AP6_NAME}.device="@\${AP_NAME}"
    uci set network.\${AP6_NAME}.reqaddress='try'
    uci set network.\${AP6_NAME}.reqprefix='no'
    uci set network.\${AP6_NAME}.type='bridge'

    # WLAN attach
    [ -n "\$(uci -q get wireless.default_radio0)" ] && uci set wireless.default_radio0.network="\${AP_NAME}"
    [ -n "\$(uci -q get wireless.default_radio1)" ] && uci set wireless.default_radio1.network="\${AP_NAME}"
    [ -n "\$(uci -q get wireless.default_radio2)" ] && uci set wireless.default_radio2.network="\${AP_NAME}"

    # Disable services only if enabled/running
    [ -x /etc/init.d/odhcpd ] && /etc/init.d/odhcpd enabled && /etc/init.d/odhcpd disable
    [ -x /etc/init.d/odhcpd ] && /etc/init.d/odhcpd running && /etc/init.d/odhcpd stop
    [ -x /etc/init.d/dnsmasq ] && /etc/init.d/dnsmasq enabled && /etc/init.d/dnsmasq disable
    [ -x /etc/init.d/dnsmasq ] && /etc/init.d/dnsmasq running && /etc/init.d/dnsmasq stop
    [ -x /etc/init.d/firewall ] && /etc/init.d/firewall enabled && /etc/init.d/firewall disable
    [ -x /etc/init.d/firewall ] && /etc/init.d/firewall running && /etc/init.d/firewall stop
fi

# Configure ttyd
if [ -n "$enable_ttyd" ]; then
    echo "Enabling ttyd service..." 
    uci set ttyd.@ttyd[0].ttyd.ipv6='1' 
    uci set ttyd.@ttyd[0].command='/bin/login -f root' 
fi 

# Configure irqbalance
if [ -n "$enable_irqbalance" ]; then
    echo "Enabling irqbalance service..."
    uci set irqbalance.irqbalance=irqbalance
    uci set irqbalance.irqbalance.enabled='1'
fi

# Configure samba4
if [ -n "$enable_samba4" ]; then
    NAS="openwrt"
    MNT="/mnt/sda"
    uci set samba4.@samba[0]=samba
    uci set samba4.@samba[0].workgroup='WORKGROUP'
    uci set samba4.@samba[0].charset='UTF-8'
    uci set samba4.@samba[0].description='Samba on OpenWRT'
    uci set samba4.@samba[0].enable_extra_tuning='1'
    uci set samba4.@samba[0].interface='lan'
    uci set samba4.sambashare=sambashare
    uci set samba4.sambashare.name="\${NAS}"
    uci set samba4.sambashare.path="\${MNT}"
    uci set samba4.sambashare.read_only='no'
    uci set samba4.sambashare.force_root='1'
    uci set samba4.sambashare.guest_ok='yes'
    uci set samba4.sambashare.inherit_owner='yes'
    uci set samba4.sambashare.create_mask='0777'
    uci set samba4.sambashare.dir_mask='0777'
fi

# Commit all changes
echo "Committing UCI configuration..."
uci commit 2>/dev/null

echo "Configuration completed successfully!"
echo "All done!"
exit 0`;

// config.jsÁõ∏ÂΩì„ÅÆË®≠ÂÆö
const config = {
    show_help: true,
    image_url: "https://downloads.openwrt.org",
    info_url: "https://openwrt.org/start?do=search&id=toh&q={title} @toh",
    asu_url: "https://sysupgrade.openwrt.org",
    asu_extra_packages: ["luci"],
    feeds: ["base", "luci", "packages", "routing", "telephony"]
};

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let app = {
    versions: [],
    devices: [],
    selectedDevice: null,
    selectedVersion: '',
    templateLoaded: false,
    availablePackages: [] // „Éá„Éê„Ç§„ÇπÂõ∫Êúâ„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏„É™„Çπ„Éà
};
        
// map.sh„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
let mapShCache = {
    'new': null,
    '19': null
};

// „Éë„ÉÉ„Ç±„Éº„Ç∏„Éá„Éº„Çø„Éô„Éº„Çπ
const PACKAGE_DB = {
    categories: [
        {
            id: "basic-system",
            name: "Basic System Features",
            description: "Terminal access and file transfer tools",
            packages: [
                {
                    id: "ttyd",
                    name: "ttyd",
                    url: "https://openwrt.org/packages/pkgdata/ttyd",
                    enableVar: "enable_ttyd"
                },
                {
                    id: "openssh-sftp-server",
                    name: "openssh-sftp-server",
                    url: "https://openwrt.org/packages/pkgdata/openssh-sftp-server"
                },
                {
                    id: "luci-app-commands",
                    name: "luci-app-commands",
                    url: "https://openwrt.org/packages/pkgdata/luci-app-commands"
                },
                {
                    id: "luci-app-filebrowser",
                    name: "luci-app-filebrowser",
                    url: "https://openwrt.org/packages/pkgdata/luci-app-filebrowser"
                }
            ]
        },
        {
            id: "system-management",
            name: "System Management",
            description: "CPU interrupt balancing for multi-core systems",
            packages: [
                { 
                    id: "irqbalance", 
                    name: "irqbalance", 
                    url: "https://openwrt.org/packages/pkgdata/irqbalance",
                    enableVar: "enable_irqbalance"
                }
            ]
        },
        {
            id: "network-management",
            name: "Network Management",
            description: "QoS, bandwidth monitoring, Wi-Fi scheduling, and network utilities",
            packages: [
                { 
                    id: "luci-app-qos", 
                    name: "luci-app-qos", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-qos"
                },
                { 
                    id: "luci-app-sqm", 
                    name: "luci-app-sqm", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-sqm",
                    dependencies: ["tc-full"]
                },
                { 
                    id: "tc-full", 
                    name: "tc-full", 
                    url: "https://openwrt.org/packages/pkgdata/tc-full",
                    hidden: true
                },
                { 
                    id: "luci-app-statistics", 
                    name: "luci-app-statistics", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-statistics",
                    dependencies: ["collectd", "rrdtool1"]
                },
                { 
                    id: "collectd", 
                    name: "collectd", 
                    url: "https://openwrt.org/packages/pkgdata/collectd",
                    hidden: true
                },
                { 
                    id: "rrdtool1", 
                    name: "rrdtool1", 
                    url: "https://openwrt.org/packages/pkgdata/rrdtool1",
                    hidden: true
                },
                { 
                    id: "nlbwmon", 
                    name: "nlbwmon", 
                    url: "https://openwrt.org/packages/pkgdata/nlbwmon"
                },
                { 
                    id: "wifischedule", 
                    name: "wifischedule", 
                    url: "https://openwrt.org/packages/pkgdata/wifischedule"
                },
                { 
                    id: "luci-app-wol", 
                    name: "luci-app-wol", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-wol"
                },
                { 
                    id: "luci-app-ddns", 
                    name: "luci-app-ddns", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-ddns"
                }
            ]
        },
        {
            id: "security-tools",
            name: "Security Tools",
            description: "Intrusion prevention and IP blocking tools",
            packages: [
                { 
                    id: "znc-mod-fail2ban", 
                    name: "znc-mod-fail2ban", 
                    url: "https://openwrt.org/packages/pkgdata/znc-mod-fail2ban"
                },
                { 
                    id: "banip", 
                    name: "banip", 
                    url: "https://openwrt.org/packages/pkgdata/banip"
                }
            ]
        },
        {
            id: "system-monitoring",
            name: "System Monitoring",
            description: "System watchdog and network monitoring",
            packages: [
                { 
                    id: "luci-app-watchcat", 
                    name: "luci-app-watchcat", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-watchcat"
                }
            ]
        },
        {
            id: "diagnostic-tools",
            name: "Network Diagnostic Tools",
            description: "System monitoring and network analysis tools",
            packages: [
                { 
                    id: "htop", 
                    name: "htop", 
                    url: "https://openwrt.org/packages/pkgdata/htop",
                    dependencies: ["collectd", "collectd-mod-thermal"]
                },
                { 
                    id: "collectd-mod-thermal", 
                    name: "collectd-mod-thermal", 
                    url: "https://openwrt.org/packages/pkgdata/collectd-mod-thermal",
                    hidden: true
                },
                { 
                    id: "mtr", 
                    name: "mtr", 
                    url: "https://openwrt.org/packages/pkgdata/mtr"
                },
                { 
                    id: "nmap", 
                    name: "nmap", 
                    url: "https://openwrt.org/packages/pkgdata/nmap"
                },
                { 
                    id: "tcpdump", 
                    name: "tcpdump", 
                    url: "https://openwrt.org/packages/pkgdata/tcpdump"
                }
            ]
        },
        {
            id: "themes-dashboard",
            name: "Themes and Dashboard",
            description: "UI themes and dashboard improvements",
            packages: [
                { 
                    id: "luci-theme-openwrt", 
                    name: "luci-theme-openwrt", 
                    url: "https://openwrt.org/packages/pkgdata/luci-theme-openwrt",
                    dependencies: ["luci-theme-material", "luci-theme-openwrt-2020"]
                },
                { 
                    id: "luci-theme-material", 
                    name: "luci-theme-material", 
                    url: "https://openwrt.org/packages/pkgdata/luci-theme-material"
                },
                { 
                    id: "luci-theme-openwrt-2020", 
                    name: "luci-theme-openwrt-2020", 
                    url: "https://openwrt.org/packages/pkgdata/luci-theme-openwrt-2020"
                },
                { 
                    id: "luci-mod-dashboard", 
                    name: "luci-mod-dashboard", 
                    url: "https://openwrt.org/packages/pkgdata/luci-mod-dashboard"
                }
            ]
        },
        {
            id: "utilities",
            name: "Utilities",
            description: "System upgrade tools and VPN utilities",
            packages: [
                { 
                    id: "attendedsysupgrade-common", 
                    name: "attendedsysupgrade-common", 
                    url: "https://openwrt.org/packages/pkgdata/attendedsysupgrade-common"
                },
                { 
                    id: "wireguard-tools", 
                    name: "wireguard-tools", 
                    url: "https://openwrt.org/packages/pkgdata/wireguard-tools"
                },
                { 
                    id: "luci-app-wireguard", 
                    name: "luci-app-wireguard", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-wireguard",
                    dependencies: ["wireguard-tools"]
                },
                { 
                    id: "luci-app-dockerman",
                    name: "luci-app-dockerman",
                    url: "https://openwrt.org/packages/pkgdata/luci-app-dockerman",
                    dependencies: ["docker-compose"]
                },
                { 
                    id: "docker-compose",
                    name: "docker-compose",
                    url: "https://openwrt.org/packages/pkgdata/docker-compose",
                    dependencies: ["docker"],
                    hidden: true
                },
                { 
                    id: "docker",
                    name: "docker",
                    url: "https://openwrt.org/packages/pkgdata/docker",
                    hidden: true
                }
            ]
        },
        {
            id: "usb-storage",
            name: "USB Storage Support",
            description: "USB storage kernel module and filesystem tools",
            packages: [
                { 
                    id: "kmod-usb-storage", 
                    name: "kmod-usb-storage", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-usb-storage",
                    dependencies: ["block-mount", "kmod-usb-storage-uas", "usbutils", "libblkid1", "gdisk"]
                },
                { 
                    id: "block-mount", 
                    name: "block-mount", 
                    url: "https://openwrt.org/packages/pkgdata/block-mount",
                    hidden: true
                },
                { 
                    id: "kmod-usb-storage-uas", 
                    name: "kmod-usb-storage-uas", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-usb-storage-uas",
                    hidden: true
                },
                { 
                    id: "usbutils", 
                    name: "usbutils", 
                    url: "https://openwrt.org/packages/pkgdata/usbutils",
                    hidden: true
                },
                { 
                    id: "libblkid1", 
                    name: "libblkid1", 
                    url: "https://openwrt.org/packages/pkgdata/libblkid1",
                    hidden: true
                },
                {
                    id: "gdisk",
                    name: "gdisk",
                    url: "https://openwrt.org/packages/pkgdata/gdisk",
                    hidden: true
                },
                {
                    id: "dosfstools",
                    name: "dosfstools",
                    url: "https://openwrt.org/packages/pkgdata/dosfstools",
                    dependencies: ["kmod-fs-vfat"]
                },
                { 
                    id: "kmod-fs-vfat", 
                    name: "kmod-fs-vfat", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-vfat",
                    hidden: true
                },
                { 
                    id: "e2fsprogs", 
                    name: "e2fsprogs", 
                    url: "https://openwrt.org/packages/pkgdata/e2fsprogs",
                    dependencies: ["kmod-fs-ext4"]
                },
                { 
                    id: "kmod-fs-ext4", 
                    name: "kmod-fs-ext4", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-ext4",
                    hidden: true
                },
                { 
                    id: "f2fs-tools", 
                    name: "f2fs-tools", 
                    url: "https://openwrt.org/packages/pkgdata/f2fs-tools",
                    dependencies: ["kmod-fs-f2fs"]
                },
                { 
                    id: "kmod-fs-f2fs", 
                    name: "kmod-fs-f2fs", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-f2fs",
                    hidden: true
                },
                { 
                    id: "exfat-fsck", 
                    name: "exfat-fsck", 
                    url: "https://openwrt.org/packages/pkgdata/exfat-fsck",
                    dependencies: ["kmod-fs-exfat"]
                },
                { 
                    id: "kmod-fs-exfat", 
                    name: "kmod-fs-exfat", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-exfat",
                    hidden: true
                },
                { 
                    id: "ntfs-3g", 
                    name: "ntfs-3g", 
                    url: "https://openwrt.org/packages/pkgdata/ntfs-3g",
                    dependencies: ["kmod-fs-ntfs3"]
                },
                { 
                    id: "kmod-fs-ntfs3", 
                    name: "kmod-fs-ntfs3", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-ntfs3",
                    hidden: true
                },
                { 
                    id: "hfsfsck", 
                    name: "hfsfsck", 
                    url: "https://openwrt.org/packages/pkgdata/hfsfsck",
                    dependencies: ["kmod-fs-hfs", "kmod-fs-hfsplus"]
                },
                { 
                    id: "kmod-fs-hfs", 
                    name: "kmod-fs-hfs", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-hfs",
                    hidden: true
                },
                { 
                    id: "kmod-fs-hfsplus", 
                    name: "kmod-fs-hfsplus", 
                    url: "https://openwrt.org/packages/pkgdata/kmod-fs-hfsplus",
                    hidden: true
                },
                { 
                    id: "hdparm", 
                    name: "hdparm", 
                    url: "https://openwrt.org/packages/pkgdata/hdparm",
                    dependencies: ["hd-idle"]
                },
                { 
                    id: "hd-idle", 
                    name: "hd-idle", 
                    url: "https://openwrt.org/packages/pkgdata/hd-idle",
                    hidden: true
                }
            ]
        },
        {
            id: "file-sharing",
            name: "File Sharing",
            description: "SMB/CIFS file sharing server",
            packages: [
                { 
                    id: "luci-app-samba4", 
                    name: "luci-app-samba4", 
                    url: "https://openwrt.org/packages/pkgdata/luci-app-samba4",
                    dependencies: ["wsdd2"],
                    enableVar: "enable_samba4"
                },
                { 
                    id: "wsdd2", 
                    name: "wsdd2", 
                    url: "https://openwrt.org/packages/pkgdata/wsdd2",
                    hidden: true
                }
            ]
        }
    ]
};
        
// AfterÔºàaios-language „ÅÆ change „Éê„Ç§„É≥„Éâ„Çí init ÂÜÖ„Å´ÁßªÂãïÔºâ
document.addEventListener('DOMContentLoaded', init);

function init() {
    const langEl = document.getElementById('aios-language');
    if (langEl) {
        langEl.addEventListener('change', function() {
            refreshTemplateAndPackages();
        });
    }
    // Êó¢Â≠ò„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ„Çí„Åì„Åì„Å´Á∂ö„Åë„Çã‚Ä¶
}

// ==================== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ====================
async function loadPackageDatabase() {
    const res = await fetch('data/packages.json');
    app.packageDB = await res.json();
}

function updateInstalledPackageList() {
    const container = document.getElementById('installed-packages');
    if (!container) return;

    container.innerHTML = '';
    app.packageDB.forEach(pkg => {
        const li = document.createElement('li');
        li.textContent = pkg.name;
        container.appendChild(li);
    });
}

// ==================== ÂàùÊúüÂåñÈñ¢Êï∞ ====================
async function init() {
    try {
        // „Éê„Éº„Ç∏„Éß„É≥Ë™≠„ÅøËæº„Åø
        await loadVersions();

        // „Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞ÔºàË¶ÅÁ¥†Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
        if (typeof bindEvents === 'function') {
            try {
                bindEvents();
            } catch (error) {
                console.error('Failed to bind events:', error);
            }
        }

        // map.sh„Çí‰∫ãÂâç„É≠„Éº„Éâ
        await loadMapShScripts();

        // „Éë„ÉÉ„Ç±„Éº„Ç∏„Çª„É¨„ÇØ„Çø„ÉºÁîüÊàêÔºàDOMÁîüÊàêÂÆå‰∫Ü„ÇíÂæÖÊ©üÔºâ
        try {
            if (typeof generatePackageSelector === 'function') {
                await generatePackageSelector();
                console.log('Package selector generated successfully');
            }
        } catch (error) {
            console.error('Failed to generate package selector:', error);
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊõ¥Êñ∞
        try {
            if (typeof refreshTemplateAndPackages === 'function') {
                await refreshTemplateAndPackages();
            }
        } catch (error) {
            console.error('Failed to refresh template and packages:', error);
        }

        // ====== „Åì„Åì„ÅßÂøÖÈ†àDOM„Å®‰æùÂ≠òÁä∂ÊÖã„ÅåÊèÉ„ÅÜ„Åæ„ÅßÂæÖÊ©ü ======
        await waitForReady([
            'versions',
            'models',
            'use-package-selector'
            // ÂøÖË¶Å„Å™„Çâ‰ªñ„ÅÆË¶ÅÁ¥†„ÇÇËøΩÂä†
        ]);

        // „Éë„ÉÉ„Ç±„Éº„Ç∏DB„Çí„É≠„Éº„ÉâÔºÜUIÂèçÊò†
        try {
            // await loadPackageDatabase();
            // updateInstalledPackageList();
        } catch (error) {
            console.error('Failed to load/update package DB:', error);
        }

        // ISPÊÉÖÂ†±„ÇíÂàùÊúüÂèñÂæó
        console.log('Starting ISP info fetch...');
        await fetchApiInfoAndUpdate();

    } catch (error) {
        console.error('Failed to initialize:', error);
        updateIspDisplay(
            'Initialization error',
            'Failed to initialize application: ' + error.message
        );
    }
}

// ==================== ÂøÖÈ†àË¶ÅÁ¥†„ÅÆÂ≠òÂú®„ÇíÂæÖ„Å§„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ====================
function waitForReady(ids = []) {
    return new Promise(resolve => {
        const check = () => {
            if (ids.every(id => document.getElementById(id))) {
                resolve();
            } else {
                requestAnimationFrame(check);
            }
        };
        check();
    });
}

// ==================== „Éë„ÉÉ„Ç±„Éº„Ç∏Èñ¢Êï∞ ====================
function normalizeLang(lang) {
  const map = {
    en: '',       // Ëã±Ë™û„ÅØ i18n „Éë„ÉÉ„Ç±„Éº„Ç∏‰∏çË¶Å
    pt_br: 'pt-br',
    zh_cn: 'zh-cn',
    zh_tw: 'zh-tw'
  };
  return (map[lang] ?? String(lang || '').toLowerCase());
}

function asuI18nDB(lang) {
  const norm = normalizeLang(lang);
  const isEN = !norm;
  const s = isEN ? '' : `-${norm}`;
  const make = (key) => (isEN ? [] : [`luci-i18n-${key}${s}`]);

  return {
    base: make('base'),
    opkg: make('opkg'),
    firewall: make('firewall'),
    ttyd: make('ttyd'),
    commands: make('commands'),
    irqbalance: make('irqbalance'),
    qos: make('qos'),
    sqm: make('sqm'),
    statistics: make('statistics'),
    nlbwmon: make('nlbwmon'),
    wifischedule: make('wifischedule'),
    wol: make('wol'),
    ddns: make('ddns'),
    banip: make('banip'),
    watchcat: make('watchcat'),
    dashboard: make('dashboard'),
    attendedsysupgrade: make('attendedsysupgrade'),
    dockerman: make('dockerman'),
    'hd-idle': make('hd-idle'),
    samba4: make('samba4'),
  };
}

function asuCollectPackages() {
  const lang = document.getElementById('aios-language').value?.trim() || 'en';
  const norm = normalizeLang(lang);
  const db = asuI18nDB(lang);
  const textarea = document.getElementById('asu-packages');
  let current = split(textarea.value);

  // 1) i18n „ÅÆÊï¥ÁêÜ: Ëã±Ë™û„Å™„ÇâÂÖ® i18n „ÇíÂâäÈô§„ÄÅÈùûËã±Ë™û„Å™„ÇâÁèæÂú®Ë®ÄË™û‰ª•Â§ñ„ÇíÂâäÈô§
  current = current.filter(pkg => {
    if (!pkg.startsWith('luci-i18n-')) return true;
    const m = pkg.match(/^luci-i18n-(.+?)-([A-Za-z]{2}(?:-[A-Za-z]{2})?)$/);
    const suffix = (m && m[2]) ? m[2].toLowerCase() : '';
    if (!norm) return false; // Ëã±Ë™û: i18n ÂÖ®ÊéíÈô§
    return suffix === norm;  // ÁèæÂú®Ë®ÄË™û„ÅÆ„ÅøÊ∏©Â≠ò
  });

  // 2) „Éô„Éº„Çπ„Éë„ÉÉ„Ç±„Éº„Ç∏ÈõÜÂêàÔºà„Çª„É¨„ÇØ„Çø„ÉºÈÅ∏ÊäûÔºãÊâãÂãïÂÖ•Âäõ„ÅÆÂèåÊñπÔºâ
  const baseSet = new Set();

  // „Çª„É¨„ÇØ„Çø„ÉºÈÅ∏Êäû„Åã„Çâ
  document.querySelectorAll('.package-selector-checkbox:checked').forEach(cb => {
    const names = cb.getAttribute('data-package')?.split(/\s+/) || [];
    names.forEach(n => baseSet.add(n));
  });

  // ÊâãÂãïÂÖ•Âäõ„Åã„ÇâÔºàluci-app- „Å†„Åë„Åß„Å™„ÅèÁ¥†„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏Âêç„ÇÇ„Éô„Éº„Çπ„Å®„Åó„Å¶Êâ±„ÅÜÔºâ
  current.forEach(pkg => {
    // Èô§Â§ñ: i18n Ëá™‰Ωì„ÅØ„Éô„Éº„Çπ„Åß„ÅØ„Å™„ÅÑ
    if (pkg.startsWith('luci-i18n-')) return;
    baseSet.add(pkg);
  });

  // 3) ÁèæÂú®Ë®ÄË™û„ÅÆ i18n „Åß„ÇÇ„ÄÅÂØæÂøú„Åô„Çã„Éô„Éº„Çπ„Éë„ÉÉ„Ç±„Éº„Ç∏„Åå„Å™„Åë„Çå„Å∞Èô§ÂéªÔºà„Ç¥„Éº„Çπ„ÉàÈô§ÂéªÔºâ
  current = current.filter(pkg => {
    if (!pkg.startsWith('luci-i18n-')) return true;
    const m = pkg.match(/^luci-i18n-(.+?)-([A-Za-z]{2}(?:-[A-Za-z]{2})?)$/);
    if (!m) return false;
    const key = m[1]; // luci-i18n-<key>-<lang>
    // luci-app-<key> „Åå„Éô„Éº„Çπ„Å´„Å™„Çã„Ç±„Éº„Çπ„Å´ÂØæÂøú
    return baseSet.has(`luci-app-${key}`) || baseSet.has(key);
  });

  // 4) ËøΩÂä†Èñ¢Êï∞
  const add = (pkg) => {
    if (pkg && !current.includes(pkg)) current.push(pkg);
  };

  // 5) ÈùûËã±Ë™û„ÅÆ„Åø„ÄÅÂü∫Êú¨ i18n „ÇíËøΩÂä†
  ['base', 'opkg', 'firewall'].forEach(k => (db[k] || []).forEach(add));

  // 6) i18n ÂØæË±°„Ç≠„ÉºÔºà„Çª„É¨„ÇØ„Çø„Éº„Å®ÊâãÊâì„Å°„ÅÆ‰∏°Êñπ„Åã„ÇâÊäΩÂá∫Ôºâ
  const keys = new Set();

  // „Çª„É¨„ÇØ„Çø„ÉºÈÅ∏Êäû‰∏≠„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏„Åã„Çâ„Ç≠„ÉºÊäΩÂá∫
  document.querySelectorAll('.package-selector-checkbox:checked').forEach(cb => {
    const names = cb.getAttribute('data-package')?.split(/\s+/) || [];
    names.forEach(pkg => {
      const m = pkg.match(/^luci-app-(.+)$/);
      const key = m ? m[1] : pkg;
      if (db[key]) keys.add(key);
    });
  });

  // ÊâãÂãïÂÖ•Âäõ„Åã„Çâ„Ç≠„ÉºÊäΩÂá∫Ôºàluci-app- „Å®Á¥†„ÅÆ‰∏°ÂØæÂøúÔºâ
  current.forEach(pkg => {
    if (pkg.startsWith('luci-i18n-')) return;
    const m = pkg.match(/^luci-app-(.+)$/);
    const key = m ? m[1] : pkg;
    if (db[key]) keys.add(key);
  });

  // 7) ÁèæÂú®Ë®ÄË™û„ÅÆ i18n „ÅÆ„ÅøËøΩÂä†ÔºàËã±Ë™û„ÅØ‰Ωï„ÇÇËøΩÂä†„Åó„Å™„ÅÑÔºâ
  keys.forEach(k => (db[k] || []).forEach(add));

  // 8) ÊúÄÁµÇÈáçË§áÊéíÈô§
  current = Array.from(new Set(current));

  textarea.value = current.join(' ');
}
            
// ==================== map.shÈñ¢ÈÄ£ ====================
async function loadMapShScripts() {
    try {
        // OpenWrt 21.02‰ª•ÈôçÁî®
        if (!mapShCache['new']) {
            const responseNew = await fetch('https://site-u.pages.dev/build/scripts/map.sh.new');
            if (responseNew.ok) {
                mapShCache['new'] = await responseNew.text();
                console.log('Loaded map.sh.new successfully');
            } else {
                console.error('Failed to load map.sh.new');
            }
        }
        
        // OpenWrt 19.xÁî®
        if (!mapShCache['19']) {
            const response19 = await fetch('https://site-u.pages.dev/build/scripts/map.sh.19');
            if (response19.ok) {
                mapShCache['19'] = await response19.text();
                console.log('Loaded map.sh.19 successfully');
            } else {
                console.error('Failed to load map.sh.19');
            }
        }
    } catch (error) {
        console.error('Failed to load map.sh scripts:', error);
    }
}

// map.shÂÜÖÂÆπ„ÇíÂüã„ÇÅËæº„ÇÄÔºàÂêåÊúüÁâà - „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂèñÂæóÔºâ
function loadMapShContentSync(content, osVersion) {
    // ${map_sh_content}„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    if (!content.includes('\\${map_sh_content}')) {
        return content;
    }

    let mapShContent = '';
    
    // OS„Éê„Éº„Ç∏„Éß„É≥„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å™map.sh„ÇíÈÅ∏Êäû
    if (osVersion && osVersion.startsWith('19')) {
        mapShContent = mapShCache['19'] || '';
        console.log('Using map.sh.19 for OpenWrt 19.x');
    } else {
        mapShContent = mapShCache['new'] || '';
        console.log('Using map.sh.new for OpenWrt 21.02+');
    }
    
    // map.sh„ÅåÂèñÂæó„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆË≠¶Âëä
    if (!mapShContent) {
        console.warn('map.sh content not available, using fallback');
        mapShContent = `#!/bin/sh
# MAP-E script not loaded - network download required
# This is a fallback placeholder. The actual script should be downloaded from:
# https://site-u.pages.dev/build/scripts/map.sh.new or map.sh.19
echo "ERROR: map.sh was not properly embedded during build" >&2
exit 1`;
    }
    
    // ${map_sh_content}„ÇíÂÆüÈöõ„ÅÆÂÜÖÂÆπ„ÅßÁΩÆÊèõ
    return content.replace('\\${map_sh_content}', mapShContent);
}
        
// ==================== „Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞ ====================
function bindEvents() {
    const versionsEl = document.getElementById('versions');
    if (versionsEl) versionsEl.addEventListener('change', handleVersionChange);
    
    const modelsEl = document.getElementById('models');
    if (modelsEl) modelsEl.addEventListener('input', handleDeviceSearch);
    
    const aiosConfigDetails = document.getElementById('use-aios-config-details');
    if (aiosConfigDetails) aiosConfigDetails.addEventListener('toggle', toggleAiosConfig);
    
    const pkgSelectorDetails = document.getElementById('use-package-selector-details');
    if (pkgSelectorDetails) pkgSelectorDetails.addEventListener('toggle', togglePackageSelector);
    
    const buildBtnEl = document.getElementById('request-build');
    if (buildBtnEl) buildBtnEl.addEventListener('click', buildAsuRequest);
    
    // ===== Âü∫Êú¨Ë®≠ÂÆö„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    const basicFields = [
        'aios-language',
        'aios-country', 
        'aios-timezone',
        'aios-zonename',
        'aios-lan-ipv4',
        'aios-lan-ipv6',
        'aios-device-name',
        'aios-root-password',
        'aios-wifi-ssid',
        'aios-wifi-password'
    ];
    
    basicFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
            el.addEventListener('input', () => refreshTemplateAndPackages());
        }
    });
    
    // ===== PPPoEË®≠ÂÆö„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    const pppoeFields = [
        'pppoe-username',
        'pppoe-password'
    ];
    
    pppoeFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
            el.addEventListener('input', () => refreshTemplateAndPackages());
        }
    });
    
    // ===== DS-LiteË®≠ÂÆö„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    const dsliteFields = [
        'dslite-aftr-address',
        'dslite-aftr-type',
        'dslite-area'
    ];
    
    dsliteFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
            el.addEventListener('input', () => refreshTemplateAndPackages());
            el.addEventListener('change', () => refreshTemplateAndPackages());
        }
    });
    
    // ===== MAP-EË®≠ÂÆö„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    const mapeFields = [
        'mape-br',
        'mape-ealen',
        'mape-ipv4-prefix',
        'mape-ipv4-prefixlen',
        'mape-ipv6-prefix',
        'mape-ipv6-prefixlen',
        'mape-psid-offset',
        'mape-psidlen',
        'mape-gua-prefix'
    ];
    
    mapeFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
            el.addEventListener('input', () => refreshTemplateAndPackages());
        }
    });
    
    // ===== APË®≠ÂÆö„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    const apFields = [
        'ap-ip-address',
        'ap-gateway'
    ];
    
    apFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
            el.addEventListener('input', () => refreshTemplateAndPackages());
        }
    });
    
    // ===== „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò† =====
    // DS-Lite mode
    document.querySelectorAll('input[name="dsliteMode"]').forEach(radio => {
        radio.addEventListener('change', handleDsliteModeChange);
    });
    
    // Connection mode
    document.querySelectorAll('input[name="connectionMode"]').forEach(radio => {
        radio.addEventListener('change', handleConnectionModeChange);
    });
    
    // Connection type
    document.querySelectorAll('input[name="connectionType"]').forEach(radio => {
        radio.addEventListener('change', handleConnectionTypeChange);
    });
    
    // MAP-E type
    document.querySelectorAll('input[name="mapeType"]').forEach(radio => {
        radio.addEventListener('change', handleMapeTypeChange);
    });
    
    // ===== „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„ÉàÈñ¢ÈÄ£ =====
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.autocomplete')) {
            hideAutocomplete();
        }
    });
    
    // ===== ÂàùÊúüÁä∂ÊÖãË®≠ÂÆöÔºàÂ≠òÂú®Á¢∫Ë™ç„ÅÇ„ÇäÔºâ =====
    const manualSection = document.getElementById('manual-connection-section');
    if (manualSection) manualSection.style.display = 'none';
    
    const pppoeSection = document.getElementById('pppoe-section');
    if (pppoeSection) pppoeSection.style.display = 'none';
    
    const dsliteSection = document.getElementById('dslite-section');
    if (dsliteSection) dsliteSection.style.display = 'none';
    
    const mapeSection = document.getElementById('mape-manual-section');
    if (mapeSection) mapeSection.style.display = 'none';
    
    const apSection = document.getElementById('ap-section');
    if (apSection) apSection.style.display = 'none';
}

// ==================== „Éë„ÉÉ„Ç±„Éº„Ç∏„Çª„É¨„ÇØ„Çø„ÉºÈñ¢ÈÄ£ ====================
function togglePackageSelector(e) {
    const configSection = document.getElementById('package-selector-config');
    configSection.style.display = e.target.open ? 'block' : 'none';
}

function generatePackageSelector() {
    const container = document.getElementById('package-categories');
    if (!container) return;

    container.innerHTML = '';

    // ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏ID„ÅÆÈõÜÂêà„ÇíÊßãÁØâ
    const depIds = new Set();
    PACKAGE_DB.categories.forEach(cat => {
        cat.packages.forEach(pkg => {
            if (pkg.dependencies) {
                pkg.dependencies.forEach(d => depIds.add(d));
            }
        });
    });

    PACKAGE_DB.categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'package-category';

        const categoryTitle = document.createElement('h6');
        categoryTitle.textContent = category.name;
        categoryDiv.appendChild(categoryTitle);

        const packageGrid = document.createElement('div');
        packageGrid.className = 'package-grid';

        category.packages.forEach(pkg => {
            // ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅØ„Éà„ÉÉ„Éó„É¨„Éô„É´ÊèèÁîª„Åó„Å™„ÅÑ
            if (depIds.has(pkg.id)) return;

            // Ë¶™Ë°å
            const packageItem = document.createElement('div');
            packageItem.className = 'package-item';
            if (pkg.hidden) packageItem.classList.add('package-hidden');

            const formCheck = document.createElement('div');
            formCheck.className = 'form-check';

            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input package-selector-checkbox';
            checkbox.type = 'checkbox';
            checkbox.id = `pkg-${pkg.id}`;
            checkbox.setAttribute('data-package', pkg.name);
            if (pkg.dependencies) {
                checkbox.setAttribute('data-dependencies', pkg.dependencies.join(','));
            }
            checkbox.addEventListener('change', handlePackageSelection);

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.setAttribute('for', `pkg-${pkg.id}`);

            const link = document.createElement('a');
            link.href = pkg.url;
            link.target = '_blank';
            link.className = 'package-link';
            link.textContent = pkg.name;

            label.appendChild(link);
            formCheck.appendChild(checkbox);
            formCheck.appendChild(label);
            packageItem.appendChild(formCheck);

            // Â≠êË°åÔºà‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏Ôºâ
            if (pkg.dependencies) {
                pkg.dependencies.forEach(depId => {
                    let depPkg;
                    for (const cat of PACKAGE_DB.categories) {
                        depPkg = cat.packages.find(p => p.id === depId);
                        if (depPkg) break;
                    }

                    const depItem = document.createElement('div');
                    depItem.className = 'package-dependent';

                    const depCheck = document.createElement('input');
                    depCheck.className = 'form-check-input package-selector-checkbox';
                    depCheck.type = 'checkbox';
                    depCheck.id = `pkg-${depPkg ? depPkg.id : depId}`;
                    depCheck.setAttribute('data-package', depPkg ? depPkg.name : depId);
                    depCheck.addEventListener('change', handlePackageSelection);

                    const depLabel = document.createElement('label');
                    depLabel.className = 'form-check-label';
                    depLabel.setAttribute('for', `pkg-${depPkg ? depPkg.id : depId}`);

                    if (depPkg) {
                        const depLink = document.createElement('a');
                        depLink.href = depPkg.url;
                        depLink.target = '_blank';
                        depLink.className = 'package-link';
                        depLink.textContent = depPkg.name;
                        depLabel.appendChild(depLink);
                    } else {
                        depLabel.textContent = depId;
                    }

                    depItem.appendChild(depCheck);
                    depItem.appendChild(depLabel);
                    packageItem.appendChild(depItem);
                });
            }

            packageGrid.appendChild(packageItem);
        });

        categoryDiv.appendChild(packageGrid);

        const description = document.createElement('div');
        description.className = 'package-description';
        description.textContent = category.description;
        categoryDiv.appendChild(description);

        container.appendChild(categoryDiv);
    });
}

function handlePackageSelection(e) {
    const pkg = e.target;
    const packageName = pkg.getAttribute('data-package');
    const isChecked = pkg.checked;

    // „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅÆË®òÈå≤Ôºà‰ªªÊÑè‰∏äÊõ∏„ÅçOKÔºâ
    if (isChecked) {
        pkg.setAttribute('data-user', '1');
    } else {
        pkg.removeAttribute('data-user');
    }

    // ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÂÆåÂÖ®ÂêåË™øÔºà„Ç´„É≥„Éû/Á©∫ÁôΩ„ÅÆ‰∏°ÂØæÂøúÔºâ
    const dependencies = pkg.getAttribute('data-dependencies') || '';
    const depPackages = dependencies.split(/[\s,]+/).map(s => s.trim()).filter(Boolean);

    if (depPackages.length) {
        depPackages.forEach(dep => {
            const depCheckbox = document.querySelector(`#pkg-${dep}`);
            if (!depCheckbox) return;
            depCheckbox.checked = isChecked;
            depCheckbox.disabled = false; // Âøµ„ÅÆ„Åü„ÇÅËß£Èô§
        });
    }

    updatePackageListFromSelector();
}
    
function updatePackageListFromSelector() {
    const packagesTextarea = document.getElementById('asu-packages');
    let currentPackages = split(packagesTextarea.value);
    
    // „Ç∞„É©„Éï„Ç£„Ç´„É´„Çª„É¨„ÇØ„Çø„Éº„ÅßÁÆ°ÁêÜ„Åô„Çã„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„É™„Çπ„Éà
    const selectorPackages = [];
    document.querySelectorAll('.package-selector-checkbox').forEach(checkbox => {
        const pkgName = checkbox.getAttribute('data-package');
        if (pkgName) {
            selectorPackages.push(pkgName);
        }
    });
    
    // Êó¢Â≠ò„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏„Åã„Çâ„ÄÅ„Çª„É¨„ÇØ„Çø„ÉºÁÆ°ÁêÜ„ÅÆ„ÇÇ„ÅÆ„ÇíÂÆåÂÖ®‰∏ÄËá¥„ÅßÂâäÈô§
    currentPackages = currentPackages.filter(pkg => !selectorPackages.includes(pkg));
    
    // „ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíËøΩÂä†
    document.querySelectorAll('.package-selector-checkbox:checked').forEach(checkbox => {
        const pkgName = checkbox.getAttribute('data-package');
        if (pkgName) {
            currentPackages.push(pkgName);
        }
    });

    // ÈáçË§áÊéíÈô§
    currentPackages = Array.from(new Set(currentPackages));
    
    packagesTextarea.value = currentPackages.join(' ');
    
    // „Éë„ÉÉ„Ç±„Éº„Ç∏„Å®„ÉÜ„É≥„Éó„É¨„ÅÆ‰∏ÄÂÖÉÂèçÊò†
    refreshTemplateAndPackages();
}

// ==================== „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ ====================
async function loadVersions() {
    try {
        const response = await fetch('https://downloads.openwrt.org/.versions.json');
        const data = await response.json();

        // ÂÖ¨Âºè„Å®Âêå„Åò: SNAPSHOT„ÇíÊúÄÂàù„Å´ËøΩÂä†
        app.versions = ['SNAPSHOT'];
        
        // ÂÆâÂÆöÁâà„ÇíËøΩÂä†
        if (data.versions_list) {
            app.versions = app.versions.concat(data.versions_list);
        }

        // „Éá„Éï„Ç©„É´„ÉàÈÅ∏Êäû: ÂÖ¨Âºè„Å®Âêå„Åò„ÅèÊúÄÊñ∞„É™„É™„Éº„ÇπÁâàÔºà2Áï™ÁõÆÔºâ
        app.selectedVersion = data.stable_version || (data.versions_list ? data.versions_list[0] : 'SNAPSHOT');

        updateVersionSelect();
        await loadDevices();
    } catch (error) {
        console.error('Failed to load versions:', error);
    }
}

function updateVersionSelect() {
    const select = document.getElementById('versions');
    select.innerHTML = '';

    app.versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version;
        option.textContent = version;
        if (version === app.selectedVersion) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

async function handleVersionChange(e) {
    app.selectedVersion = e.target.value;
    app.selectedDevice = null;
    hideDeviceInfo();
    await loadDevices();
}

// ==================== „Éá„Éê„Ç§„ÇπÁÆ°ÁêÜ ====================
async function loadDevices() {
    if (!app.selectedVersion) return;

    try {
        let url;
        if (app.selectedVersion === 'SNAPSHOT') {
            url = 'https://downloads.openwrt.org/snapshots/.overview.json';
        } else {
            url = `https://downloads.openwrt.org/releases/${app.selectedVersion}/.overview.json`;
        }
        
        const response = await fetch(url);
        const data = await response.json();

        app.devices = data.profiles || [];
    } catch (error) {
        console.error('Failed to load devices:', error);
        app.devices = [];
    }
}

function handleDeviceSearch(e) {
    const query = e.target.value.toLowerCase();

    if (query.length < 2) {
        hideAutocomplete();
        return;
    }

    const matches = app.devices.filter(device => {
        const title = getDeviceTitle(device).toLowerCase();
        return title.includes(query) || device.id.toLowerCase().includes(query);
    }).slice(0, 10);

    showAutocomplete(matches);
}

function getDeviceTitle(device) {
    if (device.titles && device.titles.length > 0) {
        return device.titles[0].title || device.id;
    }
    return device.id;
}

function showAutocomplete(devices) {
    // Êó¢Â≠ò„ÅÆautocomplete-items„ÇíÂâäÈô§
    let existingContainer = document.querySelector('.autocomplete-items');
    if (existingContainer) {
        existingContainer.remove();
    }
    
    // Êñ∞„Åó„Åè‰ΩúÊàê
    const autocompleteDiv = document.getElementById('models-autocomplete');
    const container = document.createElement('div');
    container.className = 'autocomplete-items';
    
    if (devices.length === 0) {
        autocompleteDiv.appendChild(container);
        container.style.display = 'none';
        return;
    }

    // DocumentFragment„Çí‰ΩøÁî®„Åó„Å¶„Éê„ÉÉ„ÉÅÂá¶ÁêÜ
    const fragment = document.createDocumentFragment();
    
    devices.forEach(device => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${getDeviceTitle(device)}</strong><br><small>Target: ${device.target}</small>`;
        div.addEventListener('click', () => selectDevice(device));
        fragment.appendChild(div);
    });
    
    // ‰∏ÄÂ∫¶„Å†„ÅëDOM„Å´ËøΩÂä†
    container.appendChild(fragment);
    autocompleteDiv.appendChild(container);
    container.style.display = 'block';
}
    
function hideAutocomplete() {
    const items = document.querySelector('.autocomplete-items');
    if (items) {
        items.remove();
    }
}

function selectDevice(device) {
    app.selectedDevice = device;
    document.getElementById('models').value = getDeviceTitle(device);
    hideAutocomplete();
    loadDeviceProfile(device);
}

// AfterÔºàÂÖ¨ÂºèÂêåÁ≠â„ÅÆURL„Éû„ÉÉ„Éî„É≥„Ç∞ÊßãÈÄ†„Çí‰Ωø„ÅÑ SNAPSHOT/Release ÂèåÊñπ„Å´ÂØæÂøúÔºâ
async function loadDeviceProfile(device) {
    if (!device || !device.target || !device.id) return;

    const version = app.selectedVersion;
    const target = device.target;
    const profileId = device.id;

    // ÂÖ¨ÂºèÂêåÁ≠âÔºöversion‚ÜíURL „Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÊßãÁØâ
    if (!config.image_urls) config.image_urls = {};
    if (!config.overview_urls) config.overview_urls = {};

    if (version === 'SNAPSHOT') {
        config.overview_urls[version] = `${config.image_url}/snapshots`;
        config.image_urls[version]    = `${config.image_url}/snapshots`;
    } else {
        config.overview_urls[version] = `${config.image_url}/releases/${encodeURIComponent(version)}`;
        config.image_urls[version]    = `${config.image_url}/releases/${encodeURIComponent(version)}`;
    }

    const profilesUrl = `${config.image_urls[version]}/targets/${target}/profiles.json`;

    try {
        console.log(`Loading profile from: ${profilesUrl}`);
        const response = await fetch(profilesUrl, { cache: 'no-cache' });
        if (!response.ok) {
            throw new Error(`Failed to fetch profiles.json: ${response.status}`);
        }
        
        const profilesData = await response.json();
        console.log(`Loaded profiles data:`, profilesData);

        app.versionCode = profilesData.version_code || '';

        if (profilesData.profiles && profilesData.profiles[profileId]) {
            const profile = profilesData.profiles[profileId];
            const defaultPackages = profilesData.default_packages || [];
            const devicePackages = profile.device_packages || [];
            const asuExtraPackages = ['luci'];
            const allPackages = defaultPackages.concat(devicePackages, asuExtraPackages);

            document.getElementById('asu-packages').value = allPackages.join(' ');
            asuCollectPackages(); 
        }

        // profiles.jsonÂèñÂæóÂæå„Å´About„ÇíÂç≥Ë°®Á§∫
        showDeviceInfo();

        // Èáç„ÅÑÂá¶ÁêÜ„ÅØÈùûÂêåÊúü‰∏¶Âàó„ÅßÂÆüË°å
        Promise.allSettled([
            fetchDevicePackages(),
            loadMapShScripts(),
            fetchApiInfoAndUpdate()
        ]).then(() => {
            console.log('Background tasks completed');
        });

    } catch (error) {
        console.error('Failed to load device profile:', error);

        // „Ç®„É©„ÉºÊôÇ„ÇÇAbout„Å†„Åë„ÅØÂç≥Ë°®Á§∫
        showDeviceInfo();

        Promise.allSettled([
            fetchDevicePackages(),
            loadMapShScripts(),
            fetchApiInfoAndUpdate()
        ]).then(() => {
            console.log('Background tasks completed (after error)');
        });
    }
}
       
function showDeviceInfo() {
    if (!app.selectedDevice) return;

    const device = app.selectedDevice;
    
    // „Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÅÆÂèñÂæóÔºà„Éì„É´„ÉâÁï™Âè∑Âê´„ÇÄÔºâ
    let fullVersion = app.selectedVersion;
    if (app.versionCode) {
        fullVersion = `${app.selectedVersion} (${app.versionCode})`;
    }
    
    // URLsÁîüÊàê
    const imageFolder = app.selectedVersion === 'SNAPSHOT' 
        ? `https://downloads.openwrt.org/snapshots/targets/${device.target}`
        : `https://downloads.openwrt.org/releases/${app.selectedVersion}/targets/${device.target}`;
    
    const deviceLink = `${window.location.origin}${window.location.pathname}?version=${encodeURIComponent(app.selectedVersion)}&target=${encodeURIComponent(device.target)}&id=${encodeURIComponent(device.id)}`;
    
    const infoUrl = (config.info_url || "")
        .replace("{title}", encodeURI(getDeviceTitle(device)))
        .replace("{target}", device.target)
        .replace("{id}", device.id)
        .replace("{version}", app.selectedVersion);
    
    // ÂÖ¨ÂºèÂΩ¢Âºè„ÅÆAbout this build„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊßãÁØâ
    const infoHtml = `
        <h5>About this build</h5>
        <div class="row">
            <span class="col1">Model</span>
            <span class="col2" id="image-model"><strong>${getDeviceTitle(device)}</strong></span>
        </div>
        <div class="row">
            <span class="col1">Target</span>
            <span class="col2" id="image-target">${device.target}</span>
        </div>
        <div class="row">
            <span class="col1">Version</span>
            <span class="col2">
                <span id="image-version">${app.selectedVersion}</span>
                (<span id="image-code">${app.versionCode || ''}</span>)
            </span>
        </div>   
        <div class="row">
            <span class="col1">Links</span>
            <span class="col2">
                <a id="image-folder" href="${imageFolder}" title="Browse image folder" target="_blank"></a>
                <a id="image-info" href="${infoUrl}" title="Device info" target="_blank"></a>
                <a id="image-link" href="#" title="Copy link" onclick="navigator.clipboard.writeText('${deviceLink}').then(() => alert('Link copied!')); return false;"></a>
            </span>
        </div>
    `;
    
    document.getElementById('info').innerHTML = infoHtml;
    document.getElementById('info').style.display = 'block';
    document.getElementById('packages').style.display = 'block';
    document.getElementById('request-build').style.display = 'inline-block';

    // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊúÄÂàù„Å´Ë®≠ÂÆöÔºà„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
    const textarea = document.getElementById('uci-defaults-content');
    if (!app.templateLoaded && (!textarea.value || textarea.value.trim() === '')) {
        textarea.value = SETUP_SH_TEMPLATE;
        app.templateLoaded = true;
        console.log('Template loaded for the first time');
    }
}

function hideDeviceInfo() {
    document.getElementById('info').style.display = 'none';
    document.getElementById('packages').style.display = 'none';
    document.getElementById('request-build').style.display = 'none';
}

// ==================== Êé•Á∂öË®≠ÂÆöÂ§âÊõ¥ÂèçÊò†Èñ¢Êï∞ ====================
function applyConnectionSettingsChange() {
    // Ë°®Á§∫Êõ¥Êñ∞
    updateGuaSectionVisibility();
    // APIÂÄ§„ÅÆÈÅ©Áî®ÔºàÁèæÂú®„ÅÆÊé•Á∂öÁ®ÆÂà•„ÇíÊ∏°„ÅôÔºâ
    applyInitialsFromApi(document.querySelector('input[name="connectionType"]:checked')?.value || '');
    // ÂøÖË¶Å„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊõ¥Êñ∞
    updateRequiredPackages();
    // „Éë„ÉÉ„Ç±„Éº„Ç∏„Å®„ÉÜ„É≥„Éó„É¨„ÅÆ‰∏ÄÂÖÉÂèçÊò†
    refreshTemplateAndPackages();
}

// ==================== Êé•Á∂öË®≠ÂÆö„Éè„É≥„Éâ„É©„Éº ====================
function handleConnectionModeChange(e) {
    const manualSection = document.getElementById('manual-connection-section');
    
    if (e.target.value === 'manual') {
        manualSection.style.display = 'block';
    } else {
        manualSection.style.display = 'none';
    }
    
    applyConnectionSettingsChange();
}

function handleConnectionTypeChange(e) {
    const pppoeSection = document.getElementById('pppoe-section');
    const dsliteSection = document.getElementById('dslite-section');
    const mapeManualSection = document.getElementById('mape-manual-section');
    const apSection = document.getElementById('ap-section');

    pppoeSection.style.display = 'none';
    dsliteSection.style.display = 'none';
    mapeManualSection.style.display = 'none';
    if (apSection) apSection.style.display = 'none';

    if (e.target.value === 'pppoe') {
        pppoeSection.style.display = 'block';
    } else if (e.target.value === 'dslite') {
        dsliteSection.style.display = 'block';
    } else if (e.target.value === 'mape') {
        mapeManualSection.style.display = 'block';
        // map.sh Êú™„É≠„Éº„ÉâÊôÇ„ÅÆÂÜç„É≠„Éº„ÉâË©¶Ë°åÔºàÂøÖË¶ÅÊôÇ„ÅÆ„ÅøÔºâ
        if (!mapShCache['new'] && !mapShCache['19']) {
            loadMapShScripts().then(() => {
                applyConnectionSettingsChange();
            });
            return;
        }
    } else if (e.target.value === 'ap') {
        if (apSection) apSection.style.display = 'block';
    }
    
    applyConnectionSettingsChange();
}

function handleMapeTypeChange(e) {
    applyConnectionSettingsChange();
}

function handleDsliteModeChange(e) {
    const manualConfig = document.getElementById('dslite-manual-config');
    const aftrAddressField = document.getElementById('dslite-aftr-address');
    
    if (e.target.value === 'manual') {
        manualConfig.style.display = 'block';
        applyInitialsFromApi('dslite');
    } else {
        manualConfig.style.display = 'none';
        if (window.cachedApiInfo && window.cachedApiInfo.rule && window.cachedApiInfo.rule.aftrIpv6Address) {
            aftrAddressField.value = window.cachedApiInfo.rule.aftrIpv6Address;
        }
    }
    
    applyConnectionSettingsChange();
}

// GUA„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂà∂Âæ°
function updateGuaSectionVisibility() {
    const guaSection = document.getElementById('mape-gua-section');
    const mapeType = document.querySelector('input[name="mapeType"]:checked')?.value;
    const connectionMode = document.querySelector('input[name="connectionMode"]:checked')?.value;
    const connectionType = document.querySelector('input[name="connectionType"]:checked')?.value;
    
    // Ë°®Á§∫Êù°‰ª∂„ÅÆÂà§ÂÆö
    let shouldShow = false;
    
    if (connectionMode === 'auto') {
        // AUTO„É¢„Éº„ÉâÔºöAPI„Å´GUAÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
        if (window.cachedApiInfo && window.cachedApiInfo.ipv6) {
            shouldShow = true;
            // ÂÄ§„ÇíË®≠ÂÆö
            const guaInput = document.getElementById('mape-gua-prefix');
            if (!guaInput.value) {
                const guaPrefix = calculateGuaPrefixFromApi();
                if (guaPrefix) {
                    guaInput.value = guaPrefix;
                }
            }
        }
    } else if (connectionMode === 'manual' && connectionType === 'mape') {
        // „Éû„Éã„É•„Ç¢„É´„É¢„Éº„Éâ + MAP-EÈÅ∏ÊäûÊôÇ
        if (mapeType === 'auto') {
            // Auto-detect„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºöGUAÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
            if (window.cachedApiInfo && window.cachedApiInfo.ipv6) {
                shouldShow = true;
                const guaInput = document.getElementById('mape-gua-prefix');
                if (!guaInput.value) {
                    const guaPrefix = calculateGuaPrefixFromApi();
                    if (guaPrefix) {
                        guaInput.value = guaPrefix;
                    }
                }
            }
        } else if (mapeType === 'gua') {
            // GUA„É¢„Éº„Éâ„ÅåÊòéÁ§∫ÁöÑ„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºöÂ∏∏„Å´Ë°®Á§∫
            shouldShow = true;
            // API„Åã„Çâ„ÅÆÂÄ§„Åå„ÅÇ„Çå„Å∞Ë®≠ÂÆöÔºà„Å™„Åë„Çå„Å∞Á©∫Ê¨Ñ„ÅÆ„Åæ„ÅæÔºâ
            if (window.cachedApiInfo && window.cachedApiInfo.ipv6) {
                const guaInput = document.getElementById('mape-gua-prefix');
                if (!guaInput.value) {
                    const guaPrefix = calculateGuaPrefixFromApi();
                    if (guaPrefix) {
                        guaInput.value = guaPrefix;
                    }
                }
            }
        } else if (mapeType === 'pd') {
            // PD„É¢„Éº„ÉâÔºöÈùûË°®Á§∫
            shouldShow = false;
        }
    }
    
    // Ë°®Á§∫/ÈùûË°®Á§∫„ÇíÈÅ©Áî®
    if (guaSection) {
        guaSection.style.display = shouldShow ? 'block' : 'none';
    }
}

// ==================== „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„ÇπË®àÁÆóÂÖ±ÈÄöÈñ¢Êï∞ ====================
function calculatePrefix(ipv6, length = 64) {
    if (!ipv6) return '';
    const segments = ipv6.split(':');
    if (segments.length >= 4) {
        const prefix = segments.slice(0, 4).join(':');
        return `${prefix}::/${length}`;
    }
    return '';
}

// API„ÅÆIPv6„Ç¢„Éâ„É¨„Çπ„Åã„ÇâGUA„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíË®àÁÆó
function calculateGuaPrefixFromApi() {
    return calculatePrefix(window.cachedApiInfo?.ipv6 || '', 64);
}
        
// ==================== „Éï„Ç©„Éº„É†ÂàùÊúüÂÄ§Ê≥®ÂÖ•ÂÖ±ÈÄöÈñ¢Êï∞ ====================
function setIfEmpty(id, value) {
    const el = document.getElementById(id);
    if (el && !el.value && value != null && value !== '') {
        el.value = value;
    }
}

// ==================== ISPÊÉÖÂ†±Ë°®Á§∫ÊßãÁØâÂÖ±ÈÄöÈñ¢Êï∞ ====================
function buildIspStatus(apiInfo) {
    if (!apiInfo) {
        return {
            status: 'Auto-detection failed',
            details: 'API connection error or unsupported ISP\nManual configuration required.'
        };
    }

    let statusText = 'Auto-detection successful';
    let details = '';

    if (apiInfo.isp) details += `ISP: ${apiInfo.isp}\n`;
    if (apiInfo.country) {
        details += `Country/Region: ${apiInfo.country}`;
        if (apiInfo.regionName) details += ` (${apiInfo.regionName})`;
        details += '\n';
    }
    if (apiInfo.timezone) details += `Timezone: ${apiInfo.timezone}\n`;

    if (apiInfo.rule) {
        if (apiInfo.rule.aftrType) {
            statusText += ' - DS-Lite support detected';
            details += `\n[DS-Lite Configuration]\n`;
            details += `aftrType: ${apiInfo.rule.aftrType}\n`;
            if (apiInfo.rule.aftrIpv6Address) {
                details += `aftrIpv6Address: ${apiInfo.rule.aftrIpv6Address}\n`;
            }
        } else if (apiInfo.rule.brIpv6Address) {
            statusText += ' - MAP-E support detected';
            details += `\n[MAP-E Configuration]\n`;
            details += `brIpv6Address: ${apiInfo.rule.brIpv6Address}\n`;
            details += `eaBitLength: ${apiInfo.rule.eaBitLength}\n`;
            details += `ipv4Prefix: ${apiInfo.rule.ipv4Prefix}\n`;
            details += `ipv4PrefixLength: ${apiInfo.rule.ipv4PrefixLength}\n`;
            details += `ipv6Prefix: ${apiInfo.rule.ipv6Prefix}\n`;
            details += `ipv6PrefixLength: ${apiInfo.rule.ipv6PrefixLength}\n`;
            details += `psIdOffset: ${apiInfo.rule.psIdOffset}\n`;
            details += `psidlen: ${apiInfo.rule.psidlen}\n`;
        }
    } else {
        statusText += ' - DHCP/PPPoE environment';
        details += '\nStandard DHCP or PPPoE connection environment detected.';
    }

    const formatted = details
        .split('\n')
        .map(line => `<div>${line}</div>`)
        .join('');

    return { status: statusText, details: formatted };
}
      
// ==================== ISPÊÉÖÂ†±Èñ¢ÈÄ£ ====================
async function fetchApiInfoAndUpdate() {
    try {
        updateIspDisplay('Fetching', 'Retrieving ISP information...');
        console.log('Starting fetchApiInfoAndUpdate...');

        const apiInfo = await fetchApiInfo();
        console.log('fetchApiInfo returned:', apiInfo);

        window.cachedApiInfo = apiInfo;

        if (apiInfo) {
            // Country „Å® TimezoneÔºàÁ©∫Ê¨Ñ„ÅÆ„ÅøË®≠ÂÆöÔºâ
            setIfEmpty('aios-country', apiInfo.country);
            setIfEmpty('aios-zonename', apiInfo.timezone);

            // ISPË°®Á§∫„ÅØÂÖ±ÈÄöÈñ¢Êï∞„ÅßÊßãÁØâ
            const isp = buildIspStatus(apiInfo);
            updateIspDisplay(isp.status, isp.details);

            // GUA „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
            updateGuaSectionVisibility();

            // „Ç¶„Ç£„Ç∂„Éº„Éâ„ÅÆON/OFF„Å´Èñ¢‰øÇ„Å™„Åè„ÄÅÁ©∫Ê¨Ñ„Å´„ÅØÂàùÊúüÂÄ§„ÇíÊ≥®ÂÖ•Ôºà‰∏äÊõ∏„Åç„ÅØ„Åó„Å™„ÅÑÔºâ
            // MAP-EÊÉÖÂ†±
            if (apiInfo.rule && apiInfo.rule.brIpv6Address) {
                setIfEmpty('mape-br', apiInfo.rule.brIpv6Address);
                setIfEmpty('mape-ealen', apiInfo.rule.eaBitLength || '');
                setIfEmpty('mape-ipv4-prefix', apiInfo.rule.ipv4Prefix || '');
                setIfEmpty('mape-ipv4-prefixlen', apiInfo.rule.ipv4PrefixLength || '');
                setIfEmpty('mape-ipv6-prefix', apiInfo.rule.ipv6Prefix || '');
                setIfEmpty('mape-ipv6-prefixlen', apiInfo.rule.ipv6PrefixLength || '');
                setIfEmpty('mape-psid-offset', apiInfo.rule.psIdOffset || '');
                setIfEmpty('mape-psidlen', apiInfo.rule.psidlen || '');
            }
            
            // DS-LiteÊÉÖÂ†±
            if (apiInfo.rule && apiInfo.rule.aftrType) {
                document.getElementById('dslite-aftr-type').value = apiInfo.rule.aftrType;
                if (apiInfo.rule.aftrIpv6Address && !document.getElementById('dslite-aftr-address').value) {
                    document.getElementById('dslite-aftr-address').value = apiInfo.rule.aftrIpv6Address;
                }
            }

        } else {
            updateIspDisplay(
                'Auto-detection failed',
                'API connection error or unsupported ISP\nManual configuration required.'
            );
        }

    } catch (error) {
        console.error('ISP info fetch error:', error);
        updateIspDisplay(
            'Fetch error',
            'API connection failed.\nPlease use manual configuration for offline environments.'
        );
    }
}
        
function updateIspDisplay(status, details) {
    const statusMessage = document.getElementById('isp-status-message');
    const technicalInfo = document.getElementById('isp-technical-info');

    statusMessage.textContent = status;

    if (details) {
        technicalInfo.innerHTML = details;
        technicalInfo.style.display = 'block';
    } else {
        technicalInfo.style.display = 'none';
    }
}

async function fetchApiInfo() {
    try {
        console.log('Fetching API info from auto-config.site-u.workers.dev...');
        
        const response = await fetch('https://auto-config.site-u.workers.dev/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('API response status:', response.status);
        
        if (!response.ok) {
            console.warn('API access failed with status:', response.status);
            return null;
        }
        
        const data = await response.json();
        console.log('API Info fetched successfully:', data);
        
        return data;
    } catch (error) {
        console.error('Failed to fetch API info:', error);
        return null;
    }
}

// ==================== „ÉÜ„É≥„Éó„É¨ÊñáÂ≠óÂàó„ÅÆÂ§âÊï∞Ë®≠ÂÆöÂÖ±ÈÄöÈñ¢Êï∞ ====================
function setScriptVar(content, key, value, active) {
    const safe = (v) => (v === undefined || v === null) ? '' : String(v).trim();
    const val = safe(value);
    const re = new RegExp(`^#?\\s*${key}=".*"$`, 'm');
    const line = active ? `${key}="${val}"` : `# ${key}="${val}"`;
    return content.replace(re, line);
}

// ==================== „ÉÜ„É≥„Éó„É¨„Éº„ÉàË®≠ÂÆö ====================
async function updateConfiguredTemplate() {
    try {
        let content = document.getElementById('uci-defaults-content').value;

        if (!content || content.trim() === '' || content.includes('Failed to load setup.sh template')) {
            content = SETUP_SH_TEMPLATE;
            app.templateLoaded = true;
        }

        const config = getAiosConfig();

        let apiInfo = window.cachedApiInfo;
        if (!apiInfo) {
            apiInfo = await fetchApiInfo();
            window.cachedApiInfo = apiInfo;
        }

        // ÈÅ∏ÊäûÊ∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏Ôºàenable_* ÂèçÊò†Áî®Ôºâ
        const selectedPackages = new Set(split(document.getElementById('asu-packages').value));

        const customized = customizeSetupScript(content, config, apiInfo, selectedPackages);
        document.getElementById('uci-defaults-content').value = customized;
    } catch (error) {
        console.error('Template update error:', error);
    }
}

function customizeSetupScript(content, config, apiInfo, selectedPackages) {
    let customized = content;

    // OpenWrt version flags
    if (app.selectedVersion && app.selectedVersion.startsWith('19')) {
        customized = customized.replace(/^# openwrt_19=""/m, `openwrt_19="1"`);
        customized = customized.replace(/^# openwrt_21=""/m, `# openwrt_21=""`);
    } else {
        customized = customized.replace(/^# openwrt_19=""/m, `# openwrt_19=""`);
        customized = customized.replace(/^# openwrt_21=""/m, `openwrt_21="1"`);
    }

    // Basic settings
    customized = setScriptVar(customized, 'device_name', config.deviceName, !!config.deviceName);
    customized = setScriptVar(customized, 'lan_ip_address', config.lanIpv4, !!config.lanIpv4);
    customized = setScriptVar(customized, 'lan_ipv6_address', config.lanIpv6, !!config.lanIpv6);
    customized = setScriptVar(customized, 'root_password', config.rootPassword, !!config.rootPassword);
    customized = setScriptVar(customized, 'language', config.language, !!config.language);
    customized = setScriptVar(customized, 'country', config.country, !!config.country);
    customized = setScriptVar(customized, 'timezone', config.timezone, !!config.timezone);
    customized = setScriptVar(customized, 'zonename', config.zonename, !!config.zonename);

    // Wi-Fi
    const wifiActive = !!(config.wifiSSID && config.wifiPassword && String(config.wifiPassword).length >= 8);
    customized = setScriptVar(customized, 'wlan_name', config.wifiSSID, wifiActive);
    customized = setScriptVar(customized, 'wlan_password', config.wifiPassword, wifiActive);

    // API„Éô„Éº„Çπ„ÅÆÊé®Â•®ÂÄ§
    const api = apiInfo?.rule || {};
    const apiHasDslite = !!api.aftrIpv6Address;
    const apiHasMape = !!api.brIpv6Address;

    // DS-Lite ÂÄôË£úÂÄ§ÔºàÊú™‰ΩøÁî®„ÅÆ dsliteVal „ÅØÂâäÈô§Ôºâ
    // MAP-E ÂÄôË£úÂÄ§
    const mapeVals = {
        br: config.mapeBr || (apiHasMape ? api.brIpv6Address : ''),
        ealen: config.mapeEalen || (apiHasMape ? api.eaBitLength : ''),
        v4p: config.mapeIpv4Prefix || (apiHasMape ? api.ipv4Prefix : ''),
        v4l: config.mapeIpv4Prefixlen || (apiHasMape ? api.ipv4PrefixLength : ''),
        v6p: config.mapeIpv6Prefix || (apiHasMape ? api.ipv6Prefix : ''),
        v6l: config.mapeIpv6Prefixlen || (apiHasMape ? api.ipv6PrefixLength : ''),
        off: config.mapePsidOffset || (apiHasMape ? api.psIdOffset : ''),
        psid: config.mapePsidlen || (apiHasMape ? api.psidlen : '')
    };

    // GUA„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ
    const guaPrefix = config.mapeGuaPrefix || calculateGuaPrefixFromApi() || '';

    // ÈÅ∏Êäû„Éó„É≠„Éà„Ç≥„É´
    const manual = (config.connectionMode === 'manual');
    let activeProto = '';

    if (manual) {
        activeProto = config.connectionType;
    } else {
        if (apiHasDslite) activeProto = 'dslite';
        else if (apiHasMape) activeProto = 'mape';
        else activeProto = 'dhcp';
    }

    // PPPoE
    const pppoeActive = (activeProto === 'pppoe');
    customized = setScriptVar(customized, 'pppoe_username', config.pppoeUsername || '', pppoeActive);
    customized = setScriptVar(customized, 'pppoe_password', config.pppoePassword || '', pppoeActive);

    // DS-Lite
    let dsliteAddress = '';
    if (config.dsliteMode === 'auto') {
        dsliteAddress = (apiInfo?.rule?.aftrIpv6Address) || config.dsliteAftrAddress || '';
    } else {
        dsliteAddress = config.dsliteAftrAddress || '';
    }
    const dsliteActive = (activeProto === 'dslite') && !!dsliteAddress;
    customized = setScriptVar(customized, 'dslite_aftr_address', dsliteAddress, dsliteActive);

    // MAP-E
    const mapeActive = (activeProto === 'mape');
    customized = setScriptVar(customized, 'mape_br', mapeVals.br || '', mapeActive);
    customized = setScriptVar(customized, 'mape_ealen', mapeVals.ealen || '', mapeActive);
    customized = setScriptVar(customized, 'mape_ipv4_prefix', mapeVals.v4p || '', mapeActive);
    customized = setScriptVar(customized, 'mape_ipv4_prefixlen', mapeVals.v4l || '', mapeActive);
    customized = setScriptVar(customized, 'mape_ipv6_prefix', mapeVals.v6p || '', mapeActive);
    customized = setScriptVar(customized, 'mape_ipv6_prefixlen', mapeVals.v6l || '', mapeActive);
    customized = setScriptVar(customized, 'mape_psid_offset', mapeVals.off || '', mapeActive);
    customized = setScriptVar(customized, 'mape_psidlen', mapeVals.psid || '', mapeActive);

    // MAP-E GUA
    const guaActive = mapeActive && (config.mapeType === 'gua' || config.mapeType === 'auto');
    customized = setScriptVar(customized, 'mape_gua_mode', guaActive ? '1' : '', guaActive);
    customized = setScriptVar(customized, 'mape_gua_prefix', guaActive ? guaPrefix : '', guaActive);

    // enable_* „Éï„É©„Ç∞Ôºà„Éë„ÉÉ„Ç±„Éº„Ç∏ÈÅ∏Êäû„Å´Âøú„Åò„Å¶Ê±éÁî®ÁöÑ„Å´ÊúâÂäπÂåñÔºâ
    if (selectedPackages) {
        // PACKAGE_DB „Åã„Çâ enableVar „Éû„ÉÉ„Éó„ÇíÊßãÁØâ
        const enableMap = {};
        PACKAGE_DB.categories.forEach(cat => {
            (cat.packages || []).forEach(pkg => {
                if (pkg.enableVar) {
                    enableMap[pkg.name] = pkg.enableVar;
                }
            });
        });
        // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éë„ÉÉ„Ç±„Éº„Ç∏„Å´ÂØæÂøú„Åô„Çã enableVar „ÇíON
        selectedPackages.forEach(pkgName => {
            const varName = enableMap[pkgName];
            if (varName) {
                customized = setScriptVar(customized, varName, '1', true);
            }
        });
    }

    // MAP-EÈÅ∏ÊäûÊôÇ„ÅÆ„Åømap.sh„ÇíÂüã„ÇÅËæº„ÇÄ
    if (mapeActive) {
        customized = loadMapShContentSync(customized, app.selectedVersion);
    }
    
    // AP
    const apActive = (activeProto === 'ap');

    // „É´„Éº„Çø„ÉºIPÔºàAPÊôÇ„Åß„ÇÇÂÄ§„ÅØ‰øùÊåÅ„ÄÅ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅÆ„ÅøÔºâ
    customized = setScriptVar(customized, 'lan_ip_address', config.lanIpv4, !apActive);
    customized = setScriptVar(customized, 'lan_ipv6_address', config.lanIpv6, !apActive);

    // AP IPÔºàAPÊôÇ„ÅÆ„ÅøÊúâÂäπÂåñÔºâ
    customized = setScriptVar(customized, 'ap_ip_address', config.apIpAddress, apActive);
    customized = setScriptVar(customized, 'ap_gateway', config.apGateway, apActive);
    
    return customized;
}

function toggleAiosConfig(e) {
    const details = document.getElementById('use-aios-config-details');
    if (details && details.open) {
        updateConfiguredTemplate();
    } else {
        document.getElementById('uci-defaults-content').value = SETUP_SH_TEMPLATE;
        app.templateLoaded = true;
    }
}

// ÂàùÊúüÂåñÊôÇ„Å´ toggle „Çí„Éê„Ç§„É≥„Éâ
document.addEventListener('DOMContentLoaded', () => {
    const details = document.getElementById('use-aios-config-details');
    if (details) {
        details.addEventListener('toggle', toggleAiosConfig);
    }
});

function getAiosConfig() {
    const parseOrEmpty = (id, type = 'string') => {
        const val = document.getElementById(id)?.value?.trim();
        if (!val) return '';
        if (type === 'int') {
            const num = parseInt(val, 10);
            return isNaN(num) ? '' : num;
        }
        return val;
    };

    const config = {
        language: parseOrEmpty('aios-language'),
        country: parseOrEmpty('aios-country'),
        timezone: parseOrEmpty('aios-timezone'),
        zonename: parseOrEmpty('aios-zonename'),
        deviceName: parseOrEmpty('aios-device-name'),
        lanIpv4: parseOrEmpty('aios-lan-ipv4'),
        lanIpv6: parseOrEmpty('aios-lan-ipv6'),
        rootPassword: parseOrEmpty('aios-root-password'),
        wifiSSID: parseOrEmpty('aios-wifi-ssid'),
        wifiPassword: parseOrEmpty('aios-wifi-password'),

        connectionMode: document.querySelector('input[name="connectionMode"]:checked')?.value || 'auto',
        connectionType: document.querySelector('input[name="connectionType"]:checked')?.value || 'dhcp',
        mapeType: document.querySelector('input[name="mapeType"]:checked')?.value || 'auto',

        pppoeUsername: parseOrEmpty('pppoe-username'),
        pppoePassword: parseOrEmpty('pppoe-password'),

        dsliteAftrAddress: parseOrEmpty('dslite-aftr-address'),
        dsliteMode: document.querySelector('input[name="dsliteMode"]:checked')?.value || 'auto',
        dsliteAftrType: parseOrEmpty('dslite-aftr-type'),
        dsliteArea: parseOrEmpty('dslite-area'),
        
        mapeBr: parseOrEmpty('mape-br'),
        mapeEalen: parseOrEmpty('mape-ealen', 'int'),
        mapeIpv4Prefix: parseOrEmpty('mape-ipv4-prefix'),
        mapeIpv4Prefixlen: parseOrEmpty('mape-ipv4-prefixlen', 'int'),
        mapeIpv6Prefix: parseOrEmpty('mape-ipv6-prefix'),
        mapeIpv6Prefixlen: parseOrEmpty('mape-ipv6-prefixlen', 'int'),
        mapePsidOffset: parseOrEmpty('mape-psid-offset', 'int'),
        mapePsidlen: parseOrEmpty('mape-psidlen', 'int'),
        mapeGuaPrefix: parseOrEmpty('mape-gua-prefix'),

        apIpAddress: parseOrEmpty('ap-ip-address'),
        apGateway: parseOrEmpty('ap-gateway')
    };

    return config;
}

function applyInitialsFromApi(type) {
    if (type === 'dslite') {
        const aftrInput = document.getElementById('dslite-aftr-address');
        const dsliteMode = document.querySelector('input[name="dsliteMode"]:checked')?.value || 'auto';
        
        if (dsliteMode === 'auto') {
            // APIÊ§úÂá∫ÂÄ§„Çí‰ΩøÁî®
            if (window.cachedApiInfo && window.cachedApiInfo.rule && window.cachedApiInfo.rule.aftrIpv6Address) {
                if (aftrInput) {
                    aftrInput.value = window.cachedApiInfo.rule.aftrIpv6Address;
                }
            }
        } else {
            // Manual mode: Âú∞Âüü„Éª„Çø„Ç§„Éó„Éô„Éº„Çπ„ÅÆË®≠ÂÆö
            const areaSel = document.getElementById('dslite-area');
            const typeSel = document.getElementById('dslite-aftr-type');

            const area = areaSel?.value || 'east';
            const aftrType = typeSel?.value || 'transix';

            const aftrMap = {
                transix: {
                    east: '2404:8e00::feed:100',
                    west: '2404:8e01::feed:100'
                },
                xpass: {
                    east: '2001:e30:1c1e:1::1',
                    west: '2001:e30:1c1f:1::1'
                },
                v6option: {
                    east: '2404:8e00::feed:101',
                    west: '2404:8e01::feed:101'
                }
            };

            if (aftrInput) {
                const regionKey = area === 'west' ? 'west' : 'east';
                aftrInput.value = aftrMap[aftrType]?.[regionKey] || '';
            }
        }
    }

    // MAP-E: API„ÅÆÂàùÊúüÂÄ§„Çí„Åù„ÅÆ„Åæ„ÅæÊµÅ„ÅóËæº„ÇÄÔºàÂàùÊúüÂåñ„ÅØÁÑ°Êù°‰ª∂„Å´‰∏äÊõ∏„ÅçÔºâ
    if (type === 'mape') {
        const s = (window.cachedApiInfo && window.cachedApiInfo.rule) ? window.cachedApiInfo.rule : null;

        // Êó¢Áü•„ÅÆ„Ç≠„Éº„ÅåÁÑ°„ÅÑÂ†¥Âêà„Åß„ÇÇÁÑ°Êù°‰ª∂ÂàùÊúüÂåñ„ÅÆ„Éù„É™„Ç∑„Éº„Å´Âæì„ÅÑ„ÄÅÂÄ§„Åå„ÅÇ„Çã„ÇÇ„ÅÆ„ÅØ‰∏äÊõ∏„Åç
        const set = (id, val) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (val !== undefined && val !== null) el.value = val;
        };

        if (s) {
            set('mape-br', s.brIpv6Address);
            set('mape-ealen', s.eaBitLength);
            set('mape-ipv4-prefix', s.ipv4Prefix);
            set('mape-ipv4-prefixlen', s.ipv4PrefixLength);
            set('mape-ipv6-prefix', s.ipv6Prefix);
            set('mape-ipv6-prefixlen', s.ipv6PrefixLength);
            set('mape-psid-offset', s.psIdOffset);
            set('mape-psidlen', s.psidlen);
        }
        
        // GUA„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇÇË®≠ÂÆö
        const guaPrefix = calculateGuaPrefixFromApi();
        if (guaPrefix) {
            set('mape-gua-prefix', guaPrefix);
        }
        
        // GUA„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        updateGuaSectionVisibility();
    }
}

// ==================== ÂÖ±ÈÄöÂèçÊò†Èñ¢Êï∞ ====================
function refreshTemplateAndPackages() {
    // i18n Êï¥ÁêÜ
    asuCollectPackages();

    // aios-config ÊúâÂäπÊôÇ„ÅÆ„Åø„ÉÜ„É≥„Éó„É¨Êõ¥Êñ∞
    if (document.getElementById('use-aios-config-details').open) {
        updateConfiguredTemplate().catch(console.error);
    }
}

// ==================== „Éë„ÉÉ„Ç±„Éº„Ç∏ÁÆ°ÁêÜ ====================
function split(str) {
    return str.match(/[^\s,]+/g) || [];
}

function updateRequiredPackages() {
  const config = getAiosConfig();
  const packagesTextarea = document.getElementById('asu-packages');
  let currentPackages = split(packagesTextarea.value);

  // Ëá™ÂãïËøΩÂä†ÂØæË±°„ÇíÂà∂ÈôêÔºàmap, ds-lite „ÅÆ„ÅøÔºâ
  currentPackages = currentPackages.filter(pkg =>
    pkg !== 'map' &&
    pkg !== 'ds-lite'
  );
    
  // Êé•Á∂öÊñπÂºè„Å´Âøú„Åò„Åü„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆËøΩÂä†
  if (config.connectionMode === 'auto') {
      if (window.cachedApiInfo && window.cachedApiInfo.rule) {
          if (window.cachedApiInfo.rule.aftrType) {
              if (!currentPackages.includes('ds-lite')) {
                  currentPackages.push('ds-lite');
              }
          } else if (window.cachedApiInfo.rule.brIpv6Address) {
              if (!currentPackages.includes('map')) {
                  currentPackages.push('map');
              }
          }
      }
  } else {
      switch(config.connectionType) {
          case 'mape':
              if (!currentPackages.includes('map')) {
                  currentPackages.push('map');
              }
              break;
          case 'dslite':
              if (!currentPackages.includes('ds-lite')) {
                  currentPackages.push('ds-lite');
              }
              break;
      }
  }

  // ÊúÄÁµÇÈáçË§áÊéíÈô§ÔºàÊâãÂÖ•ÂäõÈáçË§á„Å™„Å©„Å´„ÇÇÂº∑„Åè„Åô„ÇãÔºâ
  currentPackages = Array.from(new Set(currentPackages));
    
  packagesTextarea.value = currentPackages.join(' ');
}

// ==================== „Éì„É´„ÉâÂá¶ÁêÜ ====================
async function buildAsuRequest() {
    if (!app.selectedDevice) {
        alert('Please select a device first');
        return;
    }

    try {
        document.getElementById('request-build').disabled = true;
        showProgress('Sending build request...', 10);

        const packages = split(document.getElementById('asu-packages').value);
        const script = document.getElementById('uci-defaults-content').value;

        const requestBody = {
            target: app.selectedDevice.target,
            profile: app.selectedDevice.id,
            packages: packages,
            version: app.selectedVersion
        };

        if (script && script.trim()) {
            requestBody.defaults = script;
        }

        const response = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        const responseText = await response.text();

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${responseText}`);
        }

        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            throw new Error('Invalid JSON response: ' + responseText);
        }

        if (result.request_hash) {
            await pollBuildStatus(result.request_hash);
        } else if (result.images && result.images.length > 0) {
            hideProgress();
            showDownloadLinks(result.images);
        } else {
            throw new Error('No request hash or images in response');
        }

    } catch (error) {
        console.error('Build request failed:', error);
        alert('Build failed: ' + error.message);
        hideProgress();
    } finally {
        document.getElementById('request-build').disabled = false;
    }
}

async function pollBuildStatus(requestHash) {
    const maxAttempts = 120;
    let attempts = 0;
    const startTime = Date.now();

    while (attempts < maxAttempts) {
        try {
            const statusUrl = `https://sysupgrade.openwrt.org/api/v1/build/${requestHash}`;
            const response = await fetch(statusUrl, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            if (!response.ok) {
                if (response.status === 404 && attempts < 5) {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                    showProgress(`Waiting for build to start... ${timeStr}`, 10);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;
                    continue;
                }
                throw new Error(`Status check failed: HTTP ${response.status}`);
            }

            const statusText = await response.text();
            let status;

            try {
                status = JSON.parse(statusText);
            } catch (e) {
                throw new Error('Invalid JSON in status response: ' + statusText);
            }

            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

            const progressPercent = Math.min((elapsedSeconds / 600) * 85 + 10, 95);
            const progressMsg =
                status.detail && typeof status.detail === 'string' ? status.detail :
                status.status && typeof status.status === 'string' ? status.status :
                'Processing';

            if (status.status === 'done' || status.status === 'success' || 
                status.detail === 'done' || status.imagebuilder_status === 'done') {
                const images = status.images || 
                               status.request?.images || 
                               status.request?.files ||
                               status.files || [];

                const rh = status.request_hash || status.request?.request_hash;

                showProgress('Build completed!', 100);
                setTimeout(() => {
                    hideProgress();
                    showBuildStatus('Build successful', 'info');
                    
                    // STDERR/STDOUT „ÅÆË°®Á§∫
                    if (status.stderr || status.stdout) {
                        document.getElementById('asu-stderr').textContent = status.stderr || 'No errors';
                        document.getElementById('asu-stdout').textContent = status.stdout || 'No output';
                        document.getElementById('asu-log').style.display = 'block';
                    }
                    
                    showDownloadLinks(images, status, rh);
                }, 500);
                return;
            }

            if (status.status === 'failed' || status.status === 'failure' || 
                status.detail === 'failed' || status.imagebuilder_status === 'failed') {
                throw new Error(`Build failed: ${status.detail || status.stdout || 'Unknown error'}`);
            }

            showProgress(`${progressMsg}... ${timeStr}`, progressPercent);
            await new Promise(resolve => setTimeout(resolve, 5000));
            attempts++;

        } catch (error) {
            if (attempts >= 5) throw error;

            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            showProgress(`Connection error, retrying... ${elapsedSeconds}s`, 5);
            await new Promise(resolve => setTimeout(resolve, 5000));
            attempts++;
        }
    }

    throw new Error('Build timeout after 10 minutes');
}

function showProgress(message, percentage) {
    document.getElementById('build-message').textContent = message;
    document.getElementById('progress-bar').style.width = `${percentage}%`;
    document.getElementById('build-progress').style.display = 'block';
}

function hideProgress() {
    document.getElementById('build-progress').style.display = 'none';
}

function showBuildStatus(message, type) {
    const bs = document.getElementById('asu-buildstatus');
    
    if (type === 'error') {
        bs.classList.remove('asu-info');
        bs.classList.add('asu-error');
    } else {
        bs.classList.remove('asu-error');
        bs.classList.add('asu-info');
    }
    
    bs.querySelector('span').textContent = message;
    bs.style.display = 'block';
}

function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleString();
}

function showDownloadLinks(images, fullStatus, requestHash) {
    const container = document.getElementById('download-links');
    
    if (!images || images.length === 0) {
        container.innerHTML = '<h4>Downloads</h4><p>No images available</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="images">
            <h4>Factory Image</h4>
            <p class="text-muted">The factory image is used for the initial flashing of OpenWrt. This would replace an existing firmware.</p>
            <div id="factory-images"></div>
            
            <h4>Sysupgrade Image</h4>
            <p class="text-muted">The sysupgrade image is used to upgrade an existing OpenWrt installation.</p>
            <div id="sysupgrade-images"></div>
            
            <div id="other-images" style="display: none;">
                <h4>Other Images</h4>
                <div id="other-images-content"></div>
            </div>
        </div>
    `;

    const factoryContainer = document.getElementById('factory-images');
    const sysupgradeContainer = document.getElementById('sysupgrade-images');
    const otherContainer = document.getElementById('other-images-content');
    const otherSection = document.getElementById('other-images');
    
    let hasFactory = false;
    let hasSysupgrade = false;
    let hasOther = false;

    images.forEach((image) => {
        if (!image.name || !requestHash) return;
        
        const imageUrl = `https://sysupgrade.openwrt.org/store/${requestHash}/${image.name}`;
        const fileName = image.name;
        
        const link = document.createElement('a');
        link.href = imageUrl;
        link.className = 'download-link';
        link.target = '_blank';
        link.download = fileName;
        link.title = fileName;
        
        // ÂÖ¨Âºè„Å´Âêà„Çè„Åõ„Åü„Éï„Ç°„Ç§„É´Âêç„ÅÆË°®Á§∫ÂΩ¢Âºè
        let displayName = fileName;
        
        // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„ÅÆÂà§ÂÆö„Å®ÊåØ„ÇäÂàÜ„Åë
        if (image.type) {
            const type = image.type.toLowerCase();
            
            if (type.includes('factory')) {
                displayName = fileName;
                link.textContent = displayName;
                factoryContainer.appendChild(link);
                factoryContainer.appendChild(document.createTextNode(' '));
                hasFactory = true;
            } else if (type.includes('sysupgrade')) {
                displayName = fileName;
                link.textContent = displayName;
                sysupgradeContainer.appendChild(link);
                sysupgradeContainer.appendChild(document.createTextNode(' '));
                hasSysupgrade = true;
            } else {
                displayName = fileName;
                link.textContent = displayName;
                otherContainer.appendChild(link);
                otherContainer.appendChild(document.createTextNode(' '));
                hasOther = true;
            }
        } else {
            // type„Åå‰∏çÊòé„Å™Â†¥Âêà„ÅØ„Éï„Ç°„Ç§„É´Âêç„ÅßÂà§ÂÆö
            const nameLower = fileName.toLowerCase();
            if (nameLower.includes('factory')) {
                link.textContent = displayName;
                factoryContainer.appendChild(link);
                factoryContainer.appendChild(document.createTextNode(' '));
                hasFactory = true;
            } else if (nameLower.includes('sysupgrade')) {
                link.textContent = displayName;
                sysupgradeContainer.appendChild(link);
                sysupgradeContainer.appendChild(document.createTextNode(' '));
                hasSysupgrade = true;
            } else {
                link.textContent = displayName;
                otherContainer.appendChild(link);
                otherContainer.appendChild(document.createTextNode(' '));
                hasOther = true;
            }
        }
    });
    
    // Á©∫„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å´„ÄåÂà©Áî®‰∏çÂèØ„Äç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    if (!hasFactory) {
        factoryContainer.innerHTML = '<span class="text-muted">No factory image available for this device.</span>';
    }
    
    if (!hasSysupgrade) {
        sysupgradeContainer.innerHTML = '<span class="text-muted">No sysupgrade image available for this device.</span>';
    }
    
    // „Åù„ÅÆ‰ªñ„ÅÆ„Ç§„É°„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
    if (hasOther) {
        otherSection.style.display = 'block';
    }
    
    // BuildÊÉÖÂ†±„ÇíË°®Á§∫ÔºàÂÖ¨Âºè„Çπ„Çø„Ç§„É´Ôºâ
    if (requestHash) {
        const buildInfo = document.createElement('div');
        buildInfo.className = 'info';
        buildInfo.style.marginTop = '1rem';
        buildInfo.innerHTML = `
            <h5>Build Information</h5>
            <div>Request ID: <code>${requestHash}</code></div>
            <div>Build completed successfully</div>
        `;
        container.appendChild(buildInfo);
    }
}

// ‚òÖ„Éë„ÉÉ„Ç±„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂèñÂæóÔºàdevice_packages_url „ÅØÂªÉÊ≠¢Ôºâ
async function fetchDevicePackages() {
    app.devicePackages = [];
    if (!app.selectedDevice || !app.selectedVersion) return;

    // target/subtarget ÊäΩÂá∫
    const [target, subtarget] = (() => {
        if (app.selectedDevice.target && app.selectedDevice.target.includes('/')) {
            return app.selectedDevice.target.split('/');
        }
        return [app.selectedDevice.target || "", app.selectedDevice.subtarget || ""];
    })();

    const version = app.selectedVersion;

    let profilesUrl;
    if (version === 'SNAPSHOT') {
        profilesUrl = `${config.image_url}/snapshots/targets/${encodeURIComponent(target)}/${encodeURIComponent(subtarget)}/profiles.json`;
    } else {
        profilesUrl = `${config.image_url}/releases/${encodeURIComponent(version)}/targets/${encodeURIComponent(target)}/${encodeURIComponent(subtarget)}/profiles.json`;
    }
    
    let arch;
    try {
        const res = await fetch(profilesUrl);
        if (!res.ok) throw new Error(`profiles.json HTTP ${res.status}`);
        const meta = await res.json();
        arch = meta.arch_packages;
        if (!arch) throw new Error("profiles.json „Å´ arch_packages „Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    } catch (e) {
        console.error("arch_packages ÂèñÂæóÂ§±Êïó:", e);
        return;
    }

    // „Éë„ÉÉ„Ç±„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπURL‰∏ÄË¶ßÔºàtargets „Å® feedsÔºâ
    const feeds = ["base", "luci", "packages", "routing", "telephony"];
    const urls = [
        `${config.image_url}/releases/${encodeURIComponent(version)}` +
        `/targets/${encodeURIComponent(target)}/${encodeURIComponent(subtarget)}/packages/Packages`
    ];
    for (const feed of feeds) {
        urls.push(
            `${config.image_url}/releases/${encodeURIComponent(version)}` +
            `/packages/${encodeURIComponent(arch)}/${encodeURIComponent(feed)}/Packages`
        );
    }

// ÂêÑ Packages „Çí‰∏¶ÂàóÂèñÂæó„Åó„Å¶„Éë„Éº„Çπ
const allPkgs = [];

const results = await Promise.allSettled(
    urls.map(async (url) => {
        try {
            const res = await fetch(url);
            if (!res.ok) return [];
            const text = await res.text();
            return parsePackagesText(text, url);
        } catch (e) {
            console.warn(`„Éë„ÉÉ„Ç±„Éº„Ç∏ÂèñÂæóÂ§±Êïó: ${url}`, e);
            return [];
        }
    })
);

results.forEach(r => {
    if (r.status === 'fulfilled' && Array.isArray(r.value)) {
        allPkgs.push(...r.value);
    }
});

    // ÂêçÂâçÈáçË§á„ÇíÁµ±Âêà
    const pkgMap = new Map();
    for (const p of allPkgs) {
        pkgMap.set(p.name, p);
    }
    app.devicePackages = Array.from(pkgMap.values());
}

// Packages „Éï„Ç°„Ç§„É´„Çí„Éë„Éº„ÇπÔºàÂøÖË¶Å„Å™„ÇâÂ§ñÈÉ®Âåñ„Åó„Å¶„ÇÇOKÔºâ
function parsePackagesText(text, source) {
    const blocks = text.split(/\n\s*\n/);
    const pkgs = [];
    for (const blk of blocks) {
        const rec = {};
        for (const line of blk.split('\n')) {
            const m = line.match(/^([A-Za-z-]+):\s*(.*)$/);
            if (!m) continue;
            const key = m[1], val = m[2];
            if (key === "Package") rec.name = val;
            else if (key === "Version") rec.version = val;
            else if (key === "Description") rec.description = val;
            else if (key === "Section") rec.section = val;
        }
        if (rec.name) {
            rec.source = source;
            pkgs.push(rec);
        }
    }
    return pkgs;
}
    
(function() {
    const pkgInput = document.getElementById('package-search');
    let pkgSearchTimer;

    if (pkgInput) {
        pkgInput.addEventListener('input', function(e) {
            clearTimeout(pkgSearchTimer);
            const query = e.target.value.trim().toLowerCase();

            if (query.length < 2 || !Array.isArray(app.devicePackages) || app.devicePackages.length === 0) {
                hidePackageAutocomplete();
                return;
            }

            // „Éá„Éê„Ç§„ÇπÂêçÂÖ•Âäõ„Å®Âêå„ÅòÈÅÖÂª∂Ê§úÁ¥¢„É≠„Ç∏„ÉÉ„ÇØ
            pkgSearchTimer = setTimeout(() => {
                const matches = app.devicePackages
                    .filter(pkg => {
                        const name = (typeof pkg === 'string') ? pkg : pkg.name || '';
                        return name.toLowerCase().includes(query);
                    })
                    .slice(0, 10);

                showPackageAutocomplete(matches);
            }, 200);
        });
    }
})();

function hidePackageAutocomplete() {
    const el = document.querySelector('#package-search-autocomplete .autocomplete-items');
    if (el) el.remove();
}

function showPackageAutocomplete(matches) {
    hidePackageAutocomplete();
    const host = document.getElementById('package-search-autocomplete');
    if (!host) return;

    const container = document.createElement('div');
    container.className = 'autocomplete-items';

    (matches || []).forEach(item => {
        const name = (typeof item === 'string') ? item : (item && item.name) || '';
        if (!name) return;
        const div = document.createElement('div');
        div.textContent = name;
        div.addEventListener('click', (e) => {
            e.stopPropagation();
            addPackageToList(name);

            // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊòéÁ§∫ÁöÑ„Å´‰ªò‰∏é
            div.classList.add('bold-flash');

            document.getElementById('package-search').value = '';

            const cont = document.querySelector('#package-search-autocomplete .autocomplete-items');
            if (cont) {
                cont.style.pointerEvents = 'none';
                cont.style.userSelect = 'none';
                setTimeout(() => { hidePackageAutocomplete(); }, 1500);
            } else {
                hidePackageAutocomplete();
            }
        });
        container.appendChild(div);
    });
    
    host.appendChild(container);
}

function addPackageToList(pkgName, clickedEl) {
    const textarea = document.getElementById('asu-packages');
    const list = textarea.value.trim() ? textarea.value.trim().split(/\s+/) : [];
    if (!list.includes(pkgName)) {
        list.push(pkgName);
        textarea.value = list.join(' ');
        refreshTemplateAndPackages();
    }
    flashSelectedOption(clickedEl); // null Ê∏°„Åó„Çí„ÇÑ„ÇÅ„Çã
}

function flashSelectedOption(el) {
    if (!el) return;
    el.classList.add('bold-flash');      // Âç≥ÊôÇÂèçÊò†
    setTimeout(() => {
        el.classList.remove('bold-flash');
    }, 200);
}
  
document.addEventListener('click', function (e) {
    if (!e.target.closest('#package-search-autocomplete')) {
        hidePackageAutocomplete();
    }
});

    // „Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÈÅ∏Êäû„ÉªÈùûÈÅ∏Êäû„ÇíÂàá„ÇäÊõø„Åà„ÇãÈñ¢Êï∞
    function togglePackage(packageName) {
        let packagesList = asuPackagesTextarea.value.split('\n').filter(p => p.trim() !== '');

        if (installedPackages.has(packageName)) {
            installedPackages.delete(packageName);
            packagesList = packagesList.filter(p => p !== packageName);
        } else {
            installedPackages.add(packageName);
            packagesList.push(packageName);
        }
        
        asuPackagesTextarea.value = packagesList.join('\n');
    }

    </script>
</body>

</html>
