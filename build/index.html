<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>OpenWrt Firmware Selector</title>
    <style>
        /* ÂÖ¨Âºè„Çµ„Ç§„Éà„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂÜçÁèæ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 1rem;
            color: #007bff;
        }

        .lead {
            font-size: 1.25rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 2rem;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: inline-block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .autocomplete {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4edda;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4edda;
        }

        .autocomplete-items div:hover {
            background-color: #e9ecef;
        }

        .autocomplete-active {
            background-color: #007bff !important;
            color: #ffffff;
        }

        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }

        .info h5 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .packages {
            margin: 1.5rem 0;
        }

        .packages h4 {
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .btn {
            display: inline-block;
            font-weight: 400;
            color: #212529;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            text-decoration: none.
        }

        .btn-primary {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            color: #fff;
            background-color: #0069d9;
            border-color: #0062cc;
        }

        .btn-primary:disabled {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            opacity: 0.65;
        }

        .images {
            margin: 1.5rem 0;
        }

        .download-link {
            display: inline-block;
            margin: 0.25rem 0.5rem 0.25rem 0;
            padding: 0.5rem 1rem;
            background-color: #28a745;
            color: #fff;
            text-decoration: none;
            border-radius: 0.25rem;
        }

        .download-link:hover {
            background-color: #218838;
            color: #fff;
            text-decoration: none;
        }

        /* aios-light.shË®≠ÂÆöÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .aios-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }

        .aios-config {
            margin-top: 1rem;
            display: none;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -5px;
            margin-left: -5px;
        }

        .form-row > .form-group {
            padding-right: 5px;
            padding-left: 5px;
            flex: 1;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .form-check {
            position: relative;
            display: block;
            padding-left: 1.25rem;
        }

        .form-check-input {
            position: absolute;
            margin-top: 0.3rem;
            margin-left: -1.25rem;
        }

        .form-check-label {
            margin-bottom: 0;
        }

        .conditional-section {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.25rem;
            display: none;
        }

        .text-muted {
            color: #6c757d;
        }

        .small {
            font-size: 0.875em;
        }

        /* „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫„ÅÆÊîπÂñÑ */
        .build-progress {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 0.25rem;
            display: none;
        }

        .progress {
            width: 100%;
            height: 1rem;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        @media (max-width: 576px) {
            .form-row {
                flex-direction: column;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>OpenWrt Firmware Selector</h1>
        <p class="lead">Type the name or model of your device, then select a stable build or the nightly "snapshot" build.</p>

        <div class="form-group">
            <label for="versions">Version</label>
            <select id="versions" class="form-control">
                <option value="" disabled selected>Loading versions...</option>
            </select>
        </div>

        <div class="form-group">
            <div class="autocomplete">
                <input type="text" id="models" class="form-control" placeholder="Type device model" autocomplete="off">
                <div id="models-autocomplete-list" class="autocomplete-items"></div>
            </div>
        </div>

        <div id="info" class="info" style="display: none;">
            <h5 id="device-title"></h5>
            <div id="device-details"></div>
        </div>

        <div id="images" class="images" style="display: none;">
            <!-- Device images will be shown here -->
        </div>

        <div id="packages" class="packages" style="display: none;">
            <h4>Customize installed packages and/or first boot script</h4>
            <div class="form-group">
                <label for="packages-custom">Packages to add/remove (one per line, prefix with '-' to remove):</label>
                <textarea id="packages-custom" class="form-control" rows="3" placeholder="-wpad-basic-wolfssl&#10;wpad-wolfssl&#10;luci-ssl"></textarea>
            </div>

            <!-- setup.shË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="aios-section">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="use-aios-config">
                    <label class="form-check-label" for="use-aios-config">
                        Use setup.sh configuration wizard
                    </label>
                </div>

                <div id="aios-config" class="aios-config">
                    <h5>Basic Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-language">Language</label>
                            <select id="aios-language" class="form-control">
                                <option value="en">English</option>
                                <option value="ja">Japanese</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aios-device-name">Device name</label>
                            <input type="text" id="aios-device-name" class="form-control" placeholder="OpenWrt-Router">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-root-password">Root password</label>
                            <input type="password" id="aios-root-password" class="form-control" placeholder="8+ characters">
                            <small class="form-text text-muted">Leave empty to disable password authentication</small>
                        </div>
                        <div class="form-group">
                            <label for="aios-confirm-password">Confirm password</label>
                            <input type="password" id="aios-confirm-password" class="form-control" placeholder="Confirm password">
                        </div>
                    </div>

                    <h5>Wi-Fi Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-wifi-ssid">Wi-Fi SSID</label>
                            <input type="text" id="aios-wifi-ssid" class="form-control" placeholder="MyOpenWrt">
                        </div>
                        <div class="form-group">
                            <label for="aios-wifi-password">Wi-Fi password</label>
                            <input type="password" id="aios-wifi-password" class="form-control" placeholder="8+ characters">
                        </div>
                    </div>

                    <h5>Internet Connection</h5>
                    <div class="form-group">
                        <label>Connection type</label>
                        <div class="radio-group">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-auto" value="auto" checked>
                                <label class="form-check-label" for="conn-auto">Auto-detect</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-dhcp" value="dhcp">
                                <label class="form-check-label" for="conn-dhcp">DHCP</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-pppoe" value="pppoe">
                                <label class="form-check-label" for="conn-pppoe">PPPoE</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-dslite" value="dslite">
                                <label class="form-check-label" for="conn-dslite">DS-Lite</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-mape" value="mape">
                                <label class="form-check-label" for="conn-mape">MAP-E</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionType" id="conn-none" value="none">
                                <label class="form-check-label" for="conn-none">None</label>
                            </div>
                        </div>
                    </div>

                    <div id="pppoe-section" class="conditional-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pppoe-username">PPPoE username</label>
                                <input type="text" id="pppoe-username" class="form-control" placeholder="Username from ISP">
                            </div>
                            <div class="form-group">
                                <label for="pppoe-password">PPPoE password</label>
                                <input type="password" id="pppoe-password" class="form-control" placeholder="Password from ISP">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="script">Script to run on first boot (uci-defaults):</label>
                <textarea id="script" class="form-control" rows="8" placeholder="#!/bin/sh&#10;&#10;# Your script here"></textarea>
            </div>

            <button id="request-build" class="btn btn-primary" style="display: none;">REQUEST BUILD</button>
        </div>

        <!-- ÊîπÂñÑ„Åï„Çå„Åü„Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫ -->
        <div id="build-progress" class="build-progress">
            <div id="build-message">Building image...</div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div id="download-links"></div>
    </div>

    <script>
        let app = {
            versions: [],
            devices: [],
            selectedDevice: null,
            selectedVersion: ''
        };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                await loadVersions();
                bindEvents();
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        }

        function bindEvents() {
            document.getElementById('versions').addEventListener('change', handleVersionChange);
            document.getElementById('models').addEventListener('input', handleDeviceSearch);
            document.getElementById('use-aios-config').addEventListener('change', toggleAiosConfig);
            document.getElementById('request-build').addEventListener('click', requestBuild);

            document.querySelectorAll('input[name="connectionType"]').forEach(radio => {
                radio.addEventListener('change', handleConnectionTypeChange);
            });

            document.getElementById('aios-config').addEventListener('input', function() {
                if (document.getElementById('use-aios-config').checked) {
                    loadAiosTemplate();
                    updateRequiredPackages();
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete')) {
                    hideAutocomplete();
                }
            });
        }

        async function loadVersions() {
            try {
                const response = await fetch('https://downloads.openwrt.org/.versions.json');
                const data = await response.json();

                app.versions = data.versions_list || [];
                app.selectedVersion = data.stable_version || app.versions[0];

                updateVersionSelect();
                await loadDevices();
            } catch (error) {
                console.error('Failed to load versions:', error);
            }
        }

        function updateVersionSelect() {
            const select = document.getElementById('versions');
            select.innerHTML = '';

            app.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version;
                option.textContent = version;
                if (version === app.selectedVersion) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        async function loadDevices() {
            if (!app.selectedVersion) return;

            try {
                const url = `https://downloads.openwrt.org/releases/${app.selectedVersion}/.overview.json`;
                const response = await fetch(url);
                const data = await response.json();

                app.devices = data.profiles || [];
            } catch (error) {
                console.error('Failed to load devices:', error);
                app.devices = [];
            }
        }

        async function handleVersionChange(e) {
            app.selectedVersion = e.target.value;
            app.selectedDevice = null;
            hideDeviceInfo();
            await loadDevices();
        }

        function handleDeviceSearch(e) {
            const query = e.target.value.toLowerCase();

            if (query.length < 2) {
                hideAutocomplete();
                return;
            }

            const matches = app.devices.filter(device => {
                const title = getDeviceTitle(device).toLowerCase();
                return title.includes(query) || device.id.toLowerCase().includes(query);
            }).slice(0, 10);

            showAutocomplete(matches);
        }

        function getDeviceTitle(device) {
            if (device.titles && device.titles.length > 0) {
                return device.titles[0].title || device.id;
            }
            return device.id;
        }

        function showAutocomplete(devices) {
            const container = document.getElementById('models-autocomplete-list');
            container.innerHTML = '';

            if (devices.length === 0) {
                hideAutocomplete();
                return;
            }

            devices.forEach(device => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${getDeviceTitle(device)}</strong><br><small>Target: ${device.target}</small>`;
                div.addEventListener('click', () => selectDevice(device));
                container.appendChild(div);
            });

            container.style.display = 'block';
        }

        function hideAutocomplete() {
            document.getElementById('models-autocomplete-list').style.display = 'none';
        }

        // Â§âÊõ¥ÁÇπ: selectDevice „Çí async „Å´„Åó„ÄÅprofile „Åã„Çâ„Éë„ÉÉ„Ç±„Éº„Ç∏ÂàùÊúüÂÄ§„ÇíÂèñÂæó„Åó„Å¶ textarea „Å´ÂèçÊò†
        async function selectDevice(device) {
            app.selectedDevice = device;
            document.getElementById('models').value = getDeviceTitle(device);
            hideAutocomplete();
            showDeviceInfo();
            await fetchProfilePackagesAndPopulate(device);
        }

        // ËøΩÂä†: profiles.json / ÂÄãÂà• profile JSON „Åã„Çâ default packages „ÇíÂèñÂæó„Åó„ÄÅ‰∫íÊèõ„ÅÆ„Åü„ÇÅÊîπË°åÂå∫Âàá„Çä„ÅßÊäïÂÖ•
        async function fetchProfilePackagesAndPopulate(device) {
            if (!device || !device.target || !device.id) return;

            const version = app.selectedVersion || 'snapshots';
            const target = device.target;
            const profileId = device.id;

            const candidates = [];
            if (version && version !== 'snapshots') {
                candidates.push(`https://downloads.openwrt.org/releases/${version}/targets/${target}/profiles.json`);
                candidates.push(`https://downloads.openwrt.org/releases/${version}/targets/${target}/profiles/${profileId}.json`);
            }
            candidates.push(`https://downloads.openwrt.org/snapshots/targets/${target}/profiles.json`);
            candidates.push(`https://downloads.openwrt.org/snapshots/targets/${target}/profiles/${profileId}.json`);

            for (const url of candidates) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) continue;
                    const json = await res.json();

                    if (Array.isArray(json.profiles)) {
                        const found = json.profiles.find(p =>
                            p.id === profileId || p.profile === profileId || p.name === profileId || p.model === profileId
                        );
                        if (found) {
                            const pkgs = normalizePackagesField(found.packages || found.package || found.defaults || found.default_packages || found['installed-packages']);
                            if (pkgs.length) {
                                document.getElementById('packages-custom').value = pkgs.join(' ');
                                return;
                            }
                        }
                    }

                    const direct = json.packages || json.defaults || json.default_packages || json.installed || (json.profile && (json.profile.packages || json.profile.defaults));
                    if (direct) {
                        const pkgs = normalizePackagesField(direct);
                        if (pkgs.length) {
                            document.getElementById('packages-custom').value = pkgs.join('\n');
                            return;
                        }
                    }
                } catch (e) {
                    console.error('fetchProfilePackagesAndPopulate error for', url, e);
                    continue;
                }
            }
        }

        function normalizePackagesField(raw) {
            if (!raw) return [];
            if (Array.isArray(raw)) return raw.map(String).map(s => s.trim()).filter(Boolean);
            if (typeof raw === 'string') return raw.split(/\s+/).map(s => s.trim()).filter(Boolean);
            try {
                return Object.values(raw).map(String).map(s => s.trim()).filter(Boolean);
            } catch (e) {
                return [];
            }
        }

        function showDeviceInfo() {
            if (!app.selectedDevice) return;

            const device = app.selectedDevice;

            document.getElementById('device-title').textContent = getDeviceTitle(device);
            document.getElementById('device-details').innerHTML = `Target: ${device.target}<br>Version: ${app.selectedVersion}`;

            document.getElementById('info').style.display = 'block';
            document.getElementById('packages').style.display = 'block';
            document.getElementById('request-build').style.display = 'inline-block';
        }

        function hideDeviceInfo() {
            document.getElementById('info').style.display = 'none';
            document.getElementById('packages').style.display = 'none';
            document.getElementById('request-build').style.display = 'none';
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø + „Ç´„Çπ„Çø„Éû„Ç§„Ç∫
        async function loadAiosTemplate() {
            try {
                const response = await fetch('scripts/setup.sh');
                if (!response.ok) {
                    throw new Error('Failed to load setup.sh template');
                }
                let content = await response.text();
                
                // Ë®≠ÂÆö„Ç¶„Ç£„Ç∂„Éº„Éâ„ÅÆÂÄ§„ÇíÂèñÂæó
                if (document.getElementById('use-aios-config').checked) {
                    const config = getAiosConfig();
                    content = customizeSetupScript(content, config);
                }
                
                document.getElementById('script').value = content;
            } catch (error) {
                console.error('Template loading error:', error);
                document.getElementById('script').value = '#!/bin/sh\n\n# Failed to load setup.sh template\n# Please check if scripts/setup.sh exists';
            }
        }

        // setup.sh„Çπ„ÇØ„É™„Éó„Éà„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
        function customizeSetupScript(content, config) {
            let customized = content;
            
            // Ë®ÄË™ûË®≠ÂÆö
            if (config.language) {
                customized = customized.replace('LANGUAGE="${LANGUAGE:-en}"', `LANGUAGE="${config.language}"`);
            }
            
            // ISPÊé•Á∂ö„Çø„Ç§„Éó
            customized = customized.replace('ISP_MODE="${ISP_MODE:-auto}"', `ISP_MODE="${config.connectionType}"`);
            
            // „Éá„Éê„Ç§„ÇπÂêç
            if (config.deviceName) {
                customized = customized.replace('# DEVICE_NAME=""', `DEVICE_NAME="${config.deviceName}"`);
            }
            
            // root„Éë„Çπ„ÉØ„Éº„Éâ
            if (config.rootPassword) {
                customized = customized.replace('# ROOT_PASSWORD=""', `ROOT_PASSWORD="${config.rootPassword}"`);
            }
            
            // Wi-FiË®≠ÂÆö
            if (config.wifiSSID) {
                customized = customized.replace('# WLAN_NAME=""', `WLAN_NAME="${config.wifiSSID}"`);
            }
            if (config.wifiPassword) {
                customized = customized.replace('# WLAN_PASSWORD=""', `WLAN_PASSWORD="${config.wifiPassword}"`);
            }
            
            // PPPoEË®≠ÂÆö
            if (config.connectionType === 'pppoe') {
                if (config.pppoeUsername) {
                    customized = customized.replace('# PPPOE_USERNAME=""', `PPPOE_USERNAME="${config.pppoeUsername}"`);
                }
                if (config.pppoePassword) {
                    customized = customized.replace('# PPPOE_PASSWORD=""', `PPPOE_PASSWORD="${config.pppoePassword}"`);
                }
            }
            
            return customized;
        }

        function toggleAiosConfig(e) {
            const config = document.getElementById('aios-config');
            const script = document.getElementById('script');

            if (e.target.checked) {
                config.style.display = 'block';
                loadAiosTemplate();
                updateRequiredPackages();
            } else {
                config.style.display = 'none';
                script.value = '';
            }
        }

        function handleConnectionTypeChange(e) {
            const pppoeSection = document.getElementById('pppoe-section');

            if (e.target.value === 'pppoe') {
                pppoeSection.style.display = 'block';
            } else {
                pppoeSection.style.display = 'none';
            }

            if (document.getElementById('use-aios-config').checked) {
                loadAiosTemplate();
                updateRequiredPackages();
            }
        }

        // ÂøÖË¶Å„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆËá™ÂãïËøΩÂä†
        function updateRequiredPackages() {
            const config = getAiosConfig();
            const packagesTextarea = document.getElementById('packages-custom');
            let currentPackages = packagesTextarea.value.split('\n').map(pkg => pkg.trim()).filter(pkg => pkg);
            
            // Êó¢Â≠ò„ÅÆaiosÈñ¢ÈÄ£„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÂâäÈô§
            currentPackages = currentPackages.filter(pkg => pkg !== 'map' && pkg !== 'ds-lite');
            
            // Êé•Á∂ö„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Éë„ÉÉ„Ç±„Éº„Ç∏ËøΩÂä†
            switch(config.connectionType) {
                case 'mape':
                    if (!currentPackages.includes('map')) {
                        currentPackages.push('map');
                    }
                    break;
                case 'dslite':
                    if (!currentPackages.includes('ds-lite')) {
                        currentPackages.push('ds-lite');
                    }
                    break;
            }
            
            packagesTextarea.value = currentPackages.join('\n');
        }

        function getAiosConfig() {
            return {
                language: document.getElementById('aios-language').value,
                deviceName: document.getElementById('aios-device-name').value,
                rootPassword: document.getElementById('aios-root-password').value,
                wifiSSID: document.getElementById('aios-wifi-ssid').value,
                wifiPassword: document.getElementById('aios-wifi-password').value,
                connectionType: document.querySelector('input[name="connectionType"]:checked').value,
                pppoeUsername: document.getElementById('pppoe-username').value,
                pppoePassword: document.getElementById('pppoe-password').value
            };
        }

        async function requestBuild() {
            if (!app.selectedDevice) {
                alert('Please select a device first');
                return;
            }

            try {
                document.getElementById('request-build').disabled = true;
                showProgress('Sending build request...', 10);

                const packages = getPackages();
                const script = document.getElementById('script').value;

                const requestBody = {
                    target: app.selectedDevice.target,
                    profile: app.selectedDevice.id,
                    packages: packages
                };

                if (app.selectedVersion && app.selectedVersion !== 'SNAPSHOT') {
                    requestBody.version = app.selectedVersion;
                }

                if (script && script.trim()) {
                    requestBody.defaults = script;
                }

                const response = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('Invalid JSON response: ' + responseText);
                }

                if (result.request_hash) {
                    await pollBuildStatus(result.request_hash);
                } else if (result.images && result.images.length > 0) {
                    hideProgress();
                    showDownloadLinks(result.images);
                } else {
                    throw new Error('No request hash or images in response');
                }

            } catch (error) {
                console.error('Build request failed:', error);
                alert('Build failed: ' + error.message);
                hideProgress();
            } finally {
                document.getElementById('request-build').disabled = false;
            }
        }

        function getPackages() {
            const input = document.getElementById('packages-custom').value;
            return input.split('\n').map(pkg => pkg.trim()).filter(pkg => pkg);
        }

        async function pollBuildStatus(requestHash) {
            const maxAttempts = 120; // 10ÂàÜÈñì
            let attempts = 0;
            const startTime = Date.now();

            while (attempts < maxAttempts) {
                try {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                    
                    const statusUrl = `https://sysupgrade.openwrt.org/api/v1/build/${requestHash}`;

                    const response = await fetch(statusUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404 && attempts < 5) {
                            showProgress(`Waiting for build to start... ${timeStr}`, 10);
                            await new Promise(resolve => setTimeout(resolve, 5000));
                            attempts++;
                            continue;
                        }
                        throw new Error(`Status check failed: HTTP ${response.status}`);
                    }

                    const statusText = await response.text();

                    let status;
                    try {
                        status = JSON.parse(statusText);
                    } catch (e) {
                        throw new Error('Invalid JSON in status response: ' + statusText);
                    }
                    
                    const progressPercent = Math.min((elapsedSeconds / 600) * 85 + 10, 95);

                    if (status.status === 'done' || status.status === 'success' || 
                        status.detail === 'done' || status.imagebuilder_status === 'done') {
                        let images = status.images || 
                                   status.request?.images || 
                                   status.request?.files ||
                                   status.files ||
                                   [];
                        
                        let rh = status.request_hash || status.request?.request_hash;
                        
                        showProgress('Build completed!', 100);
                        setTimeout(() => {
                            hideProgress();
                            showDownloadLinks(images, status, rh);
                        }, 500);
                        return;
                    } else if (status.status === 'failed' || status.status === 'failure' || 
                              status.detail === 'failed' || status.imagebuilder_status === 'failed') {
                        throw new Error(`Build failed: ${status.detail || status.stdout || 'Unknown error'}`);
                    } else if (status.status === 'queued') {
                        showProgress(`Queued for build... ${timeStr}`, Math.max(progressPercent * 0.3, 10));
                    } else if (status.status === 'building') {
                        showProgress(`Building image... ${timeStr}`, Math.max(progressPercent * 0.8, 30));
                    } else {
                        showProgress(`Processing (${status.status})... ${timeStr}`, progressPercent);
                    }

                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;

                } catch (error) {
                    if (attempts >= 5) {
                        throw error;
                    }
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    showProgress(`Connection error, retrying... ${elapsedSeconds}s`, 5);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;
                }
            }

            throw new Error('Build timeout after 10 minutes');
        }

        function showProgress(message, percentage) {
            document.getElementById('build-message').textContent = message;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('build-progress').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('build-progress').style.display = 'none';
        }

        function showDownloadLinks(images, fullStatus, requestHash) {
            const container = document.getElementById('download-links');
            container.innerHTML = '<h4>Download</h4>';

            if (images && images.length > 0) {
                images.forEach((image, index) => {
                    const link = document.createElement('a');
                    let imageUrl = '';
                    let fileName = '';
                    
                    if (image.name && requestHash) {
                        imageUrl = `https://sysupgrade.openwrt.org/store/${requestHash}/${image.name}`;
                        fileName = image.name;
                        
                        let displayName = fileName;
                        if (image.type) {
                            if (image.type.includes('sysupgrade')) {
                                displayName = `üîÑ Sysupgrade (${image.type})`;
                            } else if (image.type.includes('factory')) {
                                displayName = `üè≠ Factory (${image.type})`;
                            } else if (image.type.includes('sdcard')) {
                                displayName = `üíæ SD Card (${image.type})`;
                            } else {
                                displayName = `üì¶ ${image.type}`;
                            }
                        }
                        
                        link.href = imageUrl;
                        link.className = 'download-link';
                        link.textContent = displayName;
                        link.target = '_blank';
                        link.download = fileName;
                        link.title = fileName;
                        
                        container.appendChild(link);
                        container.appendChild(document.createElement('br'));
                        
                    } else {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.color = 'red';
                        errorDiv.style.margin = '5px 0';
                        errorDiv.innerHTML = `‚ùå Image ${index}: Missing data (name: ${!!image.name}, hash: ${!!requestHash})`;
                        container.appendChild(errorDiv);
                    }
                });
                
                const debugDiv = document.createElement('div');
                debugDiv.style.background = '#f9f9f9';
                debugDiv.style.padding = '5px';
                debugDiv.style.marginTop = '10px';
                debugDiv.style.fontSize = '11px';
                debugDiv.style.color = '#666';
                debugDiv.innerHTML = `<strong>Debug:</strong> Found ${images.length} images, Request Hash: ${requestHash?.substring(0, 16)}...`;
                container.appendChild(debugDiv);
                
            } else {
                container.innerHTML = '<h4>Download</h4><p>No images available</p>';
            }
        }
    </script>
</body>

</html>
