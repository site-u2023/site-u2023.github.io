<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt „Ç´„Çπ„Çø„É†„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Éì„É´„ÉÄ„Éº</title>
    <style>
        :root {
            --primary-color: #1e90ff;
            --secondary-color: #f0f8ff;
            --border-color: #ddd;
            --text-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active {
            color: var(--primary-color);
        }

        .step.active::after {
            background: var(--primary-color);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--border-color);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: var(--primary-color);
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
        }

        .device-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .device-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .device-item:hover {
            background: var(--bg-light);
        }

        .device-item.selected {
            background: var(--secondary-color);
            border-left: 4px solid var(--primary-color);
        }

        .device-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .device-details {
            font-size: 14px;
            color: #666;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
        }

        .package-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .package-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .package-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: var(--bg-light);
            border-radius: 5px;
        }

        .package-item button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: var(--success-color);
            color: white;
        }

        .remove-btn {
            background: var(--danger-color);
            color: white;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #1c7ed6;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: var(--primary-color);
            background-color: var(--secondary-color);
        }

        .radio-item input[type="radio"] {
            margin-right: 8px;
        }

        .conditional-fields {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .hidden {
            display: none;
        }

        .build-status {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .download-link {
            display: inline-block;
            padding: 12px 20px;
            background: var(--success-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            transition: background 0.3s ease;
        }

        .download-link:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .package-section {
                grid-template-columns: 1fr;
            }
            
            .step-indicator {
                flex-direction: column;
                gap: 10px;
            }
            
            .step::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ OpenWrt „Ç´„Çπ„Çø„É†„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Éì„É´„ÉÄ„Éº</h1>
            <p>„Éá„Éê„Ç§„ÇπÈÅ∏Êäû„Åã„Çâ„Éì„É´„Éâ„Åæ„Åß„ÄÅ„Åô„Åπ„Å¶„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</p>
        </div>

        <!-- „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div>„Éá„Éê„Ç§„ÇπÈÅ∏Êäû</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>Âü∫Êú¨Ë®≠ÂÆö</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>„Éë„ÉÉ„Ç±„Éº„Ç∏</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>„Éì„É´„Éâ</div>
            </div>
        </div>

        <!-- „Çπ„ÉÜ„ÉÉ„Éó1: „Éá„Éê„Ç§„ÇπÈÅ∏Êäû -->
        <div class="card" id="deviceSelection">
            <h2>üì± „Éá„Éê„Ç§„ÇπÈÅ∏Êäû</h2>
            <div class="search-section">
                <input type="text" id="deviceSearch" class="search-input" placeholder="„Éá„Éê„Ç§„ÇπÂêç„ÄÅ„É°„Éº„Ç´„Éº„ÄÅÂûãÁï™„ÅßÊ§úÁ¥¢...">
                <div class="device-list" id="deviceList">
                    <div class="device-item" onclick="selectDevice(this)" data-id="xiaomi_redmi-router-ax6s">
                        <div class="device-name">Xiaomi Redmi Router AX6S</div>
                        <div class="device-details">Target: mediatek/filogic | Version: 23.05.5</div>
                    </div>
                    <div class="device-item" onclick="selectDevice(this)" data-id="buffalo_wsr-2533dhp">
                        <div class="device-name">Buffalo WSR-2533DHP</div>
                        <div class="device-details">Target: bcm53xx/generic | Version: 23.05.5</div>
                    </div>
                    <div class="device-item" onclick="selectDevice(this)" data-id="banana-pi_bpi-r4">
                        <div class="device-name">Banana Pi BPI-R4</div>
                        <div class="device-details">Target: mediatek/filogic | Version: 23.05.5</div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="nextStep(2)" id="nextToConfig" disabled>Ê¨°„Å∏ÔºöÂü∫Êú¨Ë®≠ÂÆö</button>
        </div>

        <!-- „Çπ„ÉÜ„ÉÉ„Éó2: Âü∫Êú¨Ë®≠ÂÆö -->
        <div class="card hidden" id="basicConfig">
            <h2>‚öôÔ∏è Âü∫Êú¨Ë®≠ÂÆö</h2>
            
            <!-- aios-light.sh Ë®≠ÂÆö -->
            <div class="form-section">
                <h3>üåê „Éá„Éê„Ç§„ÇπÂü∫Êú¨Ë®≠ÂÆö</h3>
                
                <div class="form-group">
                    <label for="language">Ë®ÄË™ûË®≠ÂÆö</label>
                    <select id="language" class="form-control">
                        <option value="en">English</option>
                        <option value="ja" selected>Êó•Êú¨Ë™û</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="deviceName">„Éá„Éê„Ç§„ÇπÂêç</label>
                    <input type="text" id="deviceName" class="form-control" placeholder="‰æã: OpenWrt-Router">
                </div>

                <div class="form-group">
                    <label for="rootPassword">Root„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="rootPassword" class="form-control" placeholder="8ÊñáÂ≠ó‰ª•‰∏äÔºàÁ©∫Ê¨ÑÂèØÔºâ">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                </div>
            </div>

            <div class="form-section">
                <h3>üì∂ Wi-FiË®≠ÂÆö</h3>
                
                <div class="form-group">
                    <label for="wifiSSID">Wi-Fi SSID</label>
                    <input type="text" id="wifiSSID" class="form-control" placeholder="‰æã: MyOpenWrt">
                </div>

                <div class="form-group">
                    <label for="wifiPassword">Wi-Fi „Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="wifiPassword" class="form-control" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä">
                </div>
            </div>

            <div class="form-section">
                <h3>üåç „Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂öË®≠ÂÆö</h3>
                
                <div class="form-group">
                    <label>Êé•Á∂ö„Çø„Ç§„Éó</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="connAuto" name="connectionType" value="auto" checked>
                            <span>Ëá™ÂãïÊ§úÂá∫</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connDHCP" name="connectionType" value="dhcp">
                            <span>DHCP</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connPPPoE" name="connectionType" value="pppoe">
                            <span>PPPoE</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connDSLite" name="connectionType" value="dslite">
                            <span>DS-Lite</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connMAPE" name="connectionType" value="mape">
                            <span>MAP-E</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connNone" name="connectionType" value="none">
                            <span>Ë®≠ÂÆö„Å™„Åó</span>
                        </div>
                    </div>
                </div>

                <!-- PPPoEË®≠ÂÆö -->
                <div id="pppoeFields" class="conditional-fields hidden">
                    <div class="form-group">
                        <label for="pppoeUsername">PPPoE „É¶„Éº„Ç∂„ÉºÂêç</label>
                        <input type="text" id="pppoeUsername" class="form-control" placeholder="„Éó„É≠„Éê„Ç§„ÉÄ„Åã„ÇâÊèê‰æõ„Åï„Çå„Åü„É¶„Éº„Ç∂„ÉºÂêç">
                    </div>
                    <div class="form-group">
                        <label for="pppoePassword">PPPoE „Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="pppoePassword" class="form-control" placeholder="„Éó„É≠„Éê„Ç§„ÉÄ„Åã„ÇâÊèê‰æõ„Åï„Çå„Åü„Éë„Çπ„ÉØ„Éº„Éâ">
                    </div>
                </div>
            </div>

            <button class="btn secondary" onclick="prevStep(1)">Êàª„Çã</button>
            <button class="btn" onclick="nextStep(3)">Ê¨°„Å∏Ôºö„Éë„ÉÉ„Ç±„Éº„Ç∏Ë®≠ÂÆö</button>
        </div>

        <!-- „Çπ„ÉÜ„ÉÉ„Éó3: „Éë„ÉÉ„Ç±„Éº„Ç∏Ë®≠ÂÆö -->
        <div class="card hidden" id="packageConfig">
            <h2>üì¶ „Éë„ÉÉ„Ç±„Éº„Ç∏Ë®≠ÂÆö</h2>
            
            <div class="package-section">
                <div>
                    <h3>Âà©Áî®ÂèØËÉΩ„Éë„ÉÉ„Ç±„Éº„Ç∏</h3>
                    <input type="text" id="packageSearch" class="form-control" placeholder="„Éë„ÉÉ„Ç±„Éº„Ç∏Ê§úÁ¥¢..." style="margin-bottom: 10px;">
                    <div class="package-list" id="availablePackages">
                        <div class="package-item">
                            <span>luci-ssl</span>
                            <button class="add-btn" onclick="addPackage('luci-ssl')">ËøΩÂä†</button>
                        </div>
                        <div class="package-item">
                            <span>ttyd</span>
                            <button class="add-btn" onclick="addPackage('ttyd')">ËøΩÂä†</button>
                        </div>
                        <div class="package-item">
                            <span>nano</span>
                            <button class="add-btn" onclick="addPackage('nano')">ËøΩÂä†</button>
                        </div>
                        <div class="package-item">
                            <span>curl</span>
                            <button class="add-btn" onclick="addPackage('curl')">ËøΩÂä†</button>
                        </div>
                        <div class="package-item">
                            <span>htop</span>
                            <button class="add-btn" onclick="addPackage('htop')">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>ÈÅ∏ÊäûÊ∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏</h3>
                    <div class="package-list" id="selectedPackages">
                        <!-- „Éá„Éï„Ç©„É´„Éà„Éë„ÉÉ„Ç±„Éº„Ç∏ -->
                        <div class="package-item">
                            <span>base-files</span>
                            <button class="remove-btn" onclick="removePackage('base-files')">ÂâäÈô§</button>
                        </div>
                        <div class="package-item">
                            <span>luci</span>
                            <button class="remove-btn" onclick="removePackage('luci')">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üìù „Ç´„Çπ„Çø„É†„Éë„ÉÉ„Ç±„Éº„Ç∏ËøΩÂä†</h3>
                <div class="form-group">
                    <label for="customPackages">„Éë„ÉÉ„Ç±„Éº„Ç∏ÂêçÔºà„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßË§áÊï∞ÊåáÂÆöÂèØËÉΩÔºâ</label>
                    <input type="text" id="customPackages" class="form-control" placeholder="‰æã: vim wget openssh-server">
                    <button class="btn" onclick="addCustomPackages()" style="margin-top: 10px;">„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíËøΩÂä†</button>
                </div>
            </div>

            <button class="btn secondary" onclick="prevStep(2)">Êàª„Çã</button>
            <button class="btn" onclick="nextStep(4)">Ê¨°„Å∏Ôºö„Éì„É´„ÉâÂÆüË°å</button>
        </div>

        <!-- „Çπ„ÉÜ„ÉÉ„Éó4: „Éì„É´„Éâ -->
        <div class="card hidden" id="buildConfig">
            <h2>üî® „Éì„É´„ÉâË®≠ÂÆö„Å®ÂÆüË°å</h2>
            
            <div class="form-section">
                <h3>üìã Ë®≠ÂÆöÁ¢∫Ë™ç</h3>
                <div id="configSummary"></div>
            </div>

            <div class="form-section">
                <h3>üöÄ „Éì„É´„ÉâÂÆüË°å</h3>
                <button class="btn" onclick="startBuild()" id="buildBtn">„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„Çí„Éì„É´„Éâ</button>
                <button class="btn secondary" onclick="prevStep(3)" id="backBtn">Êàª„Çã</button>
            </div>

            <!-- „Éì„É´„ÉâÁä∂Ê≥Å -->
            <div id="buildStatus" class="hidden">
                <div class="build-status">
                    <div class="spinner"></div>
                    <h3>„Éì„É´„Éâ‰∏≠...</h3>
                    <p id="buildProgress">„Éì„É´„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°‰∏≠...</p>
                </div>
            </div>

            <!-- „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ -->
            <div id="buildComplete" class="hidden">
                <div class="build-status">
                    <h3>‚úÖ „Éì„É´„ÉâÂÆå‰∫ÜÔºÅ</h3>
                    <div class="download-links" id="downloadLinks">
                        <!-- „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
        let currentStep = 1;
        let selectedDevice = null;
        let selectedPackages = ['base-files', 'luci'];
        let buildRequestId = null;

        // „Éá„Éê„Ç§„ÇπÊ§úÁ¥¢
        document.getElementById('deviceSearch').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const devices = document.querySelectorAll('.device-item');
            
            devices.forEach(device => {
                const name = device.querySelector('.device-name').textContent.toLowerCase();
                const details = device.querySelector('.device-details').textContent.toLowerCase();
                
                if (name.includes(query) || details.includes(query)) {
                    device.style.display = 'block';
                } else {
                    device.style.display = 'none';
                }
            });
        });

        // „Éá„Éê„Ç§„ÇπÈÅ∏Êäû
        function selectDevice(element) {
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíË®≠ÂÆö
            element.classList.add('selected');
            selectedDevice = {
                id: element.dataset.id,
                name: element.querySelector('.device-name').textContent,
                details: element.querySelector('.device-details').textContent
            };
            
            document.getElementById('nextToConfig').disabled = false;
        }

        // Êé•Á∂ö„Çø„Ç§„ÉóÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
        document.querySelectorAll('input[name="connectionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const pppoeFields = document.getElementById('pppoeFields');
                if (this.value === 'pppoe') {
                    pppoeFields.classList.remove('hidden');
                } else {
                    pppoeFields.classList.add('hidden');
                }
            });
        });

        // „Éë„ÉÉ„Ç±„Éº„Ç∏ÁÆ°ÁêÜ
        function addPackage(packageName) {
            if (!selectedPackages.includes(packageName)) {
                selectedPackages.push(packageName);
                updateSelectedPackages();
            }
        }

        function removePackage(packageName) {
            const index = selectedPackages.indexOf(packageName);
            if (index > -1) {
                selectedPackages.splice(index, 1);
                updateSelectedPackages();
            }
        }

        function addCustomPackages() {
            const input = document.getElementById('customPackages');
            const packages = input.value.split(' ').filter(pkg => pkg.trim());
            
            packages.forEach(pkg => {
                if (!selectedPackages.includes(pkg)) {
                    selectedPackages.push(pkg);
                }
            });
            
            input.value = '';
            updateSelectedPackages();
        }

        function updateSelectedPackages() {
            const container = document.getElementById('selectedPackages');
            container.innerHTML = '';
            
            selectedPackages.forEach(pkg => {
                const item = document.createElement('div');
                item.className = 'package-item';
                item.innerHTML = `
                    <span>${pkg}</span>
                    <button class="remove-btn" onclick="removePackage('${pkg}')">ÂâäÈô§</button>
                `;
                container.appendChild(item);
            });
        }

        // „Çπ„ÉÜ„ÉÉ„ÉóÁÆ°ÁêÜ
        function nextStep(step) {
            if (step === 2 && !selectedDevice) {
                alert('„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            if (step === 4) {
                updateConfigSummary();
            }
            
            showStep(step);
        }

        function prevStep(step) {
            showStep(step);
        }

        function showStep(step) {
            // „Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                if (index + 1 <= step) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
            });
            
            // ÂØæÂøú„Åô„Çã„Ç´„Éº„Éâ„ÇíË°®Á§∫
            const stepIds = ['', 'deviceSelection', 'basicConfig', 'packageConfig', 'buildConfig'];
            document.getElementById(stepIds[step]).classList.remove('hidden');
            
            currentStep = step;
        }

        // Ë®≠ÂÆö„Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        function updateConfigSummary() {
            const summary = document.getElementById('configSummary');
            const config = getConfiguration();
            
            summary.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>ÈÅ∏Êäû„Éá„Éê„Ç§„Çπ</h4>
                    <p>${selectedDevice.name}</p>
                    
                    <h4>Âü∫Êú¨Ë®≠ÂÆö</h4>
                    <p>Ë®ÄË™û: ${config.language}</p>
                    <p>„Éá„Éê„Ç§„ÇπÂêç: ${config.deviceName || 'Êú™Ë®≠ÂÆö'}</p>
                    <p>Êé•Á∂ö„Çø„Ç§„Éó: ${config.connectionType}</p>
                    
                    <h4>Wi-FiË®≠ÂÆö</h4>
                    <p>SSID: ${config.wifiSSID || 'Êú™Ë®≠ÂÆö'}</p>
                    
                    <h4>„Éë„ÉÉ„Ç±„Éº„Ç∏ (${selectedPackages.length}ÂÄã)</h4>
                    <p>${selectedPackages.join(', ')}</p>
                </div>
            `;
        }

        // Ë®≠ÂÆöÂèñÂæó
        function getConfiguration() {
            return {
                language: document.getElementById('language').value,
                deviceName: document.getElementById('deviceName').value,
                rootPassword: document.getElementById('rootPassword').value,
                wifiSSID: document.getElementById('wifiSSID').value,
                wifiPassword: document.getElementById('wifiPassword').value,
                connectionType: document.querySelector('input[name="connectionType"]:checked').value,
                pppoeUsername: document.getElementById('pppoeUsername').value,
                pppoePassword: document.getElementById('pppoePassword').value
            };
        }

        // aios-light.sh „Çπ„ÇØ„É™„Éó„ÉàÁîüÊàê
        function generateAiosScript(config) {
            let script = '#!/bin/sh\n\n';
            script += '# OpenWrt Auto Configuration Script\n';
            script += '# Generated by OpenWrt Custom Firmware Builder\n\n';
            
            script += 'CONFIG_SCRIPT="/tmp/aios/aios-light.sh"\n';
            script += 'mkdir -p /tmp/aios\n\n';

            script += 'wget --no-check-certificate -O "$CONFIG_SCRIPT" "https://site-u.pages.dev/build/scripts/aios-light.sh" 2>/dev/null\n\n';

            script += 'if [ ! -f "$CONFIG_SCRIPT" ]; then\n';
            script += '    logger -t firmware-builder "Failed to download aios-light.sh"\n';
            script += '    exit 1\n';
            script += 'fi\n\n';

            script += 'chmod +x "$CONFIG_SCRIPT"\n\n';

            // Áí∞Â¢ÉÂ§âÊï∞„ÅÆË®≠ÂÆö
            script += '# Configuration Variables\n';
            
            if (config.language) {
                script += `export LANGUAGE="${config.language}"\n`;
            }
            
            if (config.deviceName) {
                script += `export DEVICE_NAME="${config.deviceName}"\n`;
            }
            
            if (config.rootPassword) {
                script += `export ROOT_PASSWORD="${config.rootPassword}"\n`;
            }
            
            if (config.wifiSSID) {
                script += `export WLAN_NAME="${config.wifiSSID}"\n`;
            }
            
            if (config.wifiPassword) {
                script += `export WLAN_PASSWORD="${config.wifiPassword}"\n`;
            }

            // Êé•Á∂ö„Çø„Ç§„Éó„ÅÆË®≠ÂÆö
            if (config.connectionType === 'auto') {
                script += 'export ISP_MODE=""\n';
            } else if (config.connectionType === 'pppoe') {
                script += 'export ISP_MODE="pppoe"\n';
                if (config.pppoeUsername) {
                    script += `export PPPOE_USERNAME="${config.pppoeUsername}"\n`;
                }
                if (config.pppoePassword) {
                    script += `export PPPOE_PASSWORD="${config.pppoePassword}"\n`;
                }
            } else {
                script += `export ISP_MODE="${config.connectionType}"\n`;
            }

            script += '\n# Execute configuration script\n';
            script += 'exec sh "$CONFIG_SCRIPT" "$ISP_MODE"\n';

            return script;
        }

        // „Éì„É´„ÉâÈñãÂßã
        async function startBuild() {
            const config = getConfiguration();
            const script = generateAiosScript(config);
            
            // UI„ÇíÊõ¥Êñ∞
            document.getElementById('buildBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('buildStatus').classList.remove('hidden');
            
            try {
                // OpenWrt API„Å´„Éì„É´„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
                const buildData = {
                    target: extractTarget(selectedDevice.details),
                    profile: selectedDevice.id,
                    packages: selectedPackages,
                    script: script
                };
                
                // ÂÆüÈöõ„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅØ OpenWrt „ÅÆ„ÇÇ„ÅÆ„Çí‰ΩøÁî®
                const response = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(buildData)
                });
                
                if (!response.ok) {
                    throw new Error('„Éì„É´„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                const result = await response.json();
                buildRequestId = result.request_id;
                
                // „Éì„É´„ÉâÁä∂Ê≥Å„ÇíÁõ£Ë¶ñ
                pollBuildStatus();
                
            } catch (error) {
                console.error('Build error:', error);
                document.getElementById('buildProgress').textContent = '„Éì„É´„Éâ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message;
            }
        }

        // „Éì„É´„ÉâÁä∂Ê≥ÅÁõ£Ë¶ñ
        async function pollBuildStatus() {
            try {
                const response = await fetch(`https://sysupgrade.openwrt.org/api/v1/build/${buildRequestId}`);
                const status = await response.json();
                
                document.getElementById('buildProgress').textContent = `Áä∂Ê≥Å: ${status.status}`;
                
                if (status.status === 'completed') {
                    showBuildComplete(status);
                } else if (status.status === 'failed') {
                    document.getElementById('buildProgress').textContent = '„Éì„É´„Éâ„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü';
                } else {
                    // „Åæ„Å†„Éì„É´„Éâ‰∏≠„ÅÆÂ†¥Âêà„ÅØ5ÁßíÂæå„Å´ÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
                    setTimeout(pollBuildStatus, 5000);
                }
            } catch (error) {
                console.error('Status check error:', error);
                setTimeout(pollBuildStatus, 5000);
            }
        }

        // „Éì„É´„ÉâÂÆå‰∫ÜË°®Á§∫
        function showBuildComplete(status) {
            document.getElementById('buildStatus').classList.add('hidden');
            document.getElementById('buildComplete').classList.remove('hidden');
            
            const linksContainer = document.getElementById('downloadLinks');
            linksContainer.innerHTML = '';
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÁîüÊàê
            if (status.images) {
                status.images.forEach(image => {
                    const link = document.createElement('a');
                    link.href = image.url;
                    link.className = 'download-link';
                    link.textContent = `üì• ${image.name} „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ`;
                    link.target = '_blank';
                    linksContainer.appendChild(link);
                });
            }
        }

        // „Çø„Éº„Ç≤„ÉÉ„ÉàÊäΩÂá∫
        function extractTarget(details) {
            const match = details.match(/Target: ([^|]+)/);
            return match ? match[1].trim() : 'generic';
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedPackages();
        });
    </script>
</body>
</html>
