<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ãƒ“ãƒ«ãƒ€ãƒ¼</title>
    <style>
        :root {
            --primary-color: #1e90ff;
            --secondary-color: #f0f8ff;
            --border-color: #ddd;
            --text-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active {
            color: var(--primary-color);
        }

        .step.active::after {
            background: var(--primary-color);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--border-color);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: var(--primary-color);
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
        }

        .device-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .device-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .device-item:hover {
            background: var(--bg-light);
        }

        .device-item.selected {
            background: var(--secondary-color);
            border-left: 4px solid var(--primary-color);
        }

        .device-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .device-details {
            font-size: 14px;
            color: #666;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
        }

        .package-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .package-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .package-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: var(--bg-light);
            border-radius: 5px;
        }

        .package-item button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: var(--success-color);
            color: white;
        }

        .remove-btn {
            background: var(--danger-color);
            color: white;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #1c7ed6;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: var(--primary-color);
            background-color: var(--secondary-color);
        }

        .radio-item input[type="radio"] {
            margin-right: 8px;
        }

        .conditional-fields {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .hidden {
            display: none;
        }

        .build-status {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .download-link {
            display: inline-block;
            padding: 12px 20px;
            background: var(--success-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            transition: background 0.3s ease;
        }

        .download-link:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .package-section {
                grid-template-columns: 1fr;
            }
            
            .step-indicator {
                flex-direction: column;
                gap: 10px;
            }
            
            .step::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ OpenWrt ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ãƒ“ãƒ«ãƒ€ãƒ¼</h1>
            <p>ãƒ‡ãƒã‚¤ã‚¹é¸æŠã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã¾ã§ã€ã™ã¹ã¦ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</p>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div>ãƒ‡ãƒã‚¤ã‚¹é¸æŠ</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>åŸºæœ¬è¨­å®š</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>ãƒ“ãƒ«ãƒ‰</div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒã‚¤ã‚¹é¸æŠ -->
        <div class="card" id="deviceSelection">
            <h2>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹é¸æŠ</h2>
            <div class="search-section">
                <input type="text" id="deviceSearch" class="search-input" placeholder="ãƒ‡ãƒã‚¤ã‚¹åã€ãƒ¡ãƒ¼ã‚«ãƒ¼ã€å‹ç•ªã§æ¤œç´¢...">
                <div class="device-list" id="deviceList">
                    <div class="device-item" onclick="selectDevice(this)" data-id="xiaomi_redmi-router-ax6s">
                        <div class="device-name">Xiaomi Redmi Router AX6S</div>
                        <div class="device-details">Target: mediatek/filogic | Version: 23.05.5</div>
                    </div>
                    <div class="device-item" onclick="selectDevice(this)" data-id="buffalo_wsr-2533dhp">
                        <div class="device-name">Buffalo WSR-2533DHP</div>
                        <div class="device-details">Target: bcm53xx/generic | Version: 23.05.5</div>
                    </div>
                    <div class="device-item" onclick="selectDevice(this)" data-id="banana-pi_bpi-r4">
                        <div class="device-name">Banana Pi BPI-R4</div>
                        <div class="device-details">Target: mediatek/filogic | Version: 23.05.5</div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="nextStep(2)" id="nextToConfig" disabled>æ¬¡ã¸ï¼šåŸºæœ¬è¨­å®š</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬è¨­å®š -->
        <div class="card hidden" id="basicConfig">
            <h2>âš™ï¸ åŸºæœ¬è¨­å®š</h2>
            
            <!-- aios-light.sh è¨­å®š -->
            <div class="form-section">
                <h3>ğŸŒ ãƒ‡ãƒã‚¤ã‚¹åŸºæœ¬è¨­å®š</h3>
                
                <div class="form-group">
                    <label for="language">è¨€èªè¨­å®š</label>
                    <select id="language" class="form-control">
                        <option value="en">English</option>
                        <option value="ja" selected>æ—¥æœ¬èª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="deviceName">ãƒ‡ãƒã‚¤ã‚¹å</label>
                    <input type="text" id="deviceName" class="form-control" placeholder="ä¾‹: OpenWrt-Router">
                </div>

                <div class="form-group">
                    <label for="rootPassword">Rootãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="rootPassword" class="form-control" placeholder="8æ–‡å­—ä»¥ä¸Šï¼ˆç©ºæ¬„å¯ï¼‰">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸ“¶ Wi-Fiè¨­å®š</h3>
                
                <div class="form-group">
                    <label for="wifiSSID">Wi-Fi SSID</label>
                    <input type="text" id="wifiSSID" class="form-control" placeholder="ä¾‹: MyOpenWrt">
                </div>

                <div class="form-group">
                    <label for="wifiPassword">Wi-Fi ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="wifiPassword" class="form-control" placeholder="8æ–‡å­—ä»¥ä¸Š">
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šè¨­å®š</h3>
                
                <div class="form-group">
                    <label>æ¥ç¶šã‚¿ã‚¤ãƒ—</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="connAuto" name="connectionType" value="auto" checked>
                            <span>è‡ªå‹•æ¤œå‡º</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connDHCP" name="connectionType" value="dhcp">
                            <span>DHCP</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connPPPoE" name="connectionType" value="pppoe">
                            <span>PPPoE</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connDSLite" name="connectionType" value="dslite">
                            <span>DS-Lite</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connMAPE" name="connectionType" value="mape">
                            <span>MAP-E</span>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="connNone" name="connectionType" value="none">
                            <span>è¨­å®šãªã—</span>
                        </div>
                    </div>
                </div>

                <!-- PPPoEè¨­å®š -->
                <div id="pppoeFields" class="conditional-fields hidden">
                    <div class="form-group">
                        <label for="pppoeUsername">PPPoE ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                        <input type="text" id="pppoeUsername" class="form-control" placeholder="ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‹ã‚‰æä¾›ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                    </div>
                    <div class="form-group">
                        <label for="pppoePassword">PPPoE ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="pppoePassword" class="form-control" placeholder="ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‹ã‚‰æä¾›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                </div>
            </div>

            <button class="btn secondary" onclick="prevStep(1)">æˆ»ã‚‹</button>
            <button class="btn" onclick="nextStep(3)">æ¬¡ã¸ï¼šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š -->
        <div class="card hidden" id="packageConfig">
            <h2>ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š</h2>
            
            <div class="package-section">
                <div>
                    <h3>åˆ©ç”¨å¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</h3>
                    <input type="text" id="packageSearch" class="form-control" placeholder="ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¤œç´¢..." style="margin-bottom: 10px;">
                    <div class="package-list" id="availablePackages">
                        <div class="package-item">
                            <span>luci-ssl</span>
                            <button class="add-btn" onclick="addPackage('luci-ssl')">è¿½åŠ </button>
                        </div>
                        <div class="package-item">
                            <span>ttyd</span>
                            <button class="add-btn" onclick="addPackage('ttyd')">è¿½åŠ </button>
                        </div>
                        <div class="package-item">
                            <span>nano</span>
                            <button class="add-btn" onclick="addPackage('nano')">è¿½åŠ </button>
                        </div>
                        <div class="package-item">
                            <span>curl</span>
                            <button class="add-btn" onclick="addPackage('curl')">è¿½åŠ </button>
                        </div>
                        <div class="package-item">
                            <span>htop</span>
                            <button class="add-btn" onclick="addPackage('htop')">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>é¸æŠæ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</h3>
                    <div class="package-list" id="selectedPackages">
                        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ -->
                        <div class="package-item">
                            <span>base-files</span>
                            <button class="remove-btn" onclick="removePackage('base-files')">å‰Šé™¤</button>
                        </div>
                        <div class="package-item">
                            <span>luci</span>
                            <button class="remove-btn" onclick="removePackage('luci')">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ </h3>
                <div class="form-group">
                    <label for="customPackages">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯èƒ½ï¼‰</label>
                    <input type="text" id="customPackages" class="form-control" placeholder="ä¾‹: vim wget openssh-server">
                    <button class="btn" onclick="addCustomPackages()" style="margin-top: 10px;">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ </button>
                </div>
            </div>

            <button class="btn secondary" onclick="prevStep(2)">æˆ»ã‚‹</button>
            <button class="btn" onclick="nextStep(4)">æ¬¡ã¸ï¼šãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ“ãƒ«ãƒ‰ -->
        <div class="card hidden" id="buildConfig">
            <h2>ğŸ”¨ ãƒ“ãƒ«ãƒ‰è¨­å®šã¨å®Ÿè¡Œ</h2>
            
            <div class="form-section">
                <h3>ğŸ“‹ è¨­å®šç¢ºèª</h3>
                <div id="configSummary"></div>
            </div>

            <div class="form-section">
                <h3>ğŸš€ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ</h3>
                <button class="btn" onclick="startBuild()" id="buildBtn">ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ãƒ“ãƒ«ãƒ‰</button>
                <button class="btn secondary" onclick="prevStep(3)" id="backBtn">æˆ»ã‚‹</button>
            </div>

            <!-- ãƒ“ãƒ«ãƒ‰çŠ¶æ³ -->
            <div id="buildStatus" class="hidden">
                <div class="build-status">
                    <div class="spinner"></div>
                    <h3>ãƒ“ãƒ«ãƒ‰ä¸­...</h3>
                    <p id="buildProgress">ãƒ“ãƒ«ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...</p>
                </div>
            </div>

            <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ -->
            <div id="buildComplete" class="hidden">
                <div class="build-status">
                    <h3>âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼</h3>
                    <div class="download-links" id="downloadLinks">
                        <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentStep = 1;
        let selectedDevice = null;
        let selectedPackages = ['base-files', 'luci'];
        let buildRequestId = null;

        // ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢
        document.getElementById('deviceSearch').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const devices = document.querySelectorAll('.device-item');
            
            devices.forEach(device => {
                const name = device.querySelector('.device-name').textContent.toLowerCase();
                const details = device.querySelector('.device-details').textContent.toLowerCase();
                
                if (name.includes(query) || details.includes(query)) {
                    device.style.display = 'block';
                } else {
                    device.style.display = 'none';
                }
            });
        });

        // ãƒ‡ãƒã‚¤ã‚¹é¸æŠ
        function selectDevice(element) {
            // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠã‚’è¨­å®š
            element.classList.add('selected');
            selectedDevice = {
                id: element.dataset.id,
                name: element.querySelector('.device-name').textContent,
                details: element.querySelector('.device-details').textContent
            };
            
            document.getElementById('nextToConfig').disabled = false;
        }

        // æ¥ç¶šã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
        document.querySelectorAll('input[name="connectionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const pppoeFields = document.getElementById('pppoeFields');
                if (this.value === 'pppoe') {
                    pppoeFields.classList.remove('hidden');
                } else {
                    pppoeFields.classList.add('hidden');
                }
            });
        });

        // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†
        function addPackage(packageName) {
            if (!selectedPackages.includes(packageName)) {
                selectedPackages.push(packageName);
                updateSelectedPackages();
            }
        }

        function removePackage(packageName) {
            const index = selectedPackages.indexOf(packageName);
            if (index > -1) {
                selectedPackages.splice(index, 1);
                updateSelectedPackages();
            }
        }

        function addCustomPackages() {
            const input = document.getElementById('customPackages');
            const packages = input.value.split(' ').filter(pkg => pkg.trim());
            
            packages.forEach(pkg => {
                if (!selectedPackages.includes(pkg)) {
                    selectedPackages.push(pkg);
                }
            });
            
            input.value = '';
            updateSelectedPackages();
        }

        function updateSelectedPackages() {
            const container = document.getElementById('selectedPackages');
            container.innerHTML = '';
            
            selectedPackages.forEach(pkg => {
                const item = document.createElement('div');
                item.className = 'package-item';
                item.innerHTML = `
                    <span>${pkg}</span>
                    <button class="remove-btn" onclick="removePackage('${pkg}')">å‰Šé™¤</button>
                `;
                container.appendChild(item);
            });
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†
        function nextStep(step) {
            if (step === 2 && !selectedDevice) {
                alert('ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (step === 4) {
                updateConfigSummary();
            }
            
            showStep(step);
        }

        function prevStep(step) {
            showStep(step);
        }

        function showStep(step) {
            // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                if (index + 1 <= step) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
            });
            
            // å¯¾å¿œã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const stepIds = ['', 'deviceSelection', 'basicConfig', 'packageConfig', 'buildConfig'];
            document.getElementById(stepIds[step]).classList.remove('hidden');
            
            currentStep = step;
        }

        // è¨­å®šã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateConfigSummary() {
            const summary = document.getElementById('configSummary');
            const config = getConfiguration();
            
            summary.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>é¸æŠãƒ‡ãƒã‚¤ã‚¹</h4>
                    <p>${selectedDevice.name}</p>
                    
                    <h4>åŸºæœ¬è¨­å®š</h4>
                    <p>è¨€èª: ${config.language}</p>
                    <p>ãƒ‡ãƒã‚¤ã‚¹å: ${config.deviceName || 'æœªè¨­å®š'}</p>
                    <p>æ¥ç¶šã‚¿ã‚¤ãƒ—: ${config.connectionType}</p>
                    
                    <h4>Wi-Fiè¨­å®š</h4>
                    <p>SSID: ${config.wifiSSID || 'æœªè¨­å®š'}</p>
                    
                    <h4>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (${selectedPackages.length}å€‹)</h4>
                    <p>${selectedPackages.join(', ')}</p>
                </div>
            `;
        }

        // è¨­å®šå–å¾—
        function getConfiguration() {
            return {
                language: document.getElementById('language').value,
                deviceName: document.getElementById('deviceName').value,
                rootPassword: document.getElementById('rootPassword').value,
                wifiSSID: document.getElementById('wifiSSID').value,
                wifiPassword: document.getElementById('wifiPassword').value,
                connectionType: document.querySelector('input[name="connectionType"]:checked').value,
                pppoeUsername: document.getElementById('pppoeUsername').value,
                pppoePassword: document.getElementById('pppoePassword').value
            };
        }

        // aios-light.sh ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
        function generateAiosScript(config) {
            let script = '#!/bin/sh\n\n';
            script += '# OpenWrt Auto Configuration Script\n';
            script += '# Generated by OpenWrt Custom Firmware Builder\n\n';
            
            script += 'CONFIG_SCRIPT="/tmp/aios/aios-light.sh"\n';
            script += 'mkdir -p /tmp/aios\n\n';

            script += 'wget --no-check-certificate -O "$CONFIG_SCRIPT" "https://site-u.pages.dev/build/scripts/aios-light.sh" 2>/dev/null\n\n';

            script += 'if [ ! -f "$CONFIG_SCRIPT" ]; then\n';
            script += '    logger -t firmware-builder "Failed to download aios-light.sh"\n';
            script += '    exit 1\n';
            script += 'fi\n\n';

            script += 'chmod +x "$CONFIG_SCRIPT"\n\n';

            // ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
            script += '# Configuration Variables\n';
            
            if (config.language) {
                script += `export LANGUAGE="${config.language}"\n`;
            }
            
            if (config.deviceName) {
                script += `export DEVICE_NAME="${config.deviceName}"\n`;
            }
            
            if (config.rootPassword) {
                script += `export ROOT_PASSWORD="${config.rootPassword}"\n`;
            }
            
            if (config.wifiSSID) {
                script += `export WLAN_NAME="${config.wifiSSID}"\n`;
            }
            
            if (config.wifiPassword) {
                script += `export WLAN_PASSWORD="${config.wifiPassword}"\n`;
            }

            // æ¥ç¶šã‚¿ã‚¤ãƒ—ã®è¨­å®š
            if (config.connectionType === 'auto') {
                script += 'export ISP_MODE=""\n';
            } else if (config.connectionType === 'pppoe') {
                script += 'export ISP_MODE="pppoe"\n';
                if (config.pppoeUsername) {
                    script += `export PPPOE_USERNAME="${config.pppoeUsername}"\n`;
                }
                if (config.pppoePassword) {
                    script += `export PPPOE_PASSWORD="${config.pppoePassword}"\n`;
                }
            } else {
                script += `export ISP_MODE="${config.connectionType}"\n`;
            }

            script += '\n# Execute configuration script\n';
            script += 'exec sh "$CONFIG_SCRIPT" "$ISP_MODE"\n';

            return script;
        }

        // ãƒ“ãƒ«ãƒ‰é–‹å§‹
        async function startBuild() {
            const config = getConfiguration();
            const script = generateAiosScript(config);
            
            // UIã‚’æ›´æ–°
            document.getElementById('buildBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('buildStatus').classList.remove('hidden');
            
            try {
                // OpenWrt APIã«ãƒ“ãƒ«ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const buildData = {
                    target: extractTarget(selectedDevice.details),
                    profile: selectedDevice.id,
                    packages: selectedPackages,
                    script: script
                };
                
                // å®Ÿéš›ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ OpenWrt ã®ã‚‚ã®ã‚’ä½¿ç”¨
                const response = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(buildData)
                });
                
                if (!response.ok) {
                    throw new Error('ãƒ“ãƒ«ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                buildRequestId = result.request_id;
                
                // ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã‚’ç›£è¦–
                pollBuildStatus();
                
            } catch (error) {
                console.error('Build error:', error);
                document.getElementById('buildProgress').textContent = 'ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
            }
        }

        // ãƒ“ãƒ«ãƒ‰çŠ¶æ³ç›£è¦–
        async function pollBuildStatus() {
            try {
                const response = await fetch(`https://sysupgrade.openwrt.org/api/v1/build/${buildRequestId}`);
                const status = await response.json();
                
                document.getElementById('buildProgress').textContent = `çŠ¶æ³: ${status.status}`;
                
                if (status.status === 'completed') {
                    showBuildComplete(status);
                } else if (status.status === 'failed') {
                    document.getElementById('buildProgress').textContent = 'ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ';
                } else {
                    // ã¾ã ãƒ“ãƒ«ãƒ‰ä¸­ã®å ´åˆã¯5ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
                    setTimeout(pollBuildStatus, 5000);
                }
            } catch (error) {
                console.error('Status check error:', error);
                setTimeout(pollBuildStatus, 5000);
            }
        }

        // ãƒ“ãƒ«ãƒ‰å®Œäº†è¡¨ç¤º
        function showBuildComplete(status) {
            document.getElementById('buildStatus').classList.add('hidden');
            document.getElementById('buildComplete').classList.remove('hidden');
            
            const linksContainer = document.getElementById('downloadLinks');
            linksContainer.innerHTML = '';
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            if (status.images) {
                status.images.forEach(image => {
                    const link = document.createElement('a');
                    link.href = image.url;
                    link.className = 'download-link';
                    link.textContent = `ğŸ“¥ ${image.name} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
                    link.target = '_blank';
                    linksContainer.appendChild(link);
                });
            }
        }

        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæŠ½å‡º
        function extractTarget(details) {
            const match = details.match(/Target: ([^|]+)/);
            return match ? match[1].trim() : 'generic';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedPackages();
        });
    </script>
</body>
</html>
