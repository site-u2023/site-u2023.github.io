<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt Enhanced Firmware Selector</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #0056b3;
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .language-select {
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wifi-interface {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }
        
        .wifi-interface h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .device-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .build-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }
        
        .build-btn:hover {
            background: #218838;
        }
        
        .build-btn-secondary {
            background: #007bff;
        }
        
        .build-btn-secondary:hover {
            background: #0056b3;
        }
        
        .build-section {
            text-align: center;
            padding: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .preview {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover,
        .autocomplete-active {
            background-color: #007bff;
            color: white;
        }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ OpenWrt Enhanced Firmware Selector</h1>
            <select class="language-select" id="language-select">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="en">English</option>
            </select>
        </div>
        
        <div class="content">
            <!-- å…¬å¼ãƒ“ãƒ«ãƒ€ãƒ¼çµ±åˆ -->
            <div class="form-section">
                <h3>ğŸ“¡ ãƒ‡ãƒã‚¤ã‚¹é¸æŠ</h3>
                
                <!-- å…¬å¼ã¨åŒã˜ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢UI -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="models">ãƒ‡ãƒã‚¤ã‚¹åæ¤œç´¢</label>
                        <div id="models-autocomplete" class="autocomplete" style="position: relative;">
                            <input id="models" type="text" class="form-control" 
                                   placeholder="ãƒ‡ãƒã‚¤ã‚¹åãƒ»å‹ç•ªã‚’å…¥åŠ› (ä¾‹: BPI-R4, Archer C7)" 
                                   spellcheck="false" autocapitalize="off" autofocus>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="versions">OpenWrtãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
                        <select id="versions" class="form-control"></select>
                    </div>
                </div>
                
                <!-- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤º -->
                <div id="device-info" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <h4>é¸æŠã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹</h4>
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>ãƒ¢ãƒ‡ãƒ«:</strong></div>
                        <div id="device-model">-</div>
                        <div><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:</strong></div>
                        <div id="device-target">-</div>
                        <div><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong></div>
                        <div id="device-version">-</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒã‚¤ã‚¹æ©Ÿèƒ½é¸æŠ -->
            <div class="form-section">
                <h3>ğŸ”§ ãƒ‡ãƒã‚¤ã‚¹æ©Ÿèƒ½</h3>
                <div class="device-features">
                    <div class="feature-item">
                        <input type="checkbox" id="has_usb" checked>
                        <label for="has_usb">USBå¯¾å¿œ</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_sata">
                        <label for="has_sata">SATAå¯¾å¿œ</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_pcie">
                        <label for="has_pcie">PCIeå¯¾å¿œ</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_5g" checked>
                        <label for="has_5g">5G Wi-Fiå¯¾å¿œ</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_6g">
                        <label for="has_6g">6G Wi-Fiå¯¾å¿œ</label>
                    </div>
                    <div class="feature-item">
                        <input type="checkbox" id="has_mesh">
                        <label for="has_mesh">Meshå¯¾å¿œ</label>
                    </div>
                </div>
            </div>

            <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šè¨­å®š -->
            <div class="form-section">
                <h3>ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šè¨­å®š</h3>
                <div class="form-group">
                    <label>æ¥ç¶šæ–¹å¼</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="isp_mape" name="isp_type" value="mape" checked>
                            <label for="isp_mape">MAP-Eè‡ªå‹•è¨­å®š</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="isp_pppoe" name="isp_type" value="pppoe">
                            <label for="isp_pppoe">PPPoEæ¥ç¶š</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="isp_none" name="isp_type" value="none">
                            <label for="isp_none">è¨­å®šã—ãªã„</label>
                        </div>
                    </div>
                </div>
                
                <div id="pppoe_settings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pppoe_username">PPPoE ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                            <input type="text" id="pppoe_username" class="form-control" placeholder="ISPã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                        </div>
                        <div class="form-group">
                            <label for="pppoe_password">PPPoE ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="pppoe_password" class="form-control" placeholder="ISPã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒã‚¤ã‚¹åŸºæœ¬è¨­å®š -->
            <div class="form-section">
                <h3>âš™ï¸ ãƒ‡ãƒã‚¤ã‚¹åŸºæœ¬è¨­å®š</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="root_password">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="root_password" class="form-control" placeholder="ãƒ«ãƒ¼ã‚¿ãƒ¼ç®¡ç†ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <div class="form-group">
                        <label for="lan_ip">LAN IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="text" id="lan_ip" class="form-control" value="192.168.1.1">
                    </div>
                </div>
            </div>

            <!-- Wi-Fiè¨­å®š -->
            <div class="form-section">
                <h3>ğŸ“¶ Wi-Fiè¨­å®š</h3>
                <div class="form-group">
                    <label>Wi-Fiæ§‹æˆæ–¹å¼</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="wifi_standard" name="wifi_mode" value="standard" checked>
                            <label for="wifi_standard">æ¨™æº–è¨­å®š</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="wifi_usteer" name="wifi_mode" value="usteer">
                            <label for="wifi_usteer">usteerï¼ˆãƒãƒ³ãƒ‰ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ï¼‰</label>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 1 -->
                <div class="wifi-interface">
                    <h4>ğŸ“¡ Wi-Fi Interface 1</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi1_ssid">SSID</label>
                            <input type="text" id="wifi1_ssid" class="form-control" placeholder="MyWiFi">
                        </div>
                        <div class="form-group">
                            <label for="wifi1_password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="wifi1_password" class="form-control" placeholder="8æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label for="wifi1_band">å¸¯åŸŸ</label>
                            <select id="wifi1_band" class="form-control">
                                <option value="">ä½¿ç”¨ã—ãªã„</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G">5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 2 -->
                <div class="wifi-interface">
                    <h4>ğŸ“¡ Wi-Fi Interface 2</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi2_ssid">SSID</label>
                            <input type="text" id="wifi2_ssid" class="form-control" placeholder="MyWiFi_5G">
                        </div>
                        <div class="form-group">
                            <label for="wifi2_password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="wifi2_password" class="form-control" placeholder="8æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label for="wifi2_band">å¸¯åŸŸ</label>
                            <select id="wifi2_band" class="form-control">
                                <option value="">ä½¿ç”¨ã—ãªã„</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G" selected>5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Wi-Fi Interface 3 -->
                <div class="wifi-interface">
                    <h4>ğŸ“¡ Wi-Fi Interface 3</h4>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="wifi3_ssid">SSID</label>
                            <input type="text" id="wifi3_ssid" class="form-control" placeholder="MyWiFi_6G">
                        </div>
                        <div class="form-group">
                            <label for="wifi3_password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="wifi3_password" class="form-control" placeholder="8æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label for="wifi3_band">å¸¯åŸŸ</label>
                            <select id="wifi3_band" class="form-control">
                                <option value="">ä½¿ç”¨ã—ãªã„</option>
                                <option value="2.4G">2.4GHz</option>
                                <option value="5G">5GHz</option>
                                <option value="6G">6GHz</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š -->
            <div class="form-section">
                <h3>ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_basic" checked>
                        <label for="pkg_basic">åŸºæœ¬ã‚»ãƒƒãƒˆ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_mape">
                        <label for="pkg_mape">MAP-Eå¯¾å¿œ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_vpn">
                        <label for="pkg_vpn">VPN</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_usb">
                        <label for="pkg_usb">USBå¯¾å¿œ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_monitoring">
                        <label for="pkg_monitoring">ç›£è¦–ãƒ»çµ±è¨ˆ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pkg_docker">
                        <label for="pkg_docker">Docker</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="custom_packages">ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</label>
                    <textarea id="custom_packages" class="form-control" placeholder="ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰"></textarea>
                </div>
            </div>

            <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="form-section">
                <h3>ğŸ“ uci-defaultsã‚¹ã‚¯ãƒªãƒ—ãƒˆ</h3>
                <div class="button-group">
                    <button class="build-btn build-btn-secondary" id="generate-btn">ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ</button>
                    <button class="build-btn build-btn-secondary" id="copy-btn">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                </div>
                
                <div class="preview" id="scriptPreview" style="display: none;">
                    <!-- ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <div class="build-section">
                <p>ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆå¾Œã€ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ç›´æ¥ãƒ“ãƒ«ãƒ‰ã§ãã¾ã™ã€‚</p>
                
                <div class="button-group">
                    <button class="build-btn" id="test-btn">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ç¢ºèªï¼‰
                    </button>
                    <button class="build-btn" id="proxy-test-btn" style="background: #ffc107; color: #212529;">
                        ğŸ” ãƒ—ãƒ­ã‚­ã‚·ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button class="build-btn" id="debug-info-btn" style="background: #6c757d;">
                        ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    </button>
                    <button class="build-btn" id="direct-build-btn">
                        ğŸš€ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ç›´æ¥ãƒ“ãƒ«ãƒ‰
                    </button>
                </div>
                
                <div id="build-status" style="display: none; margin-top: 15px; padding: 15px; border-radius: 4px;">
                    <div id="build-message"></div>
                    <div id="build-progress" style="margin-top: 10px;">
                        <progress id="build-progress-bar" style="width: 100%;" max="100" value="0"></progress>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 4px; font-size: 14px;">
                    <strong>âœ… è¨­å®šå®Œäº†:</strong><br>
                    ãƒ—ãƒ­ã‚­ã‚·WorkerãŒ <code>openwrt-builder-proxy.site-u.workers.dev</code> ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã§ã™ã€‚<br>
                    ã€ŒğŸ” ãƒ—ãƒ­ã‚­ã‚·ãƒ†ã‚¹ãƒˆã€ã§ãƒ†ã‚¹ãƒˆå¾Œã€ã€ŒğŸš€ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ç›´æ¥ãƒ“ãƒ«ãƒ‰ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ—ãƒ­ã‚­ã‚·Workerã®URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ï¼‰
        const PROXY_URL = 'https://openwrt-builder-proxy.site-u.workers.dev';
        
        // OpenWrtå…¬å¼ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®æ©Ÿèƒ½ã‚’çµ±åˆ
        const config = {
            image_url: "https://downloads.openwrt.org",
            versions: [], // å‹•çš„ã«å–å¾—
            default_version: "24.10.2"
        };
        
        let current_device = {};
        let current_overview = {};
        
        // å…¬å¼ã¨åŒã˜ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½
        function setupAutocompleteList(input, items, onbegin, onend) {
            let currentFocus = -1;
            
            const collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: "base",
            });
            items.sort(collator.compare);
            
            input.oninput = function () {
                onbegin();
                
                let pattern = this.value;
                closeAllLists();
                
                if (pattern.length === 0) {
                    return false;
                }
                
                if (items.includes(pattern)) {
                    closeAllLists();
                    onend(input);
                    return false;
                }
                
                const list = document.createElement("DIV");
                list.setAttribute("id", this.id + "-autocomplete-list");
                list.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(list);
                
                const patterns = pattern.toUpperCase().split(/\s+/).filter(p => p.length > 0);
                let count = 0;
                
                for (const item of items) {
                    const matches = matchPatterns(item, patterns);
                    if (matches.length === 0) continue;
                    
                    count += 1;
                    if (count >= 15) {
                        let div = document.createElement("DIV");
                        div.innerText = "...";
                        list.appendChild(div);
                        break;
                    } else {
                        let div = document.createElement("DIV");
                        div.innerHTML = highlightMatches(item, matches) + `<input type="hidden" value="${item}">`;
                        
                        div.addEventListener("click", function () {
                            input.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                            onend(input);
                        });
                        
                        list.appendChild(div);
                    }
                }
            };
            
            input.onkeydown = function (e) {
                let x = document.getElementById(this.id + "-autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode === 40) {
                    currentFocus += 1;
                    setActive(x);
                } else if (e.keyCode === 38) {
                    currentFocus -= 1;
                    setActive(x);
                } else if (e.keyCode === 13) {
                    e.preventDefault();
                    if (currentFocus > -1 && x) x[currentFocus].click();
                }
            };
            
            input.onkeyup = function (e) {
                if (e && (e.key === "Enter" || e.keyCode === 13)) {
                    onend(input);
                }
            };
            
            function setActive(xs) {
                if (!xs) return false;
                for (const x of xs) {
                    x.classList.remove("autocomplete-active");
                }
                if (currentFocus >= xs.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = xs.length - 1;
                xs[currentFocus].classList.add("autocomplete-active");
            }
            
            function closeAllLists(elmnt) {
                const items = document.querySelectorAll(".autocomplete-items");
                for (const x of items) {
                    if (elmnt !== x && elmnt !== input) {
                        x.parentNode.removeChild(x);
                    }
                }
            }
            
            document.addEventListener("click", (e) => {
                closeAllLists(e.target);
            });
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°é–¢æ•°
        function matchPatterns(value, patterns) {
            const item = value.toUpperCase();
            let matches = [];
            for (const p of patterns) {
                const i = item.indexOf(p);
                if (i === -1) return [];
                matches.push({ begin: i, length: p.length });
            }
            return matches.sort((a, b) => a.begin - b.begin);
        }
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
        function highlightMatches(item, matches) {
            let prev = 0;
            let html = "";
            for (const m of matches) {
                html += item.substr(prev, m.begin - prev);
                html += `<strong>${item.substr(m.begin, m.length)}</strong>`;
                prev = m.begin + m.length;
            }
            html += item.substr(prev);
            return html;
        }
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupSelectList(select, items, onselection) {
            items.sort((b, a) =>
                (a + (a.indexOf("-") < 0 ? "-Z" : "")).localeCompare(
                    b + (b.indexOf("-") < 0 ? "-Z" : ""),
                    undefined,
                    { numeric: true }
                )
            );
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            select.innerHTML = '';
            
            for (const item of items) {
                const option = document.createElement("OPTION");
                option.innerText = item;
                option.value = item;
                select.appendChild(option);
            }
            
            select.addEventListener("change", () => {
                onselection(items[select.selectedIndex]);
            });
            
            if (select.selectedIndex >= 0) {
                onselection(items[select.selectedIndex]);
            }
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´å‡¦ç†ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«ä¿®æ­£ï¼‰
        function changeModel(version, overview, title) {
            console.log('=== ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´å‡¦ç† ===', { version, title });
            
            const entry = overview.profiles[title];
            if (entry) {
                console.log('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', entry);
                
                // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°ã‚’å–å¾—
                const base_url = `${PROXY_URL}/releases/${version}`;
                const profileUrl = `${base_url}/targets/${entry.target}/profiles.json`;
                
                console.log('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°å–å¾—ä¸­:', profileUrl);
                
                fetch(profileUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(mobj => {
                        console.log('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°å–å¾—æˆåŠŸ');
                        
                        const device = {
                            id: entry.id,
                            target: entry.target,
                            version: version,
                            model: title,
                            images: mobj.profiles[entry.id]?.images || [],
                            default_packages: mobj.default_packages || [],
                            device_packages: mobj.profiles[entry.id]?.device_packages || []
                        };
                        
                        current_device = device;
                        updateDeviceInfo(device);
                        
                        console.log('âœ… ãƒ‡ãƒã‚¤ã‚¹è¨­å®šå®Œäº†:', device);
                    })
                    .catch(err => {
                        console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                        
                        // åŸºæœ¬æƒ…å ±ã®ã¿ã§ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®š
                        const device = {
                            id: entry.id,
                            target: entry.target,
                            version: version,
                            model: title,
                            images: [],
                            default_packages: [],
                            device_packages: []
                        };
                        
                        current_device = device;
                        updateDeviceInfo(device);
                        
                        console.log('âš ï¸ åŸºæœ¬æƒ…å ±ã®ã¿ã§ãƒ‡ãƒã‚¤ã‚¹è¨­å®š:', device);
                    });
            } else {
                console.error('ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', title);
                console.log('åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§:');
                Object.keys(overview.profiles).forEach((key, index) => {
                    if (index < 10) { // æœ€åˆã®10ä»¶ã®ã¿è¡¨ç¤º
                        console.log(`  ${index + 1}. ${key}`);
                    }
                });
                if (Object.keys(overview.profiles).length > 10) {
                    console.log(`  ... ä»– ${Object.keys(overview.profiles).length - 10} ä»¶`);
                }
                
                current_device = {};
                hideDeviceInfo();
            }
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤ºæ›´æ–°
        function updateDeviceInfo(device) {
            document.getElementById('device-model').textContent = device.model;
            document.getElementById('device-target').textContent = device.target;
            document.getElementById('device-version').textContent = device.version;
            document.getElementById('device-info').style.display = 'block';
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±éè¡¨ç¤º
        function hideDeviceInfo() {
            document.getElementById('device-info').style.display = 'none';
        }
        
        // OpenWrtå…¬å¼APIã‹ã‚‰ç‰ˆæœ¬ã¨ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«ä¿®æ­£ï¼‰
        async function initOpenWrtData() {
            try {
                console.log('=== OpenWrt ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–‹å§‹ ===');
                console.log('ãƒ—ãƒ­ã‚­ã‚·URL:', PROXY_URL);
                
                // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
                const versionsUrl = `${PROXY_URL}/.versions.json`;
                console.log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å–å¾—ä¸­:', versionsUrl);
                
                const versionsResponse = await fetch(versionsUrl);
                
                if (!versionsResponse.ok) {
                    throw new Error(`ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: ${versionsResponse.status}`);
                }
                
                const versionsData = await versionsResponse.json();
                console.log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', versionsData);
                
                // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰
                const unsupported_versions_re = /^(19\.07\.\d|18\.06\.\d|17\.01\.\d)$/;
                const versions = versionsData.versions_list.filter(
                    version => !unsupported_versions_re.test(version)
                );
                versions.push("SNAPSHOT");
                
                config.versions = versions;
                config.default_version = versionsData.stable_version || "24.10.2";
                
                console.log('åˆ©ç”¨å¯èƒ½ãƒãƒ¼ã‚¸ãƒ§ãƒ³:', versions);
                
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰
                setupSelectList(document.getElementById('versions'), versions, (version) => {
                    loadDevicesForVersion(version);
                });
                
                console.log('âœ… OpenWrt ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('OpenWrt ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                const fallbackVersions = ["24.10.2", "23.05.5", "SNAPSHOT"];
                config.versions = fallbackVersions;
                config.default_version = "24.10.2";
                
                setupSelectList(document.getElementById('versions'), fallbackVersions, (version) => {
                    loadDevicesForVersion(version);
                });
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çŠ¶æ³ã‚’é€šçŸ¥
                showNetworkError('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚');
            }
        }
        
        // æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«ä¿®æ­£ï¼‰
        function loadDevicesForVersion(version) {
            console.log(`=== ãƒ‡ãƒã‚¤ã‚¹èª­ã¿è¾¼ã¿é–‹å§‹: ${version} ===`);
            
            // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§overview.jsonã‚’å–å¾—
            const overview_url = version === "SNAPSHOT" 
                ? `${PROXY_URL}/snapshots/.overview.json`
                : `${PROXY_URL}/releases/${version}/.overview.json`;
                
            console.log('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—ä¸­:', overview_url);
            
            fetch(overview_url)
                .then(response => {
                    console.log('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(obj => {
                    console.log('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—æˆåŠŸ:', obj);
                    
                    // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰
                    const profiles = {};
                    for (const profile of obj.profiles) {
                        const titles = getModelTitles(profile.titles);
                        for (const title of titles) {
                            if (title.length > 0) {
                                profiles[title] = {
                                    id: profile.id,
                                    target: profile.target,
                                    title: title
                                };
                            }
                        }
                    }
                    
                    current_overview = { profiles };
                    console.log('åˆ©ç”¨å¯èƒ½ãƒ‡ãƒã‚¤ã‚¹æ•°:', Object.keys(profiles).length);
                    
                    // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰
                    setupAutocompleteList(
                        document.getElementById('models'),
                        Object.keys(profiles),
                        () => hideDeviceInfo(),
                        (input) => changeModel(version, current_overview, input.value)
                    );
                    
                    console.log('âœ… ãƒ‡ãƒã‚¤ã‚¹èª­ã¿è¾¼ã¿å®Œäº†');
                })
                .catch(err => {
                    console.error('ãƒ‡ãƒã‚¤ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                    showNetworkError(`ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
                });
        }
        
        // ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆå…¬å¼ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        function getModelTitles(titles) {
            return titles.map((e) => {
                if (e.title) {
                    return e.title;
                } else {
                    return (
                        (e.vendor || "") + " " + (e.model || "") + " " + (e.variant || "")
                    ).trim();
                }
            });
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showNetworkError(message) {
            console.warn('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', message);
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 15px;
                border-radius: 4px;
                max-width: 400px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            
            errorDiv.innerHTML = `
                <strong>âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</strong><br>
                ${message}<br>
                <small>ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
                <button onclick="this.parentNode.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer; margin-top: -5px;">Ã—</button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 10000);
        }
        
        // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å®šç¾©
        const packageSets = {
            basic: ['luci-i18n-base-ja', 'luci-i18n-firewall-ja', 'luci-i18n-opkg-ja'],
            mape: ['map-e', 'kmod-map-e', 'jsonfilter'],
            vpn: ['luci-app-openvpn', 'openvpn-openssl', 'luci-app-wireguard', 'wireguard-tools'],
            usb: ['kmod-usb-storage', 'kmod-fs-ext4', 'kmod-fs-vfat', 'usbutils'],
            monitoring: ['collectd', 'luci-app-statistics', 'iftop', 'htop'],
            docker: ['dockerd', 'docker-compose', 'luci-app-dockerman']
        };
        
        // ISPé¸æŠã®å¤‰æ›´å‡¦ç†
        document.querySelectorAll('input[name="isp_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const pppoeSettings = document.getElementById('pppoe_settings');
                if (this.value === 'pppoe') {
                    pppoeSettings.style.display = 'block';
                } else {
                    pppoeSettings.style.display = 'none';
                }
            });
        });
        
        // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é¸æŠã®å¤‰æ›´å‡¦ç†
        document.querySelectorAll('input[type="checkbox"][id^="pkg_"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCustomPackages();
            });
        });
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
        function updateCustomPackages() {
            const customPackagesTextarea = document.getElementById('custom_packages');
            let packages = [];
            
            // ãƒ‡ãƒã‚¤ã‚¹æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
            const hasUsb = document.getElementById('has_usb').checked;
            const hasSata = document.getElementById('has_sata').checked;
            
            // é¸æŠã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
            Object.keys(packageSets).forEach(key => {
                if (document.getElementById(`pkg_${key}`).checked) {
                    // USBæ©Ÿèƒ½ãŒãªã„ãƒ‡ãƒã‚¤ã‚¹ã§USBãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (key === 'usb' && !hasUsb) {
                        console.log('USB packages skipped: device has no USB support');
                        return;
                    }
                    packages = packages.concat(packageSets[key]);
                }
            });
            
            customPackagesTextarea.value = packages.join(' ');
        }
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
        async function generateScript() {
            try {
                // build-tools.shã‚’èª­ã¿è¾¼ã¿
                const response = await fetch('./build-tools.sh');
                if (!response.ok) {
                    throw new Error('build-tools.sh not found');
                }
                const baseScript = await response.text();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¨ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
                const ispType = document.querySelector('input[name="isp_type"]:checked').value;
                const wifiMode = document.querySelector('input[name="wifi_mode"]:checked').value;
                const rootPassword = document.getElementById('root_password').value;
                const lanIp = document.getElementById('lan_ip').value;
                const pppoeUsername = document.getElementById('pppoe_username').value;
                const pppoePassword = document.getElementById('pppoe_password').value;
                
                // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸå¤‰æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
                let customVariables = `# Generated for device: ${current_device.model || 'Unknown'}\n`;
                customVariables += `# Target: ${current_device.target || 'Unknown'}\n`;
                customVariables += `# Version: ${current_device.version || 'Unknown'}\n\n`;
                
                // ãƒ‡ãƒã‚¤ã‚¹åŸºæœ¬è¨­å®š
                if (rootPassword) customVariables += `ROOT_PASSWORD="${rootPassword}"\n`;
                if (lanIp && lanIp !== '192.168.1.1') customVariables += `LAN_IP_ADDRESS="${lanIp}"\n`;
                
                // PPPoEè¨­å®š
                if (ispType === 'pppoe' && pppoeUsername && pppoePassword) {
                    customVariables += `PPPOE_USERNAME="${pppoeUsername}"\n`;
                    customVariables += `PPPOE_PASSWORD="${pppoePassword}"\n`;
                }
                
                // Wi-Fiè¨­å®š
                for (let i = 1; i <= 3; i++) {
                    const ssid = document.getElementById(`wifi${i}_ssid`).value;
                    const password = document.getElementById(`wifi${i}_password`).value;
                    const band = document.getElementById(`wifi${i}_band`).value;
                    if (ssid && password && band) {
                        customVariables += `WLAN_NAME_${i}="${ssid}"\n`;
                        customVariables += `WLAN_PASSWORD_${i}="${password}"\n`;
                        customVariables += `WLAN_BAND_${i}="${band}"\n`;
                    }
                }
                
                // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ†ã‚’æ±ºå®š
                let mainExecution = '';
                if (ispType === 'mape') {
                    mainExecution = 'openwrt_main';
                } else if (ispType === 'pppoe') {
                    mainExecution = 'openwrt_pppoe_main';
                } else {
                    mainExecution = `# No ISP configuration selected
set_device_basic_config
set_wifi_config

uci commit system >/dev/null 2>&1
uci commit wireless >/dev/null 2>&1
uci commit network
echo "Basic configuration done!"`;
                }
                
                // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‹ã‚‰å¤‰æ•°å®šç¾©è¡Œã‚’æ¢ã—ã¦ç½®ãæ›ãˆ
                let modifiedScript = baseScript;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸå¤‰æ•°å®šç¾©ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆ
                const variableLines = customVariables.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                variableLines.forEach(line => {
                    if (line.includes('=')) {
                        const [varName] = line.split('=');
                        const commentedPattern = new RegExp(`# ${varName}=""`, 'g');
                        modifiedScript = modifiedScript.replace(commentedPattern, line);
                    }
                });
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œã‚’ç½®ãæ›ãˆ
                modifiedScript = modifiedScript.replace('openwrt_main', mainExecution);
                
                // Wi-Fiè¨­å®šã«é–¢ã™ã‚‹è¿½åŠ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                if (wifiMode === 'usteer') {
                    modifiedScript += `

# usteer band steering configuration
setup_usteer() {
    logger -t mape-setup "Setting up usteer band steering"
    opkg update && opkg install usteer >/dev/null 2>&1
    
    uci set usteer.@usteer[0]=usteer
    uci set usteer.@usteer[0].enabled='1'
    uci set usteer.@usteer[0].debug_level='2'
    uci commit usteer
    
    /etc/init.d/usteer enable
    /etc/init.d/usteer start
}

# Call usteer setup
setup_usteer`;
                }
                
                // æœ€çµ‚çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                const finalScript = customVariables + '\n' + modifiedScript;
                
                document.getElementById('scriptPreview').textContent = finalScript;
                document.getElementById('scriptPreview').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating script:', error);
                document.getElementById('scriptPreview').textContent = `# Error: Could not load build-tools.sh
# Make sure build-tools.sh is in the same directory as this HTML file
# Error details: ${error.message}

# Device Information:
# Model: ${current_device.model || 'Not selected'}
# Target: ${current_device.target || 'Not selected'}
# Version: ${current_device.version || 'Not selected'}

#!/bin/sh
# Fallback basic script
echo "Script generation failed. Please check build-tools.sh file."
exit 1`;
                document.getElementById('scriptPreview').style.display = 'block';
            }
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard() {
            const script = document.getElementById('scriptPreview').textContent;
            if (!script || script.includes('ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™')) {
                alert('å…ˆã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            navigator.clipboard.writeText(script).then(() => {
                alert('ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(() => {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            });
        }
        
        // ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œã®éåŒæœŸé–¢æ•°
        async function performBuild(script, buildBtn, buildStatus, buildMessage, progressBar) {
            try {
                // é¸æŠã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å–å¾—
                const customPackages = document.getElementById('custom_packages').value;
                const packages = customPackages ? customPackages.split(/\s+/).filter(p => p.trim()) : [];
                
                // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ã‚‚ã†ä¸€åº¦ç¢ºèª
                if (!current_device.target) {
                    throw new Error('ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                const buildRequest = {
                    profile: current_device.id,
                    target: current_device.target,
                    version: current_device.version || '24.10.2',
                    packages: packages,
                    defaults: script,
                    diff_packages: true,
                    client: "enhanced-firmware-selector"
                };
                
                console.log('Build request:', buildRequest);
                
                buildMessage.textContent = 'ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...';
                progressBar.value = 20;
                
                // ãƒ—ãƒ­ã‚­ã‚·WorkerçµŒç”±ã§ASU APIã‚’å‘¼ã³å‡ºã—
                const response = await fetch(`${PROXY_URL}/api/build`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(buildRequest)
                });
                
                console.log('Response status:', response.status);
                progressBar.value = 40;
                
                if (response.status === 200) {
                    // ãƒ“ãƒ«ãƒ‰å®Œäº†
                    const result = await response.json();
                    console.log('Build result:', result);
                    buildStatus.style.backgroundColor = '#d4edda';
                    buildMessage.innerHTML = `
                        âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼<br>
                        <a href="${PROXY_URL}/store/${result.bin_dir}" target="_blank" 
                           style="color: #155724; font-weight: bold;">ğŸ“¥ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                    `;
                    progressBar.value = 100;
                    
                } else if (response.status === 202) {
                    // ãƒ“ãƒ«ãƒ‰é€²è¡Œä¸­
                    const result = await response.json();
                    console.log('Build queued:', result);
                    buildMessage.textContent = 'ãƒ“ãƒ«ãƒ‰ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...';
                    progressBar.value = 60;
                    
                    // ãƒãƒ¼ãƒªãƒ³ã‚°ã§ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
                    if (result.request_hash) {
                        checkBuildStatus(result.request_hash);
                    } else {
                        throw new Error('ãƒ“ãƒ«ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒã‚·ãƒ¥ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                } else {
                    // ã‚¨ãƒ©ãƒ¼
                    const errorText = await response.text();
                    console.error('Build error response:', errorText);
                    let errorMessage = 'ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${errorText}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('Build error:', error);
                buildStatus.style.backgroundColor = '#f8d7da';
                buildMessage.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}<br><small>ãƒ—ãƒ­ã‚­ã‚·WorkerãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</small>`;
                progressBar.value = 0;
            } finally {
                buildBtn.disabled = false;
            }
        }
        
        // ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
        async function checkBuildStatus(requestHash) {
            const buildMessage = document.getElementById('build-message');
            const progressBar = document.getElementById('build-progress-bar');
            const buildStatus = document.getElementById('build-status');
            
            try {
                console.log('Checking build status for hash:', requestHash);
                const response = await fetch(`${PROXY_URL}/api/build/${requestHash}`);
                
                if (response.status === 200) {
                    // ãƒ“ãƒ«ãƒ‰å®Œäº†
                    const result = await response.json();
                    console.log('Build completed:', result);
                    buildStatus.style.backgroundColor = '#d4edda';
                    buildMessage.innerHTML = `
                        âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼<br>
                        <a href="${PROXY_URL}/store/${result.bin_dir}" target="_blank" 
                           style="color: #155724; font-weight: bold;">ğŸ“¥ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                    `;
                    progressBar.value = 100;
                    
                } else if (response.status === 202) {
                    // ã¾ã ãƒ“ãƒ«ãƒ‰ä¸­
                    const result = await response.json();
                    console.log('Build in progress:', result);
                    const status = result.imagebuilder_status || result.queue_position || 'å‡¦ç†ä¸­';
                    buildMessage.textContent = `ãƒ“ãƒ«ãƒ‰ä¸­: ${status}...`;
                    progressBar.value = Math.min(90, progressBar.value + 5);
                    
                    // 5ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
                    setTimeout(() => checkBuildStatus(requestHash), 5000);
                    
                } else {
                    // ã‚¨ãƒ©ãƒ¼
                    const errorText = await response.text();
                    console.error('Build status error:', errorText);
                    throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Build status check error:', error);
                buildStatus.style.backgroundColor = '#f8d7da';
                buildMessage.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                progressBar.value = 0;
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼ˆãƒ›ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œï¼‰
        function buildFirmwareDirectly() {
            console.log('=== buildFirmwareDirectly() called ===');
            console.log('Function start time:', new Date().toISOString());
            console.log('current_device object:', JSON.stringify(current_device, null, 2));
            
            // ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒã‚§ãƒƒã‚¯
            if (!current_device || !current_device.id) {
                console.log('Device check failed - no device selected');
                alert('ã¾ãšãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„\n\nãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹: ' + JSON.stringify(current_device));
                return;
            }
            console.log('âœ… Device check passed');
            
            // ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
            const scriptElement = document.getElementById('scriptPreview');
            console.log('Script element:', scriptElement);
            
            const script = scriptElement ? scriptElement.textContent : '';
            console.log('Script content length:', script.length);
            console.log('Script preview:', script.substring(0, 200) + '...');
            
            if (!script || script.includes('Error:')) {
                console.log('Script check failed');
                alert('ã¾ãšã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„\n\nã‚¹ã‚¯ãƒªãƒ—ãƒˆçŠ¶æ…‹: ' + (script ? 'ã‚¨ãƒ©ãƒ¼å«ã‚€' : 'æœªç”Ÿæˆ'));
                return;
            }
            console.log('âœ… Script check passed');
            
            // DOMè¦ç´ å–å¾—
            const buildBtn = document.getElementById('direct-build-btn');
            const buildStatus = document.getElementById('build-status');
            const buildMessage = document.getElementById('build-message');
            const progressBar = document.getElementById('build-progress-bar');
            
            console.log('DOM elements:', {
                buildBtn: !!buildBtn,
                buildStatus: !!buildStatus,
                buildMessage: !!buildMessage,
                progressBar: !!progressBar
            });
            
            if (!buildBtn || !buildStatus || !buildMessage || !progressBar) {
                console.error('Some DOM elements are missing');
                alert('ç”»é¢è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('âœ… DOM elements check passed');
            
            // UIæ›´æ–°
            buildBtn.disabled = true;
            buildStatus.style.display = 'block';
            buildStatus.style.backgroundColor = '#d1ecf1';
            buildMessage.textContent = 'ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
            progressBar.value = 10;
            
            console.log('âœ… UI updated, starting build process...');
            
            // éåŒæœŸå‡¦ç†ã‚’é–‹å§‹
            performBuild(script, buildBtn, buildStatus, buildMessage, progressBar);
        }
        
        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM loaded, initializing... ===');
            console.log('Page URL:', window.location.href);
            console.log('PROXY_URL:', PROXY_URL);
            
            // é‡è¦ãªDOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const importantElements = [
                'direct-build-btn',
                'test-btn', 
                'proxy-test-btn',
                'scriptPreview',
                'build-status',
                'build-message',
                'build-progress-bar'
            ];
            
            importantElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`Element ${id}:`, !!element);
                if (!element) {
                    console.warn(`âš ï¸ Missing element: ${id}`);
                }
            });
            
            // ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’å…ˆã«è¨­å®š
            setupEventListeners();
            
            try {
                updateCustomPackages();
                initOpenWrtData(); // OpenWrtå…¬å¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
                console.log('âœ… Initialization completed successfully');
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            const testBtn = document.getElementById('test-btn');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    alert('JavaScript ã¯å‹•ä½œã—ã¦ã„ã¾ã™ï¼');
                    console.log('Test button clicked');
                });
                console.log('Test button listener added');
            }
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãƒœã‚¿ãƒ³
            const debugBtn = document.getElementById('debug-info-btn');
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    const info = {
                        current_device: current_device,
                        script_length: document.getElementById('scriptPreview')?.textContent?.length || 0,
                        proxy_url: PROXY_URL,
                        functions_available: {
                            buildFirmwareDirectly: typeof buildFirmwareDirectly,
                            generateScript: typeof generateScript,
                            initOpenWrtData: typeof initOpenWrtData
                        }
                    };
                    console.log('=== DEBUG INFO ===', info);
                    alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ\n\nF12 â†’ Console ã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„');
                });
                console.log('Debug button listener added');
            }
            
            // ãƒ—ãƒ­ã‚­ã‚·ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            const proxyTestBtn = document.getElementById('proxy-test-btn');
            if (proxyTestBtn) {
                proxyTestBtn.addEventListener('click', async function() {
                    console.log('Testing proxy connection...');
                    try {
                        const response = await fetch(`${PROXY_URL}/api/build`, {
                            method: 'OPTIONS'
                        });
                        console.log('Proxy OPTIONS response:', response.status);
                        alert(`ãƒ—ãƒ­ã‚­ã‚·æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ: ${response.status} ${response.statusText || 'Success'}`);
                        
                        // è©³ç´°æƒ…å ±ã‚‚ãƒ­ã‚°å‡ºåŠ›
                        console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                        console.log('Response ok:', response.ok);
                    } catch (error) {
                        console.error('Proxy test error:', error);
                        alert('ãƒ—ãƒ­ã‚­ã‚·æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ—ãƒ­ã‚­ã‚·WorkerãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                });
                console.log('Proxy test button listener added');
            }
            
            // ãƒ“ãƒ«ãƒ‰ãƒœã‚¿ãƒ³
            const buildBtn = document.getElementById('direct-build-btn');
            if (buildBtn) {
                buildBtn.addEventListener('click', buildFirmwareDirectly);
                console.log('Build button listener added successfully');
            } else {
                console.error('Build button not found!');
            }
            
            // ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆãƒœã‚¿ãƒ³
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    console.log('Generate script button clicked');
                    generateScript();
                });
                console.log('Generate script button listener added');
            }
            
            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    console.log('Copy button clicked');
                    copyToClipboard();
                });
                console.log('Copy button listener added');
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });
    </script>
</body>
</html>
