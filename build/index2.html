<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>OpenWrt Firmware Selector</title>
    <style>
        /* 公式サイトのスタイルを再現 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 1rem;
            color: #007bff;
        }

        .lead {
            font-size: 1.25rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 2rem;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: inline-block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .autocomplete {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4edda;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4edda;
        }

        .autocomplete-items div:hover {
            background-color: #e9ecef;
        }

        .autocomplete-active {
            background-color: #007bff !important;
            color: #ffffff;
        }

        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }

        .info h5 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .packages {
            margin: 1.5rem 0;
        }

        .packages h4 {
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .btn {
            display: inline-block;
            font-weight: 400;
            color: #212529;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            text-decoration: none;
        }

        .btn-primary {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            color: #fff;
            background-color: #0069d9;
            border-color: #0062cc;
        }

        .btn-primary:disabled {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            opacity: 0.65;
        }

        .images {
            margin: 1.5rem 0;
        }

        .download-link {
            display: inline-block;
            margin: 0.25rem 0.5rem 0.25rem 0;
            padding: 0.5rem 1rem;
            background-color: #28a745;
            color: #fff;
            text-decoration: none;
            border-radius: 0.25rem;
        }

        .download-link:hover {
            background-color: #218838;
            color: #fff;
            text-decoration: none;
        }

        /* aios-light.sh設定専用スタイル */
        .aios-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }

        .aios-config {
            margin-top: 1rem;
            display: none;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -5px;
            margin-left: -5px;
        }

        .form-row > .form-group {
            padding-right: 5px;
            padding-left: 5px;
            flex: 1;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .form-check {
            position: relative;
            display: block;
            padding-left: 1.25rem;
        }

        .form-check-input {
            position: absolute;
            margin-top: 0.3rem;
            margin-left: -1.25rem;
        }

        .form-check-label {
            margin-bottom: 0;
        }

        .conditional-section {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.25rem;
            display: none;
        }

        .text-muted {
            color: #6c757d;
        }

        .small {
            font-size: 0.875em;
        }

        /* プログレス表示の改善 */
        .build-progress {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 0.25rem;
            display: none;
        }

        .progress {
            width: 100%;
            height: 1rem;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        @media (max-width: 576px) {
            .form-row {
                flex-direction: column;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>OpenWrt Firmware Selector</h1>
        <p class="lead">Type the name or model of your device, then select a stable build or the nightly "snapshot" build.</p>

        <div class="form-group">
            <label for="versions">Version</label>
            <select id="versions" class="form-control">
                <option value="" disabled selected>Loading versions...</option>
            </select>
        </div>

        <div class="form-group">
            <div class="autocomplete">
                <input type="text" id="models" class="form-control" placeholder="Type device model" autocomplete="off">
                <div id="models-autocomplete-list" class="autocomplete-items"></div>
            </div>
        </div>

        <div id="info" class="info" style="display: none;">
            <h5 id="device-title"></h5>
            <div id="device-details"></div>
        </div>

        <div id="images" class="images" style="display: none;">
            <!-- Device images will be shown here -->
        </div>

        <div id="packages" class="packages" style="display: none;">
            <h4>Customize installed packages and/or first boot script</h4>
            <div class="form-group">
                <label for="asu-packages">Packages to add/remove (one per line, prefix with '-' to remove):</label>
                <textarea id="asu-packages" class="form-control" rows="3" placeholder="luci&#10;luci-ssl&#10;-wpad-basic-wolfssl&#10;wpad-wolfssl"></textarea>
            </div>

            <!-- setup.sh設定セクション -->
            <div class="aios-section">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="use-aios-config">
                    <label class="form-check-label" for="use-aios-config">
                        Use setup.sh configuration wizard
                    </label>
                </div>

                <div id="aios-config" class="aios-config">
                    <h5>Basic Configuration</h5>
                    
                    <!-- Language を単独行に配置 -->
                    <div class="form-group">
                        <label for="aios-language">Language</label>
                        <select id="aios-language" class="form-control">
                            <option value="en">English</option>
                            <option value="ar">العربية (Arabic)</option>
                            <option value="bg">Български (Bulgarian)</option>
                            <option value="ca">Català (Catalan)</option>
                            <option value="cs">Čeština (Czech)</option>
                            <option value="da">Dansk (Danish)</option>
                            <option value="de">Deutsch (German)</option>
                            <option value="el">Ελληνικά (Greek)</option>
                            <option value="es">Español (Spanish)</option>
                            <option value="et">Eesti (Estonian)</option>
                            <option value="eu">Euskera (Basque)</option>
                            <option value="fi">Suomi (Finnish)</option>
                            <option value="fr">Français (French)</option>
                            <option value="gl">Galego (Galician)</option>
                            <option value="he">עברית (Hebrew)</option>
                            <option value="hr">Hrvatski (Croatian)</option>
                            <option value="hu">Magyar (Hungarian)</option>
                            <option value="id">Bahasa Indonesia (Indonesian)</option>
                            <option value="is">Íslenska (Icelandic)</option>
                            <option value="it">Italiano (Italian)</option>
                            <option value="ja">日本語 (Japanese)</option>
                            <option value="ko">한국어 (Korean)</option>
                            <option value="lt">Lietuvių (Lithuanian)</option>
                            <option value="lv">Latviešu (Latvian)</option>
                            <option value="mk">Македонски (Macedonian)</option>
                            <option value="ms">Bahasa Melayu (Malay)</option>
                            <option value="mt">Malti (Maltese)</option>
                            <option value="nl">Nederlands (Dutch)</option>
                            <option value="no">Norsk (Norwegian)</option>
                            <option value="pl">Polski (Polish)</option>
                            <option value="pt">Português (Portuguese)</option>
                            <option value="pt_br">Português do Brasil (Portuguese Brazil)</option>
                            <option value="ro">Română (Romanian)</option>
                            <option value="ru">Русский (Russian)</option>
                            <option value="sk">Slovenčina (Slovak)</option>
                            <option value="sl">Slovenščina (Slovenian)</option>
                            <option value="sq">Shqipe (Albanian)</option>
                            <option value="sr">Српски (Serbian)</option>
                            <option value="sv">Svenska (Swedish)</option>
                            <option value="th">ไทย (Thai)</option>
                            <option value="tr">Türkçe (Turkish)</option>
                            <option value="uk">Українська (Ukrainian)</option>
                            <option value="vi">Tiếng Việt (Vietnamese)</option>
                            <option value="zh_cn">简体中文 (Chinese Simplified)</option>
                            <option value="zh_tw">繁體中文 (Chinese Traditional)</option>
                        </select>
                    </div>

                    <!-- IPアドレスとDevice name を横並びに配置 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-lan-ip">LAN IP Address</label>
                            <input type="text" id="aios-lan-ip" class="form-control" placeholder="192.168.1.1" value="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label for="aios-device-name">Device name</label>
                            <input type="text" id="aios-device-name" class="form-control" placeholder="OpenWrt-Router">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-root-password">Root password</label>
                            <input type="password" id="aios-root-password" class="form-control" placeholder="8+ characters">
                            <small class="form-text text-muted">Leave empty to disable password authentication</small>
                        </div>
                        <div class="form-group">
                            <label for="aios-confirm-password">Confirm password</label>
                            <input type="password" id="aios-confirm-password" class="form-control" placeholder="Confirm password">
                        </div>
                    </div>

                    <h5>Wi-Fi Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aios-wifi-ssid">Wi-Fi SSID</label>
                            <input type="text" id="aios-wifi-ssid" class="form-control" placeholder="MyOpenWrt">
                        </div>
                        <div class="form-group">
                            <label for="aios-wifi-password">Wi-Fi password</label>
                            <input type="password" id="aios-wifi-password" class="form-control" placeholder="8+ characters">
                        </div>
                    </div>

                    <h5>Internet Connection</h5>
                    <!-- 上段: AUTO/OFF選択 -->
                    <div class="form-group">
                        <label>Connection mode</label>
                        <div class="radio-group">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionMode" id="mode-auto" value="auto" checked>
                                <label class="form-check-label" for="mode-auto">AUTO</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="connectionMode" id="mode-manual" value="manual">
                                <label class="form-check-label" for="mode-manual">OFF</label>
                            </div>
                        </div>
                    </div>

                    <!-- 中段: 手動選択時の詳細オプション -->
                    <div id="manual-connection-section" class="conditional-section" style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
                        <div class="form-group">
                            <label>Connection type</label>
                            <div class="radio-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionType" id="conn-dhcp" value="dhcp" checked>
                                    <label class="form-check-label" for="conn-dhcp">DHCP</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionType" id="conn-pppoe" value="pppoe">
                                    <label class="form-check-label" for="conn-pppoe">PPPoE</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionType" id="conn-dslite" value="dslite">
                                    <label class="form-check-label" for="conn-dslite">DS-Lite</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionType" id="conn-mape" value="mape">
                                    <label class="form-check-label" for="conn-mape">MAP-E</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="connectionType" id="conn-none" value="none">
                                    <label class="form-check-label" for="conn-none">None</label>
                                </div>
                            </div>
                        </div>

                        <!-- 手動選択時の詳細設定 -->
                        <div id="pppoe-section" class="conditional-section" style="background-color: #e3f2fd;">
                            <h6>PPPoE Configuration</h6>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pppoe-username">PPPoE username</label>
                                    <input type="text" id="pppoe-username" class="form-control" placeholder="Username from ISP">
                                </div>
                                <div class="form-group">
                                    <label for="pppoe-password">PPPoE password</label>
                                    <input type="password" id="pppoe-password" class="form-control" placeholder="Password from ISP">
                                </div>
                            </div>
                        </div>

                        <div id="dslite-section" class="conditional-section" style="background-color: #fff3e0;">
                            <h6>DS-Lite Configuration</h6>
                            <div class="form-group">
                                <label for="dslite-aftr-type">AFTR Type</label>
                                <select id="dslite-aftr-type" class="form-control">
                                    <option value="transix">transix</option>
                                    <option value="xpass">xpass</option>
                                    <option value="v6option">v6option</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dslite-aftr-address">AFTR IPv6 Address</label>
                                <input type="text" id="dslite-aftr-address" class="form-control" placeholder="2404:8e00::feed:100" value="2404:8e00::feed:100">
                                <small class="form-text text-muted">Default addresses: transix(East): 2404:8e00::feed:100, xpass(East): 2001:e30:1c1e:1::1, v6option(East): 2404:8e00::feed:101</small>
                            </div>
                        </div>

                        <div id="mape-manual-section" class="conditional-section" style="background-color: #e8f5e8;">
                            <h6>MAP-E Configuration</h6>
                            <div class="form-group">
                                <label>MAP-E Connection Mode</label>
                                <div class="radio-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="mapeType" id="mape-auto" value="auto" checked>
                                        <label class="form-check-label" for="mape-auto">Auto-detect (Recommended)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="mapeType" id="mape-gua" value="gua">
                                        <label class="form-check-label" for="mape-gua">GUA Mode (Manual)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="mapeType" id="mape-pd" value="pd">
                                        <label class="form-check-label" for="mape-pd">PD Mode (Manual)</label>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <strong>Auto-detect</strong>: Automatically retrieve MAP-E technical information and configure with GUA mode (1G/10G compatible)<br>
                                    <strong>Manual selection</strong>: For troubleshooting or specific requirements only
                                </small>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mape-br">BR (Border Relay)</label>
                                    <input type="text" id="mape-br" class="form-control" placeholder="2001:db8::1">
                                </div>
                                <div class="form-group">
                                    <label for="mape-ealen">EA-len</label>
                                    <input type="number" id="mape-ealen" class="form-control" placeholder="16" min="0" max="48">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mape-ipv4-prefix">IPv4 Prefix</label>
                                    <input type="text" id="mape-ipv4-prefix" class="form-control" placeholder="192.0.2.0">
                                </div>
                                <div class="form-group">
                                    <label for="mape-ipv4-prefixlen">IPv4 Prefix Length</label>
                                    <input type="number" id="mape-ipv4-prefixlen" class="form-control" placeholder="24" min="1" max="32">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mape-ipv6-prefix">IPv6 Prefix</label>
                                    <input type="text" id="mape-ipv6-prefix" class="form-control" placeholder="2001:db8:8000::">
                                </div>
                                <div class="form-group">
                                    <label for="mape-ipv6-prefixlen">IPv6 Prefix Length</label>
                                    <input type="number" id="mape-ipv6-prefixlen" class="form-control" placeholder="32" min="1" max="128">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="mape-psid-offset">PSID Offset</label>
                                <input type="number" id="mape-psid-offset" class="form-control" placeholder="4" min="0" max="16">
                            </div>
                        </div>
                    </div>

                    <!-- 下段: 情報表示窓（常時表示） -->
                    <div class="form-group">
                        <label>ISP Detection Status</label>
                        <div id="isp-info-display" class="info" style="margin-bottom: 0;">
                            <div id="isp-status-message">ISP情報を取得中...</div>
                            <div id="isp-technical-info" style="font-family: monospace; font-size: 0.9em; margin-top: 0.5rem; display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="uci-defaults-content">Script to run on first boot (uci-defaults):</label>
                <textarea id="uci-defaults-content" class="form-control" rows="8" placeholder="#!/bin/sh&#10;&#10;# Your custom script here&#10;# This area is for manual editing - configuration wizard will not overwrite your changes"></textarea>
            </div>

            <button id="request-build" class="btn btn-primary" style="display: none;">REQUEST BUILD</button>
        </div>

        <!-- 改善されたプログレス表示 -->
        <div id="build-progress" class="build-progress">
            <div id="build-message">Building image...</div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div id="download-links"></div>
    </div>

    <script>
        let app = {
            versions: [],
            devices: [],
            selectedDevice: null,
            selectedVersion: ''
        };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                await loadVersions();
                bindEvents();
                // ISP情報を初期取得（常時表示のため）
                console.log('Starting ISP info fetch...');
                await fetchApiInfoAndUpdate();
            } catch (error) {
                console.error('Failed to initialize:', error);
                updateIspDisplay('Initialization error', 'Failed to initialize application: ' + error.message);
            }
        }

        function bindEvents() {
            document.getElementById('versions').addEventListener('change', handleVersionChange);
            document.getElementById('models').addEventListener('input', handleDeviceSearch);
            document.getElementById('use-aios-config').addEventListener('change', toggleAiosConfig);
            document.getElementById('request-build').addEventListener('click', buildAsuRequest);

            // Connection mode (AUTO/OFF) の監視
            document.querySelectorAll('input[name="connectionMode"]').forEach(radio => {
                radio.addEventListener('change', handleConnectionModeChange);
            });

            // Connection type (DHCP/PPPoE/DS-Lite/MAP-E/None) の監視
            document.querySelectorAll('input[name="connectionType"]').forEach(radio => {
                radio.addEventListener('change', handleConnectionTypeChange);
            });

            document.querySelectorAll('input[name="mapeType"]').forEach(radio => {
                radio.addEventListener('change', handleMapeTypeChange);
            });

            // DS-Lite AFTR Type変更監視を後で追加（DOM要素ができてから）
            setTimeout(() => {
                const dsliteSelect = document.getElementById('dslite-aftr-type');
                const dsliteAddress = document.getElementById('dslite-aftr-address');
                if (dsliteSelect) {
                    dsliteSelect.addEventListener('change', handleDsliteAftrTypeChange);
                    dsliteSelect.addEventListener('change', function() {
                        if (document.getElementById('use-aios-config').checked) {
                            loadAiosTemplate();
                            updateRequiredPackages();
                        }
                    });
                }
                if (dsliteAddress) {
                    dsliteAddress.addEventListener('input', function() {
                        if (document.getElementById('use-aios-config').checked) {
                            loadAiosTemplate();
                            updateRequiredPackages();
                        }
                    });
                }
                
                // MAP-E入力フィールドのイベントリスナー
                ['mape-br', 'mape-ealen', 'mape-ipv4-prefix', 'mape-ipv4-prefixlen', 
                 'mape-ipv6-prefix', 'mape-ipv6-prefixlen', 'mape-psid-offset'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', function() {
                            if (document.getElementById('use-aios-config').checked) {
                                loadAiosTemplate();
                                updateRequiredPackages();
                            }
                        });
                    }
                });

                // LAN IP入力フィールドのイベントリスナー
                const lanIpElement = document.getElementById('aios-lan-ip');
                if (lanIpElement) {
                    lanIpElement.addEventListener('input', function() {
                        if (document.getElementById('use-aios-config').checked) {
                            loadAiosTemplate();
                            updateRequiredPackages();
                        }
                    });
                }
            }, 100);

            document.getElementById('aios-config').addEventListener('input', function(e) {
                if (document.getElementById('use-aios-config').checked) {
                    loadAiosTemplate();
                    updateRequiredPackages();
                }
            });

            document.getElementById('aios-config').addEventListener('change', function(e) {
                if (document.getElementById('use-aios-config').checked) {
                    loadAiosTemplate();
                    updateRequiredPackages();
                }
            });

            // 公式と同じテンプレートリンク（削除済み）

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete')) {
                    hideAutocomplete();
                }
            });

            // 初期状態設定：手動接続セクションを非表示
            document.getElementById('manual-connection-section').style.display = 'none';
            document.getElementById('pppoe-section').style.display = 'none';
            document.getElementById('dslite-section').style.display = 'none';
            document.getElementById('mape-manual-section').style.display = 'none';
        }

        // AUTO/OFF モード切り替え
        function handleConnectionModeChange(e) {
            const manualSection = document.getElementById('manual-connection-section');
            
            if (e.target.value === 'manual') {
                manualSection.style.display = 'block';
            } else {
                manualSection.style.display = 'none';
            }

            if (document.getElementById('use-aios-config').checked) {
                loadAiosTemplate();
                updateRequiredPackages();
            }
        }

        // DS-Lite AFTR Type変更時のデフォルトアドレス設定
        function handleDsliteAftrTypeChange(e) {
            const aftrAddressInput = document.getElementById('dslite-aftr-address');
            const aftrType = e.target.value;
            
            console.log('DS-Lite AFTR type changed to:', aftrType);
            
            // デフォルトアドレス設定（東日本）
            switch(aftrType) {
                case 'transix':
                    aftrAddressInput.value = '2404:8e00::feed:100';
                    break;
                case 'xpass':
                    aftrAddressInput.value = '2001:e30:1c1e:1::1';
                    break;
                case 'v6option':
                    aftrAddressInput.value = '2404:8e00::feed:101';
                    break;
            }

            if (document.getElementById('use-aios-config').checked) {
                loadAiosTemplate();
                updateRequiredPackages();
            }
        }

        async function loadVersions() {
            try {
                const response = await fetch('https://downloads.openwrt.org/.versions.json');
                const data = await response.json();

                // 公式と同じ: SNAPSHOTを最初に追加
                app.versions = ['SNAPSHOT'];
                
                // 安定版を追加
                if (data.versions_list) {
                    app.versions = app.versions.concat(data.versions_list);
                }

                // デフォルト選択: 公式と同じく最新リリース版（2番目）
                app.selectedVersion = data.stable_version || (data.versions_list ? data.versions_list[0] : 'SNAPSHOT');

                updateVersionSelect();
                await loadDevices();
            } catch (error) {
                console.error('Failed to load versions:', error);
            }
        }

        function updateVersionSelect() {
            const select = document.getElementById('versions');
            select.innerHTML = '';

            app.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version;
                option.textContent = version;
                if (version === app.selectedVersion) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        async function loadDevices() {
            if (!app.selectedVersion) return;

            try {
                let url;
                if (app.selectedVersion === 'SNAPSHOT') {
                    // SNAPSHOTの場合
                    url = 'https://downloads.openwrt.org/snapshots/.overview.json';
                } else {
                    // 安定版の場合
                    url = `https://downloads.openwrt.org/releases/${app.selectedVersion}/.overview.json`;
                }
                
                const response = await fetch(url);
                const data = await response.json();

                app.devices = data.profiles || [];
            } catch (error) {
                console.error('Failed to load devices:', error);
                app.devices = [];
            }
        }

        async function handleVersionChange(e) {
            app.selectedVersion = e.target.value;
            app.selectedDevice = null;
            hideDeviceInfo();
            await loadDevices();
        }

        function handleDeviceSearch(e) {
            const query = e.target.value.toLowerCase();

            if (query.length < 2) {
                hideAutocomplete();
                return;
            }

            const matches = app.devices.filter(device => {
                const title = getDeviceTitle(device).toLowerCase();
                return title.includes(query) || device.id.toLowerCase().includes(query);
            }).slice(0, 10);

            showAutocomplete(matches);
        }

        function getDeviceTitle(device) {
            if (device.titles && device.titles.length > 0) {
                return device.titles[0].title || device.id;
            }
            return device.id;
        }

        function showAutocomplete(devices) {
            const container = document.getElementById('models-autocomplete-list');
            container.innerHTML = '';

            if (devices.length === 0) {
                hideAutocomplete();
                return;
            }

            devices.forEach(device => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${getDeviceTitle(device)}</strong><br><small>Target: ${device.target}</small>`;
                div.addEventListener('click', () => selectDevice(device));
                container.appendChild(div);
            });

            container.style.display = 'block';
        }

        function hideAutocomplete() {
            document.getElementById('models-autocomplete-list').style.display = 'none';
        }

        // 公式準拠のデバイス選択処理
        function selectDevice(device) {
            app.selectedDevice = device;
            document.getElementById('models').value = getDeviceTitle(device);
            hideAutocomplete();
            loadDeviceProfile(device);
        }

        // 公式と同じ方式: profiles.json からデバイス情報とパッケージを取得
        async function loadDeviceProfile(device) {
            if (!device || !device.target || !device.id) return;

            const version = app.selectedVersion;
            const target = device.target;
            const profileId = device.id;

            let profilesUrl;
            if (version === 'SNAPSHOT') {
                profilesUrl = `https://downloads.openwrt.org/snapshots/targets/${target}/profiles.json`;
            } else {
                profilesUrl = `https://downloads.openwrt.org/releases/${version}/targets/${target}/profiles.json`;
            }

            try {
                console.log(`Loading profile from: ${profilesUrl}`);
                const response = await fetch(profilesUrl, { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`Failed to fetch profiles.json: ${response.status}`);
                }
                
                const profilesData = await response.json();
                console.log(`Loaded profiles data:`, profilesData);

                // 公式と同じ方式: profiles.json の構造からデバイス情報を取得
                if (profilesData.profiles && profilesData.profiles[profileId]) {
                    const profile = profilesData.profiles[profileId];
                    console.log(`Found profile for ${profileId}:`, profile);
                    
                    // パッケージリストを構築（公式と同じ方式）
                    const defaultPackages = profilesData.default_packages || [];
                    const devicePackages = profile.device_packages || [];
                    // ASU用の追加パッケージ（公式準拠）
                    const asuExtraPackages = ['luci'];
                    const allPackages = defaultPackages.concat(devicePackages).concat(asuExtraPackages);
                    
                    console.log(`Setting packages: ${allPackages.join(' ')}`);
                    document.getElementById('asu-packages').value = allPackages.join(' ');
                    
                    showDeviceInfo();
                } else {
                    console.error(`Profile ${profileId} not found in profiles.json`);
                    showDeviceInfo();
                }
            } catch (error) {
                console.error('Failed to load device profile:', error);
                showDeviceInfo();
            }
        }

        function showDeviceInfo() {
            if (!app.selectedDevice) return;

            const device = app.selectedDevice;

            document.getElementById('device-title').textContent = getDeviceTitle(device);
            document.getElementById('device-details').innerHTML = `Target: ${device.target}<br>Version: ${app.selectedVersion}`;

            document.getElementById('info').style.display = 'block';
            document.getElementById('packages').style.display = 'block';
            document.getElementById('request-build').style.display = 'inline-block';
        }

        function hideDeviceInfo() {
            document.getElementById('info').style.display = 'none';
            document.getElementById('packages').style.display = 'none';
            document.getElementById('request-build').style.display = 'none';
        }

        // 公式準拠のユーティリティ関数
        function split(str) {
            return str.match(/[^\s,]+/g) || [];
        }

        // 手動選択時の接続方式詳細制御
        function handleConnectionTypeChange(e) {
            const pppoeSection = document.getElementById('pppoe-section');
            const dsliteSection = document.getElementById('dslite-section');
            const mapeManualSection = document.getElementById('mape-manual-section');

            // 全詳細セクションを非表示
            pppoeSection.style.display = 'none';
            dsliteSection.style.display = 'none';
            mapeManualSection.style.display = 'none';

            // 選択に応じて詳細セクション表示
            if (e.target.value === 'pppoe') {
                pppoeSection.style.display = 'block';
            } else if (e.target.value === 'dslite') {
                dsliteSection.style.display = 'block';
            } else if (e.target.value === 'mape') {
                mapeManualSection.style.display = 'block';
            }

            if (document.getElementById('use-aios-config').checked) {
                updateRequiredPackages(); // パッケージのみ更新、スクリプトは触らない
            }
        }

        function handleMapeTypeChange(e) {
            if (document.getElementById('use-aios-config').checked) {
                updateRequiredPackages(); // パッケージのみ更新、スクリプトは触らない
            }
        }

        // ISP情報の取得と表示更新
        async function fetchApiInfoAndUpdate() {
            try {
                updateIspDisplay('Fetching', 'Retrieving ISP information...');
                console.log('Starting fetchApiInfoAndUpdate...');
                
                const apiInfo = await fetchApiInfo();
                console.log('fetchApiInfo returned:', apiInfo);
                
                window.cachedApiInfo = apiInfo; // キャッシュ

                if (apiInfo) {
                    let statusText = 'Auto-detection successful';
                    let details = '';
                    
                    // ISP情報
                    if (apiInfo.isp) {
                        details += `ISP: ${apiInfo.isp}\n`;
                    }
                    if (apiInfo.country) {
                        details += `Country/Region: ${apiInfo.country}`;
                        if (apiInfo.regionName) {
                            details += ` (${apiInfo.regionName})`;
                        }
                        details += '\n';
                    }
                    if (apiInfo.timezone) {
                        details += `Timezone: ${apiInfo.timezone}\n`;
                    }
                    
                    // 接続方式判定
                    if (apiInfo.rule) {
                        if (apiInfo.rule.aftrType) {
                            statusText += ' - DS-Lite support detected';
                            details += `\n[DS-Lite Configuration]\n`;
                            details += `AFTR Type: ${apiInfo.rule.aftrType}\n`;
                            if (apiInfo.rule.aftrIpv6Address) {
                                details += `AFTR Address: ${apiInfo.rule.aftrIpv6Address}\n`;
                            }
                        } else if (apiInfo.rule.brIpv6Address) {
                            statusText += ' - MAP-E support detected';
                            details += `\n[MAP-E Configuration]\n`;
                            details += `BR: ${apiInfo.rule.brIpv6Address}\n`;
                            details += `EA-len: ${apiInfo.rule.eaBitLength}\n`;
                            details += `IPv4 Prefix: ${apiInfo.rule.ipv4Prefix}/${apiInfo.rule.ipv4PrefixLength}\n`;
                            details += `IPv6 Prefix: ${apiInfo.rule.ipv6Prefix}/${apiInfo.rule.ipv6PrefixLength}\n`;
                            details += `PSID Offset: ${apiInfo.rule.psIdOffset}\n`;
                            
                            // 推奨方式があれば表示
                            if (apiInfo.recommendedMapeType) {
                                details += `Recommended Mode: ${apiInfo.recommendedMapeType}\n`;
                            }
                            if (apiInfo.lineType) {
                                details += `Line Type: ${apiInfo.lineType}\n`;
                            }
                        }
                    } else {
                        statusText += ' - DHCP/PPPoE environment';
                        details += '\nStandard DHCP or PPPoE connection environment detected.';
                    }
                    
                    updateIspDisplay(statusText, details);
                    
                    // 取得した値をMAP-E入力ボックスに自動設定
                    if (apiInfo.rule && apiInfo.rule.brIpv6Address) {
                        document.getElementById('mape-br').value = apiInfo.rule.brIpv6Address;
                        document.getElementById('mape-ealen').value = apiInfo.rule.eaBitLength || '';
                        document.getElementById('mape-ipv4-prefix').value = apiInfo.rule.ipv4Prefix || '';
                        document.getElementById('mape-ipv4-prefixlen').value = apiInfo.rule.ipv4PrefixLength || '';
                        document.getElementById('mape-ipv6-prefix').value = apiInfo.rule.ipv6Prefix || '';
                        document.getElementById('mape-ipv6-prefixlen').value = apiInfo.rule.ipv6PrefixLength || '';
                        document.getElementById('mape-psid-offset').value = apiInfo.rule.psIdOffset || '';
                    }
                    
                    // DS-Lite情報があれば設定
                    if (apiInfo.rule && apiInfo.rule.aftrType) {
                        document.getElementById('dslite-aftr-type').value = apiInfo.rule.aftrType;
                        if (apiInfo.rule.aftrIpv6Address) {
                            document.getElementById('dslite-aftr-address').value = apiInfo.rule.aftrIpv6Address;
                        }
                    }
                } else {
                    updateIspDisplay('Auto-detection failed', 'API connection error or unsupported ISP\nManual configuration required.');
                }
                
            } catch (error) {
                console.error('ISP info fetch error:', error);
                updateIspDisplay('Fetch error', 'API connection failed.\nPlease use manual configuration for offline environments.');
            }
        }

        // ISP情報表示の更新
        function updateIspDisplay(status, details) {
            const statusMessage = document.getElementById('isp-status-message');
            const technicalInfo = document.getElementById('isp-technical-info');
            
            statusMessage.textContent = status;
            
            if (details) {
                technicalInfo.textContent = details;
                technicalInfo.style.display = 'block';
            } else {
                technicalInfo.style.display = 'none';
            }
        }

        // API情報を事前取得してスクリプトカスタマイズ
        async function loadAiosTemplate() {
            try {
                const response = await fetch('scripts/setup.sh');
                if (!response.ok) {
                    throw new Error('Failed to load setup.sh template');
                }
                let content = await response.text();
                
                // 設定ウィザードの値を取得
                if (document.getElementById('use-aios-config').checked) {
                    const config = getAiosConfig();
                    
                    // キャッシュされたAPI情報を使用、なければ新規取得
                    let apiInfo = window.cachedApiInfo;
                    if (!apiInfo && config.connectionType === 'mape') {
                        apiInfo = await fetchApiInfoAndUpdate();
                    }
                    
                    content = customizeSetupScript(content, config, apiInfo);
                }
                
                document.getElementById('uci-defaults-content').value = content;
            } catch (error) {
                console.error('Template loading error:', error);
                document.getElementById('uci-defaults-content').value = '#!/bin/sh\n\n# Failed to load setup.sh template\n# Please check if scripts/setup.sh exists';
            }
        }

        // API情報を事前取得（ビルド時）
        async function fetchApiInfo() {
            try {
                console.log('Fetching API info from auto-config.site-u.workers.dev...');
                
                const response = await fetch('https://auto-config.site-u.workers.dev/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    console.warn('API access failed with status:', response.status);
                    return null;
                }
                
                const data = await response.json();
                console.log('API Info fetched successfully:', data);
                
                return data;
            } catch (error) {
                console.error('Failed to fetch API info:', error);
                return null;
            }
        }

        // setup.shスクリプトのカスタマイズ（新しい変数構造対応）
        async function customizeSetupScript(content, config, apiInfo) {
            let customized = content;
            
            // OSバージョン設定
            customized = customized.replace('# os_version=""', `os_version="${app.selectedVersion}"`);
            
            // OpenWrtバージョン別フラグ設定
            if (app.selectedVersion && app.selectedVersion.startsWith('19')) {
                customized = customized.replace('# openwrt_19=""', `openwrt_19="1"`);
            } else {
                customized = customized.replace('# openwrt_21=""', `openwrt_21="1"`);
            }
            
            // 基本設定
            if (config.language) {
                customized = customized.replace('# language=""', `language="${config.language}"`);
            }
            
            if (config.deviceName) {
                customized = customized.replace('# device_name=""', `device_name="${config.deviceName}"`);
            }
            
            if (config.lanIp) {
                customized = customized.replace('# lan_ip_address="192.168.1.1"', `lan_ip_address="${config.lanIp}"`);
            }
            
            if (config.rootPassword && config.confirmPassword && config.rootPassword === config.confirmPassword) {
                customized = customized.replace('# root_password=""', `root_password="${config.rootPassword}"`);
            }
            
            // Wi-Fi設定
            if (config.wifiSSID) {
                customized = customized.replace('# wlan_name=""', `wlan_name="${config.wifiSSID}"`);
            }
            if (config.wifiPassword) {
                customized = customized.replace('# wlan_password=""', `wlan_password="${config.wifiPassword}"`);
            }
            
            // 接続方式別設定
            if (config.connectionMode === 'manual') {
                // 手動選択時
                switch(config.connectionType) {
                    case 'pppoe':
                        if (config.pppoeUsername) {
                            customized = customized.replace('# pppoe_username=""', `pppoe_username="${config.pppoeUsername}"`);
                        }
                        if (config.pppoePassword) {
                            customized = customized.replace('# pppoe_password=""', `pppoe_password="${config.pppoePassword}"`);
                        }
                        break;
                        
                    case 'dslite':
                        if (config.dsliteAftrAddress) {
                            customized = customized.replace('# dslite_aftr_address=""', `dslite_aftr_address="${config.dsliteAftrAddress}"`);
                        }
                        break;
                        
                    case 'mape':
                        // MAP-E手動設定
                        if (config.mapeBr) {
                            customized = customized.replace('# mape_br=""', `mape_br="${config.mapeBr}"`);
                        }
                        if (config.mapeEalen) {
                            customized = customized.replace('# mape_ealen=""', `mape_ealen="${config.mapeEalen}"`);
                            
                            // PSID計算
                            const ealen = parseInt(config.mapeEalen);
                            const ipv4Prefixlen = parseInt(config.mapeIpv4Prefixlen) || 32;
                            const psidOffset = parseInt(config.mapePsidOffset) || (32 - ipv4Prefixlen);
                            const psidlen = Math.max(0, Math.min(16, ealen - psidOffset));
                            
                            customized = customized.replace('# mape_psidlen=""', `mape_psidlen="${psidlen}"`);
                            customized = customized.replace('# mape_psid_offset=""', `mape_psid_offset="${psidOffset}"`);
                        }
                        if (config.mapeIpv4Prefix) {
                            customized = customized.replace('# mape_ipv4_prefix=""', `mape_ipv4_prefix="${config.mapeIpv4Prefix}"`);
                        }
                        if (config.mapeIpv4Prefixlen) {
                            customized = customized.replace('# mape_ipv4_prefixlen=""', `mape_ipv4_prefixlen="${config.mapeIpv4Prefixlen}"`);
                        }
                        if (config.mapeIpv6Prefix) {
                            customized = customized.replace('# mape_ipv6_prefix=""', `mape_ipv6_prefix="${config.mapeIpv6Prefix}"`);
                        }
                        if (config.mapeIpv6Prefixlen) {
                            customized = customized.replace('# mape_ipv6_prefixlen=""', `mape_ipv6_prefixlen="${config.mapeIpv6Prefixlen}"`);
                        }
                        
                        // GUA/PD設定
                        if (config.mapeType === 'gua' && config.mapeIpv6Prefix) {
                            const ipv6Base = config.mapeIpv6Prefix.split(':').slice(0, 4).join(':');
                            const guaPrefix = `${ipv6Base}::/64`;
                            customized = customized.replace('# mape_gua_mode=""', `mape_gua_mode="1"`);
                            customized = customized.replace('# mape_gua_prefix=""', `mape_gua_prefix="${guaPrefix}"`);
                        }
                        
                        // map.sh内容を取得・設定
                        await loadMapShContent(customized, app.selectedVersion);
                        break;
                }
            } else {
                // AUTO選択時：API情報から設定
                if (apiInfo) {
                    // 位置情報
                    if (apiInfo.country) {
                        customized = customized.replace('# country=""', `country="${apiInfo.country}"`);
                    }
                    if (apiInfo.timezone) {
                        customized = customized.replace('# timezone=""', `timezone="${apiInfo.timezone}"`);
                    }
                    
                    // DS-Lite判定
                    if (apiInfo.aftr) {
                        customized = customized.replace('# dslite_aftr_address=""', `dslite_aftr_address="${apiInfo.aftr.aftrIpv6Address}"`);
                    }
                    // MAP-E判定
                    else if (apiInfo.rule) {
                        customized = customized.replace('# mape_br=""', `mape_br="${apiInfo.rule.brIpv6Address}"`);
                        customized = customized.replace('# mape_ealen=""', `mape_ealen="${apiInfo.rule.eaBitLength}"`);
                        customized = customized.replace('# mape_ipv4_prefix=""', `mape_ipv4_prefix="${apiInfo.rule.ipv4Prefix}"`);
                        customized = customized.replace('# mape_ipv4_prefixlen=""', `mape_ipv4_prefixlen="${apiInfo.rule.ipv4PrefixLength}"`);
                        customized = customized.replace('# mape_ipv6_prefix=""', `mape_ipv6_prefix="${apiInfo.rule.ipv6Prefix}"`);
                        customized = customized.replace('# mape_ipv6_prefixlen=""', `mape_ipv6_prefixlen="${apiInfo.rule.ipv6PrefixLength}"`);
                        
                        // PSID計算
                        const ealen = parseInt(apiInfo.rule.eaBitLength);
                        const ipv4Prefixlen = parseInt(apiInfo.rule.ipv4PrefixLength);
                        const psidOffset = parseInt(apiInfo.rule.psIdOffset) || (32 - ipv4Prefixlen);
                        const psidlen = Math.max(0, Math.min(16, ealen - psidOffset));
                        
                        customized = customized.replace('# mape_psidlen=""', `mape_psidlen="${psidlen}"`);
                        customized = customized.replace('# mape_psid_offset=""', `mape_psid_offset="${psidOffset}"`);
                        
                        // GUA設定（デフォルト）
                        const ipv6Base = apiInfo.rule.ipv6Prefix.split(':').slice(0, 4).join(':');
                        const guaPrefix = `${ipv6Base}::/64`;
                        customized = customized.replace('# mape_gua_mode=""', `mape_gua_mode="1"`);
                        customized = customized.replace('# mape_gua_prefix=""', `mape_gua_prefix="${guaPrefix}"`);
                        
                        // map.sh内容を取得・設定
                        await loadMapShContent(customized, app.selectedVersion);
                    }
                }
            }
            
            return customized;
        }
        
        // map.sh内容取得・プレースホルダー置換
        async function loadMapShContent(content, osVersion) {
            try {
                let mapShUrl;
                if (osVersion && osVersion.startsWith('19')) {
                    mapShUrl = 'https://site-u.pages.dev/build/scripts/map.sh.19';
                } else {
                    mapShUrl = 'https://site-u.pages.dev/build/scripts/map.sh.new';
                }
                
                const response = await fetch(mapShUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch map.sh: ${response.status}`);
                }
                
                const mapShContent = await response.text();
                // プレースホルダー置換
                content = content.replace('${map_sh_content}', mapShContent);
                
                console.log(`Loaded map.sh for ${osVersion}:`, mapShUrl);
                return content;
            } catch (error) {
                console.error('Failed to load map.sh:', error);
                // フォールバック
                content = content.replace('${map_sh_content}', '#!/bin/sh\n# Failed to load map.sh content');
                return content;
            }
        }

        function toggleAiosConfig(e) {
            const config = document.getElementById('aios-config');

            if (e.target.checked) {
                config.style.display = 'block';
                loadAiosTemplate();
                updateRequiredPackages();
            } else {
                config.style.display = 'none';
            }
        }

        function getAiosConfig() {
            const connectionMode = document.querySelector('input[name="connectionMode"]:checked').value;
            let effectiveConnectionType = 'auto';
            
            // AUTO選択時は 'auto'、OFF選択時は選択された接続方式
            if (connectionMode === 'manual') {
                effectiveConnectionType = document.querySelector('input[name="connectionType"]:checked')?.value || 'dhcp';
            }
            
            return {
                language: document.getElementById('aios-language').value,
                deviceName: document.getElementById('aios-device-name').value,
                lanIp: document.getElementById('aios-lan-ip').value,
                rootPassword: document.getElementById('aios-root-password').value,
                confirmPassword: document.getElementById('aios-confirm-password').value,
                wifiSSID: document.getElementById('aios-wifi-ssid').value,
                wifiPassword: document.getElementById('aios-wifi-password').value,
                connectionMode: connectionMode,
                connectionType: effectiveConnectionType,
                mapeType: document.querySelector('input[name="mapeType"]:checked')?.value || 'auto',
                pppoeUsername: document.getElementById('pppoe-username').value,
                pppoePassword: document.getElementById('pppoe-password').value,
                // DS-Lite manual settings
                dsliteAftrType: document.getElementById('dslite-aftr-type').value,
                dsliteAftrAddress: document.getElementById('dslite-aftr-address').value,
                // MAP-E manual settings
                mapeBr: document.getElementById('mape-br').value,
                mapeEalen: document.getElementById('mape-ealen').value,
                mapeIpv4Prefix: document.getElementById('mape-ipv4-prefix').value,
                mapeIpv4Prefixlen: document.getElementById('mape-ipv4-prefixlen').value,
                mapeIpv6Prefix: document.getElementById('mape-ipv6-prefix').value,
                mapeIpv6Prefixlen: document.getElementById('mape-ipv6-prefixlen').value,
                mapePsidOffset: document.getElementById('mape-psid-offset').value
            };
        }

        // 必要パッケージの自動追加（公式準拠）
        function updateRequiredPackages() {
            const config = getAiosConfig();
            const packagesTextarea = document.getElementById('asu-packages');
            let currentPackages = split(packagesTextarea.value);
            
            // 既存のaios関連パッケージを削除
            currentPackages = currentPackages.filter(pkg => pkg !== 'map' && pkg !== 'ds-lite');
            
            // 接続タイプに応じてパッケージ追加（AUTO時はAPI情報で判定、手動時は選択値）
            if (config.connectionMode === 'auto') {
                // AUTO時はキャッシュされたAPI情報で判定
                if (window.cachedApiInfo && window.cachedApiInfo.rule) {
                    if (window.cachedApiInfo.rule.aftrType) {
                        // DS-Lite
                        if (!currentPackages.includes('ds-lite')) {
                            currentPackages.push('ds-lite');
                        }
                    } else if (window.cachedApiInfo.rule.brIpv6Address) {
                        // MAP-E
                        if (!currentPackages.includes('map')) {
                            currentPackages.push('map');
                        }
                    }
                }
            } else {
                // 手動選択時
                switch(config.connectionType) {
                    case 'mape':
                        if (!currentPackages.includes('map')) {
                            currentPackages.push('map');
                        }
                        break;
                    case 'dslite':
                        if (!currentPackages.includes('ds-lite')) {
                            currentPackages.push('ds-lite');
                        }
                        break;
                }
            }
            
            // 公式と同じ形式: スペース区切り
            packagesTextarea.value = currentPackages.join(' ');
        }

        // 公式準拠のビルドリクエスト関数
        async function buildAsuRequest() {
            if (!app.selectedDevice) {
                alert('Please select a device first');
                return;
            }

            try {
                document.getElementById('request-build').disabled = true;
                showProgress('Sending build request...', 10);

                const packages = split(document.getElementById('asu-packages').value);
                const script = document.getElementById('uci-defaults-content').value;

                const requestBody = {
                    target: app.selectedDevice.target,
                    profile: app.selectedDevice.id,
                    packages: packages
                };

                if (app.selectedVersion && app.selectedVersion !== 'SNAPSHOT') {
                    requestBody.version = app.selectedVersion;
                }

                if (script && script.trim()) {
                    requestBody.defaults = script;
                }

                const response = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('Invalid JSON response: ' + responseText);
                }

                if (result.request_hash) {
                    await pollBuildStatus(result.request_hash);
                } else if (result.images && result.images.length > 0) {
                    hideProgress();
                    showDownloadLinks(result.images);
                } else {
                    throw new Error('No request hash or images in response');
                }

            } catch (error) {
                console.error('Build request failed:', error);
                alert('Build failed: ' + error.message);
                hideProgress();
            } finally {
                document.getElementById('request-build').disabled = false;
            }
        }

        async function pollBuildStatus(requestHash) {
            const maxAttempts = 120; // 10分間
            let attempts = 0;
            const startTime = Date.now();

            while (attempts < maxAttempts) {
                try {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                    
                    const statusUrl = `https://sysupgrade.openwrt.org/api/v1/build/${requestHash}`;

                    const response = await fetch(statusUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404 && attempts < 5) {
                            showProgress(`Waiting for build to start... ${timeStr}`, 10);
                            await new Promise(resolve => setTimeout(resolve, 5000));
                            attempts++;
                            continue;
                        }
                        throw new Error(`Status check failed: HTTP ${response.status}`);
                    }

                    const statusText = await response.text();

                    let status;
                    try {
                        status = JSON.parse(statusText);
                    } catch (e) {
                        throw new Error('Invalid JSON in status response: ' + statusText);
                    }
                    
                    const progressPercent = Math.min((elapsedSeconds / 600) * 85 + 10, 95);

                    if (status.status === 'done' || status.status === 'success' || 
                        status.detail === 'done' || status.imagebuilder_status === 'done') {
                        let images = status.images || 
                                   status.request?.images || 
                                   status.request?.files ||
                                   status.files ||
                                   [];
                        
                        let rh = status.request_hash || status.request?.request_hash;
                        
                        showProgress('Build completed!', 100);
                        setTimeout(() => {
                            hideProgress();
                            showDownloadLinks(images, status, rh);
                        }, 500);
                        return;
                    } else if (status.status === 'failed' || status.status === 'failure' || 
                              status.detail === 'failed' || status.imagebuilder_status === 'failed') {
                        throw new Error(`Build failed: ${status.detail || status.stdout || 'Unknown error'}`);
                    } else if (status.status === 'queued') {
                        showProgress(`Queued for build... ${timeStr}`, Math.max(progressPercent * 0.3, 10));
                    } else if (status.status === 'building') {
                        showProgress(`Building image... ${timeStr}`, Math.max(progressPercent * 0.8, 30));
                    } else {
                        showProgress(`Processing (${status.status})... ${timeStr}`, progressPercent);
                    }

                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;

                } catch (error) {
                    if (attempts >= 5) {
                        throw error;
                    }
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    showProgress(`Connection error, retrying... ${elapsedSeconds}s`, 5);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;
                }
            }

            throw new Error('Build timeout after 10 minutes');
        }

        function showProgress(message, percentage) {
            document.getElementById('build-message').textContent = message;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('build-progress').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('build-progress').style.display = 'none';
        }

        function showDownloadLinks(images, fullStatus, requestHash) {
            const container = document.getElementById('download-links');
            container.innerHTML = '<h4>Download</h4>';

            if (images && images.length > 0) {
                images.forEach((image, index) => {
                    const link = document.createElement('a');
                    let imageUrl = '';
                    let fileName = '';
                    
                    if (image.name && requestHash) {
                        imageUrl = `https://sysupgrade.openwrt.org/store/${requestHash}/${image.name}`;
                        fileName = image.name;
                        
                        let displayName = fileName;
                        if (image.type) {
                            if (image.type.includes('sysupgrade')) {
                                displayName = `🔄 Sysupgrade (${image.type})`;
                            } else if (image.type.includes('factory')) {
                                displayName = `🏭 Factory (${image.type})`;
                            } else if (image.type.includes('sdcard')) {
                                displayName = `💾 SD Card (${image.type})`;
                            } else {
                                displayName = `📦 ${image.type}`;
                            }
                        }
                        
                        link.href = imageUrl;
                        link.className = 'download-link';
                        link.textContent = displayName;
                        link.target = '_blank';
                        link.download = fileName;
                        link.title = fileName;
                        
                        container.appendChild(link);
                        container.appendChild(document.createElement('br'));
                        
                    } else {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.color = 'red';
                        errorDiv.style.margin = '5px 0';
                        errorDiv.innerHTML = `❌ Image ${index}: Missing data (name: ${!!image.name}, hash: ${!!requestHash})`;
                        container.appendChild(errorDiv);
                    }
                });
                
                const debugDiv = document.createElement('div');
                debugDiv.style.background = '#f9f9f9';
                debugDiv.style.padding = '5px';
                debugDiv.style.marginTop = '10px';
                debugDiv.style.fontSize = '11px';
                debugDiv.style.color = '#666';
                debugDiv.innerHTML = `<strong>Debug:</strong> Found ${images.length} images, Request Hash: ${requestHash?.substring(0, 16)}...`;
                container.appendChild(debugDiv);
                
            } else {
                container.innerHTML = '<h4>Download</h4><p>No images available</p>';
            }
        }
    </script>
</body>

</html>
