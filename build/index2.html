async function loadProfiles() {
  const targetSelect = document.getElementById('target-select');
  targetSelect.innerHTML = '';

  try {
    const res = await fetch('https://sysupgrade.openwrt.org/targets.json');
    const targets = await res.json();

    Object.keys(targets).forEach(target => {
      const opt = document.createElement('option');
      opt.value = target;
      opt.textContent = target;
      targetSelect.appendChild(opt);
    });

    targetSelect.addEventListener('change', () => {
      loadProfilesForTarget(targetSelect.value);
    });

  } catch (err) {
    console.error('targets.json の取得に失敗しました:', err);
  }
}

async function loadProfilesForTarget(target) {
  const profileSelect = document.getElementById('profile-select');
  profileSelect.innerHTML = '';

  try {
    const res = await fetch(`https://sysupgrade.openwrt.org/${target}/profiles.json`);
    const profiles = await res.json();

    Object.entries(profiles).forEach(([name, data]) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = `${name} - ${data.title}`;
      opt.dataset.packages = data.packages || '';
      profileSelect.appendChild(opt);
    });

    profileSelect.addEventListener('change', () => {
      const selected = profileSelect.options[profileSelect.selectedIndex];
      const pkgTextarea = document.getElementById('asu-packages');
      pkgTextarea.value = selected.dataset.packages || '';
    });

    // デフォルトで最初のプロファイルを選択＆パッケージ自動入力
    if (profileSelect.options.length > 0) {
      profileSelect.selectedIndex = 0;
      const first = profileSelect.options[0];
      document.getElementById('asu-packages').value = first.dataset.packages || '';
    }

  } catch (err) {
    console.error('profiles.json の取得に失敗しました:', err);
  }
}

async function buildAsuRequest() {
  const target = document.getElementById('target-select').value;
  const profile = document.getElementById('profile-select').value;

  const pkgList = document.getElementById('asu-packages').value
    .trim()
    .split(/\s+/)  // 空白や改行で分割
    .filter(Boolean); // 空要素除去

  const body = {
    target: target,
    profile: profile,
    packages: pkgList
  };

  try {
    const res = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const errData = await res.json();
      throw new Error(`Build failed: HTTP ${res.status}: ${JSON.stringify(errData)}`);
    }

    const data = await res.json();
    console.log('ビルド成功:', data);

  } catch (err) {
    console.error('ビルドリクエストエラー:', err);
  }
}

document.addEventListener('DOMContentLoaded', loadProfiles);
