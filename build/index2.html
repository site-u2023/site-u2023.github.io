<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenWrt Firmware Selector - 改良版（パッケージ一覧取得）</title>
    <style>
        /* （元のスタイルをほぼそのまま） */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.5;color:#212529;background:#fff;margin:0;padding:20px}
        .container{max-width:900px;margin:0 auto;padding:0 15px}
        h1{font-size:2.2rem;font-weight:300;text-align:center;margin-bottom:1rem;color:#007bff}
        .lead{text-align:center;color:#6c757d;margin-bottom:1rem}
        .form-group{margin-bottom:1rem}
        label{display:inline-block;margin-bottom:.5rem;font-weight:500}
        .form-control{display:block;width:100%;padding:.375rem .75rem;font-size:1rem;border:1px solid #ced4da;border-radius:.25rem}
        .autocomplete{position:relative}
        .autocomplete-items{position:absolute;border:1px solid #d4edda;z-index:99;top:100%;left:0;right:0;max-height:300px;overflow-y:auto;background:#fff}
        .autocomplete-items div{padding:10px;cursor:pointer;border-bottom:1px solid #d4edda}
        .autocomplete-items div:hover{background:#e9ecef}
        .info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:.75rem 1.25rem;margin-bottom:1rem;border-radius:.25rem}
        .packages{margin:1.5rem 0}
        .btn{display:inline-block;padding:.375rem .75rem;border-radius:.25rem;text-decoration:none;cursor:pointer}
        .btn-primary{background:#007bff;color:#fff;border:1px solid #007bff;padding:.375rem .75rem;border-radius:.25rem}
        .download-link{display:inline-block;margin:.25rem .5rem;padding:.5rem 1rem;background:#28a745;color:#fff;border-radius:.25rem;text-decoration:none}
        .aios-section{margin:1.5rem 0;padding:1rem;background:#f8f9fa;border:1px solid #dee2e6;border-radius:.25rem}
        .available-packages{margin-top:1rem;border:1px solid #e9ecef;padding:10px;border-radius:6px;background:#fafafa}
        .available-item{padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer}
        .available-item:hover{background:#f1f1f1}
        .small{font-size:.875em;color:#6c757d}
        .flex{display:flex;gap:8px;align-items:center}
        #available-list{max-height:320px;overflow:auto}
        .muted{color:#666;font-size:12px;margin-top:6px}
        pre.debug{background:#f9f9f9;padding:6px;border-radius:4px;font-size:12px;color:#333;overflow:auto}
    </style>

    <!-- gzip 解凍用ライブラリ（pako）を CDN から読み込む -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>OpenWrt Firmware Selector — 改良版</h1>
        <p class="lead">デバイスを指定すると、プロファイルのデフォルトパッケージとターゲット／リポジトリの利用可能パッケージを取得します。</p>

        <div class="form-group">
            <label for="versions">Version</label>
            <select id="versions" class="form-control">
                <option value="" disabled selected>Loading versions...</option>
            </select>
        </div>

        <div class="form-group">
            <div class="autocomplete">
                <input type="text" id="models" class="form-control" placeholder="Type device model" autocomplete="off">
                <div id="models-autocomplete-list" class="autocomplete-items"></div>
            </div>
        </div>

        <div id="info" class="info" style="display:none;">
            <h5 id="device-title"></h5>
            <div id="device-details"></div>
        </div>

        <div id="packages" class="packages" style="display:none;">
            <h4>Customize installed packages and/or first boot script</h4>

            <div class="form-group">
                <label>利用可能パッケージを読み込む（ターゲットパッケージ）</label>
                <div class="flex">
                    <button id="btn-load-target-pkgs" class="btn btn-primary">Load Target packages</button>
                    <label style="margin-left:8px"><input type="checkbox" id="include-all-repos"> リポジトリ全走査（重い）</label>
                </div>
                <div class="muted">※ "リポジトリ全走査" は releases/<version>/packages/* を全部取得するので時間がかかります。最初はターゲットだけで十分なことが多いです。 </div>
            </div>

            <div class="form-group">
                <label for="packages-custom">Packages to add/remove (one per line, prefix with '-' to remove):</label>
                <textarea id="packages-custom" class="form-control" rows="6" placeholder="-wpad-basic-wolfssl&#10;wpad-wolfssl&#10;luci-ssl"></textarea>
            </div>

            <div class="available-packages" id="available-packages" style="display:none;">
                <div class="flex">
                    <strong>Available packages</strong>
                    <input id="available-filter" class="form-control" placeholder="Search packages..." style="margin-left:8px;">
                </div>
                <div id="available-list"></div>
                <div class="muted">クリックで textarea に追加。ダブルクリックで先頭に挿入。</div>
            </div>

            <!-- aios-light.shセクションは省略せず残す -->
            <div class="aios-section">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="use-aios-config">
                    <label class="form-check-label" for="use-aios-config">Use aios-light.sh configuration wizard</label>
                </div>

                <div id="aios-config" class="aios-config" style="display:none">
                    <h5>Basic Configuration</h5>
                    <div class="form-group">
                        <label for="aios-language">Language</label>
                        <select id="aios-language" class="form-control"><option value="en">English</option><option value="ja">Japanese</option></select>
                    </div>
                    <div class="form-group">
                        <label for="aios-device-name">Device name</label>
                        <input type="text" id="aios-device-name" class="form-control" placeholder="OpenWrt-Router">
                    </div>
                    <div class="form-row" style="display:flex;gap:8px">
                        <div class="form-group" style="flex:1">
                            <label for="aios-root-password">Root password</label>
                            <input type="password" id="aios-root-password" class="form-control" placeholder="8+ characters">
                            <small class="form-text text-muted">Leave empty to disable password authentication</small>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label for="aios-confirm-password">Confirm password</label>
                            <input type="password" id="aios-confirm-password" class="form-control" placeholder="Confirm password">
                        </div>
                    </div>
                    <h5>Wi-Fi Configuration</h5>
                    <div class="form-row" style="display:flex;gap:8px">
                        <div class="form-group" style="flex:1">
                            <label for="aios-wifi-ssid">Wi-Fi SSID</label>
                            <input type="text" id="aios-wifi-ssid" class="form-control" placeholder="MyOpenWrt">
                        </div>
                        <div class="form-group" style="flex:1">
                            <label for="aios-wifi-password">Wi-Fi password</label>
                            <input type="password" id="aios-wifi-password" class="form-control" placeholder="8+ characters">
                        </div>
                    </div>
                    <h5>Internet Connection</h5>
                    <div class="form-group">
                        <label>Connection type</label>
                        <div class="flex" style="flex-wrap:wrap">
                            <label><input type="radio" name="connectionType" value="auto" checked> Auto-detect</label>
                            <label><input type="radio" name="connectionType" value="dhcp"> DHCP</label>
                            <label><input type="radio" name="connectionType" value="pppoe"> PPPoE</label>
                            <label><input type="radio" name="connectionType" value="dslite"> DS-Lite</label>
                            <label><input type="radio" name="connectionType" value="mape"> MAP-E</label>
                            <label><input type="radio" name="connectionType" value="none"> None</label>
                        </div>
                    </div>
                    <div id="pppoe-section" style="display:none;border:1px solid #ffeaa7;padding:8px;margin-top:8px;">
                        <div style="display:flex;gap:8px">
                            <div style="flex:1"><label>PPPoE username</label><input id="pppoe-username" class="form-control"></div>
                            <div style="flex:1"><label>PPPoE password</label><input id="pppoe-password" class="form-control" type="password"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="script">Script to run on first boot (uci-defaults):</label>
                <textarea id="script" class="form-control" rows="8" placeholder="#!/bin/sh&#10;&#10;# Your script here"></textarea>
            </div>

            <button id="request-build" class="btn btn-primary" style="display:none">REQUEST BUILD</button>
        </div>

        <div id="build-progress" style="display:none;margin-top:12px">
            <div id="build-message">Building image...</div>
            <div style="width:100%;height:1rem;background:#e9ecef;border-radius:4px;margin-top:6px;overflow:hidden">
                <div id="progress-bar" style="height:100%;width:0%;background:#007bff;transition:width .3s"></div>
            </div>
        </div>

        <div id="download-links" style="margin-top:12px"></div>

        <hr>
        <div><strong>Debug / Notes</strong>
            <pre id="debug" class="debug"></pre>
        </div>
    </div>

<script>
/*
  ポイント:
  - pako（gzip展開）を使って downloads.openwrt.org の Packages.gz を展開し、
    "Package:" 行を抽出して「利用可能パッケージ一覧」を作る。
  - まずプロファイルに含まれるデフォルトパッケージ（device.packages 等）を textarea に入れる。
  - 「ターゲットのみ取得」か「全リポジトリ取得」かを選べる。
*/

let app = { versions: [], devices: [], selectedDevice: null, selectedVersion: '' };

document.addEventListener('DOMContentLoaded', init);

function logDebug(...args) {
    const d = document.getElementById('debug');
    d.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ') + '\n';
    d.scrollTop = d.scrollHeight;
}

async function init() {
    try {
        await loadVersions();
        bindEvents();
    } catch (e) {
        console.error(e);
        logDebug('init error', e);
    }
}

function bindEvents() {
    document.getElementById('versions').addEventListener('change', handleVersionChange);
    document.getElementById('models').addEventListener('input', handleDeviceSearch);
    document.getElementById('use-aios-config').addEventListener('change', toggleAiosConfig);
    document.getElementById('request-build').addEventListener('click', requestBuild);
    document.getElementById('btn-load-target-pkgs').addEventListener('click', onLoadTargetPkgs);
    document.getElementById('available-filter').addEventListener('input', filterAvailable);
    document.querySelectorAll('input[name="connectionType"]').forEach(r => r.addEventListener('change', handleConnectionTypeChange));
    document.getElementById('aios-config').addEventListener('input', generateAiosScript);

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete')) hideAutocomplete();
    });
}

async function loadVersions() {
    try {
        const resp = await fetch('https://downloads.openwrt.org/.versions.json');
        const data = await resp.json();
        app.versions = data.versions_list || [];
        app.selectedVersion = data.stable_version || app.versions[0] || '';
        updateVersionSelect();
        await loadDevices();
    } catch (e) {
        console.error('loadVersions failed', e);
        logDebug('loadVersions failed', e);
    }
}

function updateVersionSelect() {
    const sel = document.getElementById('versions');
    sel.innerHTML = '';
    app.versions.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        if (v === app.selectedVersion) opt.selected = true;
        sel.appendChild(opt);
    });
}

async function loadDevices() {
    if (!app.selectedVersion) return;
    try {
        const url = `https://downloads.openwrt.org/releases/${app.selectedVersion}/.overview.json`;
        const r = await fetch(url);
        const data = await r.json();
        // overview.json contains profiles (or similar). 保存
        app.devices = data.profiles || data || [];
        logDebug('Loaded devices count:', app.devices.length);
    } catch (e) {
        console.error('loadDevices failed', e);
        logDebug('loadDevices failed', e);
        app.devices = [];
    }
}

function handleVersionChange(e) {
    app.selectedVersion = e.target.value;
    app.selectedDevice = null;
    hideDeviceInfo();
    loadDevices();
}

function handleDeviceSearch(e) {
    const q = e.target.value.toLowerCase();
    if (q.length < 2) { hideAutocomplete(); return; }
    const matches = app.devices.filter(dev => {
        const title = getDeviceTitle(dev).toLowerCase();
        return title.includes(q) || (dev.id && dev.id.toLowerCase().includes(q)) || (dev.target && dev.target.toLowerCase().includes(q));
    }).slice(0, 25);
    showAutocomplete(matches);
}

function getDeviceTitle(device) {
    if (!device) return '';
    if (device.titles && device.titles.length) return device.titles[0].title || device.id || device.name || device.model || '';
    if (device.title) return device.title;
    return device.id || device.name || '';
}

function showAutocomplete(devices) {
    const container = document.getElementById('models-autocomplete-list');
    container.innerHTML = '';
    if (!devices.length) { hideAutocomplete(); return; }
    devices.forEach(d => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${getDeviceTitle(d)}</strong><br><small>Target: ${d.target || '(unknown)'}</small>`;
        div.addEventListener('click', () => selectDevice(d));
        container.appendChild(div);
    });
    container.style.display = 'block';
}

function hideAutocomplete() { document.getElementById('models-autocomplete-list').style.display = 'none'; }

function selectDevice(device) {
    app.selectedDevice = device;
    document.getElementById('models').value = getDeviceTitle(device);
    hideAutocomplete();
    showDeviceInfo();
    // 自動でデフォルトパッケージを textarea に入れる
    populateDefaultPackages(device);
}

function showDeviceInfo() {
    if (!app.selectedDevice) return;
    const d = app.selectedDevice;
    document.getElementById('device-title').textContent = getDeviceTitle(d);
    document.getElementById('device-details').innerHTML = `Target: ${d.target || '(unknown)'}<br>Version: ${app.selectedVersion}`;
    document.getElementById('info').style.display = 'block';
    document.getElementById('packages').style.display = 'block';
    document.getElementById('request-build').style.display = 'inline-block';
}

function hideDeviceInfo() {
    document.getElementById('info').style.display = 'none';
    document.getElementById('packages').style.display = 'none';
    document.getElementById('request-build').style.display = 'none';
}

/* ここからパッケージ取得関連 ------------------------------------------------- */

function populateDefaultPackages(device) {
    const ta = document.getElementById('packages-custom');
    // プロファイル JSON にパッケージ一覧が含まれているケースを想定
    // フィールド名はプロジェクトによって違う（packages, package_list, default_packages など）ので数パターン試す
    const candidates = device.packages || device.package || device.packages_list || device.default_packages || device.packages_default || device.packages || device.packagelist || null;
    if (candidates) {
        if (Array.isArray(candidates)) {
            ta.value = candidates.join('\n');
        } else if (typeof candidates === 'string') {
            // スペース区切りの可能性やカンマ区切りの可能性がある
            if (candidates.includes('\n')) ta.value = candidates;
            else if (candidates.includes(' ')) ta.value = candidates.split(/\s+/).join('\n');
            else ta.value = candidates;
        } else {
            // オブジェクトなら keys を出す
            try {
                ta.value = (candidates.map? candidates.map(x=>x.name||x).join('\n') : JSON.stringify(candidates));
            } catch(e){ ta.value = ''; }
        }
    } else {
        ta.value = ''; // 見つからなければ空白
    }
}

/* クリック: ターゲットパッケージをロード */
async function onLoadTargetPkgs() {
    if (!app.selectedDevice) { alert('デバイスを選んでください'); return; }
    const includeAll = document.getElementById('include-all-repos').checked;
    document.getElementById('available-packages').style.display = 'block';
    document.getElementById('available-list').innerHTML = 'Loading...';
    try {
        const pkgs = await loadAvailablePackages(app.selectedDevice, includeAll);
        showAvailablePackages(pkgs);
    } catch (e) {
        console.error('onLoadTargetPkgs error', e);
        logDebug('onLoadTargetPkgs error', e);
        document.getElementById('available-list').innerHTML = `<div style="color:red">取得失敗: ${e.message}</div>`;
    }
}

/* 実際に利用可能パッケージを集める関数 */
async function loadAvailablePackages(device, includeAllRepos=false) {
    const version = app.selectedVersion || 'snapshots';
    const target = device.target; // 期待: "ath79/generic" のような文字列
    const pkgsMap = new Map();

    // 1) まず targets/<target>/packages/Packages.gz を試す（カーネルモジュール等）
    if (target) {
        const targetPackagesGz = `https://downloads.openwrt.org/releases/${version}/targets/${target}/packages/Packages.gz`;
        try {
            const targetPkgs = await fetchAndParsePackagesGz(targetPackagesGz);
            targetPkgs.forEach(p => pkgsMap.set(p.name, p));
            logDebug(`Loaded ${targetPkgs.length} packages from target: ${target}`);
        } catch (e) {
            // snapshots の場合 URL が変わる可能性がある -> snapshots パスを試す
            try {
                const snapUrl = `https://downloads.openwrt.org/snapshots/targets/${target}/packages/Packages.gz`;
                const sp = await fetchAndParsePackagesGz(snapUrl);
                sp.forEach(p => pkgsMap.set(p.name, p));
                logDebug(`Loaded ${sp.length} packages from snapshots target: ${target}`);
            } catch (e2) {
                logDebug('target packages fetch failed', e2);
                // 無視して進む（target にパッケージが存在しないターゲットもある）
            }
        }
    }

    // 2) 必要なら releases/<version>/packages/* を列挙して各 arch の Packages.gz を取得する（重い）
    if (includeAllRepos) {
        try {
            // releases/<version>/packages/ のディレクトリ一覧を取得（HTML リストをパース）
            const packIndexUrl = `https://downloads.openwrt.org/releases/${version}/packages/`;
            const r = await fetch(packIndexUrl);
            const text = await r.text();
            const archs = [...new Set(Array.from(text.matchAll(/href="([^\/"]+)\/"/g)).map(m=>m[1]))];
            logDebug('found archs in packages index:', archs.length);
            // 各 arch の packages ディレクトリ配下の 'packages/Packages.gz' を取得（いくつかはない場合もある）
            for (const arch of archs) {
                const candidates = [
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/packages/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/base/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/luci/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/routing/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/telephony/Packages.gz`
                ];
                for (const url of candidates) {
                    try {
                        const arr = await fetchAndParsePackagesGz(url);
                        arr.forEach(p => { if (!pkgsMap.has(p.name)) pkgsMap.set(p.name, p); });
                        logDebug(`Loaded ${arr.length} pkgs from ${url}`);
                    } catch (e) {
                        // 存在しないファイルは無視
                    }
                }
            }
        } catch (e) {
            logDebug('includeAllRepos failed', e);
        }
    }

    // 3) 最後に app.selectedDevice の "packages" フィールド（プロファイル由来）もマージして優先表示
    const profilePkgs = device.packages || device.package || device.default_packages || null;
    if (Array.isArray(profilePkgs)) {
        profilePkgs.forEach(pname => {
            if (!pkgsMap.has(pname)) pkgsMap.set(pname, { name: pname, desc: '(profile default)' });
        });
    } else if (typeof profilePkgs === 'string') {
        profilePkgs.split(/\s+/).forEach(pname => { if (pname) pkgsMap.set(pname, {name:pname, desc:'(profile default)'}); });
    }

    return Array.from(pkgsMap.values()).sort((a,b)=> a.name.localeCompare(b.name));
}

/* Packages.gz を取得して展開、パースするヘルパー */
async function fetchAndParsePackagesGz(url) {
    logDebug('fetchAndParsePackagesGz', url);
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('HTTP ' + resp.status + ' for ' + url);
    const ab = await resp.arrayBuffer();
    // pako を使って ungzip
    const uint8 = new Uint8Array(ab);
    let text;
    try {
        const out = pako.ungzip(uint8);
        text = new TextDecoder('utf-8').decode(out);
    } catch (e) {
        // たまにサーバ側が圧縮してない "Packages" を置いてる場合もある
        try { text = new TextDecoder('utf-8').decode(uint8); } catch(err){ throw e; }
    }
    return parsePackagesText(text);
}

/* control-style (Debian/OPKG) Packages ファイルをパースして配列を返す */
function parsePackagesText(text) {
    const blocks = text.split(/\n\n+/);
    const out = [];
    for (const blk of blocks) {
        const m = blk.match(/^Package:\s*(.+)$/m);
        if (!m) continue;
        const name = m[1].trim();
        const descMatch = blk.match(/^Description:\s*(.+)$/m);
        const desc = descMatch ? descMatch[1].trim() : '';
        out.push({ name, desc, raw: blk });
    }
    return out;
}

/* Available packages を UI に出す */
function showAvailablePackages(pkgs) {
    const list = document.getElementById('available-list');
    list.innerHTML = '';
    if (!pkgs || !pkgs.length) {
        list.innerHTML = '<div style="color:#666">No packages found</div>';
        return;
    }
    pkgs.forEach(p => {
        const div = document.createElement('div');
        div.className = 'available-item';
        div.innerHTML = `<strong>${p.name}</strong> <span class="small"> ${p.desc?('- '+escapeHtml(p.desc)) : ''}</span>`;
        div.addEventListener('click', () => addPackageToTextarea(p.name));
        div.addEventListener('dblclick', () => insertPackageAtTop(p.name));
        list.appendChild(div);
    });
    // store last list for filter
    list.dataset.packages = JSON.stringify(pkgs);
}

/* フィルタ */
function filterAvailable() {
    const q = document.getElementById('available-filter').value.trim().toLowerCase();
    const list = document.getElementById('available-list');
    const pkgs = JSON.parse(list.dataset.packages || '[]');
    list.innerHTML = '';
    pkgs.filter(p => p.name.toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q)).forEach(p => {
        const div = document.createElement('div');
        div.className = 'available-item';
        div.innerHTML = `<strong>${p.name}</strong> <span class="small"> ${p.desc?('- '+escapeHtml(p.desc)) : ''}</span>`;
        div.addEventListener('click', () => addPackageToTextarea(p.name));
        div.addEventListener('dblclick', () => insertPackageAtTop(p.name));
        list.appendChild(div);
    });
}

/* textarea 操作 */
function addPackageToTextarea(pkgname) {
    const ta = document.getElementById('packages-custom');
    const lines = ta.value.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!lines.includes(pkgname)) lines.push(pkgname);
    ta.value = lines.join('\n');
}
function insertPackageAtTop(pkgname) {
    const ta = document.getElementById('packages-custom');
    const lines = ta.value.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!lines.includes(pkgname)) lines.unshift(pkgname);
    ta.value = lines.join('\n');
}

/* ユーティリティ */
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* aios script 関連（元のロジックを維持） */
function toggleAiosConfig(e){
    const config = document.getElementById('aios-config');
    const script = document.getElementById('script');
    if (e.target.checked) { config.style.display='block'; generateAiosScript(); } else { config.style.display='none'; script.value=''; }
}
function handleConnectionTypeChange(e){
    document.getElementById('pppoe-section').style.display = e.target.value==='pppoe' ? 'block' : 'none';
    if (document.getElementById('use-aios-config').checked) generateAiosScript();
}
function getAiosConfig(){ return {
    language: document.getElementById('aios-language').value,
    deviceName: document.getElementById('aios-device-name').value,
    rootPassword: document.getElementById('aios-root-password').value,
    wifiSSID: document.getElementById('aios-wifi-ssid').value,
    wifiPassword: document.getElementById('aios-wifi-password').value,
    connectionType: document.querySelector('input[name="connectionType"]:checked').value,
    pppoeUsername: document.getElementById('pppoe-username').value,
    pppoePassword: document.getElementById('pppoe-password').value
};}
function buildAiosScript(config){
    let script = '#!/bin/sh\n\n# OpenWrt Auto Configuration Script\n# Generated by aios-light.sh configuration\n\nCONFIG_SCRIPT="/tmp/aios/aios-light.sh"\nmkdir -p /tmp/aios\n\nwget --no-check-certificate -O "$CONFIG_SCRIPT" "https://site-u.pages.dev/build/scripts/aios-light.sh" 2>/dev/null\n\nif [ ! -f "$CONFIG_SCRIPT" ]; then\n    logger -t aios-config "Failed to download aios-light.sh"\n    exit 1\nfi\n\nchmod +x "$CONFIG_SCRIPT"\n\n# Configuration Variables\n';
    if (config.language) script += `export LANGUAGE="${config.language}"\n`;
    if (config.deviceName) script += `export DEVICE_NAME="${config.deviceName}"\n`;
    if (config.rootPassword) script += `export ROOT_PASSWORD="${config.rootPassword}"\n`;
    if (config.wifiSSID) script += `export WLAN_NAME="${config.wifiSSID}"\n`;
    if (config.wifiPassword) script += `export WLAN_PASSWORD="${config.wifiPassword}"\n`;
    if (config.connectionType === 'auto') script += 'export ISP_MODE=""\n';
    else if (config.connectionType === 'pppoe') {
        script += 'export ISP_MODE="pppoe"\n';
        if (config.pppoeUsername) script += `export PPPOE_USERNAME="${config.pppoeUsername}"\n`;
        if (config.pppoePassword) script += `export PPPOE_PASSWORD="${config.pppoePassword}"\n`;
    } else script += `export ISP_MODE="${config.connectionType}"\n`;
    script += '\n# Execute configuration script\nexec sh "$CONFIG_SCRIPT" "$ISP_MODE"\n';
    return script;
}
function generateAiosScript(){ if (!document.getElementById('use-aios-config').checked) return; const config=getAiosConfig(); document.getElementById('script').value=buildAiosScript(config); }

/* ビルド関連（元の実装を簡略） */
async function requestBuild(){
    if (!app.selectedDevice){ alert('Please select a device first'); return; }
    try {
        document.getElementById('request-build').disabled = true;
        const packages = document.getElementById('packages-custom').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const script = document.getElementById('script').value;
        const body = { target: app.selectedDevice.target, profile: app.selectedDevice.id, packages };
        if (app.selectedVersion && app.selectedVersion !== 'SNAPSHOT') body.version = app.selectedVersion;
        if (script && script.trim()) body.defaults = script;
        logDebug('Sending build request', body);
        const resp = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const text = await resp.text();
        if (!resp.ok) throw new Error('Build request failed: ' + resp.status + ' / ' + text);
        const result = JSON.parse(text);
        if (result.request_hash) {
            logDebug('build requested, hash', result.request_hash);
            alert('ビルドを開始しました（hash:' + result.request_hash + '） — ページで確認してください');
            // 本文では pollBuildStatus の既存ロジックを省略。必要ならここに入れる。
        } else {
            logDebug('build result (no hash)', result);
        }
    } catch (e) {
        console.error(e); logDebug('requestBuild error', e);
        alert('Build request failed: ' + e.message);
    } finally {
        document.getElementById('request-build').disabled = false;
    }
}

</script>
</body>
</html>
