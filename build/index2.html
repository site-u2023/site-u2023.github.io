<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OpenWrt Firmware Selector — 公式互換（Load Target packages 実装）</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;padding:20px;color:#212529;background:#fff}
.container{max-width:980px;margin:0 auto;padding:0 15px}
h1{font-size:1.8rem;color:#007bff;text-align:center;margin-bottom:8px}
.lead{color:#6c757d;text-align:center;margin-bottom:16px}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:6px;font-weight:600}
.form-control{width:100%;padding:8px;border:1px solid #ced4da;border-radius:6px;font-size:14px}
.btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
.btn-primary{background:#007bff;color:#fff;border-color:#007bff}
.info{background:#d1ecf1;border:1px solid #bee5eb;padding:10px;border-radius:6px;color:#0c5460}
.available-packages{margin-top:12px;border:1px solid #e9ecef;padding:10px;border-radius:6px;background:#fafafa}
.available-item{padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;cursor:pointer}
.available-item.default{background:#fff8e1;border-left:4px solid #ffb300}
.available-item:hover{background:#f1f1f1}
.profile-defaults-box{background:#f5f5f5;border:1px solid #ddd;padding:8px;border-radius:4px;white-space:pre-wrap;font-family:monospace;margin-top:6px}
pre.debug{background:#f9f9f9;padding:8px;border-radius:4px;overflow:auto;font-size:12px;color:#333}
.muted{color:#666;font-size:13px;margin-top:6px}
</style>
<!-- pako for ungzip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
<div class="container">
    <h1>OpenWrt Firmware Selector — 公式互換</h1>
    <p class="lead">Load Target packages を押すと公式と同じくプロファイルのインストール予定パッケージを取得して表示します。</p>

    <div class="form-group">
        <label for="versions">Version</label>
        <select id="versions" class="form-control"><option disabled selected>Loading versions...</option></select>
    </div>

    <div class="form-group">
        <label for="models">Device model</label>
        <input id="models" class="form-control" placeholder="Type device model" autocomplete="off" />
        <div id="models-autocomplete-list" style="position:relative"></div>
    </div>

    <div id="info" class="info" style="display:none;">
        <div id="device-title" style="font-weight:700"></div>
        <div id="device-details" style="margin-top:6px"></div>
    </div>

    <div id="packages" style="display:none;margin-top:12px">
        <h4>Customize installed packages and/or first boot script</h4>

        <div class="form-group">
            <button id="btn-load-target-pkgs" class="btn btn-primary">Load Target packages（公式と同じ）</button>
            <button id="btn-load-available" class="btn" style="margin-left:8px">Load Available packages</button>
            <label style="margin-left:8px"><input type="checkbox" id="include-all-repos"> リポジトリ全走査（重い）</label>
            <div class="muted">まず profile のインストールパッケージを取得して textarea に **空白区切り1行** で入れます（公式と同じ）。</div>
        </div>

        <div class="form-group">
            <label for="packages-custom">Packages to add/remove (one per line, prefix with '-' to remove):</label>
            <textarea id="packages-custom" class="form-control" rows="6" placeholder="-wpad-basic-wolfssl&#10;wpad-wolfssl&#10;luci-ssl"></textarea>
            <div id="profile-defaults-box" class="profile-defaults-box" style="display:none"></div>
        </div>

        <div id="available-container" class="available-packages" style="display:none">
            <div style="display:flex;gap:8px;align-items:center">
                <strong>Available packages</strong>
                <input id="available-filter" class="form-control" style="margin-left:8px;flex:1" placeholder="Search packages...">
            </div>
            <div id="available-list" style="max-height:320px;overflow:auto;margin-top:8px"></div>
            <div class="muted">クリックで textarea に追加。ダブルクリックで先頭に挿入。デフォルトは黄色</div>
        </div>

        <div style="margin-top:12px">
            <label for="script">Script to run on first boot (uci-defaults)</label>
            <textarea id="script" class="form-control" rows="6"></textarea>
        </div>

        <div style="margin-top:12px">
            <button id="request-build" class="btn btn-primary" style="display:none">REQUEST BUILD</button>
        </div>
    </div>

    <hr />
    <div><strong>Debug</strong><pre id="debug" class="debug"></pre></div>
</div>

<script>
const debugEl = document.getElementById('debug');
function dbg(...a){ debugEl.textContent += a.map(x=> typeof x === 'object' ? JSON.stringify(x,null,2) : String(x)).join(' ') + '\n'; debugEl.scrollTop = debugEl.scrollHeight; }

let app = { versions: [], devices: [], selectedVersion: '', selectedDevice: null, profileDefaults: [] };

document.addEventListener('DOMContentLoaded', init);

async function init(){
    await loadVersions();
    bind();
}

function bind(){
    document.getElementById('versions').addEventListener('change', async e=>{
        app.selectedVersion = e.target.value;
        app.selectedDevice = null;
        hideDeviceInfo();
        await loadDevices();
    });
    document.getElementById('models').addEventListener('input', onModelInput);
    document.getElementById('btn-load-target-pkgs').addEventListener('click', loadTargetProfilePackagesToTextarea);
    document.getElementById('btn-load-available').addEventListener('click', loadAvailablePackagesAction);
    document.getElementById('available-filter').addEventListener('input', filterAvailable);
    document.addEventListener('click', e=>{
        if(!e.target.closest('#models')) hideAutocomplete();
    });
}

async function loadVersions(){
    try{
        const r = await fetch('https://downloads.openwrt.org/.versions.json');
        const j = await r.json();
        app.versions = j.versions_list || [];
        app.selectedVersion = j.stable_version || app.versions[0] || '';
        const sel = document.getElementById('versions'); sel.innerHTML = '';
        app.versions.forEach(v=>{ const o = document.createElement('option'); o.value=v; o.textContent=v; if(v===app.selectedVersion) o.selected=true; sel.appendChild(o); });
        await loadDevices();
    }catch(e){ dbg('loadVersions error', e); }
}

async function loadDevices(){
    if(!app.selectedVersion) return;
    try{
        const url = `https://downloads.openwrt.org/releases/${app.selectedVersion}/.overview.json`;
        dbg('fetch overview', url);
        const r = await fetch(url);
        const j = await r.json();
        app.devices = j.profiles || j || [];
        dbg('devices count', app.devices.length);
    }catch(e){ dbg('loadDevices error', e); app.devices = []; }
}

function onModelInput(e){
    const q = e.target.value.toLowerCase();
    if(q.length < 1){ hideAutocomplete(); return; }
    const matches = app.devices.filter(d => {
        const t = getDeviceTitle(d).toLowerCase();
        return t.includes(q) || (d.id && d.id.toLowerCase().includes(q)) || (d.target && d.target.toLowerCase().includes(q));
    }).slice(0,25);
    showAutocomplete(matches);
}

function getDeviceTitle(d){
    if(!d) return '';
    if(d.titles && d.titles.length) return d.titles[0].title || d.id || '';
    if(d.title) return d.title;
    return d.id || d.name || '';
}

function showAutocomplete(list){
    const box = document.getElementById('models-autocomplete-list');
    box.innerHTML = '';
    list.forEach(d=>{
        const div = document.createElement('div');
        div.className='autocomplete-item';
        div.style.padding='6px';
        div.innerHTML = `<strong>${escapeHtml(getDeviceTitle(d))}</strong><br><small>${escapeHtml(d.target||'')}</small>`;
        div.addEventListener('click', ()=>{ selectDevice(d); });
        box.appendChild(div);
    });
}

function hideAutocomplete(){ document.getElementById('models-autocomplete-list').innerHTML = ''; }

function selectDevice(d){
    app.selectedDevice = d;
    document.getElementById('models').value = getDeviceTitle(d);
    hideAutocomplete();
    showDeviceInfo();
    // prepare preview: try to get defaults (async)
    prepareProfileDefaults(d);
}

function showDeviceInfo(){
    const d = app.selectedDevice;
    if(!d) return;
    document.getElementById('info').style.display = 'block';
    document.getElementById('packages').style.display = 'block';
    document.getElementById('device-title').textContent = getDeviceTitle(d);
    document.getElementById('device-details').innerHTML = `Target: ${d.target||'(unknown)'}<br>Version: ${app.selectedVersion}`;
    document.getElementById('request-build').style.display = 'inline-block';
}

function hideDeviceInfo(){
    document.getElementById('info').style.display = 'none';
    document.getElementById('packages').style.display = 'none';
}

/* ===== ここが肝心：Load Target packages（公式と同じ挙動） =====
   手順:
   1) targets/<target>/profiles.json を取得 -> profile を探す -> packages フィールドを取得
   2) 見つかれば textarea に **空白区切り1行**で入れる（公式と同じ）
   3) 見つからなければ個別 profiles/<id>.json を試す
   4) それでも無い場合は従来の Available パッケージ取得を行う（fallback）
*/

async function loadTargetProfilePackagesToTextarea(){
    if(!app.selectedDevice){ alert('デバイスを選んでください'); return; }
    const device = app.selectedDevice;
    const target = device.target;
    const profileId = device.id;
    const version = app.selectedVersion || 'snapshots';
    dbg('Attempting to load profile packages from target:', target, 'profile:', profileId, 'version:', version);

    // try candidates (releases first, then snapshots)
    const tries = [];
    if(version && version !== 'snapshots'){
        tries.push(`https://downloads.openwrt.org/releases/${version}/targets/${target}/profiles.json`);
        tries.push(`https://downloads.openwrt.org/releases/${version}/targets/${target}/profiles/${profileId}.json`);
    }
    tries.push(`https://downloads.openwrt.org/snapshots/targets/${target}/profiles.json`);
    tries.push(`https://downloads.openwrt.org/snapshots/targets/${target}/profiles/${profileId}.json`);

    let foundPackages = [];
    for(const url of tries){
        try{
            dbg('fetching', url);
            const r = await fetch(url);
            if(!r.ok){ dbg('not ok', r.status, url); continue; }
            const j = await r.json();
            // profiles.json layout
            if(Array.isArray(j.profiles)){
                const found = j.profiles.find(p => p.id === profileId || p.profile === profileId || p.name === profileId || p.model === profileId);
                if(found){
                    const pkgs = normalizePackagesField(found.packages || found.package || found.defaults || found.default_packages || found['installed-packages']);
                    if(pkgs && pkgs.length){ foundPackages = pkgs; dbg('found in profiles.json', pkgs.length); break; }
                }
            }
            // individual profile json layout
            const directPkgs = normalizePackagesField(j.packages || j.defaults || j.default_packages || j.installed || (j.profile && (j.profile.packages||j.profile.defaults)));
            if(directPkgs && directPkgs.length){ foundPackages = directPkgs; dbg('found in profile json', directPkgs.length); break; }
        }catch(e){
            dbg('fetch error', url, e);
            continue;
        }
    }

    if(foundPackages.length){
        // 公式と同じ **空白区切り1行** 表示を textarea に入れる
        const oneLine = foundPackages.join(' ');
        document.getElementById('packages-custom').value = oneLine;
        document.getElementById('profile-defaults-box').style.display = 'block';
        document.getElementById('profile-defaults-box').textContent = oneLine;
        app.profileDefaults = foundPackages.slice();
        dbg('Loaded profile defaults into textarea (one-line)', foundPackages.length);
        // update available highlight if available loaded
        highlightDefaultsInAvailable();
        return;
    }

    // fallback: profile field not found — show available packages instead (original behavior)
    dbg('Profile packages not found in target profiles; falling back to Available packages');
    await loadAvailablePackagesAction();
}

/* helpers */
function normalizePackagesField(raw){
    if(!raw) return [];
    if(Array.isArray(raw)) return raw.map(String).map(s=>s.trim()).filter(Boolean);
    if(typeof raw === 'string') return raw.split(/\s+/).map(s=>s.trim()).filter(Boolean);
    try{ return Object.values(raw).map(String).map(s=>s.trim()).filter(Boolean); }catch(e){ return []; }
}

/* ===== Available packages: Packages.gz を取得してパースして表示 ===== */

async function loadAvailablePackagesAction(){
    if(!app.selectedDevice){ alert('デバイスを選んでください'); return; }
    const includeAll = document.getElementById('include-all-repos').checked;
    const device = app.selectedDevice;
    document.getElementById('available-container').style.display = 'block';
    document.getElementById('available-list').innerHTML = 'Loading...';
    try{
        const pkgs = await loadAvailablePackages(device, includeAll);
        showAvailablePackages(pkgs);
        highlightDefaultsInAvailable();
    }catch(e){
        dbg('loadAvailablePackagesAction error', e);
        document.getElementById('available-list').innerHTML = `<div style="color:red">取得失敗: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadAvailablePackages(device, includeAllRepos=false){
    const version = app.selectedVersion || 'snapshots';
    const target = device.target || '';
    const map = new Map();
    if(target){
        const urls = [
            `https://downloads.openwrt.org/releases/${version}/targets/${target}/packages/Packages.gz`,
            `https://downloads.openwrt.org/snapshots/targets/${target}/packages/Packages.gz`
        ];
        for(const u of urls){
            try{
                const arr = await fetchAndParsePackagesGz(u);
                arr.forEach(p=>map.set(p.name, p));
                dbg('loaded target packages from', u, arr.length);
                break;
            }catch(e){ dbg('target packages fetch failed', u, e); }
        }
    }
    if(includeAllRepos){
        try{
            const idx = `https://downloads.openwrt.org/releases/${version}/packages/`;
            const r = await fetch(idx);
            const text = await r.text();
            const archs = [...new Set(Array.from(text.matchAll(/href="([^\/"]+)\/"/g)).map(m=>m[1]))];
            for(const arch of archs){
                const candidates = [
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/packages/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/base/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/luci/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/routing/Packages.gz`,
                    `https://downloads.openwrt.org/releases/${version}/packages/${arch}/telephony/Packages.gz`
                ];
                for(const u of candidates){
                    try{ const arr = await fetchAndParsePackagesGz(u); arr.forEach(p=>{ if(!map.has(p.name)) map.set(p.name,p); }); dbg('loaded', u, arr.length); }catch(e){}
                }
            }
        }catch(e){ dbg('includeAllRepos error', e); }
    }
    // merge profile defaults so they're present even if not in packages.gz
    if(app.profileDefaults && app.profileDefaults.length) app.profileDefaults.forEach(n=>{ if(!map.has(n)) map.set(n,{name:n,desc:'(profile default)'}); });
    return Array.from(map.values()).sort((a,b)=> a.name.localeCompare(b.name));
}

async function fetchAndParsePackagesGz(url){
    dbg('fetchAndParsePackagesGz', url);
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status+' '+url);
    const ab = await r.arrayBuffer();
    const uint8 = new Uint8Array(ab);
    let text;
    try{
        const out = pako.ungzip(uint8);
        text = new TextDecoder('utf-8').decode(out);
    }catch(e){
        try{ text = new TextDecoder('utf-8').decode(uint8); }catch(err){ throw e; }
    }
    return parsePackagesText(text);
}

function parsePackagesText(text){
    const blocks = text.split(/\n\n+/);
    const out = [];
    for(const blk of blocks){
        const m = blk.match(/^Package:\s*(.+)$/m);
        if(!m) continue;
        const name = m[1].trim();
        const descMatch = blk.match(/^Description:\s*(.+)$/m);
        const desc = descMatch ? descMatch[1].trim() : '';
        out.push({name,desc,raw:blk});
    }
    return out;
}

function showAvailablePackages(list){
    const container = document.getElementById('available-list');
    container.innerHTML = '';
    if(!list || !list.length){ container.innerHTML = '<div style="color:#666">No packages found</div>'; return; }
    list.forEach(p=>{
        const div = document.createElement('div');
        div.className='available-item';
        if(app.profileDefaults && app.profileDefaults.includes(p.name)) div.classList.add('default');
        div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><span style="font-weight:700">${escapeHtml(p.name)}</span><span style="color:#666">${p.desc?(' - '+escapeHtml(p.desc)):''}</span></div><div style="color:#999">${app.profileDefaults && app.profileDefaults.includes(p.name)?'★ default':''}</div>`;
        div.addEventListener('click', ()=> addPackageToTextarea(p.name));
        div.addEventListener('dblclick', ()=> insertPackageAtTop(p.name));
        container.appendChild(div);
    });
    container.dataset.packages = JSON.stringify(list);
}

function highlightDefaultsInAvailable(){
    const list = document.getElementById('available-list');
    if(!list) return;
    Array.from(list.children).forEach(child=>{
        const name = child.querySelector('span')?.textContent?.trim();
        if(app.profileDefaults && app.profileDefaults.includes(name)) child.classList.add('default');
        else child.classList.remove('default');
    });
}

function filterAvailable(){
    const q = document.getElementById('available-filter').value.trim().toLowerCase();
    const list = document.getElementById('available-list');
    const objs = JSON.parse(list.dataset.packages || '[]');
    list.innerHTML = '';
    objs.filter(p => p.name.toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q)).forEach(p => {
        const div = document.createElement('div');
        div.className='available-item';
        if(app.profileDefaults && app.profileDefaults.includes(p.name)) div.classList.add('default');
        div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><span style="font-weight:700">${escapeHtml(p.name)}</span><span style="color:#666">${p.desc?(' - '+escapeHtml(p.desc)):''}</span></div><div style="color:#999">${app.profileDefaults && app.profileDefaults.includes(p.name)?'★ default':''}</div>`;
        div.addEventListener('click', ()=> addPackageToTextarea(p.name));
        div.addEventListener('dblclick', ()=> insertPackageAtTop(p.name));
        list.appendChild(div);
    });
}

/* textarea helpers */
function addPackageToTextarea(name){
    const ta = document.getElementById('packages-custom');
    // 公式は空白区切り1行だが textarea を編集しやすく行区切りにするため既存が空白区切りなら改行に変換して追加
    let cur = ta.value;
    if(cur.indexOf('\n') === -1 && cur.trim() !== '') cur = cur.replace(/\s+/g,'\n');
    const arr = cur.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    if(!arr.includes(name)) arr.push(name);
    ta.value = arr.join('\n');
}

function insertPackageAtTop(name){
    const ta = document.getElementById('packages-custom');
    let cur = ta.value;
    if(cur.indexOf('\n') === -1 && cur.trim() !== '') cur = cur.replace(/\s+/g,'\n');
    const arr = cur.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    if(!arr.includes(name)) arr.unshift(name);
    ta.value = arr.join('\n');
}

/* util */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* prepare preview when selected device changes */
async function prepareProfileDefaults(d){
    document.getElementById('profile-defaults-box').style.display='none';
    app.profileDefaults = [];
    // first, try device object fields
    let raw = d.packages || d.package || d.default_packages || d.packages_default || d.packagelist || d.defaults || null;
    if(raw){
        app.profileDefaults = normalizePackagesField(raw);
    }
    // if empty, try fetching profiles.json (non-blocking)
    if((!app.profileDefaults || !app.profileDefaults.length) && d.target && d.id){
        try{
            const version = app.selectedVersion || 'snapshots';
            const purl = `https://downloads.openwrt.org/releases/${version}/targets/${d.target}/profiles.json`;
            dbg('preview try', purl);
            const r = await fetch(purl);
            if(r.ok){
                const j = await r.json();
                if(Array.isArray(j.profiles)){
                    const found = j.profiles.find(p => p.id === d.id || p.profile === d.id || p.name === d.id || p.model === d.id);
                    if(found){
                        app.profileDefaults = normalizePackagesField(found.packages || found.package || found.defaults || found.default_packages || found['installed-packages']);
                    }
                }
            }
        }catch(e){ dbg('prepareProfileDefaults fetch error', e); }
    }
    if(app.profileDefaults && app.profileDefaults.length){
        document.getElementById('profile-defaults-box').style.display='block';
        document.getElementById('profile-defaults-box').textContent = app.profileDefaults.join(' ');
        dbg('preview defaults prepared', app.profileDefaults.length);
    } else {
        document.getElementById('profile-defaults-box').style.display='none';
        dbg('no profile defaults preview');
    }
}
</script>
</body>
</html>
