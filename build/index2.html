<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>OpenWrt ASU Builder</title>
<style>
  body { font-family: sans-serif; }
  select, textarea, button {
    width: 100%;
    margin: 5px 0;
  }
  textarea {
    height: 150px;
  }
  .section {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 15px;
  }
</style>
</head>
<body>

<h2>OpenWrt ASU カスタムビルダー</h2>

<div class="section">
  <label for="target-select">Target（SoC/Platform）</label>
  <select id="target-select"></select>
</div>

<div class="section">
  <label for="profile-select">Profile（Device）</label>
  <select id="profile-select"></select>
</div>

<div class="section">
  <h4>Installed Packages</h4>
  <textarea id="asu-packages" autocomplete="off" spellcheck="false" autocapitalize="off"></textarea>
</div>

<div class="section">
  <button id="build-btn">REQUEST BUILD</button>
</div>

<script>
async function loadProfiles() {
  const targetSelect = document.getElementById('target-select');
  targetSelect.innerHTML = '';

  try {
    const res = await fetch('https://sysupgrade.openwrt.org/targets.json');
    const targets = await res.json();

    Object.keys(targets).forEach(target => {
      const opt = document.createElement('option');
      opt.value = target;
      opt.textContent = target;
      targetSelect.appendChild(opt);
    });

    targetSelect.addEventListener('change', () => {
      loadProfilesForTarget(targetSelect.value);
    });

    // 初回ロード時に最初のターゲットを選択
    if (targetSelect.options.length > 0) {
      targetSelect.selectedIndex = 0;
      loadProfilesForTarget(targetSelect.value);
    }

  } catch (err) {
    console.error('targets.json の取得に失敗しました:', err);
  }
}

async function loadProfilesForTarget(target) {
  const profileSelect = document.getElementById('profile-select');
  profileSelect.innerHTML = '';

  try {
    const res = await fetch(`https://sysupgrade.openwrt.org/${target}/profiles.json`);
    const profiles = await res.json();

    Object.entries(profiles).forEach(([name, data]) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = `${name} - ${data.title}`;
      opt.dataset.packages = data.packages || '';
      profileSelect.appendChild(opt);
    });

    profileSelect.addEventListener('change', () => {
      const selected = profileSelect.options[profileSelect.selectedIndex];
      const pkgTextarea = document.getElementById('asu-packages');
      pkgTextarea.value = selected.dataset.packages || '';
    });

    // デフォルトで最初のプロファイルを選択＆パッケージ自動入力
    if (profileSelect.options.length > 0) {
      profileSelect.selectedIndex = 0;
      const first = profileSelect.options[0];
      document.getElementById('asu-packages').value = first.dataset.packages || '';
    }

  } catch (err) {
    console.error('profiles.json の取得に失敗しました:', err);
  }
}

async function buildAsuRequest() {
  const target = document.getElementById('target-select').value;
  const profile = document.getElementById('profile-select').value;

  // パッケージを配列化（422回避）
  const pkgList = document.getElementById('asu-packages').value
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const body = {
    target: target,
    profile: profile,
    packages: pkgList
  };

  try {
    const res = await fetch('https://sysupgrade.openwrt.org/api/v1/build', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const errData = await res.json();
      throw new Error(`Build failed: HTTP ${res.status}: ${JSON.stringify(errData)}`);
    }

    const data = await res.json();
    console.log('ビルド成功:', data);
    alert('ビルド要求が送信されました');

  } catch (err) {
    console.error('ビルドリクエストエラー:', err);
    alert('ビルドエラー: ' + err.message);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadProfiles();
  document.getElementById('build-btn').addEventListener('click', buildAsuRequest);
});
</script>

</body>
</html>
