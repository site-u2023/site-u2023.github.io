<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ADB Format Full Dump</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
        }
        #output {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            white-space: pre-wrap;
            background: #f5f5f5;
            min-height: 200px;
            max-height: 80vh;
            overflow-y: auto;
        }
        input[type="file"] {
            margin: 20px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            display: block;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>packages.adb Full Dump & Header Info</h1>
    <p>packages.adbファイルを選択してください：</p>
    <input type="file" id="fileInput" accept=".adb">
    <div id="output">結果がここに表示されます</div>

    <script>
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const buffer = await file.arrayBuffer();
            const u8 = new Uint8Array(buffer);
            const dv = new DataView(buffer);

            let result = '';
            result += `File: ${file.name}\n`;
            result += `Size: ${u8.length} bytes\n`;

            // ヘッダー解析
            const magic = String.fromCharCode(...u8.slice(0, 4));
            result += `Magic: ${magic}\n`;

            const sqliteOffset = dv.getUint32(8, true);
            result += `SQLite offset (from header): ${sqliteOffset}\n`;

            const sig = String.fromCharCode(...u8.slice(sqliteOffset, sqliteOffset + 15));
            result += `Signature at offset: ${sig}\n`;

            // SQLiteシグネチャ検索
            const sigBytes = Array.from("SQLite format 3").map(c => c.charCodeAt(0));
            let foundOffsets = [];
            for (let i = 0; i < u8.length - sigBytes.length; i++) {
                if (sigBytes.every((b, idx) => u8[i + idx] === b)) {
                    foundOffsets.push(i);
                }
            }
            result += `Found SQLite signatures at: ${foundOffsets.join(', ')}\n\n`;

            // 全バイトをダンプ
            result += 'Full file hex dump:\n';
            for (let i = 0; i < u8.length; i += 16) {
                result += i.toString(16).padStart(6, '0') + ': ';
                result += Array.from(u8.slice(i, i + 16))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ') + '  ';
                result += Array.from(u8.slice(i, i + 16))
                    .map(b => (b >= 32 && b < 127) ? String.fromCharCode(b) : '.')
                    .join('');
                result += '\n';
            }

            document.getElementById('output').textContent = result;
        });
    </script>
</body>
</html>
