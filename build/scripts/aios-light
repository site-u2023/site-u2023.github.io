#!/bin/sh
CONFIG_SCRIPT="/tmp/aios-light.sh"

wget --no-check-certificate -O "$CONFIG_SCRIPT" "https://site-u.pages.dev/build/scripts/aios-light.sh" 2>/dev/null

if [ ! -f "$CONFIG_SCRIPT" ]; then
    printf "\033[31mFailed to download main config script\033[0m\n"
    exit 1
fi
chmod +x "$CONFIG_SCRIPT"
if [ ! -x "$CONFIG_SCRIPT" ]; then
    printf "\033[31m$CONFIG_SCRIPT not found or not executable.\033[0m\n" 
    exit 1
fi
printf "\033[33mNotes: Blank to skip\033[0m\n"
# --- Language setting ---
printf "Language [en]: "
read -r LANGUAGE
# --- password ---
while true; do
  printf "New password [8+ chars]: "
  read -rs pass1
  printf "\nRetype new password: "
  read -rs pass2
  printf "\n"
  if [ -z "$pass1" ] && [ -z "$pass2" ]; then
    ROOT_PASSWORD=""
    break
  fi
    if [ "$pass1" = "$pass2" ]; then
        if [ ${#pass1} -ge 8 ]; then
            ROOT_PASSWORD="$pass1"
            break
        else
            printf "\033[31mPassword must be at least 8 characters.\033[0m\n"
        fi
    else
        printf "\033[31mPasswords do not match. Try again.\033[0m\n"
    fi
done
# --- device name ---
printf "Device name: "
read -r DEVICE_NAME
# --- Wi-Fi SSID and password ---
printf "Wi-Fi SSID: "
read -r WLAN_NAME
printf "Wi-Fi password: "
read -r WLAN_PASSWORD
# --- ISP mode ---
while :; do
  echo "Connection Type: [1] Auto  [2] DHCP  [3] PPPoE  [4] DS-Lite  [5] MAP-E  [6] None"
  printf "Choice [1]: "
  read -r choice
  [ -z "$choice" ] && choice=1
  case "$choice" in
    [1-6]) break ;;
  esac
done
ISP_MODE=""
PPPOE_USERNAME=""
PPPOE_PASSWORD=""
case "$choice" in
  1) ISP_MODE="" ;;
  2) ISP_MODE="dhcp" ;;
  3)
    printf "PPPoE username: "
    read -r PPPOE_USERNAME
    printf "PPPoE password: "
    read -r PPPOE_PASSWORD
    if [ -n "$PPPOE_USERNAME" ] && [ -n "$PPPOE_PASSWORD" ]; then
      ISP_MODE="pppoe"
    else
      ISP_MODE=""
    fi
    ;;
  4) ISP_MODE="dslite" ;;
  5) ISP_MODE="mape" ;;
  6) ISP_MODE="none" ;;
  *) ISP_MODE="" ;;
esac

export LANGUAGE ROOT_PASSWORD PPPOE_USERNAME PPPOE_PASSWORD DEVICE_NAME WLAN_NAME WLAN_PASSWORD
export ISP_MODE
exec sh "$CONFIG_SCRIPT"
