#!/bin/sh
# Beware! This script will be in /rom/etc/uci-defaults/ as part of the image.
# Generated by aios-light.sh configuration wizard
# Uncomment lines to apply:
#
# ROOT_PASSWORD=""
# DEVICE_NAME=""
# WLAN_NAME=""
# WLAN_PASSWORD=""
# PPPOE_USERNAME=""
# PPPOE_PASSWORD=""
#
LANGUAGE="${LANGUAGE:-en}"
ISP_MODE="${ISP_MODE:-auto}"

# Global variables
GUA_ADDR=""
PD_ADDR=""
WAN6_PREFIX=""
API_URL="https://auto-config.site-u.workers.dev/"
WAN_DEF="wan"
MAP_NAME="map"
MAP6_NAME="map6"
DSLITE_NAME="dslite"
DSLITE6_NAME="dslite6"

# API response data
API_RESPONSE=""
BR=""
EALEN=""
IPV4_PREFIX=""
IPV4_PREFIXLEN=""
IPV6_PREFIX=""
IPV6_PREFIXLEN=""
PSID_OFFSET=""
COUNTRY=""
TIMEZONE=""
REGION_NAME=""
REGION_CODE=""
ISP=""
OS_VERSION=""
AFTR_TYPE=""
REGION=""
AFTR_ADDR=""

# log potential errors
exec >/tmp/setup.log 2>&1

# OpenWrtネットワークAPIでIPv6アドレス取得
get_address() {
    local timeout=60
    local count=0
    local ipv6_addr=""
    local ipv6_prefix=""
    
    # ネットワーク関数をロード
    . /lib/functions.sh
    . /lib/functions/network.sh

    while [ $count -lt $timeout ]; do
        network_flush_cache
        network_find_wan6 wan6_iface

        if [ -n "$wan6_iface" ]; then
            # GUA（グローバルIPv6アドレス）取得
            if network_get_ipaddr6 ipv6_addr "$wan6_iface" && [ -n "$ipv6_addr" ]; then
                GUA_ADDR="$ipv6_addr"
                WAN6_PREFIX=$(echo "$GUA_ADDR" | awk -F':' '{printf "%s:%s:%s:%s::/64", $1, $2, $3, $4}')
                return 0
            fi
            
            # PD（委譲プレフィックス）取得
            if network_get_prefix6 ipv6_prefix "$wan6_iface" && [ -n "$ipv6_prefix" ]; then
                PD_ADDR="$ipv6_prefix"
                return 0
            fi
        fi

        sleep 2
        count=$((count + 2))
    done

    return 1
}

get_release() {
    if [ -f "/etc/openwrt_release" ]; then
        OS_VERSION=$(grep "DISTRIB_RELEASE" /etc/openwrt_release | cut -d"'" -f2 2>/dev/null)
    fi
}

fetch_country_info() {
    API_RESPONSE=$(wget -6 --no-check-certificate -q -O - --timeout=30 "$API_URL" 2>/dev/null)

    if [ -z "$API_RESPONSE" ]; then
        return 1
    fi
    
    # 地域情報取得
    COUNTRY=$(echo "$API_RESPONSE" | jsonfilter -e '@.country' 2>/dev/null)
    TIMEZONE=$(echo "$API_RESPONSE" | jsonfilter -e '@.timezone' 2>/dev/null)
    REGION_NAME=$(echo "$API_RESPONSE" | jsonfilter -e '@.regionName' 2>/dev/null)
    REGION_CODE=$(echo "$API_RESPONSE" | jsonfilter -e '@.region' 2>/dev/null)
    ISP=$(echo "$API_RESPONSE" | jsonfilter -e '@.isp' 2>/dev/null)
    
    return 0
}

fetch_mape_info() {
    local rule_exists=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule' 2>/dev/null)
    if [ -z "$rule_exists" ] || [ "$rule_exists" = "null" ]; then
        return 1
    fi

    # API レスポンスから値を抽出
    BR=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.brIpv6Address' 2>/dev/null)
    EALEN=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.eaBitLength' 2>/dev/null)
    IPV4_PREFIX=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.ipv4Prefix' 2>/dev/null)
    IPV4_PREFIXLEN=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.ipv4PrefixLength' 2>/dev/null)
    IPV6_PREFIX=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.ipv6Prefix' 2>/dev/null)
    IPV6_PREFIXLEN=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.ipv6PrefixLength' 2>/dev/null)
    OFFSET=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.psIdOffset' 2>/dev/null)
    
    PSID_OFFSET=$(( 32 - IPV4_PREFIXLEN ))
    PSIDLEN=$((EALEN - PSID_OFFSET))
    [ "$PSIDLEN" -lt 0 ] && PSIDLEN=0
    [ "$PSIDLEN" -gt 16 ] && exit 1

    # 必須パラメータのチェック
    if [ -z "$BR" ] || [ -z "$EALEN" ] || [ -z "$IPV4_PREFIX" ] || [ -z "$IPV4_PREFIXLEN" ] || [ -z "$IPV6_PREFIX" ] || [ -z "$IPV6_PREFIXLEN" ] || [ -z "$PSID_OFFSET" ]; then
        return 1
    fi

    return 0
}

# デバイス基本設定
set_device_basic_config() {
    # rootパスワード設定
    if [ -n "$ROOT_PASSWORD" ]; then
        (echo "$ROOT_PASSWORD"; sleep 1; echo "$ROOT_PASSWORD") | passwd > /dev/null
    fi
    
    # LAN IPアドレス設定
    if [ -n "$LAN_IP_ADDRESS" ]; then
        uci set network.lan.ipaddr="$LAN_IP_ADDRESS"
    fi
    
    # デバイス名設定
    if [ -n "$DEVICE_NAME" ]; then
        uci set system.@system[0].hostname="$DEVICE_NAME"
    fi
    
    return 0
}

# 言語とタイムゾーン設定
set_country() {
    # システム設定（言語）
    if [ -n "$LANGUAGE" ]; then
        uci set system.@system[0].language="$LANGUAGE" >/dev/null 2>&1
    fi
    
    # システム設定（タイムゾーン）
    if [ -n "$TIMEZONE" ]; then
        uci set system.@system[0].timezone="$TIMEZONE" >/dev/null 2>&1
    fi

    return 0
}

# ISP接続方式の自動判別
detect_isp_mode() {
    # PPPoE判定
    if [ -n "$PPPOE_USERNAME" ] && [ -n "$PPPOE_PASSWORD" ]; then
        echo "pppoe"
        return 0
    fi

    # DS-Lite判定
    if [ -n "$API_RESPONSE" ]; then
        local aftr_type=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.aftrType' 2>/dev/null)
        local aftr_addr=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.aftrIpv6Address' 2>/dev/null)
        if [ "$aftr_type" = "transix" ] || [ "$aftr_type" = "xpass" ] || [ "$aftr_type" = "v6option" ] || [ -n "$aftr_addr" ]; then
            echo "dslite"
            return 0
        fi
    fi

    # MAP-E判定
    if [ -n "$API_RESPONSE" ]; then
        local rule_exists=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule' 2>/dev/null)
        if [ -n "$rule_exists" ] && [ "$rule_exists" != "null" ]; then
            echo "mape"
            return 0
        fi
    fi

    echo "dhcp"
    return 0
}

# PPPoE設定
set_pppoe_config() {
    if [ -n "$PPPOE_USERNAME" ] && [ -n "$PPPOE_PASSWORD" ]; then
        uci set network.wan.proto='pppoe'
        uci set network.wan.username="$PPPOE_USERNAME"
        uci set network.wan.password="$PPPOE_PASSWORD"
    fi
    
    return 0
}

# DS-Lite設定
set_dslite_config() {
    if [ -z "$GUA_ADDR" ]; then
        return 1
    fi

    AFTR_TYPE=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.aftrType' 2>/dev/null)
    AFTR_ADDR=$(echo "$API_RESPONSE" | jsonfilter -e '@.rule.aftrIpv6Address' 2>/dev/null)

    if [ -z "$AFTR_TYPE" ] || [ "$AFTR_TYPE" = "null" ]; then
        return 1
    fi

    # リージョン判定
    case "$GUA_ADDR" in
        2400:4050:*|2400:4051:*|2400:4052:*|2001:380:a0*|2001:380:a1*|2001:380:a2*|2001:380:a3*)
            REGION="east" ;;
        2400:4150:*|2400:4151:*|2400:4152:*|2001:380:b0*|2001:380:b1*|2001:380:b2*|2001:380:b3*)
            REGION="west" ;;
        *)
            REGION="east" ;;
    esac
    
    # AFTRアドレス決定
    local aftr_addr="$AFTR_ADDR"
    if [ -z "$aftr_addr" ] || [ "$aftr_addr" = "null" ]; then
        case "$AFTR_TYPE" in
            "transix")
                aftr_addr=$([ "$REGION" = "east" ] && echo "2404:8e00::feed:100" || echo "2404:8e01::feed:100") ;;
            "xpass")
                aftr_addr=$([ "$REGION" = "east" ] && echo "2001:e30:1c1e:1::1" || echo "2001:e30:1c1f:1::1") ;;
            "v6option")
                aftr_addr=$([ "$REGION" = "east" ] && echo "2404:8e00::feed:101" || echo "2404:8e01::feed:101") ;;
            *)
                return 1 ;;
        esac
    fi

    # 既存設定のクリーンアップ
    uci delete network.${DSLITE6_NAME} >/dev/null 2>&1
    uci delete network.${DSLITE_NAME} >/dev/null 2>&1
    uci delete dhcp.${DSLITE6_NAME} >/dev/null 2>&1
    uci del_list firewall.@zone[1].network="${DSLITE_NAME}" >/dev/null 2>&1
    uci del_list firewall.@zone[1].network="${DSLITE6_NAME}" >/dev/null 2>&1

    # WAN無効化
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'

    # DS-Lite IPv6インターフェース
    uci set network.${DSLITE6_NAME}=interface
    uci set network.${DSLITE6_NAME}.proto='dhcpv6'
    uci set network.${DSLITE6_NAME}.device="${WAN_DEF}"
    uci set network.${DSLITE6_NAME}.reqaddress='try'
    uci set network.${DSLITE6_NAME}.reqprefix='auto'

    # DS-Liteインターフェース
    uci set network.${DSLITE_NAME}=interface
    uci set network.${DSLITE_NAME}.proto='dslite'
    uci set network.${DSLITE_NAME}.peeraddr="$aftr_addr"
    uci set network.${DSLITE_NAME}.tunlink="${DSLITE6_NAME}"
    uci set network.${DSLITE_NAME}.mtu='1460'
    uci set network.${DSLITE_NAME}.encaplimit='ignore'

    # DHCP設定
    uci set dhcp.${DSLITE6_NAME}=dhcp
    uci set dhcp.${DSLITE6_NAME}.interface="${DSLITE6_NAME}"
    uci set dhcp.${DSLITE6_NAME}.master='1'
    uci set dhcp.${DSLITE6_NAME}.ra='relay'
    uci set dhcp.${DSLITE6_NAME}.dhcpv6='relay'
    uci set dhcp.${DSLITE6_NAME}.ndp='relay'
    uci set dhcp.${DSLITE6_NAME}.ignore='1'

    # LAN IPv6リレー
    uci set dhcp.lan.ra='relay'
    uci set dhcp.lan.dhcpv6='relay'
    uci set dhcp.lan.ndp='relay'
    uci set dhcp.lan.force='1'

    # ファイアウォール
    uci add_list firewall.@zone[1].network="${DSLITE_NAME}"
    uci add_list firewall.@zone[1].network="${DSLITE6_NAME}"
    uci set firewall.@zone[1].masq='1'
    uci set firewall.@zone[1].mtu_fix='1'

    return 0
}

replace_map() {
    cp /lib/netifd/proto/map.sh /lib/netifd/proto/map.sh.bak 2>/dev/null

    local map_url=""
    local map_path="/lib/netifd/proto/map.sh"
    if echo "$OS_VERSION" | grep -q "^19"; then
        map_url="https://site-u.pages.dev/build/scripts/map.sh.19"
    else
        map_url="https://site-u.pages.dev/build/scripts/map.sh.new"
    fi
    wget -6 --no-check-certificate -q -O "$map_path" "$map_url"
    
    return 0
}

# MAP-E設定
set_mape_config() {
    # 既存設定のクリーンアップ
    uci delete network.${MAP6_NAME} >/dev/null 2>&1
    uci delete network.${MAP_NAME} >/dev/null 2>&1
    uci delete dhcp.${MAP6_NAME} >/dev/null 2>&1
    uci del_list firewall.@zone[1].network="${MAP_NAME}" >/dev/null 2>&1
    uci del_list firewall.@zone[1].network="${MAP6_NAME}" >/dev/null 2>&1

    # WAN/WAN6無効化
    uci set network.wan.disabled='1'
    uci set network.wan.auto='0'
    uci set network.wan6.disabled='1'
    uci set network.wan6.auto='0'

    # MAP-E IPv6インターフェース
    uci set network.${MAP6_NAME}=interface
    uci set network.${MAP6_NAME}.proto='dhcpv6'
    uci set network.${MAP6_NAME}.device="${WAN_DEF}"
    uci set network.${MAP6_NAME}.reqaddress='try'
    uci set network.${MAP6_NAME}.reqprefix='auto'

    # GUA/PDプレフィックス設定
    if [ -n "$GUA_ADDR" ]; then
        uci set network.${MAP6_NAME}.ip6prefix="$WAN6_PREFIX"
    elif [ -n "$PD_ADDR" ]; then
        uci set network.${MAP6_NAME}.ip6prefix="$PD_ADDR"
    fi

    # MAP-Eインターフェース
    uci set network.${MAP_NAME}=interface
    uci set network.${MAP_NAME}.proto='map'
    uci set network.${MAP_NAME}.maptype='map-e'
    uci set network.${MAP_NAME}.peeraddr="${BR}"
    uci set network.${MAP_NAME}.ipaddr="${IPV4_PREFIX}"
    uci set network.${MAP_NAME}.ip4prefixlen="${IPV4_PREFIXLEN}"
    uci set network.${MAP_NAME}.ip6prefix="${IPV6_PREFIX}"
    uci set network.${MAP_NAME}.ip6prefixlen="${IPV6_PREFIXLEN}"
    uci set network.${MAP_NAME}.ealen="${EALEN}"
    uci set network.${MAP_NAME}.psidlen="${PSIDLEN}"
    uci set network.${MAP_NAME}.offset="${OFFSET}"
    uci set network.${MAP_NAME}.mtu='1460'
    uci set network.${MAP_NAME}.encaplimit='ignore'

    # OpenWrt バージョン別設定
    if echo "$OS_VERSION" | grep -q "^19"; then
        uci delete network.${MAP_NAME}.legacymap >/dev/null 2>&1
        uci delete network.${MAP_NAME}.tunlink >/dev/null 2>&1
        uci add_list network.${MAP_NAME}.tunlink="${MAP6_NAME}"
    else
        uci set network.${MAP_NAME}.legacymap='1'
        uci set network.${MAP_NAME}.tunlink="${MAP6_NAME}"
    fi

    # DHCP設定
    uci set dhcp.${MAP6_NAME}=dhcp
    uci set dhcp.${MAP6_NAME}.interface="${MAP6_NAME}"
    uci set dhcp.${MAP6_NAME}.master='1'
    uci set dhcp.${MAP6_NAME}.ra='relay'
    uci set dhcp.${MAP6_NAME}.dhcpv6='relay'
    uci set dhcp.${MAP6_NAME}.ndp='relay'

    # OpenWrt 21.02+のみでignore設定
    if ! echo "$OS_VERSION" | grep -q "^19"; then
        uci set dhcp.${MAP6_NAME}.ignore='1'
    fi

    # LAN IPv6リレー
    uci set dhcp.lan.ra='relay'
    uci set dhcp.lan.dhcpv6='relay'
    uci set dhcp.lan.ndp='relay'
    uci set dhcp.lan.force='1'

    # ファイアウォール
    uci add_list firewall.@zone[1].network="${MAP_NAME}"
    uci add_list firewall.@zone[1].network="${MAP6_NAME}"
    uci set firewall.@zone[1].masq='1'
    uci set firewall.@zone[1].mtu_fix='1'

    return 0
}

# Wi-Fi設定
set_wifi_config() {
    # 国コード設定関数
    set_country_code() {
        local device="$1"
        [ -n "$COUNTRY" ] && uci set wireless.${device}.country="$COUNTRY"
    }

    # ワイヤレス設定（国コード）
    if [ -n "$COUNTRY" ]; then
        . /lib/functions.sh
        config_load wireless
        config_foreach set_country_code wifi-device
    fi

    # WLAN設定（SSID & パスワード）
    if [ -n "$WLAN_NAME" ] && [ -n "$WLAN_PASSWORD" ] && [ ${#WLAN_PASSWORD} -ge 8 ]; then
        uci set wireless.@wifi-device[0].disabled='0'
        uci set wireless.@wifi-iface[0].disabled='0'
        uci set wireless.@wifi-iface[0].encryption='sae-mixed'
        uci set wireless.@wifi-iface[0].ssid="$WLAN_NAME"
        uci set wireless.@wifi-iface[0].key="$WLAN_PASSWORD"
    fi

    return 0
}

# メイン処理
main() {
    # デバイス基本設定
    set_device_basic_config
    get_release
    
    # IPv6接続確認
    if ! get_address; then
        uci commit network
        uci commit dhcp
        uci commit firewall
        return 0
    fi

    # API情報取得
    if ! fetch_country_info; then
        uci commit network
        uci commit dhcp
        uci commit firewall
        return 0
    fi

    # ISP接続方式判定
    if [ -z "$ISP_MODE" ] || [ "$ISP_MODE" = "auto" ]; then
        ISP_MODE=$(detect_isp_mode)
    fi

    # タイムゾーン＆国コード設定
    set_country

    # Wi-Fi設定
    set_wifi_config

    # 接続方式別設定
    case "$ISP_MODE" in
        "pppoe")
            set_pppoe_config
            ;;
        "dslite")
            set_dslite_config
            ;;
        "mape")
            fetch_mape_info && set_mape_config && replace_map
            ;;
        "dhcp"|"none"|*)
            # DHCP または設定なし
            ;;
    esac

    # 設定をコミット
    uci commit system >/dev/null 2>&1
    uci commit wireless >/dev/null 2>&1
    uci commit network
    uci commit dhcp  
    uci commit firewall

    return 0
}

main "$@"

echo "All done!"

exit 0
